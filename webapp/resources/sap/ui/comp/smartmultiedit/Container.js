/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery",".././library","sap/ui/core/Control","sap/ui/comp/smartmultiedit/Field","sap/ui/model/Context","sap/base/Log"],function(t,e,i,a,o,r){"use strict";var n=i.extend("sap.ui.comp.smartmultiedit.Container",{metadata:{library:"sap.ui.comp",properties:{entitySet:{type:"string",defaultValue:null},contexts:{type:"sap.ui.model.Context[]",defaultValue:[]}},defaultAggregation:"layout",aggregations:{layout:{type:"sap.ui.comp.smartform.SmartForm",multiple:false}},designTime:"sap/ui/comp/designtime/smartmultiedit/Container.designtime"},renderer:{apiVersion:2,render:function(t,e){t.openStart("div",e);t.class("sapUiCompSmartMultiEditContainer");t.openEnd();if(e._bReadyToRender){t.renderControl(e.getLayout())}t.close("div")}}});n.prototype.init=function(){this._bIsInitialized=false;this._bReadyToRender=false;this._aFields=null;this.attachEvent("modelContextChange",this._initializeMetadata,this)};n.prototype.setEntitySet=function(t){if(t!==this.getProperty("entitySet")){this.setProperty("entitySet",t,true);if(t){this._initializeMetadata()}}return this};n.prototype.setContexts=function(t){if(Array.isArray(t)){for(var e=0;e<t.length;e++){if(!(t[e]instanceof o)){return this}}this.setProperty("contexts",t,true);this._getFields().forEach(function(t){t._updateContextItems()})}else{r.error("Parameter contexts is expected to be an array.")}return this};n.prototype.setLayout=function(t){this.setAggregation("layout",t,true);this._refreshFields();return this};n.prototype.addCustomData=function(t){var e;if(!t){return this}i.prototype.addCustomData.apply(this,arguments);this._getFields().forEach(function(i){e=t.clone();i._oSmartField.addCustomData(e)});return this};n.prototype.insertCustomData=function(t,e){var a;if(!t){return this}i.prototype.insertCustomData.apply(this,arguments);this._getFields().forEach(function(e){a=t.clone();e._oSmartField.addCustomData(a)});return this};n.prototype.removeCustomData=function(t){var e=i.prototype.removeCustomData.apply(this,arguments);if(e){this._getFields().forEach(function(t){t._oSmartField.removeCustomData(e)})}return e};n.prototype.removeAllCustomData=function(){var t=i.prototype.removeAllCustomData.apply(this,arguments);if(t.length>0){this._getFields().forEach(function(e){t.forEach(function(t){e._oSmartField.removeCustomData(t)})})}return t};n.prototype.destroyCustomData=function(){i.prototype.destroyCustomData.apply(this,arguments);this._getFields().forEach(function(t){t._oSmartField.destroyCustomData()});return this};n.prototype.getAllUpdatedContexts=function(t){var e=this.getContexts(),i=[],a=this,o=0,r=10;if(e.length===0){return Promise.resolve(i)}return new Promise(function(n){function s(u,l,d){for(o=l;o<Math.min(d,u.length);o++){i.push({context:u[o],data:a._getUpdatedDataObject(u[o].getObject(),t)})}if(o<u.length){setTimeout(s.bind(null,e,o,o+r),0)}else{n(i)}}s(e,o,o+r)})};n.prototype.getErroneousFields=function(){return this._getFields().filter(function(t){t._performValidation();return t.hasClientError()})};n.prototype.getErroneousFieldsAndTokens=function(){var t=this._getFields().map(function(t){return t._performValidation()});return Promise.all(t).then(function(){var t=this._getFields().filter(function(t){return t.hasClientError()});return t}.bind(this))};n.prototype.indexField=function(t){var e;if(!(t instanceof a)){r.error("Container.indexField","Element '"+JSON.stringify(t)+"' must be of type sap.ui.comp.smartmultiedit.Field","sap.ui.comp.smartmultiedit.Container");return}this._aFields.push(t);t._setContainer(this);this.getCustomData().forEach(function(i){if(t.getSmartField()){e=i.clone();t.getSmartField().addCustomData(e)}})};n.prototype._getUpdatedDataObject=function(t,e){var i=e?Object.assign({},t):{},a,o,n,s;this._getFields().forEach(function(e){a=e.getPropertyName();o=e.getUnitOfMeasurePropertyName();s=e.getRawValue();if(s.hasOwnProperty(a)){if(e.isDate()||e.isDateTime()){if(!t[a]){if(s[a]){i[a]=s[a]}}else if(!s[a]){i[a]=null}else if(!t[a].getTime){r.error("Container._getUpdatedDataObject","Field "+a+" has incompatible data and metadata, expected: Date/DateTime, but found "+typeof i[a],"sap.ui.comp.smartmultiedit.Container");return}else if(s[a].getTime()!==t[a].getTime()){i[a]=s[a]}}else{if(s[a]!==t[a]&&(s[a]!==""&&s[a]!=null||t[a]!==""&&t[a]!=null)){i[a]=s[a]}}}if(e.isComposite()&&s.hasOwnProperty(o)&&s[o]!==t[o]){i[o]=s[o]}else if(e.isComboBox()){n=e.getRecordTextPath();if(s.hasOwnProperty(n)&&s[n]!==t[n]){i[n]=s[n]}}});return i};n.prototype.getFields=function(t){return this._getFields(t)};n.prototype._getFields=function(t){var e=[];if((t||!this._aFields||Array.isArray(this._aFields)&&!this._aFields.length)&&this.getLayout()){this._aFields=[];this.getLayout().getGroups().forEach(function(i){i.getGroupElements().forEach(function(i){i.getElements().forEach(function(i){if(i instanceof a){this.indexField(i)}else if(t){e.push(i)}}.bind(this))}.bind(this))}.bind(this))}return e.concat(this._aFields||[])};n.prototype._initializeMetadata=function(){var t=this.getModel();if(!this._bIsInitialized&&this.getEntitySet()&&t&&t.getMetadata().getName()==="sap.ui.model.odata.v2.ODataModel"){t.getMetaModel().loaded().then(this._onMetadataInitialized.bind(this))}};n.prototype._onMetadataInitialized=function(){if(this._bIsInitialized){return}this._bIsInitialized=true;this._bReadyToRender=true;this.invalidate()};n.prototype.resetContainer=function(){this._aFields.forEach(function(t){t.resetField()});this._bIsInitialized=false};n.prototype._refreshFields=function(){this._aFields=null;this._getFields()};return n});