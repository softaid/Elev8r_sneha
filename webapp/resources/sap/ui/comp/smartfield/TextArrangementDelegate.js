/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/core/library","sap/ui/core/Core","sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/assert","sap/base/util/deepEqual"],function(t,e,i,r,a,o,n,s){"use strict";var l=t.smartfield.TextInEditModeSource;var d=r.extend("sap.ui.comp.smartfield.TextArrangementDelegate",{constructor:function(t){r.apply(this,arguments);this.oTextArrangementType=null;this.oFactory=t;this.oSmartField=t._oParent;this.bValidMetadata=false;this.sBindingContextPath="";this.sAbsolutePathToVLProperty="";this._mOneTimeDescriptionCache=new Map;this._sTextArrangementLastReadValue=null;this._mTextArrangementLastReadAdditionalFilters=null}});d.prototype.setValue=function(t,e){var i=this.oSmartField,r=i._oControl;if(this.bValidMetadata&&t!==e&&r){var a=r[r.current],o=a&&a.getBinding("value");if(!o){return}var n=i.isPropertyBeingUpdatedByModel("value");switch(i._getComputedTextInEditModeSource()){case l.NavigationProperty:var s=!!i.getModel().getData(o.getBindings()[1].getPath(),i.getBindingContext(),true);if(n&&!s||!n){a.setValue(t)}return;case l.ValueList:case l.ValueListNoValidation:if(!n){a.setValue(t)}else if(this._sTextArrangementLastReadValue!==t){this.fetchIDAndDescriptionCollectionIfRequired()}return}}};d.getPaths=function(t,e){var i=e.property&&e.property.valueListAnnotation;switch(t){case l.NavigationProperty:var r=e.annotations.text;if(!r){return{}}return{keyField:r.entityType.key.propertyRef[0].name,descriptionField:r.property.typePath,entitySetName:r.entitySet.name};case l.ValueList:if(!i){return{}}return{keyField:i.keyField,descriptionField:i.descriptionField,entitySetName:e.property.valueListEntitySet&&e.property.valueListEntitySet.name};case l.ValueListNoValidation:if(!i){return{}}return{valueListNoValidation:true,keyField:i.keyField,descriptionField:i.descriptionField,entitySetName:e.property.valueListEntitySet.name}}};d.prototype.getBindingInfo=function(t){var e,i=t.valueListNoValidation,r={},a=this.oSmartField,o=this.oFactory,n=o._oMetaData,s=n&&n.annotations&&n.annotations.valueListData||null;this.oTextArrangementType=t&&t.type;if(!this.oTextArrangementType){var u=a.getBindingInfo("value");this.oTextArrangementType=u&&u.type||{};var p=d.getPaths(o._bTextInDisplayModeValueList?l.ValueList:a._getComputedTextInEditModeSource(),n);var y=s&&s.aInitialValueIsSignificantFields&&s.aInitialValueIsSignificantFields.indexOf(p.keyField)!==-1;this.oTextArrangementType=o._oTypes.getType(n.property,Object.assign(r,this.oTextArrangementType.oFormatOptions),this.oTextArrangementType.oConstraints,{composite:true,keyField:p.keyField,descriptionField:p.descriptionField,valueListNoValidation:i,valueList:a._getComputedTextInEditModeSource()===l.ValueList,keyInitialValueIsSignificant:y,delegate:this})}var c=this.oSmartField.getBinding("value").getValue(),h=a._getComputedTextInEditModeSource(),f=d.getPaths(this.oFactory._bTextInDisplayModeValueList?l.ValueList:h,n);var g=this.getTextAnnotationPropertyPath({entitySet:{name:f.entitySetName},entityID:c});if(g===""||g.indexOf("undefined")!==-1){g="__$$SmartFieldNotExistingBindingPath"}e={model:n.model,type:this.oTextArrangementType,parts:[{path:n.path},{path:g}]};return e};d.prototype.getTextAnnotationPropertyPath=function(t){t=t||{};var e=t.textInEditModeSource||this.oSmartField._getComputedTextInEditModeSource(),i=this.oFactory,r=i._oMetaData;if(i._bTextInDisplayModeValueList){e=l.ValueList}switch(e){case l.NavigationProperty:var a=t.textAnnotation||r.annotations.text;return i._oHelper.getTextAnnotationPropertyPath(a);case l.ValueList:var o=t.edmValueListKeyProperty||r.property.valueListKeyProperty,n=t.bindingContextPath||this.sBindingContextPath;return i._oHelper.getAbsolutePropertyPathToValueListEntity({property:o,bindingContextPath:n,entitySet:t.entitySet,entityID:t.entityID});case l.ValueListNoValidation:var o=t&&t.edmValueListKeyProperty||r.property.valueListKeyProperty,n=t&&t.bindingContextPath||this.sBindingContextPath,a=t&&t.textAnnotation||r&&r.annotations&&r.annotations.text;if(a&&n!=="/undefined"&&this.oSmartField._isValueInitial()){var s=i._oHelper.getTextAnnotationPropertyPath(a);if(s&&s!==this.oFactory.getMetaData().path){return s}}return i._oHelper.getAbsolutePropertyPathToValueListEntity({property:o,bindingContextPath:n,entitySet:t.entitySet,entityID:t.entityID});case l.None:return"";default:return""}};d.prototype.checkRequiredMetadata=function(t,e){var i=this.oFactory,r=i._oMetaData;switch(t){case l.None:return false;case l.NavigationProperty:var a=r.annotations.text,o;if(a){o=a.entityType}var n={propertyName:r.property&&r.property.property&&r.property.property.name,entityType:r.entityType,entityTypeOfNavigationProperty:o,textAnnotation:r.property&&r.property.property&&r.property.property["com.sap.vocabularies.Common.v1.Text"]};if(e){return i._oHelper.checkNavigationPropertyRequiredMetadataNoAsserts(n)}else{return i._oHelper.checkNavigationPropertyRequiredMetadata(n)}case l.ValueList:case l.ValueListNoValidation:var s={propertyName:r.property&&r.property.property&&r.property.property.name,entityType:r.entityType,valueListAnnotation:r.property&&r.property.valueListAnnotation};if(e){return i._oHelper.checkValueListRequiredMetadataForTextArrangmentNoAsserts(s)}else{return i._oHelper.checkValueListRequiredMetadataForTextArrangment(s)}default:return false}};d.prototype.onBeforeValidateValue=function(t,e){var i=this.oSmartField;if(!i.getBindingContext()){return}var r=this.onFetchIDAndDescriptionCollectionSuccess.bind(this,{success:e.success});var a=this.onFetchIDAndDescriptionCollectionError.bind(this,{error:e.error});var o={value:t,success:r,error:a,filterFields:e.filterFields,updateBusyIndicator:true,bCheckValuesValidity:e.bCheckValuesValidity};return this.fetchIDAndDescriptionCollection(o)};d.prototype.fetchIDAndDescriptionCollectionIfRequired=function(t){var e=this.oSmartField;var i=e.getMode();var r=e._getComputedTextInEditModeSource();var a=this.oFactory&&this.oFactory.getMetaData();var o=a&&a.annotations&&a.annotations.text;if(i==="edit"&&a&&a.annotations&&a.annotations.valuelistType==="fixed-values"){return}if(o&&(a&&o.path===a.path||this.sBindingContextPath==="/undefined"||!e._isValueInitial())){o=null}if(r===l.ValueList||!o&&r===l.ValueListNoValidation&&this.oFactory._getDisplayBehaviourConfiguration()!=="idOnly"||this.oFactory._bTextInDisplayModeValueList){var n="value",d=e.getModel(),u=e.getBindingContext(),p=e.getBinding(n).getPath(),y=d&&u&&p&&d.getProperty(p,u);var c=this.getAdditionalFiltersData(e,e.getControlFactory().getMetaData(),{});var h=this._mTextArrangementLastReadAdditionalFilters&&!s(this._mTextArrangementLastReadAdditionalFilters,c);if(h||this._sTextArrangementLastReadValue!==y||!this.oTextArrangementType||t){var f=["keyField"];var g={value:y,oldValue:y,initialRendering:true,mode:i};return this.fetchIDAndDescriptionCollection({value:y,filterFields:f,updateBusyIndicator:false,success:this.onFetchIDAndDescriptionCollectionSuccess.bind(this,g)})}}};d.prototype.fetchIDAndDescriptionCollection=function(t){var e=t.value;if(t.bCheckValuesValidity){t.filterFields=["keyField"]}var i=this.oSmartField._oControl&&this.oSmartField._oControl.edit;if(i&&t.updateBusyIndicator){i.setBusyIndicatorDelay(300);i.setBusy(true)}this.oSmartField._setValueInValidation(e);return this.readODataModel(t).finally(function(){if(i&&t.updateBusyIndicator){i.setBusyIndicatorDelay(0);i.setBusy(false)}})};d.prototype.readODataModel=function(t){var e=this.oSmartField,i,r,a,o,n,s=e._getComputedTextInEditModeSource(),u=e.getControlFactory().getMetaData(),p=d.getPaths(this.oFactory._bTextInDisplayModeValueList?l.ValueList:s,u),y="/"+p.entitySetName,c=u&&u.annotations&&u.annotations.valueListData||null,h=p.keyField,f=p.descriptionField,g=this.oFactory&&this.oFactory.getValueListProvider(),F=c&&c.valueListEntitySetName===p.entitySetName,m=F&&c&&c.outParams?Object.values(c.outParams):[],v=F&&c&&c.fields?c.fields:[],V={success:t.success,error:t.error};if(!f&&(this.oSmartField.getMode()==="display"||!e._isValueListValidationMode())){return Promise.resolve()}this._sTextArrangementLastReadValue=t.value;try{i=this.getAbsolutePathToVLProperty();if(i){r=this.getSelectedEntity(i);if(r){this.clearAbsolutePathToVLProperty();t.success(r);return Promise.resolve()}}}catch(t){return Promise.reject(t)}n=this.getDataForNextDescriptionRequest(t.value);if(n&&n.hasOwnProperty(f)&&g&&g._shouldHaveHistory&&!g._shouldHaveHistory()){t.success(n);return Promise.resolve()}o=this.getAdditionalFiltersData(e,u,n);var P={keyFieldPath:h,aFilterFields:t.filterFields,valueListData:c};if(f){P.descriptionFieldPath=f}for(a in o){t.filterFields.push(a)}P.additionalFilters=o;var D=this.getFilters(t.value,P);if(D.length===0){return Promise.resolve()}var T=this.getUrlParameters({keyField:h,descriptionField:f,outParams:m,allFields:v});V.filters=D;V.urlParameters=T;this._mTextArrangementLastReadAdditionalFilters=o;return e._getTextArrangementRead().read(e.getModel(),y,V).then(t.success).catch(t.error)};d.prototype.getSelectedEntity=function(t){return t!==""&&this.oSmartField.getBindingContext().getProperty(t)};d.prototype.clearAbsolutePathToVLProperty=function(){this.sAbsolutePathToVLProperty=""};d.prototype.setAbsolutePathToVLProperty=function(t){this.sAbsolutePathToVLProperty=t};d.prototype.getAbsolutePathToVLProperty=function(){return this.sAbsolutePathToVLProperty};d.prototype.getAdditionalFiltersData=function(t,e,i){var r,a,o,n,s,l={};if(typeof i==="undefined"){i={}}if(e&&e.annotations&&e.annotations.valueListData){a=e.annotations.valueListData.inParams;r=e.annotations.valueListData.constParams}if(r){for(o in r){l[o]=r[o]}}if(a){for(n in a){s=a[n];if(s!==e.annotations.valueListData.keyField){l[s]=i[s]!==undefined?i[s]:t.getBindingContext().getProperty(n)}}}return l};d.prototype._setBindingPath=function(t,e,i,r){var a=t.getModel(),o=t.getTextInEditModeSource()==="ValueListNoValidation"||t._getComputedTextInEditModeSource()==="ValueListNoValidation",s;n(Array.isArray(e)," - "+this.getMetadata().getName());if(a){if(Array.isArray(e)&&e.length===1){s=a.getKey(e[0])}if(o&&e.length!==1){this.sBindingContextPath="/"+s;this.bindPropertyForValueList(i,r,true)}else if(typeof s==="string"){this.sBindingContextPath="/"+s;this.bindPropertyForValueList(i,r,false,o)}}};d.prototype.onFetchIDAndDescriptionCollectionSuccess=function(t,e,i){var r,a,o,n,s,d,u,p=this.oSmartField;if(!p){return}o=t.mode||p.getMode();r=e&&Array.isArray(e.results)&&e.results.length===1?e.results[0]:null;a=p&&p.getControlFactory()&&p.getControlFactory().getValueListProvider()||null;n=p._oControl.edit;s=n&&n.getBinding("value");d=p._oControl.display;u=e&&e.results===undefined?[e]:e.results;if(r&&a){a._calculateAndSetODataModelOutputData(r);if(o==="edit"&&!t.initialRendering&&p._getComputedTextInEditModeSource()!==l.NavigationProperty){a._oHistoryValuesProvider&&a._oHistoryValuesProvider.setFieldData([r])}}if(!t.initialRendering){p.oValidation.handleValueListWarning(u)}if(typeof t.success==="function"){t.success(u)}if((o==="display"||o==="display_uom")&&t.initialRendering){this._setBindingPath(p,u,"text",d)}if(s&&o==="edit"&&p.isTextInEditModeSourceNotNone()){this._setBindingPath(p,u,"value",n)}this.oSmartField._setValueInValidation(undefined)};d.prototype.onFetchIDAndDescriptionCollectionError=function(t,e){if(typeof t.error==="function"){t.error(e)}this.oSmartField._setValueInValidation(undefined)};d.prototype.bindPropertyForValueList=function(t,e,i,r){var a=this.oSmartField,o={},n,s,d,u=a._getComputedTextInEditModeSource();if(u===l.ValueList||u===l.ValueListNoValidation||this.oFactory._bTextInDisplayModeValueList){s=e&&e.getBinding(t);if(this.oFactory&&s){d=s.getType();if((!d||!d.isA("sap.ui.comp.smartfield.type.TextArrangement"))&&this.oFactory._getTextArrangementType){n=this.oFactory._getTextArrangementType();if(n){d=n}}if(d){o={type:d}}o.skipValidation=i;o.bValueListNoValidation=r;e.bindProperty(t,this.getBindingInfo(o))}}};d.prototype.getUrlParameters=function(t){var e=[t.keyField];if(t.descriptionField){e.push(t.descriptionField)}t.outParams.forEach(function(t){if(e.indexOf(t)===-1){e.push(t)}});if(this.oSmartField._getComputedTextInEditModeSource()!==l.NavigationProperty){e=t.allFields.map(function(t){return t.name})}return{$select:e.join(","),$top:2}};d.prototype.getFilters=function(t,e){var i=e.aFilterFields,r;this.destroyFilters();if(Array.isArray(i)&&i.length===1){switch(i[0]){case"keyField":this.oIDFilter=this.getIDFilter(t,e);return this.oIDFilter?[this.oIDFilter]:[];case"descriptionField":this.oDescriptionFilter=this.getDescriptionFilter(t,e);return this.oDescriptionFilter?[this.oDescriptionFilter]:[]}}this.oIDFilter=this.getIDFilter(t,e);if(!this.oIDFilter){return[]}r=this._getAdditionalFilters(e);this.oFilters=new a({and:true,filters:[new a({and:false,filters:[this.oIDFilter]})]});if(r.aFilters.length>0){this.oFilters.aFilters.push(r)}return[this.oFilters]};d.prototype.setDataForNextDescriptionRequest=function(t,e){this._mOneTimeDescriptionCache.set(t,e)};d.prototype.getDataForNextDescriptionRequest=function(t){var e=this._mOneTimeDescriptionCache.get(t);this._mOneTimeDescriptionCache.delete(t);return e};d.prototype.getIDFilter=function(t,e){var i,r=e.valueListData,n=e.keyFieldPath,s=r&&r.fields,l=s&&s.find(function(t){return t.name===n}),d=l&&l.nullable==="false";if(t===null||t===undefined||t===""){i=r&&r.aInitialValueIsSignificantFields&&r.aInitialValueIsSignificantFields.indexOf(n)!==-1;if(i){return this._generateFiltersForEmptyField(n,d)}}else{return new a({value1:t,path:n,operator:o.EQ})}};d.prototype.getDescriptionFilter=function(t,e){return new a({value1:t,path:e.descriptionFieldPath,operator:o.Contains})};d.prototype._getAdditionalFilters=function(t){var e=[],i=t.valueListData,r=i&&i.fields;Object.keys(t.additionalFilters).forEach(function(a){var o=t.additionalFilters[a],n=r.find(function(t){return t.name===a}),s=i&&i.aInitialValueIsSignificantFields&&i.aInitialValueIsSignificantFields.indexOf(a)!==-1,l=this._generateFiltersForField(o,a,n,s);if(l){e.push(l)}}.bind(this));return new a({and:true,filters:e})};d.prototype._generateFiltersForField=function(t,e,i,r){if(t===null||t===undefined||t===""){if(r){return this._generateFiltersForEmptyField(e,i&&i.nullable==="false")}}else{return new a({value1:t,path:e,operator:o.EQ})}};d.prototype._generateFiltersForEmptyField=function(t,e){if(e){return new a({value1:"",path:t,operator:o.EQ})}return new a([new a({value1:"",path:t,operator:o.EQ}),new a({value1:null,path:t,operator:o.EQ})],false)};d.prototype.destroyFilters=function(){if(this.oIDFilter){this.oIDFilter.destroy();this.oIDFilter=null}if(this.oDescriptionFilter){this.oDescriptionFilter.destroy();this.oDescriptionFilter=null}if(this.oFilters){this.oFilters.destroy();this.oFilters=null}};d.prototype.destroy=function(){this.oSmartField=null;this.bValidMetadata=false;this.sBindingContextPath="";this.sAbsolutePathToVLProperty="";this._mOneTimeDescriptionCache=null;this._mTextArrangementLastReadAdditionalFilters=null;this.destroyFilters()};return d});