/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Control","./library","sap/m/library","sap/ui/core/IconPool","sap/ui/core/Item","sap/ui/core/Core","sap/ui/richtexteditor/RTESplitButton","sap/base/security/URLListValidator","sap/base/Log","./ToolbarWrapperRenderer"],function(t,e,o,r,i,n,a,s,l,u){"use strict";var c=o.ButtonGroups,g=o.EditorCommands,h=o.ButtonsToCommandsMap,d=r.ButtonType;var p=e.extend("sap.ui.richtexteditor.ToolbarWrapper",{metadata:{interfaces:["sap.ui.richtexteditor.IToolbar"],library:"sap.ui.richtexteditor",aggregations:{_toolbar:{type:"sap.m.OverflowToolbar",multiple:false,visibility:"hidden"},_customInsertImageDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_customInsertLinkDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_customTextColorDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_customBackgroundColorDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_customInsertTableDialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{editor:{type:"sap.ui.richtexteditor.RichTextEditor",multiple:false}}}});p.prototype.init=function(){this._helper=o.RichTextEditorHelper;this._oResourceBundle=a.getLibraryResourceBundle("sap.ui.richtexteditor");this._oAccessibilityTexts={};this._sTextColor=g.TextColor.defaultValue;this._sBackgroundColor=g.BackgroundColor.defaultValue};p.prototype.onBeforeRendering=function(){if(!this.getAggregation("_toolbar")){var t=this._createCustomToolbar(),e=this.getEditor();if(e){t.setEnabled(e.getEditable())}t.addStyleClass("sapUiRTECustomToolbar");this.setAggregation("_toolbar",t);this.setAggregation("_customInsertImageDialog",this._helper.createDialog(this._createInsertImageConfig("InsertImage")));this.setAggregation("_customInsertLinkDialog",this._helper.createDialog(this._createInsertLinkConfig("InsertLink")));this.setAggregation("_customTextColorDialog",this._helper.createColorPalettePopover(this._createColorPalettePopoverConfig("TextColor")));this.setAggregation("_customBackgroundColorDialog",this._helper.createColorPalettePopover(this._createColorPalettePopoverConfig("BackgroundColor")));this.setAggregation("_customInsertTableDialog",this._helper.createDialog(this._createInsertTableConfig("InsertTable")))}};p.prototype.onAfterRendering=function(){var e=this.getEditor();this._initialButtonGroupsState=e&&e.getButtonGroups().map(function(e){return t.extend(true,{},e)});this._modifyPopoverOpeningArrowHandlers(true);this._syncColors("TextColor",this._sTextColor);this._syncColors("BackgroundColor",this._sBackgroundColor)};p.prototype.exit=function(){for(var t in this._oAccessibilityTexts){this._destroyAssociatedInvisibleTexts(t)}this._customButtons=null;this._oAccessibilityTexts=null;this._helper=null;this._oResourceBundle=null;this._sTextColor=null;this._sBackgroundColor=null};p.prototype._modifyPopoverOpeningArrowHandlers=function(t){var e=this._findButtonById("TextColor"),o=e&&e._getArrowButton(),r=this._findButtonById("BackgroundColor"),i=r&&r._getArrowButton();if(t&&o&&!this._bTextColorSyncHandlersAttached){this.getAggregation("_customTextColorDialog")._ensurePopover().attachAfterOpen(o,this._customColorDialogAfterOpen,this).attachAfterClose(o,this._customColorDialogAfterClose,this);this._bTextColorSyncHandlersAttached=true}if(t&&i&&!this._bBackgroundColorSyncHandlersAttached){this.getAggregation("_customBackgroundColorDialog")._ensurePopover().attachAfterOpen(i,this._customColorDialogAfterOpen,this).attachAfterClose(i,this._customColorDialogAfterClose,this);this._bBackgroundColorSyncHandlersAttached=true}if(!t&&o&&this._bTextColorSyncHandlersAttached){this.getAggregation("_customTextColorDialog")._ensurePopover().detachAfterOpen(this._customColorDialogAfterOpen,this).detachAfterClose(this._customColorDialogAfterClose,this);this._bTextColorSyncHandlersAttached=null}if(!t&&i&&this._bBackgroundColorSyncHandlersAttached){this.getAggregation("_customBackgroundColorDialog")._ensurePopover().detachAfterOpen(this._customColorDialogAfterOpen,this).detachAfterClose(this._customColorDialogAfterClose,this);this._bBackgroundColorSyncHandlersAttached=null}};p.prototype._customColorDialogAfterOpen=function(t,e){e&&e._activeButton()};p.prototype._customColorDialogAfterClose=function(t,e){e&&e._inactiveButton()};p.prototype._getId=function(t){this._getId.counter=this._getId.counter?this._getId.counter+1:1;var e=this.getEditor()?this.getEditor().getId():"_rte"+this._getId.counter,o=this.getId(),r=[e+o];if(t||t===0){r.push(t)}return r.join("-")};p.prototype.getEditor=function(){var t=this.getAssociation("editor"),e=a.byId(t);return e||null};p.prototype.modifyRTEToolbarConfig=function(t){var e=this;t.toolbar=false;t.setup=function(t){t.on("PreInit",function(){t.addShortcut("alt+f10","Focus the first element in the toolbar.",function(){var t=e.getAggregation("_toolbar").getAggregation("content").filter(function(t){return t.getVisible()})[0];t&&t.focus()})});t.on("NodeChange",function(){e._syncToolbarStates(this)})};return t};p.prototype._applyColor=function(t,e,o,r){if(r||this._getColor(t).replace(/,\s/g,",")!==o){this.getEditor().getNativeApi().execCommand(e,false,o)}};p.prototype._syncColors=function(t,e){var o=this._findButtonById(t),r;if(!e){return}if(t==="TextColor"){o&&o.setIconColor(e)}if(t==="BackgroundColor"){r=o&&o._getTextButton().getDomRef("img");r&&a.byId(r.id).setColor(e)}};p.prototype._syncToolbarStates=function(t){var e,o,r,n=t.formatter,s=this._oResourceBundle,l=function(t,o,r){var n,a,l;for(n in t){l=e[n];a=i.getIconURI(l.icon);if(t.hasOwnProperty(n)&&o.match(t[n].style)&&r.getIcon()!==a){r.setTooltip(s.getText(t.bundleKey)+" "+s.getText(l.bundleKey));r.setIcon(a);break}}},u=function(t,e,o){var r,i,n,a=t.getDoc().queryCommandValue("FormatBlock");for(r in e){if(!e.hasOwnProperty(r)){continue}i=o.getId()+r;n=e[r];if(o.getSelectedItemId()!==i&&(a===n.commandValue||a===n.text)){o.setSelectedItemId(i);break}}},c=function(t,e,o){var r,i,n,a,s=t.getDoc().queryCommandValue("FontName");for(r in e){if(!e.hasOwnProperty(r)){continue}a=o.getId()+r;i=e[r].commandValue.match(/\w+/g).join("").toLowerCase();s=s&&s.match(/\w+/g).join("").toLowerCase();n=e[r].text.match(/\w+/g).join("").toLowerCase();if(o.getSelectedItemId()!==a&&(i===s||s===n)){o.setSelectedItemId(a);break}}},h=function(t,e){var o=t.selection.getNode(),r=o&&o.tagName.toLowerCase()==="img"||o.parentElement&&o.parentElement.tagName.toLowerCase()==="img";e.setPressed(!!r)},d=function(t,e,o){var r=t.selection.getNode(),i=r&&r.tagName.toLowerCase()==="a"||r.parentElement&&r.parentElement.tagName.toLowerCase()==="a";if(o){e.setPressed(!!i)}else{e.setEnabled(!!i)}};for(r in g){if(!g.hasOwnProperty(r)){continue}e=g[r];o=a.byId(this._getId(r));if(!o){continue}switch(r){case"TextAlign":l(e,n,o);break;case"FontFamily":c(t,e,o);break;case"FormatBlock":u(t,e,o);break;case"InsertImage":h(t,o);break;case"InsertLink":d(t,o,true);break;case"Unlink":d(t,o,false);break;case"FontSize":var p=t.getDoc().queryCommandValue(r),f=o.getId()+p;if(o.getSelectedItemId()!==f&&p){o.setSelectedItemId(f)}break;default:o.getMetadata().getName()==="sap.m.OverflowToolbarToggleButton"&&o.setPressed(n.match(e.style))}}};p.prototype._createButtonConfig=function(t){var e=g[t],o=this.getEditor();return{id:this._getId(t),icon:i.getIconURI(e.icon),tooltip:this._oResourceBundle.getText(e.bundleKey),text:this._oResourceBundle.getText(e.bundleKey),press:function(){if(o){o.getNativeApi().execCommand(e.command)}else{u.warning("Cannot execute native command: "+e.command)}}}};p.prototype._createMenuButtonItems=function(t){var e=this._helper,o=[],r,n;for(var a in g[t]){if(a==="bundleKey"){continue}n=g[t][a];r=this._oResourceBundle.getText(n.bundleKey)||n.text;o.push(e.createMenuItem(this._getId(t+a),r,i.getIconURI(n.icon)))}return o};p.prototype._findTextAlignCommandByIcon=function(t){var e=g["TextAlign"],o,r;Object.keys(e).forEach(function(n){o=i.getIconURI(e[n].icon);if(n!=="bundleKey"&&o===t){r=n}});return r};p.prototype._createFontStyleSelectItems=function(){var t=g["FontFamily"],e=[],o;for(var r in t){o={id:this._getId("FontFamily"+r),text:t[r].text};e.push(new n(o))}return e};p.prototype._getFontStyleCommand=function(t){var e=g["FontFamily"];for(var o in e){if(e.hasOwnProperty(o)&&e[o].text===t){return e[o].commandValue}}};p.prototype._getFormatBlockCommand=function(t){var e=g["FormatBlock"];for(var o in e){if(e.hasOwnProperty(o)&&this._oResourceBundle.getText(e[o].bundleKey)===t){return e[o].commandValue}}};p.prototype._createFontSizeSelectItems=function(){var t=[],e=1,o;g["FontSize"].forEach(function(r){o={id:this._getId("FontSize"+e),text:r+" pt"};t.push(new n(o));e++},this);return t};p.prototype._createFormatBlockItems=function(){var t=g["FormatBlock"],e=[],o;for(var r in t){o={id:this._getId("FormatBlock"+r),text:this._oResourceBundle.getText(t[r].bundleKey)};e.push(new n(o))}return e};p.prototype._getColor=function(t){var e=this.getEditor(),o=g[t].style,r=e.getNativeApi().selection.getNode(),i=e.getNativeApi().dom.getParents(r),n,a,s;for(n=0;n<i.length;n++){a=i[n];s=a.style[o];if(s&&s!=""){return s}}return g[t].defaultValue};p.prototype._createSplitButtonForDialog=function(t){var e=g[t],o=this,r,n;if(!e){return null}n={id:this._getId(t),tooltip:this._oResourceBundle.getText(e.bundleKey),press:function(){if(t==="TextColor"){o._applyColor(t,e.command,o._sTextColor)}if(t==="BackgroundColor"){o._applyColor(t,e.command,o._sBackgroundColor)}},arrowPress:function(){r=o.getAggregation("_custom"+t+"Dialog");this._getArrowButton()._activeButton();if(!r){return}r.openBy(this)}};if(t==="BackgroundColor"){n.icon=i.getIconURI(e.icon)}return n};p.prototype._createButtonForDialog=function(t){var e=g[t],o=this,r;if(!e){return null}return{id:this._getId(t),icon:i.getIconURI(e.icon),tooltip:this._oResourceBundle.getText(e.bundleKey),text:this._oResourceBundle.getText(e.bundleKey),press:function(){r=o.getAggregation("_custom"+t+"Dialog");if(!r){return}switch(t){case"InsertImage":this.setPressed(true);o._syncImageDialogData(r);break;case"InsertLink":o._syncLinkDialogData(r);break;case"InsertTable":o._resetDialogContent(r);break;default:break}r.open()}}};p.prototype._syncImageDialogData=function(t){var e=this.getEditor().getNativeApi().selection,o=e&&e.getNode(),r=t&&t.getContent(),i,n,a,s,l,u,c,g,h;if(!r.length){return}i=r[6];h=r[5];if(h.getMetadata().getName()==="sap.m.HBox"&&h.getAggregation("items").length){n=h.getAggregation("items")[2];a=h.getAggregation("items")[0]}if(o.tagName.toLowerCase()==="img"){s=o}else{s=o.parentElement}if(s.tagName.toLowerCase()!=="img"){this._resetDialogContent(t);return}if(!i.getEnabled()){i.setEnabled(true)}i.setSelected(s.getAttribute("data-sap-ui-rte-image-ratio")==="true"?true:false);l=s.getAttribute("src");u=s.getAttribute("alt");c=parseFloat(s.width);g=parseFloat(s.height);r[1].setValue(l);r[3].setValue(u);n.setValue(g);a.setValue(c)};p.prototype._syncLinkDialogData=function(t){var e=t&&t.getContent(),o,r,i,n,a,s,l,u,c;if(!(e instanceof Array)||!e.length){return}o=this.getEditor().getNativeApi().selection;l=o.getNode();r=this._getSelectionAnchor(o);if(!r){r=l.parentElement}u=o.getContent().length!==0&&r.textContent&&o.getContent().length<r.textContent.length&&r.tagName==="A";c=o.getContent().length!==0;if(!c||u){n=r.text}else{n=o.getNode()&&o.getNode().tagName.toLowerCase()==="a"?o.getNode().textContent:o.getContent({format:"text"})}i=r.getAttribute("href");a=r.getAttribute("title");s=r.getAttribute("target")==="true";e[1].setValue(i);e[3].setValue(n&&n.replace(/\uFEFF/g,""));e[5].setValue(a);e[6].getAggregation("items")[1].setSelectedIndex(s)};p.prototype._resetDialogContent=function(t){var e=t.findAggregatedObjects(true),o;e.forEach(function(t){o=t.getMetadata().getName();if(o==="sap.m.Input"){t.resetProperty("value")}else if(o==="sap.m.CheckBox"){t.resetProperty("selected").setEnabled(false)}})};p.prototype._createColorPalettePopoverConfig=function(t){var e=g[t],o=e.defaultValue,r=this;return{defaultColor:o,colorSelect:function(o){var i=o.getParameters().value;r._applyColor(t,e.command,i,o.getParameter("defaultAction"));if(t==="TextColor"){r._sTextColor=i;r._syncColors("TextColor",i)}if(t==="BackgroundColor"){r._sBackgroundColor=i;r._syncColors("BackgroundColor",i)}}}};p.prototype._generateImageHTML=function(t,e,o,r,i){var n=t?' src="'+t+'"':"",a=e?' alt="'+e+'"':"",s=o?' height="'+o+'px"':"",l=r?' width="'+r+'px"':"",u=s+l,c=i!==undefined?' data-sap-ui-rte-image-ratio="'+i+'"':"";return"<img"+n+a+u+c+">"};p.prototype._createInsertImageConfig=function(){var t,e=this._oResourceBundle.getText(g["InsertImage"].bundleKey),o=this._helper.createInput(),r=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_IMAGE_URL"),labelFor:o}),i=this._helper.createInput(),n=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_IMAGE_DESCRIPTION"),labelFor:i}),a=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_CONTENT_DIMENSIONS")}),s=this._helper.createInput({width:"8rem",fieldWidth:"6rem",description:"px",ariaLabelledBy:a,change:function(){_(false,true)}}),l=this._helper.createText({textAlign:"Center",width:"2rem",text:"x"}),u=this._helper.createInput({fieldWidth:"6rem",width:"8rem",description:"px",ariaLabelledBy:a,change:function(){_(true,false)}}),c=this._helper.createHBox({wrap:"Wrap",alignItems:"Center",justifyContent:"SpaceBetween",items:[s,l,u]}),h=this._helper.createCheckBox({select:function(){_(true,true)}}),p=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_IMAGE_RATIO"),labelFor:h}),f=this.getEditor(),_=function(e,o){var r=f.getNativeApi().selection,i=r&&r.getNode(),n=parseFloat(s.getValue()),a=parseFloat(u.getValue()),l,c;if(!h.getSelected()){return}if(i.tagName.toLowerCase()!=="img"&&!(i.parentElement&&i.parentElement.tagName.toLowerCase()==="img")){return}i=i.tagName.toLowerCase()==="img"?i:i.parentElement;l=parseFloat(i.width);c=parseFloat(i.height);t=l/c;if(e&&(a!==c||a!=u._lastValue)){s.setValue(a*t)}else if(o&&(n!==l||n!=s._lastValue)){u.setValue(n/t)}},m=this,b=[];a.setLabelFor(s);b.push(this._helper.createButton({id:this._getId("InsertImageButton"),type:d.Emphasized,text:this._oResourceBundle.getText("DIALOG_OK_BUTTON"),press:function(){f.getNativeApi().insertContent(m._generateImageHTML(o.getValue(),i.getValue(),u.getValue(),s.getValue(),h.getSelected()));m.getAggregation("_customInsertImageDialog").close();m._syncToolbarStates(f.getNativeApi())}}));b.push(this._helper.createButton({id:this._getId("CancelInsertImageButton"),text:this._oResourceBundle.getText("DIALOG_CANCEL_BUTTON"),press:function(){m.getAggregation("_customInsertImageDialog").close();m._syncToolbarStates(f.getNativeApi())}}));return{contentWidth:"320px",title:e,buttons:b,content:[r,o,n,i,a,c,h,p]}};p.prototype._getSelectionAnchor=function(t){var e,o;if(!t){return}e=t.getNode();if(t.getStart().tagName=="A"){o=t.getStart()}else if(e.tagName=="A"){o=e}return o};p.prototype._generateLinkHTML=function(t,e,o,r){var i={href:t&&l.validate(t)?t:"",target:o?o:null,title:e&&l.validate(e)?e:""},n=this.getEditor().getNativeApi(),a=n.selection,s=false,u,c,g;u=this._getSelectionAnchor(a);if(t===""&&!u){return}if(t===""&&u){n.execCommand("Unlink");return}if(!u){c=n.dom.select('a[href="'+i.href+'"]');if(r!==""){n.insertContent(n.dom.createHTML("a",i,n.dom.encode(r)));s=true}else{n.execCommand("mceInsertLink",false,i);s=true}g=n.dom.select('a[href="'+i.href+'"]');u=g.filter(function(t){return c.indexOf(t)===-1})[0]}if("innerText"in u){u.innerText=r!==""?r:t}else{u.textContent=r!==""?r:t}n.dom.setAttribs(u,i);n.selection.select(u);if(!s){n.fire("change")}};p.prototype._createInsertLinkConfig=function(){var t=this._oResourceBundle.getText(g["InsertLink"].bundleKey),e=this._helper.createInput(),o=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_LINK_URL"),labelFor:e}),r=this._helper.createInput(),i=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_LINK_DISPLAY_TEXT"),labelFor:r}),a=this._helper.createInput(),s=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_LINK_TITLE"),labelFor:a}),l=this._helper.createSelect({id:this._getId("InsertLinkSelect"),items:[new n({id:this._getId("InsertLinkSelectNone"),text:this._oResourceBundle.getText("INSERT_LINK_TARGET_NONE")}),new n({id:this._getId("InsertLinkSelectNewWindow"),text:this._oResourceBundle.getText("INSERT_LINK_TARGET_NEW_WINDOW")})]}),u=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_LINK_TARGET"),labelFor:l}),c=this._helper.createVBox({direction:"Column",alignItems:"Start",items:[u,l]}),h=this.getEditor(),p=this,f=[];f.push(this._helper.createButton({id:this._getId("InsertLinkButton"),type:d.Emphasized,text:this._oResourceBundle.getText("DIALOG_OK_BUTTON"),press:function(){var t=l.getSelectedItem()===l.getItems()[1];p._generateLinkHTML(e.getValue(),a.getValue(),t,r.getValue());p.getAggregation("_customInsertLinkDialog").close();p._syncToolbarStates(h.getNativeApi())}}));f.push(this._helper.createButton({id:this._getId("CancelInsertLinkButton"),text:this._oResourceBundle.getText("DIALOG_CANCEL_BUTTON"),press:function(){p.getAggregation("_customInsertLinkDialog").close();p._syncToolbarStates(h.getNativeApi())}}));return{contentWidth:"320px",title:t,buttons:f,content:[o,e,i,r,s,a,c]}};p.prototype._createInsertTableConfig=function(){var t=this._oResourceBundle.getText(g["InsertTable"].bundleKey),e=this._helper.createStepInput({value:2,min:0,width:"50%"}),r=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_TABLE_ROWS"),labelFor:e}),i=this._helper.createStepInput({value:2,min:0,width:"50%"}),n=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_TABLE_COLS"),labelFor:i}),a=this._helper.createLabel({text:this._oResourceBundle.getText("INSERT_CONTENT_DIMENSIONS")}),s=this._helper.createInput({width:"8rem",fieldWidth:"6rem",description:"px",ariaLabelledBy:a}),l=this._helper.createText({textAlign:"Center",width:"2rem",text:"x"}),u=this._helper.createInput({fieldWidth:"6rem",width:"8rem",description:"px",ariaLabelledBy:a}),c=this._helper.createHBox({wrap:"Wrap",alignItems:"Center",justifyContent:"SpaceBetween",items:[s,l,u]}),h=this.getEditor(),d=this,p=[];p.push(this._helper.createButton({id:this._getId("InsertTableButton"),text:this._oResourceBundle.getText("DIALOG_OK_BUTTON"),press:function(){var t=h.getNativeApi().dom;var r=h.getNativeApi();var n;if(h.getEditorType()===o.EditorType.TinyMCE6){r.execCommand("mceInsertTable",false,{rows:e.getValue(),columns:i.getValue()});n=t.getParents(r.selection.getNode()).find(function(t){return t.tagName.toLowerCase()==="table"})}else{n=r.plugins.table.insertTable(i.getValue(),e.getValue())}t.setStyle(n,"width",u.getValue()+"px");t.setStyle(n,"height",s.getValue()+"px");d.getAggregation("_customInsertTableDialog").close()}}));p.push(this._helper.createButton({id:this._getId("CancelInsertTableButton"),text:this._oResourceBundle.getText("DIALOG_CANCEL_BUTTON"),press:function(){d.getAggregation("_customInsertTableDialog").close()}}));return{title:t,buttons:p,content:this._helper.createVBox({direction:"Column",alignItems:"Start",items:[r,e,n,i,a,c]})}};p.prototype._createCustomToolbar=function(){var t=this._helper,e=[],o=Object.keys(c),r=[],i=this.getEditor()?this.getEditor().getButtonGroups():[];o.forEach(function(t){i.forEach(function(e){if(e.name===t){r.push(e)}})});r=this._sortToolbarContent(r);r.forEach(function(t){e=e.concat(this._createButtonGroup(t))}.bind(this));return t.createOverflowToolbar(this._getId(),e)};p.prototype.setToolbarEnabled=function(t,e){var o=this.getAggregation("_toolbar");if(o&&o.getEnabled()!==t){o.setEnabled(t,e)}};p.prototype.setShowGroup=function(t,e){var o=this._findGroupedControls(t),r=this.getAggregation("_toolbar");o.forEach(function(t){t.setVisible(e)});r&&r.rerender()};p.prototype._mapNativeButtonsToCommands=function(t,e){var o=this.getEditor();var r=[];var i=c[t];if(!Array.isArray(i)||e&&!e.length){return[]}switch(t){case"text-align":r.push("TextAlign");break;case"formatselect":case"blocks":case"styleselect":case"styles":r.push("FormatBlock");break;case"insert":r.push("InsertImage");break;default:e.forEach(function(e){var n=h[e];if(i.indexOf(n)>-1){r.push(n)}else{u.warning("Unsupported button for the custom toolbar found: "+e+", for group: "+t+".",o)}});break}return r};p.prototype._createFontToolbarContent=function(t,e){var r=[];var i=o.Accessibility;var n=this.getEditor();var a=this;if(t.indexOf("FontFamily")!==-1){var l=this._helper.createInvisibleText({text:this._oResourceBundle.getText(i["FontFamily"])}).toStatic();this._registerAssociatedInvisibleTexts("font",l.getId());r.push(this._helper.createSelect({id:this._getId("FontFamily"),ariaLabelledBy:l,selectedItemId:this._getId("FontFamilyVerdana"),items:this._createFontStyleSelectItems(),change:function(t){var e;if(n){e=t.getSource().getSelectedItem();n.getNativeApi().execCommand("FontName",false,a._getFontStyleCommand(e.getText()))}else{u.warning("Cannot execute native command: "+"FontName")}}}).setVisible(e))}if(t.indexOf("FontSize")!==-1){var c=this._helper.createInvisibleText({text:this._oResourceBundle.getText(i["FontSize"])}).toStatic();this._registerAssociatedInvisibleTexts("font",c.getId());r.push(this._helper.createSelect({id:this._getId("FontSize"),ariaLabelledBy:c,selectedItemId:this._getId("FontSize2"),items:this._createFontSizeSelectItems(),change:function(t){var e;if(n){e=t.getSource().getSelectedItem();n.getNativeApi().execCommand("FontSize",false,e.getText().replace(/\s/g,""))}else{u.warning("Cannot execute native command: "+"FontSize")}}}).setVisible(e))}if(t.indexOf("TextColor")!==-1){var g=this._helper.createInvisibleText({text:this._oResourceBundle.getText(i["FontColor"])}).toStatic();var h=new s(this._createSplitButtonForDialog("TextColor")).setVisible(e);h._getTextButton().addAriaLabelledBy(g);r.push(h)}if(t.indexOf("BackgroundColor")!==-1){var d=this._helper.createInvisibleText({text:this._oResourceBundle.getText(i["BackgroundColor"])}).toStatic();var p=this._helper.createSplitButton(this._createSplitButtonForDialog("BackgroundColor")).setVisible(e);p._getTextButton().addAriaLabelledBy(d);r.push(p)}return r};p.prototype._createTextAlignToolbarContent=function(t){var e=this.getEditor();var o=e?e.getShowGroupFontStyle()||t:false;var r=this;var i=e._getTextDirection()==="rtl";var n=i?2:0;var a=this._createMenuButtonItems("TextAlign");return[this._helper.createMenuButton(this._getId("TextAlign"),a,function(t){var o,n,a;if(e){o=t.getParameter("item");n=e.getNativeApi();a=o.getIcon();if(a===this.getParent().getIcon()){var s=i?"JustifyRight":"JustifyLeft";n.execCommand(s)}else{n.execCommand("Justify"+r._findTextAlignCommandByIcon(a))}}else{u.warning("Cannot execute native command: "+"Justify")}},a[n].getIcon(),this._oResourceBundle.getText(g["TextAlign"].bundleKey)).setVisible(o)]};p.prototype._createFormatSelectToolbarContent=function(t){var e=this.getEditor();var r=o.Accessibility;var i=this._helper.createInvisibleText({text:this._oResourceBundle.getText(r["FormatBlock"])}).toStatic();this._registerAssociatedInvisibleTexts("formatselect",i.getId());return[this._helper.createSelect({id:this._getId("FormatBlock"),ariaLabelledBy:i,items:this._createFormatBlockItems(),change:function(t){var o;if(e){o=t.getSource().getSelectedItem();if(o){var r=e.getAggregation("_toolbarWrapper")._getFormatBlockCommand(o.getText());e.getNativeApi().execCommand("FormatBlock",false,r)}}else{u.warning("Cannot execute native command: "+"FormatBlock")}}}).setVisible(t)]};p.prototype._createFontStyleToolbarContent=function(t,e){var o=[];t.forEach(function(t){o.push(this._helper.createOverflowToolbarToggleButton(this._createButtonConfig(t)).setVisible(e))},this);return o};p.prototype._createInsertToolbarContent=function(t){return[this._helper.createOverflowToolbarToggleButton(this._createButtonForDialog("InsertImage")).setVisible(t)]};p.prototype._createLinkToolbarContent=function(t,e){var o=[];if(t.indexOf("InsertLink")!==-1){o.push(this._helper.createOverflowToolbarToggleButton(this._createButtonForDialog("InsertLink")).setVisible(e))}if(t.indexOf("Unlink")!==-1){o.push(this._helper.createOverflowToolbarButton(this._createButtonConfig("Unlink")).setVisible(e))}return o};p.prototype._createStructureToolbarContent=function(t,e){var o=[];t.forEach(function(t){o.push(this._helper.createOverflowToolbarButton(this._createButtonConfig(t)).setVisible(e))},this);return o};p.prototype._createClipboardToolbarContent=function(t,e){var o=[];t.forEach(function(t){o.push(this._helper.createOverflowToolbarButton(this._createButtonConfig(t)).setVisible(e))},this);return o};p.prototype._createUndoToolbarContent=function(t,e){var o=[];t.forEach(function(t){o.push(this._helper.createOverflowToolbarButton(this._createButtonConfig(t)).setVisible(e))},this);return o};p.prototype._createButtonGroup=function(t){var e=this.getEditor(),o=this._helper,r=[],i=[];if(!e){return[]}i=this._mapNativeButtonsToCommands(t.name,t.buttons);switch(t.name){case"font-style":r=this._createFontStyleToolbarContent(i,t.visible);break;case"font":r=this._createFontToolbarContent(i,t.visible);break;case"text-align":r=this._createTextAlignToolbarContent(t.visible);break;case"styleselect":case"styles":case"blocks":case"formatselect":r=this._createFormatSelectToolbarContent(this._isButtonGroupAdded("styleselect")||this._isButtonGroupAdded("styles")||this._isButtonGroupAdded("blocks")||this._isButtonGroupAdded("formatselect"));break;case"structure":r=this._createStructureToolbarContent(i,t.visible);break;case"clipboard":r=this._createClipboardToolbarContent(i,t.visible);break;case"undo":r=this._createUndoToolbarContent(i,t.visible);break;case"insert":r=this._createInsertToolbarContent(t.visible);break;case"link":r=this._createLinkToolbarContent(i,t.visible);break;case"table":r.push(o.createOverflowToolbarButton(this._createButtonForDialog("InsertTable")).setVisible(t.visible));break;default:break}return r};p.prototype.addButtonGroupToContent=function(t){var e;if(t.name==="table"){e=t.name;c[t.name]=["InsertTable"]}if(t.name==="formatselect"||t.name==="styleselect"||t.name==="styles"||t.name==="blocks"){e="formatselect";c[t.name]=["FormatBlock"]}if(!c[t.name]&&!c.custom[t.name]){return this}if(!e){e=t.name}var o=this.getAggregation("_toolbar"),r=this._createButtonGroup(t),i=r.length,n,a;a=this._findGroupPriorityPosition(t);r.reverse();for(n=0;n<i;n++){o.insertContent(r[n],a)}return this};p.prototype._sortToolbarContent=function(t){t.sort(function(t,e){return t.customToolbarPriority-e.customToolbarPriority});return t};p.prototype._findGroupPriorityPosition=function(t){var e=this.getEditor().getButtonGroups(),o=0;if(typeof t.customToolbarPriority!=="number"){t.customToolbarPriority=this._getLastGroupPriority(e)+10}e=this._sortToolbarContent(e);e.map(function(t){return{name:t.name,iButtonsCount:this._mapNativeButtonsToCommands(t.name,t.buttons).length,customToolbarPriority:t.customToolbarPriority}}.bind(this)).forEach(function(e){if(e.customToolbarPriority<t.customToolbarPriority&&e.name!==t.name){o+=c[e.name]?e.iButtonsCount:0}});return o};p.prototype._getLastGroupPriority=function(t){var e=t.map(function(t){return t.customToolbarPriority||0});return Math.max.apply(null,e)};p.prototype.removeButtonGroup=function(t){var e=this._findGroupedControls(t);if(t==="font"){this._modifyPopoverOpeningArrowHandlers(false)}this._destroyAssociatedInvisibleTexts(t);e.forEach(function(t){t.destroy()})};p.prototype._destroyAssociatedInvisibleTexts=function(t){var e=this._oAccessibilityTexts[t]||[];e.forEach(function(t){a.byId(t).destroy()});this._oAccessibilityTexts[t]=[]};p.prototype._registerAssociatedInvisibleTexts=function(t,e){if(!this._oAccessibilityTexts[t]){this._oAccessibilityTexts[t]=[]}this._oAccessibilityTexts[t].push(e)};p.prototype.setButtonGroups=function(t){var e=this.getAggregation("_toolbar"),o=this._getGroupsForUpdate(t);if(!e){return this}o.aRemovedGroups.forEach(function(t){this.removeButtonGroup(t.name)}.bind(this));o.aAddedGroups=this._sortToolbarContent(o.aAddedGroups);o.aAddedGroups.forEach(function(t){this.addButtonGroupToContent(t,true)}.bind(this));return this};p.prototype._getJSONStringForGroups=function(t){var e=[];t.forEach(function(t){e.push(JSON.stringify(t,["name","visible","customToolbarPriority","buttons"]))});return e};p.prototype._getGroupsForUpdate=function(t){var e=this._getJSONStringForGroups(t),o=this._getJSONStringForGroups(this._initialButtonGroupsState),r={aRemovedGroups:[],aAddedGroups:[]};e.forEach(function(e,i){if(o.indexOf(e)===-1){r.aAddedGroups.push(t[i])}});o.forEach(function(t,o){if(e.indexOf(t)===-1){r.aRemovedGroups.push(this._initialButtonGroupsState[o])}}.bind(this));return r};p.prototype._findGroupedControls=function(t){var e=this.getAggregation("_toolbar"),o=[];if(!e){return[]}if(c[t]){o=c[t]}else if(c.custom[t]){o=c.custom[t].controls}var r=o.map(function(t){return this._getId(t)},this);return e.findAggregatedObjects(false,function(t){return r.indexOf(t.getId())>-1})||[]};p.prototype.modifyToolbarContent=function(t){var e;var o=Array.prototype.slice.call(arguments);var r=this.getAggregation("_toolbar");if(!r){return null}o.shift();switch(t){case"add":e=this._proxyToolbarAdd.apply(this,o);break;case"destroy":e=this._proxyToolbarDestroy.apply(this,o);break;case"get":e=this._proxyToolbarGet.apply(this,o);break;case"indexOf":e=this._proxyToolbarIndexOf.apply(this,o);break;case"insert":e=this._proxyToolbarInsert.apply(this,o);break;case"removeAll":e=this._proxyToolbarRemoveAll.apply(this,o);break;case"remove":e=this._proxyToolbarRemove.apply(this,o);break;default:break}return e};p.prototype._isButtonGroupAdded=function(t){var e=this.getEditor().getButtonGroups(),o=false,r;for(r=0;r<e.length;r++){if(e[r].name===t){o=true;break}}return o};p.prototype._updateCustomToolbarRefIds=function(t,e){var o,r;o=this._customButtons||[];r=o.indexOf(t);if(r>-1){o.splice(r,1)}if(e!==-1){e=e>=0&&e<=o.length?e:o.length;o.splice(e,0,t)}this._customButtons=o};p.prototype._proxyToolbarAdd=function(t){var e=this.getAggregation("_toolbar"),o=e.addContent(t);e.rerender();if(o){this._updateCustomToolbarRefIds(t.getId())}return o};p.prototype._proxyToolbarGet=function(){var t=this.getAggregation("_toolbar"),e=this._customButtons||[];return t.findAggregatedObjects(false,function(t){return e.indexOf(t.getId())>-1})||[]};p.prototype._proxyToolbarDestroy=function(){var t=this._proxyToolbarGet();t.forEach(function(t){t.destroy()});this._customButtons=[]};p.prototype._proxyToolbarIndexOf=function(t){var e=this._customButtons||[],o=typeof t==="object"?t.getId():t;return e.indexOf(o)};p.prototype._proxyToolbarInsert=function(t,e){var o,r=this.getAggregation("_toolbar"),i=r.getContent()||[],n=this._customButtons||[],a=i.length-n.length;if(e<0){e=0}else if(e>n.length){e=n.length}else if(!e&&e!==0){e=n.length}a+=e;o=r.insertContent(t,a);r.rerender();if(o){this._updateCustomToolbarRefIds(t.getId(),e)}return o};p.prototype._proxyToolbarRemoveAll=function(){var t=this._proxyToolbarGet();t.forEach(this._proxyToolbarRemove,this);return t};p.prototype._proxyToolbarRemove=function(t){var e,o,r=this.getAggregation("_toolbar");switch(typeof t){case"string":e=t;break;case"object":e=t.getId();break;case"number":e=this._customButtons[t];break;default:break}o=r.removeContent(e);if(o&&e){this._updateCustomToolbarRefIds(e,-1)}return o};p.prototype._findButtonById=function(t){var e=this.getEditor();if(!e){return null}return a.byId(e.getId()+this.getId()+"-"+t)};return p});