/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.script","sap/base/Log","../thirdparty/three","../ContentManager","./Scene","../TransformationMatrix","./PerspectiveCamera","./OrthographicCamera","../Messages","../getResourceBundle","./ContentDeliveryService","./ThreeUtils","./Viewport","./ViewStateManager"],function(e,r,t,a,o,n,i,s,d,l,u,c){"use strict";var f=function(e){Object.defineProperties(this,{source:{value:e.getSource()},sourceType:{value:e.getSourceType()},sourceId:{value:null,writable:true},name:{value:null,writable:true},localMatrix:{value:null,writable:true},children:{value:[]},nodeProxy:{value:null,writable:true},loader:{value:null,writable:true},builder:{value:null,writable:true}});e._shadowContentResource=this};var h=a.extend("sap.ui.vk.threejs.ContentManager",{metadata:{library:"sap.ui.vk"}});var g=h.getMetadata().getParent().getClass().prototype;h.prototype.init=function(){if(g.init){g.init.call(this)}this._shadowContentResources=[]};h.prototype.exit=function(){if(this.defaultCdsLoader){this.defaultCdsLoader.destroy();this.defaultCdsLoader=null}if(this.defaultMataiLoader){this.defaultMataiLoader.destroy();this.defaultMataiLoader=null}if(g.exit){g.exit.call(this)}this._shadowContentResources=null};h.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};h.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};function p(e){if(e&&e.isMesh){e.castShadow=true;e.receiveShadow=false}if(e&&e.children){for(var r=0;r<e.children.length;r++){p(e.children[r])}}}function v(e,r){if(e){var t=new THREE.Group;e.add(t);t.name="DefaultLights";t.private=true;var a=(new THREE.Box3).setFromObject(e);var o=new THREE.Vector3;a.getSize(o);var n=o.length();var i=new THREE.PointLight;i.color.setRGB(.72,.72,.81);a.getCenter(i.position);i.visible=true;i.private=true;t.add(i);var s=[new THREE.Color(.2,.2,.2),new THREE.Color(.32,.32,.36),new THREE.Color(.36,.36,.36)];var d=[new THREE.Vector3(2,1.5,.5),new THREE.Vector3(-2,-1.1,2.5),new THREE.Vector3(-.04,-.01,-2)];for(var l=0,u=s.length;l<u;l++){var c=new THREE.DirectionalLight;c.color.copy(s[l]);c.position.copy(d[l]);c.private=true;t.add(c)}if(r){p(e);var f=new THREE.DirectionalLight;f.color.setRGB(.5,.5,.5);f.position.set(0,1,0);f.castShadow=true;f.shadow.mapSize.width=512;f.shadow.mapSize.height=512;var h=2e3;f.shadow.camera.left=-h;f.shadow.camera.right=h;f.shadow.camera.top=h;f.shadow.camera.bottom=-h;f.shadow.camera.far=3500;f.shadow.bias=-1e-4;f.private=true;t.add(f);var g=new THREE.PlaneBufferGeometry(a.getSize().x,a.getSize().z);var v=new THREE.ShadowMaterial;v.opacity=.2;var C=new THREE.Mesh(g,v);C.rotation.x=-Math.PI/2;C.position.x=a.getCenter().x;C.position.y=a.min.y-n*.1;C.position.z=a.getCenter().z;e.add(C);C.receiveShadow=true}}}h.prototype.loadContent=function(e,t){this.fireContentChangesStarted();var a=e||new o(new THREE.Scene);var n=this;this._loadContentResources(a,t).then(function(t){r.info("Content loading resolved");if(t){for(var o=0;o<t.length;++o){if(!a.getInitialView()&&t[o].initialView){a.setInitialView(t[o].initialView)}a.camera=a.camera||t[o].camera;var i=t[o].contentResource?t[o].contentResource._shadowContentResource:null;if(t[o].loader){if(i){i.loader=t[o].loader}a.loaders=a.loaders||[];a.loaders.push(t[o].loader)}if(t[o].builder){if(i){i.builder=t[o].builder}a.builders=a.builders||[];a.builders.push(t[o].builder)}}if(t.length>0){var s=t[0];a.backgroundTopColor=s.backgroundTopColor;a.backgroundBottomColor=s.backgroundBottomColor;a.renderMode=s.renderMode;a.upAxis=s.upAxis;a.annotations=s.annotations}}a.getSceneRef().updateMatrixWorld();if(!e){v(a.getSceneRef(),false)}if(a.loaders){n._initSceneWithCDSLoaderIfExists(a,a.loaders)}n.fireContentChangesFinished({content:a})},function(e){r.info("Content loading rejected:",e);var t;if(typeof e==="string"){t=e}else if(e.errorText){t=e.errorText}else if(e.message){t=e.message}t=t||l().getText(d.VIT37.summary);r.error(l().getText("CONTENTMANAGER_MSG_CONTENTRESOURCESFAILEDTOLOAD"),t);n.fireContentChangesFinished({content:null,failureReason:[{error:e,errorMessage:t}]})});return this};h.prototype._findLoader=function(e){if(e._contentManagerResolver&&e._contentManagerResolver.settings&&e._contentManagerResolver.settings.loader){return Promise.resolve(e._contentManagerResolver.settings.loader)}if(e.getSource()){var r=e.getSourceType().toLowerCase();var t=this;switch(r){case"stream":{if(this.defaultCdsLoader==null){return new Promise(function(e){var r="sap/ui/vk/threejs/ContentDeliveryService";sap.ui.require([r],function(r){e(t.defaultCdsLoader=new r({authorizationHandler:t._authorizationHandler}))})})}return Promise.resolve(this.defaultCdsLoader)}case"vds4":{if(this.defaultMataiLoader==null){return new Promise(function(e){var r="sap/ui/vk/matai/MataiLoader";sap.ui.require([r],function(r){e(t.defaultMataiLoader=new r)})})}return Promise.resolve(this.defaultMataiLoader)}default:break}}return Promise.resolve(null)};h.prototype._loadContentResources=function(r,t){function a(e,r){if(typeof r==="string"){return(e||"")+r}return null}function o(e,r){if(!e&&!r){return true}else if(!!e^!!r){return false}else{return e.source===r.getSource()&&e.sourceType===r.getSourceType()}}function i(e,r){r._shadowContentResource=e;var t=e.nodeProxy.getNodeRef();e.name=r.getName();t.name=e.name;e.sourceId=r.getSourceId();t.sourceId=e.sourceId;function a(e,r){if(!e&&!r){return true}var t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var a=e||t,o=r||t;for(var n=0;n<t.length;++n){if(a[n]!==o[n]){return false}}return true}if(!a(e.localMatrix,r.getLocalMatrix())){e.localMatrix=r.getLocalMatrix();t.matrix.fromArray(n.convertTo4x4(e.localMatrix));t.matrix.decompose(t.position,t.quaternion,t.scale);t.matrixWorldNeedsUpdate=true}}var s=[];var d=new Map;function l(e){var r=a(e.sourceType,e.source);var t=d.get(r);if(!t){t=[];d.set(r,t)}t.push(e);var o=e.nodeProxy.getNodeRef();o.parent.remove(o);e.children.forEach(function(e){l(e)});e.children.length=0}function u(e,t){var a=new f(e);var o=new THREE.Group;t.add(o);o.matrixWorldNeedsUpdate=true;a.nodeProxy=r.getDefaultNodeHierarchy().createNodeProxy(o);i(a,e);s.push(e);return a}(function r(t,a,n){var s=0;var d=e.sap.arrayDiff(t,a,o,true);d.forEach(function(e){for(;s<e.index;++s){i(t[s],a[s]);r(t[s].children,a[s].getContentResources(),t[s].nodeProxy.getNodeRef())}if(e.type==="delete"){l(t[e.index]);t.splice(e.index,1)}else if(e.type==="insert"){var o=u(a[e.index],n);t.splice(e.index,0,o);r(o.children,a[e.index].getContentResources(),o.nodeProxy.getNodeRef())}++s});for(;s<t.length;++s){i(t[s],a[s]);r(t[s].children,a[s].getContentResources(),t[s].nodeProxy.getNodeRef())}})(this._shadowContentResources,t,r.getSceneRef());var h=[];s.forEach(function(e){var t=e._shadowContentResource.nodeProxy.getNodeRef();var o=a(e.getSourceType(),e.getSource());var n=d.get(o);if(o&&n&&n.length>0){var i=n.pop();var s=i.nodeProxy.getNodeRef();for(var l=0;l<s.children.length;++l){t.add(s.children[l])}if(i.loader){e._shadowContentResource.loader=i.loader}if(i.builder){e._shadowContentResource.builder=i.builder}r.getDefaultNodeHierarchy().destroyNodeProxy(i.nodeProxy);i.nodeProxy=null}else{var u=this;h.push(this._findLoader(e).then(function(r){if(r){if(r.attachContentChangesProgress){r.attachContentChangesProgress(u._handleContentChangesProgress,u)}if(r.attachContentLoadingFinished){r.attachContentLoadingFinished(u._handleContentLoadingFinished,u)}}if(typeof r==="function"){return r(t,e,u._authorizationHandler,u._retryCount)}else if(r&&r.load){return r.load(t,e,u._authorizationHandler,u._retryCount)}else{return Promise.resolve({node:t,contentResource:e})}}))}},this);function g(e){var r=[];var t=[];c.getAllTHREENodes([e],r,t);var a=new Map;var o=new Map;r.forEach(function(e){if(e instanceof THREE.Mesh){if(!o.has(e.geometry.uuid)){c.disposeGeometry(e);o.set(e.geometry.uuid,true)}if(e.material){if(!a.has(e.material.uuid)){c.disposeMaterial(e.material);a.set(e.material.uuid,true)}}if(e.userData&&e.userData.originalMaterial&&e.userData.originalMaterial.uuid!==e.material.uuid&&!a.has(e.userData.originalMaterial.uuid)){c.disposeMaterial(e.userData.originalMaterial);a.set(e.userData.originalMaterial.uuid,true)}}if(e.parent){e.parent.remove(e)}});t.forEach(function(e){if(e.parent){e.parent.remove(e)}});a.clear();o.clear()}d.forEach(function(e,r){for(var t=0;t<e.length;++t){var a=e[t];g(a.nodeProxy.getNodeRef());if(a.builder){a.builder.cleanup()}if(a.loader){if(a.loader._loader&&a.loader._loader.sceneBuilder){a.loader._loader.removeContext(a.loader._loader.currentSceneInfo.id);a.loader._loader.sceneBuilder.cleanup()}if(a.loader.detachContentChangesProgress){a.loader.detachContentChangesProgress(this._handleContentChangesProgress,this)}if(a.loader.detachContentLoadingFinished){a.loader.detachContentLoadingFinished(this._handleContentLoadingFinished,this)}}}},this);if(t.length===1&&t[0].getName()==null&&t[0].getLocalMatrix()==null){t[0]._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=true}else{t.forEach(function(e){e._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=false})}return Promise.all(h)};h.prototype._initSceneWithCDSLoaderIfExists=function(e,r){if(r){var t;for(var a=0;a<r.length;a++){if(r[a]instanceof u){t=r[a].getSceneBuilder();break}}if(t){e.setSceneBuilder(t);e.getDefaultNodeHierarchy().attachNodeRemoving(function(e){var r=e.getParameter("nodeRef");if(r.userData.treeNode&&r.userData.treeNode.sid){t.decrementResourceCountersForDeletedTreeNode(r.userData.treeNode.sid)}});return true}}return false};h.prototype.destroyContent=function(e){if(e){e.destroy();this._shadowContentResources=[];if(e.loaders&&Array.isArray(e.loaders)&&e.loaders.length>0){if(e.loaders[0]._loader&&e.loaders[0]._loader.sceneBuilder){e.loaders[0]._loader.removeContext(e.loaders[0]._loader.currentSceneInfo.id);e.loaders[0]._loader.sceneBuilder.cleanup()}if(e.loaders[0].detachContentChangesProgress){e.loaders[0].detachContentChangesProgress(this._handleContentChangesProgress,this)}if(e.loaders[0].detachContentLoadingFinished){e.loaders[0].detachContentLoadingFinished(this._handleContentLoadingFinished,this)}}else if(e.builders&&Array.isArray(e.builders)){e.builders.forEach(function(e){if(e){e.cleanup()}})}}return this};h.prototype.createOrthographicCamera=function(){return new s};h.prototype.createPerspectiveCamera=function(){return new i};return h});