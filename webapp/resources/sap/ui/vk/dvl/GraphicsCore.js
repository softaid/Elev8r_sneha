/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.script","sap/ui/base/EventProvider","../thirdparty/html2canvas","../ve/dvl","./Scene","../ContentResource","../DownloadManager","./ViewStateManager","../DvlException","../Messages","sap/ui/thirdparty/URI","./GraphicsCoreApi","./checkResult","./getPointer","./getJSONObject","../getResourceBundle","../utf8ArrayBufferToString","sap/base/assert","sap/base/util/uid","sap/base/Log","sap/ui/core/Core"],function(e,t,r,n,o,s,i,a,c,u,d,l,h,v,f,p,_,g,y,S,m){"use strict";function w(e){return e instanceof File?"local":"remote"}function C(e){return e instanceof File?e.name:e}var D=function(e){Object.defineProperties(this,{source:{value:e,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}})};D.prototype.isInUse=function(){return this._refCount>0};D.prototype.addRef=function(){++this._refCount;return this};D.prototype.release=function(){--this._refCount;g(this._refCount>=0,"Too many calls to SourceDatum.release().");return this};D.prototype.destroy=function(){};var R=function(e,t,r){D.call(this,e);Object.defineProperties(this,{content:{value:r,writable:false,enumerable:true},vdsSourceDatum:{value:t,writable:false,enumerable:true}})};R.prototype=Object.create(D.prototype);R.prototype.constructor=R;R.prototype.destroy=function(){g(this.vdsSourceDatum,"VDSL source without VDS reference");if(this.vdsSourceDatum){this.vdsSourceDatum.release()}D.prototype.destroy.call(this)};var L=function(e,t,r){Object.defineProperties(this,{dvlSceneId:{value:e,writable:false,enumerable:true},sourceDatum:{value:t,writable:false,enumerable:true},root:{value:!!r,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}})};L.prototype.isInUse=function(){return this._refCount>0};L.prototype.addRef=function(){++this._refCount;return this};L.prototype.release=function(){--this._refCount;g(this._refCount>=0,"Too many calls to DvlSceneDatum.release().");return this};L.prototype.destroy=function(){if(this.sourceDatum){this.sourceDatum.release()}};var I=function(e,t){Object.defineProperties(this,{source:{value:e.getSource()},sourceType:{value:e.getSourceType()},sourceId:{value:e.getSourceId(),writable:true},name:{value:e.getName()},localMatrix:{value:e.getLocalMatrix(),writable:true},password:{value:e.getPassword()},children:{value:e.getContentResources().map(function(e){return new I(e)})},dvlSceneDatum:{value:null,writable:true},nodeProxy:{value:null,writable:true},fake:{value:!!t},sourceProperties:{value:null,writable:true}});e._shadowContentResource=this};I.prototype.destroy=function(){if(this.dvlSceneDatum){this.dvlSceneDatum.release()}};var P=function(e,t){Object.defineProperties(this,{vkScene:{value:e},shadowContentResource:{value:t}})};var b=t.extend("sap.ui.vk.dvl.GraphicsCore",{metadata:{library:"sap.ui.vk",publicMethods:["attachSceneLoadingFinished","attachSceneLoadingProgress","attachSceneLoadingStarted","buildSceneTree","buildSceneTreeAsync","createViewStateManager","destroyScene","destroyViewStateManager","detachSceneLoadingFinished","detachSceneLoadingProgress","detachSceneLoadingStarted","getApi","loadContentResourcesAsync","showDebugInfo","updateSceneTree","updateSceneTreeAsync"]},constructor:function(r,n){t.apply(this);var o=e.extend({},r,{filePackagePrefixURL:sap.ui.require.toUrl("sap/ui/vk/ve")+"/"});this._dvlClientId=y();var s=this;this._initialized=new Promise(function(e){s._initResolve=e});sap.ve.dvl.createRuntime(o).then(function(e){s._dvl=e;s._dvl.CreateCoreInstance(s._dvlClientId);h(s._dvl.Core.Init(s._DVLMajorVersion,s._DVLMinorVersion));var t=m;t.attachLocalizationChanged(s._onlocalizationChanged,s);h(s._dvl.Core.SetLocale(t.getConfiguration().getLanguageTag()));s._canvas=s._createRenderingCanvasAndContext(n);s._rendererId=v(s._dvl.Core.CreateRenderer());s._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*window.devicePixelRatio,s._rendererId);s._initResolve()});this._sourceData=[];this._dvlSceneData=[];this._vkSceneData=[];this._viewports=[];this._renderLoopRequestId=null;this._renderLoop=this._renderLoop.bind(this);this._viewStateManagers=[];this._authorizationHandler=null;this._retryCount=1},_DVLMajorVersion:7,_DVLMinorVersion:6});b.create=function(e,t){return new Promise(function(r,n){try{var o=new b(e,t);o._initialized.then(function(){r(o)})}catch(e){n(e)}})};b.prototype.destroy=function(){m.detachLocalizationChanged(this._onlocalizationChanged,this);var e=this._viewports.slice();e.reverse();e.forEach(function(e){e.control.setGraphicsCore(null)});this._viewports=null;this._cleanupVkSceneData();this._vkSceneData=null;this._cleanupDvlSceneData();g(this._dvlSceneData.length===0,"Not all DVL scenes are destroyed when sap.ui.vk.dvl.Scene objects are destroyed.");this._dvlSceneData=null;this._cleanupSourceData();g(this._sourceData.length===0,"Not all sources are deleted.");this._sourceData=null;this._viewStateManagers.slice().forEach(this.destroyViewStateManager.bind(this));this._viewStateManagers=null;this._webGLContext=null;this._canvas=null;this._dvl.Core.DeleteRenderer(this._rendererId);this._rendererId=null;this._dvl.Core.Release();this._dvl=null;t.prototype.destroy.apply(this)};b.prototype._createRenderingCanvasAndContext=function(e){var t=document.createElement("canvas");t.id=y();this._webGLContext=this._dvl.Core.CreateWebGLContext(t,e);return t};b.prototype._getCanvas=function(){return this._canvas};b.prototype._getWebGLContext=function(){return this._webGLContext};b.prototype._getDvl=function(){return this._dvl};b.prototype._getDvlClientId=function(){return this._dvlClientId};b.prototype._findSourceData=function(e){var t=Object.getOwnPropertyNames(e);return this._sourceData.filter(function(r){return t.every(function(t){return e[t]===r[t]})})};b.prototype._destroySourceDatum=function(e){if(!(e instanceof R)){this._dvl.Core.DeleteFileByUrl(C(e.source),w(e.source))}e.destroy();return this};b.prototype._cleanupSourceData=function(){var e=false;for(var t=this._sourceData.length-1;t>=0;--t){var r=this._sourceData[t];if(!r.isInUse()){var n=r instanceof R?r.vdsSourceDatum:null;this._sourceData.splice(t,1);this._destroySourceDatum(r);if(n&&!n.isInUse()){e=true}}}if(e){this._cleanupSourceData()}return this};b.prototype._findDvlSceneData=function(e){var t=Object.getOwnPropertyNames(e);return this._dvlSceneData.filter(function(r){return t.every(function(t){return e[t]===r[t]})})};b.prototype._destroyDvlSceneDatum=function(e){this._dvl.Scene.Release(e.dvlSceneId);e.destroy();return this};b.prototype._cleanupDvlSceneData=function(){for(var e=this._dvlSceneData.length-1;e>=0;--e){var t=this._dvlSceneData[e];if(!t.isInUse()){this._dvlSceneData.splice(e,1);this._destroyDvlSceneDatum(t)}}};b.prototype._findVkSceneData=function(e){var t=Object.getOwnPropertyNames(e);return this._vkSceneData.filter(function(r){return t.every(function(t){return e[t]===r[t]})})};b.prototype._cleanupVkSceneData=function(){for(var e=this._vkSceneData.length-1;e>=0;--e){this.destroyScene(this._vkSceneData[e].vkScene)}};b.prototype._destroyShadowContentResource=function(e,t){if(t.children){t.children.forEach(this._destroyShadowContentResource.bind(this,e))}if(t.nodeProxy){var r=e.getDefaultNodeHierarchy();try{r.removeNode(t.nodeProxy.getNodeRef())}catch(e){var n="Failed to delete node with ID = "+t.nodeProxy.getNodeRef()+".";if(e instanceof c){n+=" Error code: "+e.code+". Message: "+e.message+"."}S.error(n)}r.destroyNodeProxy(t.nodeProxy)}t.destroy()};b.prototype._filterContentResources=function(e,t){var r=[];e.forEach(function e(n){if(t(n)){r.push(n)}n.getContentResources().forEach(e)});return r};b.prototype._getContentResourcesWithMissingPasswords=function(e){var t=this._dvl.Library;return this._filterContentResources(e,function(e){var r=e.getSource();try{return r&&f(t.RetrieveInfo(C(r),w(r))).flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED&&!e.getPassword()}catch(e){S.warning("Failed to get information from Emscripten virtual file system about file '"+C(r)+"'");return false}})};b.prototype._getContentResourcesWithEncryptedVds3=function(e){var t=this._dvl.Library;return this._filterContentResources(e,function(e){var r=e.getSource();if(r){try{var n=f(t.RetrieveInfo(C(r),w(r)));return n.major<=3&&n.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED}catch(e){S.warning("Failed to get information from Emscripten virtual file system about file '"+C(r)+"'");return false}}else{return false}})};b.prototype._collectAndCheckSourceProperties=function(e){var t=e.dvlSceneDatum.sourceDatum;if(!t){return this}try{if(t instanceof R){t=t.vdsSourceDatum}var r=f(this._dvl.Library.RetrieveInfo(C(t.source),w(t.source)));e.sourceProperties={version:{major:r.major,minor:r.minor}};if(r.flags&(sap.ve.dvl.DVLFILEFLAG.PAGESCOMPRESSED|sap.ve.dvl.DVLFILEFLAG.WHOLEFILECOMPRESSED)){e.sourceProperties.compressed=true}if(r.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED){e.sourceProperties.encrypted=true}}catch(t){S.warning("Failed to get information from Emscripten virtual file system about file '"+C(e.source)+"'")}return this};b.prototype.loadContentResourcesAsync=function(e,t,r){var n=this,o=[],s=new Map;e.forEach(function e(t){var r=t.getSource();if(r&&o.indexOf(r)<0&&n._findSourceData({source:r}).length===0){o.push(r);var i=t.getSource();var a;if(i instanceof Object){a=i.name}else{a=i}if(t.getSourceType()==="vdsl"||t.getSourceType()==="vds"&&a.split(".").pop()==="vdsl"){s.set(r,{})}}t.getContentResources().forEach(e)});var a=[];if(o.length>0){var c;var l=new i(o,null,this._authorizationHandler,this._retryCount).attachItemSucceeded(function(e){var t=e.getParameter("source");var r=e.getParameter("response");if(s.has(t)){var n=_(r);if(n.trim().length===0){c=c||[];c.push({source:t,status:u.VIT22.code,statusText:p().getText(u.VIT22.summary)});S.error(p().getText(u.VIT22.summary),u.VIT22.code,"sap.ui.vk.dvl.GraphicsCore");return}else{var i=n.split(/\n|\r\n/);var h=i[0].match(/^file=(.+)$/);if(!h){c=c||[];c.push({source:t,status:u.VIT23.code,statusText:p().getText(u.VIT23.summary)});S.error(p().getText(u.VIT23.summary),u.VIT23.code,"sap.ui.vk.dvl.GraphicsCore");return}else{var v=s.get(t);v.content=i;var f=h[1];var g=f;var y=new d(g);if(y.is("relative")){if(t instanceof File){c=c||[];c.push({source:t,status:u.VIT24.code,statusText:p().getText(u.VIT24.summary)});S.error(p().getText(u.VIT24.summary),u.VIT24.code,"sap.ui.vk.dvl.GraphicsCore");return}else{var m=new d(t);f=y.absoluteTo(m).href()}}v.referencedSource=f;v.content[0]=v.content[0].replace(g,this._dvl.Core.GetFilename(v.referencedSource,"remote"));if(o.indexOf(v.referencedSource)<0&&this._findSourceData({source:v.referencedSource}).length===0){o.push(v.referencedSource);l.queue(v.referencedSource)}}}}else{var C=t instanceof File;var R=C?t.name:t;var L=w(t);this._dvl.Core.CreateFileFromArrayBuffer(r,R,L);a.push(new D(t))}},this).attachAllItemsCompleted(function(e){Array.prototype.push.apply(this._sourceData,a);s.forEach(function(e,t){var r=this._findSourceData({source:e.referencedSource})[0];if(r){var n=new R(t,r,e.content.join("\n"));this._sourceData.push(n);r.addRef()}}.bind(this));if(t){t(c)}},this).attachItemFailed(function(e){c=c||[];c.push({source:e.getParameter("source"),status:e.getParameter("status"),statusText:e.getParameter("statusText")})},this);if(r){l.attachItemProgress(r,this)}l.start()}else if(t){t()}return this};b.prototype._buildPlaceholders=function(e,t,r,n){var o=[];n.forEach(function t(r,n,s){var i=e.createNode(r,s.name,n);s.nodeProxy=e.createNodeProxy(i);if(s.localMatrix){s.nodeProxy.setLocalMatrix(s.localMatrix)}if(s.source){o.push(s)}s.children.forEach(t.bind(this,i,null))}.bind(this,t,r));return o};b.prototype._updatePlaceholders=function(t,r,n){var o=this,s=t.getDefaultNodeHierarchy(),i=[];(function r(n,a,c){function u(e,t){if(!e&&!t){return true}else if(!!e^!!t){return false}else{return e.source===t.getSource()&&e.sourceType===t.getSourceType()&&e.name===t.getName()&&e.password===t.getPassword()}}function d(e,t){t._shadowContentResource=e;e.sourceId=t.getSourceId();e.localMatrix=t.getLocalMatrix();if(e.nodeProxy){e.nodeProxy.setLocalMatrix(e.localMatrix)}}var l=0;var h=e.sap.arrayDiff(n,a,u,true);h.forEach(function(e){for(;l<e.index;++l){r(n[l].children,a[l].getContentResources(),n[l].nodeProxy.getNodeRef());d(n[l],a[l])}if(e.type==="delete"){o._destroyShadowContentResource(t,n[e.index]);n.splice(e.index,1)}else if(e.type==="insert"){var u;if(l<n.length&&n[l].nodeProxy){u=n[l].nodeProxy.getNodeRef()}var h=new I(a[e.index]);i=i.concat(o._buildPlaceholders(s,c,u,[h]));n.splice(e.index,0,h);++l}});for(;l<n.length;++l){r(n[l].children,a[l].getContentResources(),n[l].nodeProxy&&n[l].nodeProxy.getNodeRef());d(n[l],a[l])}})(r.fake?r.children:[r],n,null);return i};b.prototype._loadAndMergeContentResource=function(e,t){if(t.source){var r=this._findSourceData({source:t.source})[0];if(!r){S.warning("Failed to load content resource with sourceId '"+t.sourceId+"' due to failed downloading from URL '"+C(t.source)+"'.")}else{var n=t.nodeProxy.getNodeRef();var o=this._findDvlSceneData({sourceDatum:r,root:false})[0];if(!o){try{o=new L(v(r instanceof R?this._dvl.Core.LoadSceneFromVDSL(r.content,t.password):this._dvl.Core.LoadSceneByUrl(C(t.source),t.password,w(t.source))),r,false)}catch(e){S.error(p().getText(u.VIT34.summary)+": "+C(t.source),u.VIT34.code,"sap.ui.vk.dvl.GraphicsCore");return}this._dvlSceneData.push(o);r.addRef()}t.dvlSceneDatum=o;o.addRef();this._collectAndCheckSourceProperties(t);this._dvl.Renderer.ResetView(sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA,this._rendererId);this._dvl.Scene.Merge(e._dvlSceneRef,o.dvlSceneId,n)}}};b.prototype.buildSceneTree=function(e){if(e.length===0){return null}var t;var r;var n=e.map(function(e){return new I(e)});if(n.length===1&&n[0].name==null){r=n[0];if(r.source){var i=this._findSourceData({source:r.source})[0];try{t=new L(v(i instanceof R?this._dvl.Core.LoadSceneFromVDSL(i.content,r.password):this._dvl.Core.LoadSceneByUrl(C(r.source),r.password,w(r.source))),i,true)}catch(e){S.error(p().getText(u.VIT34.summary)+": "+C(r.source),u.VIT34.code,"sap.ui.vk.dvl.GraphicsCore");return null}i.addRef()}else{t=new L(this._dvl.Core.CreateEmptyScene(),null,true)}}else{var a=new s({sourceType:"vds",sourceId:y()});r=new I(a,true);a.destroy();a=null;Array.prototype.push.apply(r.children,n);n=[r];t=new L(this._dvl.Core.CreateEmptyScene(),null,true)}this._dvlSceneData.push(t);r.dvlSceneDatum=t;t.addRef();this._collectAndCheckSourceProperties(r);var c=new o(this,t.dvlSceneId);this._vkSceneData.push(new P(c,r));this._buildPlaceholders(c.getDefaultNodeHierarchy(),null,null,r.children).forEach(this._loadAndMergeContentResource.bind(this,c.getDefaultNodeHierarchy()));return c};b.prototype.updateSceneTree=function(e,t,r){if(t.length===0){return null}var n;var o=this._getContentResourcesWithEncryptedVds3(t);if(o.length>0){S.error(p().getText(u.VIT25.summary),u.VIT25.code,"sap.ui.vk.dvl.GraphicsCore");n=n||{};n.contentResourcesWithEncryptedVds3=o}var s=this._getContentResourcesWithMissingPasswords(t);if(s.length>0){S.error(p().getText(u.VIT21.summary),u.VIT21.code,"sap.ui.vk.dvl.GraphicsCore");n=n||{};n.contentResourcesWithMissingPasswords=s}if(n&&r){r(n)}if(!e){return this.buildSceneTree(t)}var i=this._findVkSceneData({vkScene:e})[0].shadowContentResource;var a=!!i.source;var c=t.length===1&&!!t[0].getSource();if(!(a&&c&&i.source===t[0].getSource()||!a&&!c&&i.fake===t.length>1)||!i.fake&&t.length===1&&i.name!==t[0].getName()){return this.buildSceneTree(t)}this._updatePlaceholders(e,i,t).forEach(this._loadAndMergeContentResource.bind(this,e.getDefaultNodeHierarchy()));e.getDefaultNodeHierarchy().fireChanged();return e};b.prototype._loadDvlSceneAsync=function(e,t){return new Promise(function(r,n){var o;var s=function(t){o();this.fireSceneLoadingFinished({source:e.source,sceneId:t.sceneId});r(t.sceneId)};var i=function(t){o();var r=t.errorMessage;if(r==null){r=sap.ve.dvl.DVLRESULT.getDescription?sap.ve.dvl.DVLRESULT.getDescription(t.errorCode):""}var s={source:e.source,errorCode:t.errorCode,errorMessage:r};this.fireSceneLoadingFinished(s);n(s)};var a=function(t,r){this.fireSceneLoadingProgress({source:C(e.source),percentage:r});return true}.bind(this);o=function(){this._dvl.Client.NotifyFileLoadProgress=null;this._dvl.Client.detachSceneFailed(i,this);this._dvl.Client.detachSceneLoaded(s,this)}.bind(this);this._dvl.Client.attachSceneLoaded(s,this);this._dvl.Client.attachSceneFailed(i,this);this._dvl.Client.NotifyFileLoadProgress=a;this.fireSceneLoadingStarted({source:C(e.source)});try{h(e instanceof R?this._dvl.Core.LoadSceneFromVDSLAsync(e.content,t):this._dvl.Core.LoadSceneByUrlAsync(C(e.source),t,w(e.source)))}catch(e){o();i.call(this,{errorCode:e instanceof c?e.code:sap.ve.dvl.DVLRESULT.FAIL,errorMessage:e instanceof c?null:e})}}.bind(this))};var T=function(e,t){return new Promise(function(r){(function n(o){if(o>=e.length){r()}else{t(e[o]).catch(function(){}).then(function(){n(o+1)})}})(0)})};b.prototype._loadAndMergeContentResourcesAsync=function(e,t){var r,n=this;return T(t,function(t){if(t.source){var o=n._findSourceData({source:t.source})[0];if(!o){var s="Failed to load content resource with sourceId '"+t.sourceId+"' due to failed downloading from URL '"+C(t.source)+"'.";S.warning(s);r=r||[];r.push({errorMessage:s,source:t.source});return Promise.reject()}return function(){var e=n._findDvlSceneData({sourceDatum:o,root:false})[0];if(e){return Promise.resolve(e)}else{return n._loadDvlSceneAsync(o,t.password).then(function(t){e=new L(t,o,false);n._dvlSceneData.push(e);o.addRef();return Promise.resolve(e)},function(e){r=r||[];r.push(e);return Promise.reject()})}}().then(function(r){t.dvlSceneDatum=r;r.addRef();n._collectAndCheckSourceProperties(t);var o=t.nodeProxy.getNodeRef();n._dvl.Renderer.ResetView(sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA,n._rendererId);n._dvl.Scene.Merge(e._dvlSceneRef,r.dvlSceneId,o);return Promise.resolve()})}return Promise.resolve()}).then(function(){return Promise.resolve(r)})};b.prototype.buildSceneTreeAsync=function(e){if(e.length===0){return Promise.resolve(null)}var t=e.map(function(e){return new I(e)});return function(){var e;if(t.length===1&&t[0].name==null){e=t[0];if(e.source){var r=this._findSourceData({source:e.source})[0];if(r){return this._loadDvlSceneAsync(r,e.password).then(function(t){var n=new L(t,r,true);r.addRef();return Promise.resolve({shadowContentResource:e,dvlSceneDatum:n})})}else{return Promise.reject({errorMessage:"Failed to download the root content resource.",source:e.source})}}return Promise.resolve({shadowContentResource:e,dvlSceneDatum:new L(this._dvl.Core.CreateEmptyScene(),null,true)})}else{var n=new s({sourceType:"vds",sourceId:y()});e=new I(n,true);n.destroy();n=null;Array.prototype.push.apply(e.children,t);t=[e];return Promise.resolve({shadowContentResource:e,dvlSceneDatum:new L(this._dvl.Core.CreateEmptyScene(),null,true)})}}.call(this).then(function(e){this._dvlSceneData.push(e.dvlSceneDatum);e.shadowContentResource.dvlSceneDatum=e.dvlSceneDatum;e.dvlSceneDatum.addRef();this._collectAndCheckSourceProperties(e.shadowContentResource);var t=new o(this,e.dvlSceneDatum.dvlSceneId);this._vkSceneData.push(new P(t,e.shadowContentResource));var r=t.getDefaultNodeHierarchy();return this._loadAndMergeContentResourcesAsync(r,this._buildPlaceholders(t.getDefaultNodeHierarchy(),null,null,e.shadowContentResource.children)).then(function(e){return Promise.resolve({scene:t,failureReason:e})})}.bind(this))};b.prototype.updateSceneTreeAsync=function(e,t){if(t.length===0){return Promise.resolve(null)}var r=this._getContentResourcesWithEncryptedVds3(t);if(r.length>0){S.error(p().getText(u.VIT25.summary),u.VIT25.code,"sap.ui.vk.dvl.GraphicsCore")}var n=this._getContentResourcesWithMissingPasswords(t);if(n.length>0){S.error(p().getText(u.VIT21.summary),u.VIT21.code,"sap.ui.vk.dvl.GraphicsCore")}if(!e){return this.buildSceneTreeAsync(t)}var o=this._findVkSceneData({vkScene:e})[0].shadowContentResource;var s=!!o.source;var i=t.length===1&&!!t[0].getSource();if(!(s&&i&&o.source===t[0].getSource()||!s&&!i&&o.fake===t.length>1)||!o.fake&&t.length===1&&o.name!==t[0].getName()){return this.buildSceneTreeAsync(t)}return new Promise(function(r,n){var s=e.getDefaultNodeHierarchy();this._loadAndMergeContentResourcesAsync(s,this._updatePlaceholders(e,o,t)).then(function(t){r({scene:e,failureReason:t});s.fireChanged()})}.bind(this))};b.prototype.destroyScene=function(e){var t;for(t=0;t<this._vkSceneData.length;++t){if(this._vkSceneData[t].vkScene===e){break}}if(t===this._vkSceneData.length){S.warning("Scene with id '"+e.getId()+"' is not created by this GraphicsCore.");return this}var r=this._vkSceneData.splice(t,1)[0];this._destroyShadowContentResource(e,r.shadowContentResource);e.destroy();return this};var V=function(e,t,r){g(Array.isArray(e),"The first parameter must be an array.");g(typeof t==="function","The second parameter must be a function.");for(var n=0,o=e.length;n<o;++n){if(t.call(r,e[n],n,e)){return n}}return-1};var E=function(e,t){return V(e,function(e){return e.control===t})};var x=function(e,t){return V(e,function(e){return e.rendererId===t})};b.prototype._registerViewport=function(e){g(e,"The viewportControl parameter must not be null.");if(E(this._viewports,e)>=0){return false}var t={control:e,canvas:null,rendererId:null};if(this._viewports.length===0){t.canvas=this._canvas;t.rendererId=this._rendererId;this._startRenderLoop()}else{if(this._viewports.length===1){var r=this._viewports[0];r.control._setCanvas(r.canvas=document.createElement("canvas"));this._dvl.Client.attachFrameFinished(this._handleFrameFinished,this)}t.canvas=document.createElement("canvas");t.rendererId=this._dvl.Core.CreateRenderer()}e._setCanvas(t.canvas);e._setRenderer(t.rendererId);e.attachResize(this._handleViewportResize,this);this._viewports.push(t);return true};b.prototype._deregisterViewport=function(e){g(e,"The viewportControl parameter must not be null.");var t=E(this._viewports,e);if(t<0){return false}g(t>0||this._viewports.length===1,"The first registered viewport control must be deregistered last.");var r=this._viewports.splice(t,1)[0];if(this._viewports.length===0){this._stopRenderLoop()}else{if(this._viewports.length===1){this._dvl.Client.detachFrameFinished(this._handleFrameFinished,this);var n=this._viewports[1-t];n.control._setCanvas(n.canvas=this._canvas)}this._dvl.Core.DeleteRenderer(r.rendererId)}e.detachResize(this._handleViewportResize,this);e._setRenderer(null);e._setCanvas(null);return true};b.prototype._getViewportCount=function(){return this._viewports.length};b.prototype._handleViewportResize=function(e){if(this._viewports.length>1){this._canvas.width=Math.max.apply(null,this._viewports.map(function(e){return e.canvas.width}));this._canvas.height=Math.max.apply(null,this._viewports.map(function(e){return e.canvas.height}))}};b.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoop)}return this};b.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=null}return this};b.prototype._renderLoop=function(){var e;return function(){var t=this._viewports.length>1;this._viewports.forEach(function(r){var n=r.canvas,o=r.rendererId;this._dvl.Renderer._processCommandQueue(o);if(n.width>0&&n.height>0&&this._dvl.Renderer.ShouldRenderFrame(o)){if(t&&e!==o){this._dvl.Renderer.SetDimensions(n.width,n.height,o)}r.control.renderFrame();e=o}},this);this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoop)}}();b.prototype._handleFrameFinished=function(e){g(this._viewports.length>1,"Method _handleFrameFinished should be only called when there are multiple viewports.");if(this._viewports.length>1){var t=x(this._viewports,e.rendererId);if(t>=0){var r=this._viewports[t].canvas,n=r.getContext("2d"),o=r.width,s=r.height;n.drawImage(this._canvas,0,this._canvas.height-s,o,s,0,0,o,s)}}};b.prototype.createViewStateManager=function(e,t){var r=new a;r._setNodeHierarchy(e).setShouldTrackVisibilityChanges(t);this._viewStateManagers.push(r);return r};b.prototype.destroyViewStateManager=function(e){var t=this._viewStateManagers.indexOf(e);if(t>=0){this._viewStateManagers.splice(t,1)[0].destroy()}return this};b.prototype.showDebugInfo=function(e){this._viewports.forEach(function(t){t.control.setShowDebugInfo(e)});return this};b.prototype.getApi=function(e){switch(e){case l.LegacyDvl:return this._dvl;default:return null}};b.prototype.collectGarbage=function(){this._cleanupDvlSceneData();this._cleanupSourceData();return this};b.prototype._onlocalizationChanged=function(e){if(e.getParameter("changes").language){h(this._dvl.Core.SetLocale(m.getConfiguration().getLanguageTag()))}};b.prototype.getDecryptionHandler=function(){return this._dvl.Client.getDecryptionHandler()};b.prototype.setDecryptionHandler=function(e){this._dvl.Client.setDecryptionHandler(e);return this};b.prototype.setAuthorizationHandler=function(e){this._authorizationHandler=e;return this};b.prototype.setRetryCount=function(e){this._retryCount=Math.max(e,0);return this};b.prototype.attachSceneLoadingFinished=function(e,t,r){return this.attachEvent("sceneLoadingFinished",e,t,r)};b.prototype.detachSceneLoadingFinished=function(e,t){return this.detachEvent("sceneLoadingFinished",e,t)};b.prototype.fireSceneLoadingFinished=function(e,t,r){return this.fireEvent("sceneLoadingFinished",e,t,r)};b.prototype.attachSceneLoadingProgress=function(e,t,r){return this.attachEvent("sceneLoadingProgress",e,t,r)};b.prototype.detachSceneLoadingProgress=function(e,t){return this.detachEvent("sceneLoadingProgress",e,t)};b.prototype.fireSceneLoadingProgress=function(e,t,r){return this.fireEvent("sceneLoadingProgress",e,t,r)};b.prototype.attachSceneLoadingStarted=function(e,t,r){return this.attachEvent("sceneLoadingStarted",e,t,r)};b.prototype.detachSceneLoadingStarted=function(e,t){return this.detachEvent("sceneLoadingStarted",e,t)};b.prototype.fireSceneLoadingStarted=function(e,t,r){return this.fireEvent("sceneLoadingStarted",e,t,r)};return b});