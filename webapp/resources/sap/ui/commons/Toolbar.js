/*!
 # * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/ui/core/Popup","sap/ui/core/delegate/ItemNavigation","./ToolbarRenderer","sap/base/assert","sap/ui/dom/containsOrEquals","sap/ui/core/ResizeHandler","sap/ui/core/Element","sap/ui/events/KeyCodes","sap/ui/core/Configuration"],function(e,t,i,o,s,n,r,a,h,p,l,u){"use strict";var f=t.ToolbarDesign;var m=i.extend("sap.ui.commons.Toolbar",{metadata:{interfaces:["sap.ui.core.Toolbar"],library:"sap.ui.commons",deprecated:true,properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"auto"},design:{type:"sap.ui.commons.ToolbarDesign",group:"Appearance",defaultValue:f.Flat},standalone:{type:"boolean",group:"Appearance",defaultValue:true}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.commons.ToolbarItem",multiple:true,singularName:"item"},rightItems:{type:"sap.ui.commons.ToolbarItem",multiple:true,singularName:"rightItem"}}}});m.prototype.init=function(){this.bOpen=false;this.oDomRef=null;this.oInnerRef=null;this.oOverflowDomRef=null;this._oOverflowPopup=null;this.sOriginalStylePropertyWidth=null;this.bHasRightItems=false;this._bRendering=false;this.bRtl=u.getRTL();this._detectVisibleItemCountChangeTimer=null;var t=this;this.oItemDelegate={onAfterRendering:e.proxy(t._itemRendered,t)};this.data("sap-ui-fastnavgroup","true",true)};m.prototype.onBeforeRendering=function(){n.emptyOverflowPopup(this,false);this.cleanup();this.$("mn").off("keydown",this._handleKeyDown);this.bFirstTime=true;this._bRendering=true};m.prototype.onAfterRendering=function(){this._bRendering=false;this.oDomRef=this.getDomRef();this.oInnerRef=this.oDomRef.firstChild.firstChild;e(this.oInnerRef).css("visibility","visible");this.oOverflowDomRef=this.getDomRef("mn");if(!this.oItemNavigation){this.oItemNavigation=new s;this.addDelegate(this.oItemNavigation)}this.$("mn").on("keydown",e.proxy(this._handleKeyDown,this));this.sResizeListenerId=h.register(this.oDomRef,e.proxy(this.ontoolbarresize,this));var t=this.getRightItems().length;this.bHasRightItems=t>0;if(this.bHasRightItems){this.sRightSideResizeListenerId=h.register(this.oDomRef.lastChild,e.proxy(this.onrightsideresize,this));this.updateAfterResize(true);this._observeVisibleItemCountChange(40)}else{this.updateAfterResize(true);this._observeVisibleItemCountChange(350)}};m.prototype._handleKeyDown=function(e){if(e.keyCode==l.SPACE&&e.target.id===this.getId()+"-mn"){this.handleOverflowButtonTriggered();e.preventDefault();e.stopPropagation()}};m.prototype.exit=function(){this.cleanup();if(this.oItemNavigation){this.removeDelegate(this.oItemNavigation);this.oItemNavigation.destroy();delete this.oItemNavigation}this.oItemDelegate=undefined;e(window).off("resize",this.onwindowresize);v.call(this)};m.prototype.updateAfterResize=function(e){if(this._bRendering){return}var t=this.getVisibleItemInfo();this._oLastVisibleItem=t.oLastVisibleItem;this._oFirstInvisibleItem=t.oFirstInvisibleItem;this._iLastVisibleItemTop=t.iLastVisibleItemTop;this.updateItemNavigation(t.iAllItemsBeforeBreak,e);this.updateOverflowIcon(t.bOverflow);if(this.sUpdateItemNavigationTimer){clearTimeout(this.sUpdateItemNavigationTimer);this.sUpdateItemNavigationTimer=null}};m.prototype._detectVisibleItemCountChange=function(){if(!this.getDomRef()){if(this._detectVisibleItemCountChangeTimer){clearTimeout(this._detectVisibleItemCountChangeTimer);this._detectVisibleItemCountChangeTimer=null}return}if(this._oLastVisibleItem&&this._oFirstInvisibleItem){var e=this._oLastVisibleItem.offsetLeft;var t=this._oFirstInvisibleItem.offsetLeft;var i=this._oLastVisibleItem.offsetTop;var o=this.bRtl?t<e:t>e;if(i!=this._iLastVisibleItemTop||!this.bOpen&&o){if(this.bOpen){this.closePopup(true)}this.updateAfterResize(false)}}else if(this._oLastVisibleItem&&!this._oFirstInvisibleItem){if(this._oLastVisibleItem.offsetTop!=this._iLastVisibleItemTop){this.updateAfterResize(false)}}this._observeVisibleItemCountChange(350);if(this.bFirstTime&&this.bHasRightItems){this.onrightsideresize();this.bFirstTime=false}};m.prototype._observeVisibleItemCountChange=function(e){this._detectVisibleItemCountChangeTimer=setTimeout(function(){this._detectVisibleItemCountChange()}.bind(this),e)};m.prototype.updateItemNavigation=function(t,i){this.oItemNavigation.setRootDomRef(this.oDomRef);var o=d.call(this);var s=[];for(var n=0;n<t;n++){var r=o[n].getFocusDomRef();if(r){s.push(r)}}s.push(this.oOverflowDomRef);this.iLeftItemDomRefCount=s.length;var a=this.getRightItems();for(var n=0;n<a.length;n++){var r=a[n].getFocusDomRef();if(r){s.push(r)}}this.oItemNavigation.setItemDomRefs(s);this.iItemDomRefCount=s.length;if(i){for(var n=t;n<o.length;n++){var r=o[n].getFocusDomRef();var h=e(r);if(r&&h.attr("tabindex")=="0"){h.attr("tabIndex",-1)}}}};m.prototype.getVisibleItemInfo=function(e){var t=0;if(this.oInnerRef){var i=e?this.oInnerRef.childNodes:this.oInnerRef.parentNode.querySelectorAll("#"+this.oInnerRef.id+" > :not(.sapUiHiddenPlaceholder)");this.bRtl=u.getRTL();var o,s,n=0,a,h,p=0,l=null,f=null,m,g,d=false;for(var v=1,b=i.length;v<b;v++){s=i[v];a=s.offsetLeft;if(v==1){h=i[0].offsetWidth;p=i[0].offsetLeft}if(this.bRtl){n=s.offsetWidth;o=!c.call(this,s)&&a+n>=p+h}else{o=!c.call(this,s)&&a<=p&&s.offsetTop>i[0].offsetTop}if(o){t=v;l=i[v-1];f=s;m=l.offsetTop;d=true;break}else if(c.call(this,s)){t=v;r(t===b-1,"visible items ("+t+") must be one less than the items count ("+b+")");l=i[v-1];f=null;m=l.offsetTop;d=false;break}else{p=a;h=n}}g=I.call(this,l)}return{count:t,oLastVisibleItem:l,oFirstInvisibleItem:f,iLastVisibleItemTop:m,iAllItemsBeforeBreak:g,bOverflow:d}};m.prototype.updateOverflowIcon=function(e){this.oOverflowDomRef.style.display=e||this.bOpen?"block":"none"};m.prototype.onclick=function(e){if(e.target.id===this.getId()+"-mn"){this.handleOverflowButtonTriggered();e.preventDefault();e.stopPropagation()}};m.prototype.onsapdown=function(e){if(e.target.id===this.getId()+"-mn"){if(!this.bOpen){this.handleOverflowButtonTriggered();e.preventDefault();e.stopImmediatePropagation()}}};m.prototype.onsapup=function(e){if(e.target.id===this.getId()+"-mn"){if(this.bOpen){this.handleOverflowButtonTriggered();e.preventDefault();e.stopPropagation()}}};m.prototype.handleOverflowButtonTriggered=function(){if(!this.bPopupInitialized){this._oOverflowPopup=new g(this);this.popup=new o(this._oOverflowPopup,false,true,true);this.popup.setAutoCloseAreas([this.getId()+"-mn"]);this.bPopupInitialized=true}if(this.bOpen){this.closePopup(false)}else{this.openPopup()}};m.prototype.openPopup=function(){this.getRenderer().setActive(this);var t=e(this.getDomRef());this.sOriginalStylePropertyWidth=t.prop("style").width;t.width(t.width());n.fillOverflowPopup(this);this.popup.attachEvent("opened",this.handlePopupOpened,this);this.popup.attachEvent("closed",this.handlePopupClosed,this);e(window).on("resize",e.proxy(this.onwindowresize,this));var i=0;this.popup.open(i,o.Dock.EndTop,o.Dock.EndBottom,this.$("mn"),"","fit",true)};m.prototype.handlePopupOpened=function(){var e=d.call(this);var t=this.getVisibleItemInfo().iAllItemsBeforeBreak;this.bOpen=true;var i=[];for(var o=t;o<e.length;o++){var s=e[o].getFocusDomRef();if(s){i.push(s)}}this.popup.getContent().initItemNavigation(i)};m.prototype.closePopup=function(t){this._bResetFocus=t;this.popup.close();e(window).off("resize",this.onwindowresize)};m.prototype.handlePopupClosed=function(){this.getRenderer().unsetActive(this);this.bOpen=false;n.emptyOverflowPopup(this);var e=this.getVisibleItemInfo().iAllItemsBeforeBreak;this.updateItemNavigation(e,true);if(this._bResetFocus){this.oItemNavigation.focusItem(this.iLeftItemDomRefCount-1)}this._bResetFocus=false};m.prototype.prepareFocusInfoRedirect=function(e){if(e&&!e._orig_getFocusInfo){var t=this.getId();e._orig_getFocusInfo=e.getFocusInfo;e.getFocusInfo=function(){return{id:t,childInfo:this._orig_getFocusInfo()}};var i=this;e._orig_applyFocusInfo=e.applyFocusInfo;e.applyFocusInfo=function(e){return i.applyFocusInfo(e.childInfo)}}return e};m.prototype.cleanupFocusInfoRedirect=function(e){if(e){e.getFocusInfo=e._orig_getFocusInfo;delete e._orig_getFocusInfo;delete e._orig_applyFocusInfo}return e};m.prototype.insertItem=function(e,t){this.insertAggregation("items",this.prepareFocusInfoRedirect(e),t);e.addDelegate(this.oItemDelegate);return this};m.prototype.addItem=function(e){this.addAggregation("items",this.prepareFocusInfoRedirect(e));e.addDelegate(this.oItemDelegate);return this};m.prototype.removeItem=function(e){var t=this.removeAggregation("items",e);t.removeDelegate(this.oItemDelegate);return this.cleanupFocusInfoRedirect(t)};m.prototype.removeAllItems=function(){var e=this.removeAllAggregation("items");for(var t=0,i=e.length;t<i;t++){e[t]=this.cleanupFocusInfoRedirect(e[t]);e[t].removeDelegate(this.oItemDelegate)}return e};m.prototype.insertRightItem=function(e,t){this.insertAggregation("rightItems",this.prepareFocusInfoRedirect(e),t);e.addDelegate(this.oItemDelegate);return this};m.prototype.addRightItem=function(e){this.addAggregation("rightItems",this.prepareFocusInfoRedirect(e));e.addDelegate(this.oItemDelegate);return this};m.prototype.removeRightItem=function(e){var t=this.removeAggregation("rightItems",e);t.removeDelegate(this.oItemDelegate);return this.cleanupFocusInfoRedirect(t)};m.prototype.removeAllRightItems=function(){var e=this.removeAllAggregation("rightItems");for(var t=0,i=e.length;t<i;t++){e[t]=this.cleanupFocusInfoRedirect(e[t]);e[t].removeDelegate(this.oItemDelegate)}return e};m.prototype.getFocusInfo=function(){var e=this.getId();if(this.bOpen){return{id:e,childId:e}}else{return{id:e}}};m.prototype.applyFocusInfo=function(e){if(e){var t=e.childId;if(this.bOpen&&t){if(t===this.getId()){return}var i=sap.ui.getCore().byId(t);var o;if(i&&this.popup&&(o=this.popup.getContent())&&a(o.getDomRef(),i.getDomRef())){o.applyFocusInfo(e.childInfo);return}}}this.focus()};var g=p.extend("sap.ui.commons.ToolbarOverflowPopup",{constructor:function(e){this.oToolbar=e;var t=e.getId()+"-pu";p.call(this,t)},exit:function(){this.$().remove()},initItemNavigation:function(e){if(!this.oItemNavigation){this.oItemNavigation=new s;this.addDelegate(this.oItemNavigation)}this.oItemNavigation.setRootDomRef(n.getPopupArea(this.oToolbar));this.oItemNavigation.setItemDomRefs(e);this.oItemNavigation.focusItem(0)},getDomRef:function(){var e=n.getPopupArea(this.oToolbar);if(e){return e.parentNode}else{return null}},isActive:function(){return n.getPopupArea(this.oToolbar)!=null},onsapescape:function(e){this.oToolbar.closePopup(true)},onsaptabnext:function(e){this.oToolbar.closePopup(true);e.preventDefault();e.stopPropagation()},onsaptabprevious:function(e){this.oToolbar.closePopup(true);e.preventDefault();e.stopPropagation()}});m.prototype._itemRendered=function(){if(this.oItemNavigation){this.updateAfterResize(true)}else{if(!this.sUpdateItemNavigationTimer){this.sUpdateItemNavigationTimer=setTimeout(function(){this.updateAfterResize(true)}.bind(this),0)}}};m.prototype.onwindowresize=function(e){if(this.bOpen){this.closePopup(true)}};m.prototype.ontoolbarresize=function(e){if(this.bOpen){this.closePopup(true)}};m.prototype.onrightsideresize=function(){if(!this.getDomRef()){this.cleanup();return}if(this.getRightItems().length>0){var t=this.oDomRef.lastChild;var i=t.offsetWidth;if(this.bRtl){e(this.oInnerRef).css("margin-left",i+10+"px")}else{e(this.oInnerRef).css("margin-right",i+10+"px")}var o=this.oDomRef.firstChild.firstChild.firstChild;var s=this.getDomRef("mn").offsetWidth;var n=o.offsetWidth+i+s+20;e(this.oDomRef).css("min-width",n+"px");e(this.oInnerRef).css("visibility","visible")}};m.prototype.cleanup=function(){if(this._detectVisibleItemCountChangeTimer){clearTimeout(this._detectVisibleItemCountChangeTimer);this._detectVisibleItemCountChangeTimer=null}if(this.sUpdateItemNavigationTimer){clearTimeout(this.sUpdateItemNavigationTimer);this.sUpdateItemNavigationTimer=null}if(this.sResizeListenerId){h.deregister(this.sResizeListenerId);this.sResizeListenerId=null}if(this.sRightSideResizeListenerId){h.deregister(this.sRightSideResizeListenerId);this.sRightSideResizeListenerId=null}};function d(){var e=[];this.getItems().forEach(function(t){if(t instanceof sap.ui.commons.ToolbarSeparator||t.getVisible()){e.push(t)}});return e}function c(e){var t=this.getId()+"-mn";return e.id===t}function I(e){var t=0;var i=d.call(this);i.forEach(function(i,o){if(i.getDomRef()===e){t=o+1;return false}});return t}return m;function v(){if(this.bPopupInitialized){this._oOverflowPopup.destroy();this._oOverflowPopup=null;this.popup.detachOpened(this.handlePopupOpened,this);this.popup.detachClosed(this.handlePopupClosed,this);this.popup.destroy();this.popup=null;this.bPopupInitialized=false}}});