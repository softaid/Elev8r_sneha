/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/Log","sap/base/util/isEmptyObject","./library","sap/ui/core/Control","./TreeRenderer","./Button","sap/ui/core/Configuration"],function(e,t,o,i,s,n,l,d){"use strict";var r=i.TreeSelectionMode;var a=s.extend("sap.ui.commons.Tree",{metadata:{library:"sap.ui.commons",deprecated:true,properties:{title:{type:"string",group:"Misc",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"auto"},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"auto"},showHeader:{type:"boolean",group:"Misc",defaultValue:true},showHeaderIcons:{type:"boolean",group:"Misc",defaultValue:true},showHorizontalScrollbar:{type:"boolean",group:"Misc",defaultValue:false},minWidth:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null},selectionMode:{type:"sap.ui.commons.TreeSelectionMode",group:"Behavior",defaultValue:r.Legacy}},defaultAggregation:"nodes",aggregations:{nodes:{type:"sap.ui.commons.TreeNode",multiple:true,singularName:"node",bindable:"bindable"}},events:{select:{allowPreventDefault:true,parameters:{node:{type:"sap.ui.commons.TreeNode"},nodeContext:{type:"object"}}},selectionChange:{parameters:{nodes:{type:"sap.ui.commons.TreeNode[]"},nodeContexts:{type:"object[]"}}}}}});a.prototype.resizeListenerId;a.prototype.init=function(){this.bAllCollapsed=false;this.allowTextSelection(false);this.iOldScrollTop=null;this.mSelectedNodes={};this.mSelectedContexts={};this.aLeadSelection=null;var e=sap.ui.getCore().getLibraryResourceBundle("sap.ui.commons");this.oCollapseAllButton=new l(this.getId()+"-CollapseAll",{icon:this.getIconPrefix()+"CollapseAll.png",tooltip:e.getText("TREE_COLLAPSE_ALL"),lite:true});this.oExpandAllButton=new l(this.getId()+"-ExpandAll",{icon:this.getIconPrefix()+"ExpandAll.png",tooltip:e.getText("TREE_EXPAND_ALL"),lite:true});this.oCollapseAllButton.attachPress(this.onCollapseAll,this);this.oExpandAllButton.attachPress(this.onExpandAll,this);this.oCollapseAllButton.addStyleClass("sapUiTreeCol");this.oExpandAllButton.addStyleClass("sapUiTreeExp")};a.prototype.exit=function(){if(this.oCollapseAllButton){this.oCollapseAllButton.destroy();this.oCollapseAllButton=null}if(this.oExpandAllButton){this.oExpandAllButton.destroy();this.oExpandAllButton=null}};a.SelectionType={Select:"Select",Toggle:"Toggle",Range:"Range"};a.prototype.onThemeChanged=function(){if(this.oCollapseAllButton&&this.oExpandAllButton){this.oCollapseAllButton.setIcon(this.getIconPrefix()+"CollapseAll.png");this.oExpandAllButton.setIcon(this.getIconPrefix()+"ExpandAll.png")}};a.prototype.onExpandAll=function(){this.expandAll()};a.prototype.onCollapseAll=function(){this.collapseAll()};a.prototype.expandAll=function(){var e=this._getNodes();for(var t=0;t<e.length;t++){e[t].expand(true,true);this._adjustSelectionOnExpanding(e[t])}};a.prototype.collapseAll=function(){var e=this._getNodes();for(var t=0;t<e.length;t++){e[t].collapse(true,true);this._adjustSelectionOnCollapsing(e[t])}this._adjustFocus()};a.prototype.onsapdown=function(e){this.moveFocus(false);e.preventDefault()};a.prototype.onsapup=function(e){this.moveFocus(true);e.preventDefault()};a.prototype.onsaphome=function(e){this.placeFocus(this.getFirstSibling(e.target));e.preventDefault()};a.prototype.onsaphomemodifiers=function(e){this.placeFocus(this.getFirst());e.preventDefault()};a.prototype.onsapend=function(e){this.placeFocus(this.getLastSibling(e.target));e.preventDefault()};a.prototype.onsapendmodifiers=function(e){this.placeFocus(this.getLast());e.preventDefault()};a.prototype.onsapcollapseall=function(e){if(this.bAllCollapsed){this.expandAll()}else{this.collapseAll()}this.bAllCollapsed=!this.bAllCollapsed};a.prototype.getIconPrefix=function(){var e="themes/"+d.getTheme()+"/";if(!d.getRTL()){e+="img/tree/"}else{e+="img-RTL/tree/"}return sap.ui.resource("sap.ui.commons",e)};a.prototype.getFirstSibling=function(t){var o=e(t).siblings(".sapUiTreeNode:visible").first();if(o.length){return o[0]}return null};a.prototype.getLastSibling=function(t){var o=e(t).siblings(".sapUiTreeNode:visible").last();if(o.length){return o[0]}return null};a.prototype.getFirst=function(){var e=this.$().find(".sapUiTreeNode:visible").first();if(e.length){return e[0]}return null};a.prototype.getLast=function(){var e=this.$().find(".sapUiTreeNode:visible").last();if(e.length){return e[0]}return null};a.prototype.moveFocus=function(t){var o=e(".sapUiTreeNode:focus");if(o.length){var i=sap.ui.getCore().byId(o[0].id);var s=this.$().find(".sapUiTreeNode:visible");var n=s.index(o[0]);var l=n;if(t){l--}else{l++}if(l>=0&&l<s.length){var d=s.eq(l);var r=sap.ui.getCore().byId(d[0].id);i.blur();r.focus()}}};a.prototype._adjustFocus=function(){var t=this.$().find('.sapUiTreeNode[tabIndex="0"]');if(!t.is(":visible")){var o=this.$().find(".sapUiTreeNode");var i=o.index(t[0]);var s=o.filter(":lt("+i+")");var n=s.filter(":visible");var l=n[n.length-1];if(l){l.setAttribute("tabindex","0");if(e(".sapUiTreeNode:focus").is(":not(:visible)")){l.focus()}}}};a.prototype.placeFocus=function(e){if(!e){return}var t=this.$().find(".sapUiTreeNode[tabIndex='0']");if(t.length){t[0].setAttribute("tabindex","-1")}e.setAttribute("tabindex","0");var o=sap.ui.getCore().byId(e.id);o.focus()};a.prototype._adjustSelectionOnExpanding=function(e){if(!e){return}var t=[];if(e.getSelectedForNodes().length){t.push(e)}c(e,t,null);var o=e.$();if(o&&o.hasClass("sapUiTreeNodeSelectedParent")){o.removeClass("sapUiTreeNodeSelectedParent")}var i=e.$("children").find(".sapUiTreeNodeExpanded.sapUiTreeNodeSelectedParent");i.removeClass("sapUiTreeNodeSelectedParent")};function c(e,t,o){var i=e.getExpanded(),s=false,n=i&&!!e.getSelectedForNodes().length,l=o||i?o:e,d;for(d=0;d<t.length;d++){if(t[d].getSelectedForNodes().indexOf(e.getId())!==-1){s=true;t[d].removeAssociation("selectedForNodes",e,true)}}if(l&&s&&l!==e){if(l.getSelectedForNodes().indexOf(e.getId())===-1){l.addAssociation("selectedForNodes",e,true)}l.$().addClass("sapUiTreeNodeSelectedParent")}if(n){t.push(e)}var r=e._getNodes();for(d=0;d<r.length;d++){c(r[d],t,l)}if(n){t.pop(e)}}function p(e,t){var o=e._getNodes(),i;for(var s=0;s<o.length;s++){i=o[s];if(i.getIsSelected()){t.addAssociation("selectedForNodes",i,true)}p(i,t)}}a.prototype._adjustSelectionOnCollapsing=function(e){if(!e){return}p(e,e);if(e.getSelectedForNodes().length){var t=e.$();if(t&&!t.hasClass("sapUiTreeNodeSelectedParent")){t.addClass("sapUiTreeNodeSelectedParent")}}};a.prototype.isTreeBinding=function(e){return e=="nodes"};a.prototype.updateNodes=function(e){var t,o,i,s,n;if(e==="filter"){t=this.getAggregation("nodes");s=t.length;for(n=0;n<s;n++){t[n].destroy()}this.mSelectedNodes={}}this.updateAggregation("nodes");for(i in this.mSelectedContexts){o=this.getNodeByContext(this.mSelectedContexts[i]);if(o){o.setIsSelected(true)}else{this.mSelectedContexts=this._removeItemFromObject(this.mSelectedContexts,i)}}};a.prototype._removeItemFromObject=function(e,t){var o,i={};for(o in e){if(o!==t){i[o]=e[o]}}return i};a.prototype.getNodeContext=function(e){var t=this.getBindingInfo("nodes"),o=t&&t.model;return e.getBindingContext(o)};a.prototype.getNodeByContext=function(e){var t=this.getBindingInfo("nodes"),o=t&&t.model;return this.findNode(this,function(t){var i=t.getBindingContext(o);return e&&i&&e.getPath()===i.getPath()})};a.prototype.findNode=function(t,o){var i,s=this;if(o(t)){return t}e.each(t._getNodes(),function(e,t){i=s.findNode(t,o);if(i){return false}});return i};a.prototype.setSelectionMode=function(e){e=this.validateProperty("selectionMode",e);if(this.getSelectionMode()!=e){this.setProperty("selectionMode",e);this._delSelection()}return this};a.prototype.getSelection=function(){for(var e in this.mSelectedNodes){return this.mSelectedNodes[e]}return null};a.prototype.setSelection=function(e,t,o){var i=true;if(!t){i=this.fireSelect({node:e,nodeContext:this.getNodeContext(e)})}if(i){switch(this.getSelectionMode()){case r.Legacy:case r.Single:this._setSelectedNode(e,t);break;case r.Multi:if(o==a.SelectionType.Range){this._setSelectedNodeMapRange(e,t)}else if(o==a.SelectionType.Toggle){this._setSelectedNodeMapToggle(e,t)}else{this._setSelectedNode(e,t)}break;case r.None:break}}};a.prototype.onAfterRendering=function(){if(this.iOldScrollTop){this.$("TreeCont").scrollTop(this.iOldScrollTop)}};a.prototype.invalidate=function(){var e=this;s.prototype.invalidate.apply(this,arguments);if(this.iSelectionUpdateTimer){return}this.iSelectionUpdateTimer=setTimeout(function(){e.mSelectedNodes={};e.mSelectedContexts=[];e.updateSelection(e,true);e.iSelectionUpdateTimer=null},0)};a.prototype._addSelectedNodeContext=function(e){var t;if(e&&e.sPath){t=e.sPath;if(this.getSelectionMode()===r.Multi){if(!(t in this.mSelectedContexts)){this.mSelectedContexts[t]=e}}else{this.mSelectedContexts={};this.mSelectedContexts[t]=e}}};a.prototype.updateSelection=function(i,s){var n=this;e.each(i._getNodes(),function(e,i){if(i.getIsSelected()){switch(n.getSelectionMode()){case r.None:t.warning("Added selected nodes in a tree with disabled selection");i.setIsSelected(false);break;case r.Legacy:if(o(n.mSelectedNodes)){n.mSelectedNodes[i.getId()]=i;n._addSelectedNodeContext(n.getNodeContext(i))}break;case r.Single:if(o(n.mSelectedNodes)==false){t.warning("Added multiple selected nodes in single select tree");i.setIsSelected(false)}else{n.mSelectedNodes[i.getId()]=i;n._addSelectedNodeContext(n.getNodeContext(i))}break;case r.Multi:if(!s){t.warning("Added selected node inside collapsed node in multi select tree");i.setIsSelected(false)}else{n.mSelectedNodes[i.getId()]=i;n._addSelectedNodeContext(n.getNodeContext(i))}break}}n.updateSelection(i,s&&i.getExpanded())})};a.prototype.onBeforeRendering=function(){this.iOldScrollTop=this.$("TreeCont").scrollTop()};a.prototype._setSelectedNode=function(t,o){var i=this,s=this.getNodeContext(t);e.each(this.mSelectedNodes,function(e,t){i._delMultiSelection(t,o)});t._select(o,true);this.mSelectedNodes[t.getId()]=t;this._addSelectedNodeContext(s);this.oLeadSelection=t;if(!o){this.fireSelectionChange({nodes:[t],nodeContexts:[s]})}};a.prototype._setSelectedNodeMapToggle=function(e,t){this._setNodeSelection(e,!e.getIsSelected(),t)};a.prototype._setSelectedNodeMapRange=function(t,o){var i,s=[],n=[],l,d,r,a;if(this.mSelectedNodes[t.getId()]==t){return}else{if(this._getNodes().length>0){i=this._getSelectableNodes();l=i.indexOf(this.oLeadSelection);d=i.indexOf(t);r=l<d?l:d;a=l<d?d:l;for(var c=r;c<=a;c++){this._setMultiSelection(i[c],o)}}}if(!o){e.map(this.mSelectedNodes,function(e){s.push(e)});e.map(this.mSelectedContexts,function(e){n.push(e)});this.fireSelectionChange({nodes:s,nodeContexts:n})}};a.prototype._getSelectableNodes=function(t){var o=[];function i(t){e.each(t,function(e,t){if(t.getSelectable()){o.push(t)}if(t.getExpanded()){i(t._getNodes())}})}i(this._getNodes());return o};a.prototype._setNodeSelection=function(t,o,i){var s=[],n=[],l;if(this.getSelectionMode()==r.Single){if(o){var d=this.getSelection();this._setSelectedNode(t,i);if(!t.isVisible()){l=this._getVisibleNode(t);this._adjustSelectionOnCollapsing(l)}if(d&&!d.isVisible()){l=this._getVisibleNode(d);this._adjustSelectionOnExpanding(l)}return}else{this._delMultiSelection(t,i);if(!t.isVisible()){l=this._getVisibleNode(t);this._adjustSelectionOnExpanding(l)}}}if(o){this._setMultiSelection(t,i);this.oLeadSelection=t}else{this._delMultiSelection(t,i);this.oLeadSelection=t}if(!i){e.map(this.mSelectedNodes,function(e){s.push(e)});e.map(this.mSelectedContexts,function(e){n.push(e)});this.fireSelectionChange({nodes:s,nodeContexts:n})}};a.prototype._setMultiSelection=function(e,t){if(!e){return}e._select(t);this.mSelectedNodes[e.getId()]=e;this._addSelectedNodeContext(this.getNodeContext(e))};a.prototype._delMultiSelection=function(e){var t;if(!e){return}e._deselect();this.mSelectedNodes=this._removeItemFromObject(this.mSelectedNodes,e.getId());t=e.getBindingContext();if(t&&t.sPath){if(t.sPath in this.mSelectedContexts){this.mSelectedContexts=this._removeItemFromObject(this.mSelectedContexts,t.sPath)}}};a.prototype._delSelection=function(){var t=this;if(this.oSelectedNode){this.oSelectedNode._deselect()}if(o(this.mSelectedNodes)==false){e.each(this.mSelectedNodes,function(e,o){t._delMultiSelection(o)})}};a.prototype._getNodes=function(){return this.mAggregations.nodes||[]};a.prototype._getVisibleNode=function(e){var t=e.getParent();if(t.isVisible()){var o=t}else{o=this._getVisibleNode(t)}return o};return a});