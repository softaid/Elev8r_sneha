/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/TooltipBase","./CalloutBaseRenderer","sap/ui/core/Popup","sap/ui/events/ControlEvents","sap/ui/events/KeyCodes","sap/ui/core/Configuration","sap/ui/dom/jquery/control","sap/ui/dom/jquery/Focusable"],function(t,e,o,i,s,n,p,r){"use strict";var u=s.Dock;var h=o.extend("sap.ui.commons.CalloutBase",{metadata:{library:"sap.ui.commons",deprecated:true,events:{open:{parameters:{parent:{type:"sap.ui.core.Control"}}},close:{},beforeOpen:{allowPreventDefault:true,parameters:{parent:{type:"sap.ui.core.Control"}}},opened:{}}}});h.prototype.init=function(){this.oPopup=new s;this.oPopup.setShadow(true);this.oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.commons");this.setPosition(u.BeginBottom,u.BeginTop);this.fAnyEventHandlerProxy=t.proxy(this.onAnyEvent,this);var e=this;this.oPopup._applyPosition=function(t){s.prototype._applyPosition.call(this,t);e.setTip()};this.oPopup.setFollowOf(s.CLOSE_ON_SCROLL)};h.prototype.exit=function(){this.oPopup.close();this.oPopup.detachEvent("opened",this.handleOpened,this);this.oPopup.detachEvent("closed",this.handleClosed,this);this.oPopup.destroy();delete this.oPopup;delete this.oRb;n.unbindAnyEvent(this.fAnyEventHandlerProxy)};h.prototype._getPopup=function(){return this.oPopup};h.prototype.hasChild=function(e){return e&&!!t(e).closest(this.getDomRef()).length};h.prototype.isPopupElement=function(e){if(!e){return false}if(this.hasChild(e)){return true}var o=sap.ui.getCore().getStaticAreaRef();var i=parseInt(t(e).closest(t(o).children()).css("z-index"));var s=parseInt(this.$().css("z-index"));return i&&s&&i>=s};h.prototype.setTip=function(){if(!this.oPopup||!this.oPopup.isOpen()){return}var t=this._currentControl.$(),e=this.$(),o=this.$("arrow"),i=e.offset(),s=t.offset(),n=true,p={},u={l:i.left,r:i.left+e.outerWidth(),w:e.outerWidth(),t:i.top,b:i.top+e.outerHeight(),h:e.outerHeight()},h={l:s.left,r:s.left+t.outerWidth(),w:t.outerWidth(),t:s.top,b:s.top+t.outerHeight(),h:t.outerHeight()},f=(e.outerWidth()-e.innerWidth())/2,l=o.outerWidth()*1.4,a=o.outerWidth()/5,c=a-f-8,d=this.getMyPosition();if(u.r<h.l-c){p.x="right"}else if(u.l-c>h.r){p.x="left"}if(u.t>h.b-c){p.y="top"}else if(u.b<h.t+c){p.y="bottom"}if(p.x){var y=0;if(d.indexOf("top")>-1){y=20}else if(d.indexOf("bottom")>-1){y=u.h-20-l}else{y=(u.h-l)/2}var P=u.t+y+l/2+f;if(P<h.t||P>h.b||h.t>u.t&&h.b<u.b){y=(Math.max(u.t,h.t)+Math.min(u.b,h.b))/2-u.t-l/2}o.css(p.x,c+"px");o.css("top",y);if(y<0||y>u.h-l){n=false}}if(p.y){var m=r.getRTL();if(m){d.replace("begin","right").replace("end","left")}var O=0;if(d.indexOf("begin")>-1||d.indexOf("left")>-1){O=20}else if(d.indexOf("right")>-1||d.indexOf("end")>-1){O=u.w-20-l}else{O=(u.w-l)/2}var v=u.l+O+l/2+f;if(v<h.l||v>h.r){O=(Math.max(u.l,h.l)+Math.min(u.r,h.r))/2-u.l-l/2}o.css(p.y,c+"px");o.css("left",O+"px");if(O<0||O>u.w-l){n=false}}if(p.x&&p.y||!p.x&&!p.y){n=false}o.toggle(n)};h.prototype.adjustPosition=function(){function e(){if(this.oPopup){var t=this._currentControl.getDomRef();this.oPopup.setPosition(this.getMyPosition(),this.getAtPosition(),t,this.getOffset(),this.getCollision())}}setTimeout(t.proxy(e,this),0)};h.prototype.focus=function(){if(this.oPopup&&this.oPopup.isOpen()){var t=this.$("cont");f(t.firstFocusableDomRef()||t.get(0))}};h.prototype.openPopup=function(t){if(!this.oPopup||this.oPopup.isOpen()){return}if(o.sOpenTimeout){clearTimeout(o.sOpenTimeout);o.sOpenTimeout=undefined}if(!this.fireEvent("beforeOpen",{parent:this._currentControl},true,false)){if(!this.sCloseNowTimeout){o.sOpenTimeout=setTimeout(function(){this.openPopup(this._currentControl)}.bind(this),200)}return}this.oParentFocusInfo=t.getFocusInfo();this.oPopup.attachEvent("opened",this.handleOpened,this);o.prototype.openPopup.call(this,t);this.adjustPosition();this.fireOpen({parent:this._currentControl})};h.prototype.close=function(){if(this.oPopup&&this.oPopup.isOpen()&&!this.sCloseNowTimeout){if(o.sOpenTimeout){clearTimeout(o.sOpenTimeout);o.sOpenTimeout=undefined}this.closePopup()}};h.prototype.closePopup=function(){var t=this.oPopup!==undefined&&this.oPopup.isOpen();if(this.fAnyEventHandlerProxy){n.unbindAnyEvent(this.onAnyEvent)}o.prototype.closePopup.call(this);if(t&&this._currentControl&&this.bFocused){this._currentControl.applyFocusInfo(this.oParentFocusInfo);this.bFocused=false}this.fireClose()};h.prototype.handleClosed=function(){if(this.oPopup){this.oPopup.detachEvent("closed",this.handleClosed,this);this.fireClosed()}};h.prototype.onkeydown=function(e){var i=e.ctrlKey&&e.which==p.I;var s=e.which==p.ESCAPE;if(!i&&!s){if(t(e.target).control(0)===this._currentControl){this.close()}return}if(i){if(this.oPopup&&this.oPopup.isOpen()){return}this.bDoFocus=true}o.prototype.onkeydown.call(this,e)};h.prototype.handleOpened=function(){this.oPopup.detachEvent("opened",this.handleOpened,this);if(this.bDoFocus){this.focus();this.bDoFocus=false;this.bFocused=true}this.$().css("display","");this.fireOpened();n.bindAnyEvent(this.fAnyEventHandlerProxy)};h.prototype.onfocusin=function(t){this.bFocused=true;var e=t.target;if(e.id===this.getId()+"-fhfe"){f(this.$("cont").lastFocusableDomRef())}else if(e.id===this.getId()+"-fhee"){f(this.$("cont").firstFocusableDomRef())}};h.prototype.onfocusout=function(t){return};h.prototype.onmouseover=function(t){if(this.oPopup&&(this.oPopup.isOpen()&&this.oPopup.getContent()==this)){if(this.sCloseNowTimeout){clearTimeout(this.sCloseNowTimeout);this.sCloseNowTimeout=null}return}else{o.prototype.onmouseover.call(this,t)}};h.prototype.onmouseout=function(t){if(this.oPopup&&(this.oPopup.isOpen()&&this.isPopupElement(t.relatedTarget))){return}o.prototype.onmouseout.call(this,t)};h.prototype.onmousedown=function(e){if(t(e.target).control(0)===this._currentControl){this.close();this.removeStandardTooltips()}};h.prototype.onAnyEvent=function(e){if(this.oPopup&&!this.oPopup.isOpen()||e.type!="mouseover"||this.hasChild(e.target)){return}var i=this.isPopupElement(e.target)||t(e.target).control(0)===this._currentControl;if(!i&&!this.sCloseNowTimeout&&!o.sOpenTimeout){this.sCloseNowTimeout=setTimeout(function(){this.closePopup()}.bind(this),400)}if(i&&this.sCloseNowTimeout){clearTimeout(this.sCloseNowTimeout);this.sCloseNowTimeout=null}};h.prototype.setPosition=function(t,e){var o=t||u.BeginBottom;var i=e||u.BeginTop;var s=0,n=0,p=0,r=0,h=5;if(o.indexOf("begin")>-1||o.indexOf("left")>-1){s=-1}else if(o.indexOf("right")>-1||o.indexOf("end")>-1){s=1}if(i.indexOf("begin")>-1||i.indexOf("left")>-1){p=-1}else if(i.indexOf("right")>-1||i.indexOf("end")>-1){p=1}if(o.indexOf("top")>-1){n=-1}else if(o.indexOf("bottom")>-1){n=1}if(i.indexOf("top")>-1){r=-1}else if(i.indexOf("bottom")>-1){r=1}var f=(s-p)*s*p*h+" "+(n-r)*n*r*h;this.setMyPosition(o);this.setAtPosition(i);this.setOffset(f);return this};function f(t){if(t){t.focus()}}return h});