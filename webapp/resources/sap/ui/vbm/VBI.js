/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/core/RenderManager","jquery.sap.global","sap/base/Log","./library","./VBIRenderer","./lib/sapvbi","./lib/saputilities","./lib/sapvbicontext","./lib/sapdataprovider","./lib/sapresources","./lib/sapgeomath","./lib/sapmaplayer","./lib/sapmapprovider","./lib/sapmapmanager","./lib/sapvoutils","./lib/sapvobase","./lib/sapevents","./lib/saplabels","./lib/sappositioning","./lib/sapscene","./lib/sapwindow","./lib/sapactions","./lib/sapautomations","./lib/sapgeolocation","./lib/sapgeotool","./lib/sapscale","./lib/sapnavigation","./lib/sapvbmenu","./lib/sapprojection","./lib/sapvbcluster","./lib/sapparsing","./lib/sapconfig","./lib/saplassotrack","./lib/saprecttrack","./lib/sapheatmap"],function(e,t,i,o,n,a){"use strict";var r="sap.ui.vbm.VBI";VBI.Utilities.GetTransparentImage();var s=e.extend("sap.ui.vbm.VBI",{metadata:{library:"sap.ui.vbm",properties:{width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"800px"},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"600px"},config:{type:"object",group:"Misc",defaultValue:null},plugin:{type:"boolean",group:"Misc",defaultValue:false},rectangularSelection:{type:"boolean",group:"Misc",defaultValue:false},lassoSelection:{type:"boolean",group:"Misc",defaultValue:false},rectZoom:{type:"boolean",group:"Misc",defaultValue:false},allowKeyEventRepeat:{type:"boolean",group:"Behavior",defaultValue:true},keyEventDelay:{type:"int",group:"Behavior",defaultValue:250},enableOverlappingTest:{type:"boolean",group:"Behavior",defaultValue:true},ariaLabel:{type:"string",group:"Misc"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{submit:{parameters:{data:{type:"string"}}},thumbnailClick:{parameters:{pos:{type:"string"},zoomLevel:{type:"int"}}},render:{parameters:{canvas:{type:"object"}}},changeTrackingMode:{parameters:{mode:{type:"int"},bSet:{type:"boolean"}}},zoom:{parameters:{canvas:{type:"object"}}},move:{parameters:{canvas:{type:"object"}}},openWindow:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},closeWindow:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},containerCreated:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},containerDestroyed:{parameters:{contentarea:{type:"object"},id:{type:"string"}}}}},renderer:a});s.RttMap={};s.prototype.exit=function(){if(this.getPlugin()){var e=this.getPlugInControl();if(e){e.OnSubmit=null}}else if(this.mVBIContext){this.mVBIContext.clear()}if(this.resizeID!=""){sap.ui.core.ResizeHandler.deregister(this.resizeID);this.resizeID=""}};s.prototype.resize=function(e){var t=this.oControl!=undefined?this.oControl:this;var i=t.mVBIContext;if(i){var o=i.GetMainScene();if(o){o.resizeCanvas(e)}if(i.m_Windows){i.m_Windows.NotifyResize()}}};s.prototype.init=function(){this.m_aLoadQueue=null;if(!this.getPlugin()){this.mVBIContext=new VBI.VBIContext(this)}this.resizeID="";this.m_renderList=[]};s.prototype.loadNative=function(e){var t=this.getId();var n=document.getElementById("VBI"+t);if(!n){return}var a=function(e){try{var t;if(t=JSON.parse(e)){var i=t.SAPVB;var o=JSON.stringify(i,null,"  ");this.fireSubmit({data:o})}}catch(e){if(VBI.m_bTrace){VBI.Trace("Error submitting plugin event")}}};if(i.type(e)=="object"){var s=JSON.stringify(e,null,"  ");try{n.Load(s);n.OnSubmit=a.bind(this)}catch(e){o.error("Error loading vbiJSON from object","",r)}}else if(i.type(e)=="string"){try{n.Load(e);n.OnSubmit=a.bind(this)}catch(e){o.error("Error loading vbiJSON from string","",r)}}};s.prototype.loadHtml=function(e){var t=this.getId();var o=null;if(typeof e==="string"){o=JSON.parse(e.indexOf("{")?e.substr(e.indexOf("{")):e)}else if(typeof e==="object"){o=e}if(!o){return}if(!o["SAPVB"]){var n;if(this.mVBIContext&&(n=new VBI.Adaptor(this.mVBIContext).CreateLoadData(o))){this.loadHtml(n);return}else{return}}var a=false;var r=false;var s=false;var l=false;var m=false;var p=false;if(i.type(o)==="object"){if(o.SAPVB){if(o.SAPVB.Config){this.mVBIContext.GetConfig().load(o.SAPVB.Config,this.mVBIContext)}if(o.SAPVB.Resources){this.mVBIContext.GetResources().load(o.SAPVB.Resources,this.mVBIContext);l=true}if(o.SAPVB.DataTypes){if(!this.mVBIContext.m_DataTypeProvider){this.mVBIContext.m_DataTypeProvider=new VBI.DataTypeProvider}this.mVBIContext.m_DataTypeProvider.load(o.SAPVB.DataTypes,this.mVBIContext)}if(o.SAPVB.Data){if(!this.mVBIContext.m_DataProvider){this.mVBIContext.m_DataProvider=new VBI.DataProvider}this.mVBIContext.m_DataProvider.load(o.SAPVB.Data,this.mVBIContext);a=true}if(o.SAPVB.MapProviders){if(!this.mVBIContext.m_MapProviders){this.mVBIContext.m_MapProviders=new VBI.MapProviders}this.mVBIContext.m_MapProviders.load(o.SAPVB.MapProviders,this.mVBIContext);p=true}if(o.SAPVB.MapLayerStacks){if(!this.mVBIContext.m_MapLayerStackManager){this.mVBIContext.m_MapLayerStackManager=new VBI.MapLayerStackManager(this.mVBIContext)}this.mVBIContext.m_MapLayerStackManager.load(o.SAPVB.MapLayerStacks,this.mVBIContext);p=true}if(o.SAPVB.Windows){if(!this.mVBIContext.m_Windows){this.mVBIContext.m_Windows=new VBI.Windows}this.mVBIContext.m_Windows.load(o.SAPVB.Windows,this.mVBIContext);s=true}if(o.SAPVB.Actions){if(!this.mVBIContext.m_Actions){this.mVBIContext.m_Actions=new VBI.Actions}this.mVBIContext.m_Actions.load(o.SAPVB.Actions,this.mVBIContext)}if(o.SAPVB.Automation){if(!this.mVBIContext.m_Automations){this.mVBIContext.m_Automations=new VBI.Automations}this.mVBIContext.m_Automations.load(o.SAPVB.Automation,this.mVBIContext)}if(o.SAPVB.Menus){if(!this.mVBIContext.m_Menus){this.mVBIContext.m_Menus=new VBI.Menus}this.mVBIContext.m_Menus.load(o.SAPVB.Menus,this.mVBIContext)}if(o.SAPVB.Clustering){if(!this.mVBIContext.m_Clustering){this.mVBIContext.m_Clustering=new VBI.Clustering}this.mVBIContext.m_Clustering.load(o.SAPVB.Clustering,this.mVBIContext);m=true}if(o.SAPVB.Scenes){if(!this.mVBIContext.m_SceneManager){this.mVBIContext.m_SceneManager=new VBI.SceneManager}this.mVBIContext.m_SceneManager.load(o.SAPVB.Scenes,this.mVBIContext);r=true}else if(p){var u=this.mVBIContext.m_SceneManager.m_SceneArray;for(var h=0;h<u.length;++h){if(u[h].RefreshMapLayerStack){u[h].RefreshMapLayerStack()}}}}if(a){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.NotifyDataChange()}}if(r||s){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(t)}}if(r||a||m||l){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.RenderAsync()}}}};s.prototype.load=function(e){if(!e){return}if(!this.isRendered()){if(!this.m_aLoadQueue){this.m_aLoadQueue=[]}if(e.SAPVB&&e.SAPVB.Scenes&&e.SAPVB.Scenes.Merge&&e.SAPVB.Scenes.Merge.SceneGeo){var t=e.SAPVB.Scenes.Merge.SceneGeo.initialStartPosition;var i=e.SAPVB.Scenes.Merge.SceneGeo.initialZoom;if(t||i){var o=this.m_aLoadQueue;for(var n=0;n<o.length;++n){if(o[n].SAPVB&&o[n].SAPVB.Scenes&&o[n].SAPVB.Scenes.Set&&o[n].SAPVB.Scenes.Set.SceneGeo){var a=o[n].SAPVB.Scenes.Set.SceneGeo;a.initialStartPosition=t||a.initialStartPosition;a.initialZoom=i||a.initialZoom;break}}}}this.m_aLoadQueue.push(e);return}if(this.getPlugin()){this.loadNative(e)}else{this.loadHtml(e)}if(this.resizeID==""&&this.mVBIContext.GetMainScene()){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize)}};
/**
	 * Returns a Screenshot of the Overlay. Please note that the map cannot be included due to browser restrictions. Function returns the visible part
	 * of the Canvas excluding map, copyright info, navigation control, scaler, legend, detail windows, container elements. Analytic Maps are returned
	 * as they are not treated as "maps" internally. Modes 2 & 3 are experimental, trying to load the map (this may work on inhouse servers with
	 * adapted settings, standard configurations should fail)
	 *
	 * @param {int} [iMode] 0: Overlay only; 1 (default) and 3: include Labels; 2 and 3: try to include maps (will return "" if not possible)
	 * @returns {string} Base64 encoded picture (PNG format) on success, "" otherwise
	 * @public
	 * @ui5-metamodel This method also will be described in the UI5 (legacy) designtime metamodel
	 */s.prototype.getPicOfOverlay=function(e){var t=this.mVBIContext.GetMainScene();if(!(t&&t.GetOverlayPicture)){return""}return t.GetOverlayPicture(e)};s.prototype.minimize=function(e,t,i,o,n,a,r,s){var l=this.mVBIContext;if(!l.moThumbnail){l.moThumbnail={bThumbnailed:false}}var m=l.moThumbnail;m.nThumbWidth=e;m.nThumbHeight=t;m.strFont=n;m.strCol=a;m.nFontPos=r;m.strText=s;if(i){m.nFullWidth=i}if(o){m.nFullHeight=o}var p=l.GetMainScene();if(p){l.DoMinimize(p)}};s.prototype.maximize=function(e,t){var i=this.mVBIContext.GetMainScene();if(i&&this.mVBIContext.moThumbnail){var o,n;if(e){o=String(e)+"px"}else{o=this.mVBIContext.moThumbnail.strOrgWidth?this.mVBIContext.moThumbnail.strOrgWidth:this.getWidth()}if(t){n=String(t)+"px"}else{n=this.mVBIContext.moThumbnail.strOrgHeight?this.mVBIContext.moThumbnail.strOrgHeight:this.getHeight()}this.mVBIContext.m_bThumbnail=false;this.setWidth(o);this.setHeight(n);i.m_Ctx.moThumbnail=undefined;i.resizeCanvas(0)}};s.prototype.zoomToGeoPosition=function(e,t,o){var n=null;if(n=this.mVBIContext.GetMainScene()){if(i.type(e)=="array"&&i.type(t)=="array"){if(e.length>1&&t.length>1){n.ZoomToMultiplePositions(e,t)}else{n.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(e[0]),parseFloat(t[0])]),parseFloat(o))}}else{n.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(e),parseFloat(t)]),parseFloat(o))}}};s.prototype.zoomToAreas=function(e,t){var i=null;if(i=this.mVBIContext.GetMainScene()){i.ZoomToAreas(e,t)}};s.prototype.getInfoForCluster=function(e,t){var i=null;if(i=this.mVBIContext.GetMainScene()){return i.getInfoForCluster(e,t)}return null};s.prototype.setRectangularSelection=function(e){var t=this.mVBIContext.GetMainScene();if(t){if(!(e&&t.m_nInputMode==window.VBI.InputModeRectSelect)){t.endTrackingMode();if(e){this.setProperty("lassoSelection",false,true);this.setProperty("rectZoom",false,true);new t.RectSelection;t.m_Ctx.onChangeTrackingMode(VBI.InputModeRectSelect,true)}}}this.setProperty("rectangularSelection",e,true);return this};s.prototype.setLassoSelection=function(e){var t=this.mVBIContext.GetMainScene();if(t){if(!(e&&t.m_nInputMode==window.VBI.InputModeLassoSelect)){t.endTrackingMode();if(e){this.setProperty("rectangularSelection",false,true);this.setProperty("rectZoom",false,true);new t.LassoSelection;t.m_Ctx.onChangeTrackingMode(VBI.InputModeLassoSelect,true)}}}this.setProperty("lassoSelection",e,true);return this};s.prototype.setRectZoom=function(e){var t=this.mVBIContext.GetMainScene();if(t){if(!(e&&t.m_nInputMode==window.VBI.InputModeRectZoom)){t.endTrackingMode();if(e){this.setProperty("lassoSelection",false,true);this.setProperty("rectangularSelection",false,true);new t.RectangularZoom;t.m_Ctx.onChangeTrackingMode(VBI.InputModeRectZoom,true)}}}this.setProperty("rectZoom",e,true);return this};s.prototype.onAfterRendering=function(){if(this.$oldContent.length>0){this.$().append(this.$oldContent)}if(this.m_aLoadQueue){var e;for(e=0;e<this.m_aLoadQueue.length;++e){this.load(this.m_aLoadQueue[e])}this.m_aLoadQueue=null}if(this.resizeID==""&&this.mVBIContext.GetMainScene()){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize)}var t=this.getId();if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(t)}var o=i(this.getDomRef()).children(".vbi-hidden").children();for(var n=0,a;n<o.length;++n){a=o[n];var r=document.getElementById(a.attributes.getNamedItem("data").nodeValue);if(r){if(a.firstChild){r.appendChild(a.firstChild)}a.parentNode.removeChild(a)}}};s.prototype.onBeforeRendering=function(){var e=this.getDomRef();if(e&&!t.isPreservedContent(e)){t.preserveContent(e,true,false)}this.$oldContent=t.findPreservedContent(this.getId())};s.prototype.isRendered=function(){return this.getDomRef()?true:false};s.prototype.getPlugInControl=function(){var e=this.getId();var t=document.getElementById("VBI"+e);return t?t:null};s.prototype.setConfig=function(e){if(e){return this.load(e)}};s.prototype.setWidth=function(e){if(typeof e==="number"){this.setProperty("width",parseInt(e,10).toString()+"px")}else{this.setProperty("width",e)}};s.prototype.setHeight=function(e){if(typeof e==="number"){this.setProperty("height",parseInt(e,10).toString()+"px")}else{this.setProperty("height",e)}};s.prototype.addRenderItem=function(e,t){this.m_renderList.push({control:e,data:t});this.invalidate()};return s});