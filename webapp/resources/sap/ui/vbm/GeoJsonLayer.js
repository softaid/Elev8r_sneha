/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/core/theming/Parameters","sap/ui/unified/Menu","jquery.sap.global","sap/base/Log","./library"],function(e,t,r,i,n,a){"use strict";var o="sap.ui.vbm.GeoJsonLayer";var s=e.extend("sap.ui.vbm.GeoJsonLayer",{metadata:{library:"sap.ui.vbm",properties:{srcURL:{type:"string",defaultValue:null},data:{type:"object",defaultValue:null},defaultLineWidth:{type:"int",group:"Appearance",defaultValue:5},defaultFillColor:{type:"sap.ui.core.CSSColor",group:"Appearance",defaultValue:"rgba(186, 193, 196, 0.5)"},defaultBorderColor:{type:"sap.ui.core.CSSColor",group:"Appearance",defaultValue:"rgba(255, 255, 255, 1.0)"}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.vbm.Feature",multiple:true,singularName:"item"}},events:{click:{parameters:{featureId:{type:"string"}}},contextMenu:{parameters:{featureId:{type:"string"}}}}}});s.prototype.init=function(){this.mbGeoJSONDirty=true;this.mbSrcLoadPending=false;this._aGeoJsonObjects=[]};s.prototype.setSrcURL=function(e){this.mbGeoJSONDirty=true;return this.setProperty("srcURL",e)};s.prototype.setData=function(e){this.mbGeoJSONDirty=true;this._aGeoJsonObjects=e;return this.setProperty("data",e)};s.prototype.addData=function(e){this.mbGeoJSONDirty=true;if(i.type(e)==="array"){this._aGeoJsonObjects=this._aGeoJsonObjects.concat(e)}else{this._aGeoJsonObjects.push(e)}this.setProperty("data",this._aGeoJsonObjects);this.getParent().invalidate(this)};s.prototype._createFeatures=function(e){var t=this.getDefaultFillColor();var r=this.getDefaultBorderColor();var i=this._aGeoJsonObjects;if(e){i.push(e)}this.mFeatureColl=[];this.mFeatureBBox={};this.mNames={};this.mFeatureProps={};for(var a=0;a<i.length;++a){var s=i[a];switch(s.type){case"FeatureCollection":for(var u=0,p;u<s.features.length;++u){p=s.features[u];this._processType(p.id,p.geometry.type,p.geometry.coordinates,p.properties,t,r)}break;case"Feature":this._processType(s.id,s.geometry.type,s.geometry.coordinates,s.properties,t,r);break;case"GeometryCollection":for(var l=0,c;l<s.geometries.length;++l){c=s.geometries[l];this._processType(null,c.type,c.coordinates,null,t,r)}break;case"Polygon":case"MultiPolygon":case"LineString":case"MultiLineString":case"Point":case"MultiPoint":this._processType(null,s.type,s.coordinates,null,t,r);break;default:n.error("Unsupported GeoJSON object type",i[a].type,o);continue}}this.mbGeoJSONDirty=false};s.prototype._processType=function(e,t,r,i,a,s){var u,p,l=Number.MAX_VALUE,c=-Number.MAX_VALUE,h=Number.MAX_VALUE,d=-Number.MAX_VALUE;var f="",m;var y;var g;var v,b;var P=[];var C=[];var _=[];f=i&&i.name?i.name:"";this.mFeatureProps[e]=i;switch(t){case"Polygon":for(v=0;v<r.length;++v){g=r[v];y=[];for(b=0;b<g.length;++b){m=g[b];if(!v){if((u=m[0])<l){l=u}if(u>c){c=u}if((p=m[1])<h){h=p}if(p>d){d=p}}y.push(m[0],m[1],"0")}C.push(y)}P.push(C);_.push([l,c,h,d]);break;case"MultiPolygon":for(var S=0,B,M=r.length;S<M;++S){C=[];B=r[S].length;for(v=0;v<B;++v){g=r[S][v];y=[];for(b=0;b<g.length;++b){m=g[b];if(!v){if((u=m[0])<l){l=u}if(u>c){c=u}if((p=m[1])<h){h=p}if(p>d){d=p}}y.push(m[0],m[1],"0")}C.push(y)}P.push(C);_.push([l,c,h,d])}break;case"LineString":y=[];for(v=0;v<r.length;++v){m=r[v];if((u=m[0])<l){l=u}if(u>c){c=u}if((p=m[1])<h){h=p}if(p>d){d=p}y.push(m[0],m[1],0)}C.push(y);P.push(C);_.push([l,c,h,d]);break;case"Point":h=d=r[1];l=c=r[0];y=[r[0],r[1],0];C.push(y);P.push(C);_.push([l,c,h,d]);break;default:n.error("Unsupported geometry type",t,o);return}this.mFeatureColl.push(this._createDataElement(e,P,t,a,s,f,e));this.mFeatureBBox[e]=window.VBI.MathLib.GetSurroundingBox(_)};s.prototype._createDataElement=function(e,t,r,i,n,a,o){var s={K:e,P:[],TT:a,C:i,CB:n,type:r};s["VB:s"]=false;var u,p,l;var c,h,d,f,m;switch(r){case"Polygon":case"MultiPolygon":var y,g;m=t.length;for(l=0;l<m;++l){y=t[l];g=[];f=y.length;for(p=0;p<f;++p){c="";d=y[p].length;for(u=0;u<d;++u){if(u){c+=";"}c+=y[p][u]}g.push(c)}s.P.push(g)}break;case"LineString":c="";h=t[0][0];d=h.length;for(u=0;u<d;++u){if(u){c+=";"}c+=h[u]}s.P=c;break;case"Point":c="";h=t[0][0];d=h.length;for(u=0;u<d;++u){if(u){c+=";"}c+=h[u]}s.P=c;break}return s};s.prototype._triggerFeatureCreation=function(){var e=null;if(e=this.getSrcURL()){if(!this.mbSrcLoadPending){this.mbSrcLoadPending=true;i.getJSON(e,function(e){this._createFeatures(e);this.mbSrcLoadPending=false;var t;if(t=this.getParent()){t.invalidate()}}.bind(this)).fail(function(){n.error("The path or the GeoJSON file is invalid",e,o)})}}else{this._createFeatures(null)}};s.prototype.getTemplateObjects=function(){var e,r=[];e={id:this.getId()+"_Polys",type:"{00100000-2012-0004-B001-F311DE491C77}",hotDeltaColor:"RHLSA(0;1;1;1.5)",altBorderDeltaColor:t?t.get("_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor"):"#666"};e.datasource=e.id;e["posarraymulti.bind"]=e.id+".P";e["color.bind"]=e.id+".C";e["colorBorder.bind"]=e.id+".CB";e["tooltip.bind"]=e.id+".TT";r.push(e);e={id:this.getId()+"_Lines",type:"{00100000-2012-0004-B001-C46BD7336A1A}",hotDeltaColor:"RHLSA(0;1;1;1.5)",altBorderDeltaColor:t?t.get("_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor"):"#666"};e.datasource=e.id;e["posarray.bind"]=e.id+".P";e["color.bind"]=e.id+".C";e["colorBorder.bind"]=e.id+".CB";e["tooltip.bind"]=e.id+".TT";r.push(e);e={id:this.getId()+"_Points",type:"{00100000-2012-0004-B001-64592B8DB964}",hotDeltaColor:"RHLSA(0;1;2;1)"};e.datasource=e.id;e["pos.bind"]=e.id+".P";e["tooltip.bind"]=e.id+".TT";r.push(e);return r};s.prototype.getTypeObjects=function(){var e={},t=[];var r={key:"K",minSel:"0",maxSel:"0",A:[{name:"K",alias:"K",type:"string"},{name:"C",alias:"C",type:"color"},{name:"CB",alias:"CB",type:"string"},{name:"TT",alias:"TT",type:"string"}]};i.extend(true,e,r);e.name=this.getId()+"_Polys";e.A.push({name:"P",alias:"P",type:"vectorarraymulti"});t.push(e);e={};i.extend(true,e,r);e.name=this.getId()+"_Lines";e.A.push({name:"P",alias:"P",type:"vectorarray"});t.push(e);e={};i.extend(true,e,r);e.name=this.getId()+"_Points";e.A.push({name:"P",alias:"P",type:"vector"});t.push(e);return t};s.prototype.getDataObjects=function(){if(this.mbGeoJSONDirty){this._triggerFeatureCreation()}var e=[],t=[],r=[],a=[];i.extend(true,e,this.mFeatureColl);var s={};if(e.length){var u=this.getItems();for(var p=0,l=u?u.length:0,c;p<l;++p){c=u[p];s[c.getFeatureId()]=c}}for(var h=0,d,f,m;h<e.length;++h){d=e[h];if(f=s[d.K]){d.C=f.getColor();if(m=f.getTooltip()){d.TT=m}}switch(d.type){case"Polygon":case"MultiPolygon":t.push(d);break;case"LineString":case"MultiLineString":r.push(d);break;case"Point":case"MultiPoint":a.push(d);break;default:n.error("Unknown object type",d.type,o)}}return[{name:this.getId()+"_Polys",type:"N",E:t},{name:this.getId()+"_Lines",type:"N",E:r},{name:this.getId()+"_Points",type:"N",E:a}]};s.prototype.getDataRemoveObjects=function(){return[{name:this.getId()+"_Polys",type:"N"},{name:this.getId()+"_Lines",type:"N"},{name:this.getId()+"_Points",type:"N"}]};s.prototype.getActionArray=function(){var e=[];var t=this.getId();if(this.mEventRegistry["click"]||this.isEventRegistered("click")){e.push({id:t+"Polys1",name:"click",refScene:"MainScene",refVO:t+"_Polys",refEvent:"Click",AddActionProperty:[{name:"pos"}]});e.push({id:t+"Lines1",name:"click",refScene:"MainScene",refVO:t+"_Lines",refEvent:"Click",AddActionProperty:[{name:"pos"}]});e.push({id:t+"Points1",name:"click",refScene:"MainScene",refVO:t+"_Points",refEvent:"Click",AddActionProperty:[{name:"pos"}]})}if(this.mEventRegistry["contextMenu"]||this.isEventRegistered("contextMenu")){e.push({id:t+"_Polys2",name:"contextMenu",refScene:"MainScene",refVO:t+"_Polys",refEvent:"ContextMenu"});e.push({id:t+"_Lines2",name:"contextMenu",refScene:"MainScene",refVO:t+"_Lines",refEvent:"ContextMenu"});e.push({id:t+"_Points2",name:"contextMenu",refScene:"MainScene",refVO:t+"_Points",refEvent:"ContextMenu"})}return e};s.prototype.getFeaturesInfo=function(e){var t=[];for(var r=0,i=e.length,n;r<i;++r){n=e[r];t[n]={};t[n].BBox=this.mFeatureBBox[n];t[n].Midpoint=[(this.mFeatureBBox[n][0]+this.mFeatureBBox[n][1])/2,(this.mFeatureBBox[n][2]+this.mFeatureBBox[n][3])/2];t[n].Name=this.mNames[n];t[n].Properties=this.mFeatureProps[n]}return t};s.prototype.handleEvent=function(e){var t=e.Action.name;var i="fire"+t[0].toUpperCase()+t.slice(1);var n,a=e.Action.instance;if(n=this.findInstance(a)){if(n.mEventRegistry[t]){if(t==="click"){n.mClickGeoPos=e.Action.AddActionProperties.AddActionProperty[0]["#"]}if(t==="contextMenu"){n.mClickPos=[e.Action.Params.Param[0]["#"],e.Action.Params.Param[1]["#"]];if(this.oParent.mVBIContext.m_Menus){this.oParent.mVBIContext.m_Menus.deleteMenu("DynContextMenu")}var o=new r;o.vbi_data={};o.vbi_data.menuRef="CTM";o.vbi_data.VBIName="DynContextMenu";n.fireContextMenu({menu:o})}else if(t==="handleMoved"){n[i]({data:e})}else{n[i]({})}}}if(this.mEventRegistry[t]){this[i]({featureId:a.split(".")[1]})}};s.prototype.openDetailWindow=function(e,t){var r=this.getParent();r.mDTWindowCxt.bUseClickPos=true;r.mDTWindowCxt.open=true;r.mDTWindowCxt.src=e;r.mDTWindowCxt.key=e.getFeatureId();r.mDTWindowCxt.params=t;r.m_bWindowsDirty=true;r.invalidate(this)};s.prototype.openContextMenu=function(e,t){this.oParent.openContextMenu("Area",e,t)};s.prototype.handleChangedData=function(e){if(e&&e.length){for(var t=0,r,i;t<e.length;++t){r=e[t];i=r.K?this.findInstance(r.K):null;if(i){i.handleChangedData(r)}}}};s.prototype.isEventRegistered=function(e){var t=this.getItems();if(!t){return false}for(var r=0,i=t.length;r<i;++r){if(t[r].mEventRegistry[e]){return true}}return false};s.prototype.findInstance=function(e){var t=this.getItems();if(!t){return null}switch(i.type(e)){case"string":var r=e.indexOf(".")!==-1?e.split(".")[1]:e;for(var a=0,s=t.length;a<s;++a){if(t[a].getFeatureId()===r){return t[a]}}break;case"number":break;default:n.error("Unexpected instance name type",i.type(e),o);break}return null};return s});