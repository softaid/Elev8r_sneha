/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/valuehelp/base/FilterableListContent","sap/ui/mdc/util/loadModules","sap/base/util/deepEqual","sap/ui/mdc/enum/SelectType","sap/ui/mdc/library","sap/m/library","sap/ui/table/library","sap/ui/thirdparty/jquery","sap/ui/mdc/condition/FilterConverter","sap/base/util/restricted/_throttle","sap/ui/mdc/util/Common","sap/base/Log"],function(e,t,i,n,s,a,o,l,r,h,c,d){"use strict";var u=a.ListMode;var g=a.Sticky;var p=s.SelectionMode;var _=o.VisibleRowCountMode;var b=o.SelectionMode;var f=o.SelectionBehavior;var v=function(e){var t,i=t=e&&e.getType();if(!i){t="Table"}else if(typeof i==="object"){if(i.isA("sap.ui.mdc.table.ResponsiveTableType")){t="ResponsiveTable"}else{t="Table"}}return t};var S=function(){var e=this._getTable();var t=e&&e._oTable;var i=e.getRowBinding();var s=function(){return this._oUITableSelectionPlugin||t}.bind(this);var a=function(e,t){var i=t?n.Add:n.Remove;if(!t&&this._isSingleSelect()){i=n.Add}this._fireSelect({type:i,conditions:e})};var o={ResponsiveTable:{getListBindingInfo:function(){return t&&t.getBindingInfo("items")},getItems:function(){return t.getItems()},getSelectedItems:function(){return t.getSelectedItems()},modifySelection:function(e,t){if(e.getSelected()!==t){e.setSelected(t)}},handleItemPress:function(e){var t=e.getParameter("listItem");if(!this.isTypeahead()||!this._isSingleSelect()){t.setSelected(!t.getSelected())}var i=this._getListItemBindingContext(t);var n=this._getItemFromContext(i);var s=n&&this._createCondition(n.key,n.description,n.payload);a.call(this,[s],t.getSelected())},handleSelectionChange:function(e){if(!this.isTypeahead()||!this._isSingleSelect()){var t=e.getParameters();var i=t.listItems||t.listItem&&[t.listItem];var n=i.map(function(e){var t=this._getListItemBindingContext(e);var i=this._getItemFromContext(t);return i&&this._createCondition(i.key,i.description,i.payload)}.bind(this));a.call(this,n,t.selected)}},adjustTable:function(){var e=t.getSticky();if(!e||e.length===0){t.setSticky([g.ColumnHeaders])}if(this._isSingleSelect()){t.setMode(u.SingleSelectLeft)}else{t.setMode(u.MultiSelect)}},handleScrolling:function(e){var i=this.getScrollDelegate();if(i){t.scrollToIndex(e).catch(function(e){});return true}},handleListBinding:function(){}},Table:{getListBindingInfo:function(){return t&&t.getBindingInfo("rows")},getItems:function(){return t.getRows().filter(function(e){var t=this._getListItemBindingContext(e);return t&&t.getObject()}.bind(this))}.bind(this),getSelectedItems:function(){var e=s().getSelectedIndices();var i=e.reduce(function(e,i){var n=t.getContextByIndex(i);return n?e.concat(n):e},[]);return o["Table"].getItems().filter(function(e){return i.indexOf(this._getListItemBindingContext(e))>=0}.bind(this))}.bind(this),modifySelection:function(e,t){var i=this._getListItemBindingContext(e);var n=o["Table"].getContexts().indexOf(i);var a=s().getSelectedIndices().indexOf(n)>=0;if(t&&!a){return this._isSingleSelect()?s().setSelectedIndex(n):s().addSelectionInterval(n,n)}else if(!t&&a){return s().removeSelectionInterval(n,n)}},handleItemPress:function(e){},handleSelectionChange:function(e){if(this._bScrolling||this._bBusy){return}var i=e.getParameter("rowIndices");var n=i.map(function(e){return t.getContextByIndex(e)});var s=o["Table"].getItems().filter(function(e,t){return n.indexOf(this._getListItemBindingContext(e))>=0}.bind(this));var l=[],r=[];var h=o["Table"].getSelectedItems();var c=this.getConditions();s.forEach(function(e,t){var i=this._isItemSelected(e,c);var n=h.indexOf(e)!==-1;if(i!==n){var s=h.indexOf(e)!==-1?l:r;var a=this._getListItemBindingContext(e);var o=this._getItemFromContext(a);var d=o&&this._createCondition(o.key,o.description,o.payload);s.push(d)}}.bind(this));var d=this._isSingleSelect();if(l.length){a.call(this,l,true);if(d){return}}if(r.length){a.call(this,r,false)}},adjustTable:function(){var i=t.getRowMode();if(!i){t.setVisibleRowCountMode(_.Auto);t.setMinAutoRowCount(3)}else if(i.isA("sap.ui.table.rowmodes.AutoRowMode")){i.setMinRowCount(3)}var n=e.getSelectionMode();var a=this._isSingleSelect()?b.Single:b.MultiToggle;if(n!==p.SingleMaster){t.setSelectionBehavior(f.Row)}s().setSelectionMode(a)},handleScrolling:function(e){var i=t.getFirstVisibleRow();if(typeof e==="undefined"||e<0){e=i-1}if(e>=0&&e!=i){t.setFirstVisibleRow(e);return Promise.resolve()}return false},getContexts:function(){return i&&i.getAllCurrentContexts()},handleListBinding:function(){i.attachEvent("change",this._handleUpdateFinished.bind(this))}}};return o[this._sTableType]};function T(){if(this._oTableHelper&&!this._bSelectionIsUpdating){this._bSelectionIsUpdating=true;var e=this._oTableHelper.getItems();var t=this.getConditions();var i=[];for(var n in e){var s=e[n];var a=this._isItemSelected(s,t);i.push(this._oTableHelper.modifySelection.call(this,s,a))}Promise.all(i).then(function(){this._bSelectionIsUpdating=false}.bind(this))}}var y=h(T,100,{leading:true});var m=e.extend("sap.ui.mdc.valuehelp.content.MDCTable",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.IDialogContent"],properties:{forceBind:{type:"boolean",defaultValue:false}},aggregations:{table:{type:"sap.ui.mdc.Table",multiple:false}},events:{},defaultAggregation:"table"}});m.prototype.init=function(){e.prototype.init.apply(this,arguments);this._oObserver.observe(this,{aggregations:["table"]});this._addPromise("listBinding");this._bRebindTable=false};var C=function(){var e=this._getTable().getRowBinding();if(e){this._oTableHelper=S.call(this);this._oTableHelper.handleListBinding.call(this);P.call(this);this._resolvePromise("listBinding",e)}};var I=function(){if(this._oTable&&!this._oTable.getHeader()){this._oTable.setHeader(this._oResourceBundle.getText("valuehelp.TABLETITLENONUMBER"))}};m.prototype._handleConditionsUpdate=function(){y.call(this)};m.prototype._handleUpdateFinished=function(e){this._bScrolling=false;y.call(this)};m.prototype._handleFirstVisibleRowChanged=function(e){this._bScrolling=true;y.call(this)};m.prototype._handleBusyStateChanged=function(e){this._bBusy=e.getParameter("busy")};var B=function(e,t){if(!e){return}if(t==="remove"){if(this._sTableType==="Table"){e.detachEvent("cellClick",this._handleItemPress,this);e.detachEvent("rowSelectionChange",this._handleSelectionChange,this);e.detachEvent("rowsUpdated",this._handleUpdateFinished,this);e.detachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);e.detachEvent("busyStateChanged",this._handleBusyStateChanged,this);if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.detachEvent("selectionChange",this._handleSelectionChange,this)}this._oUITableSelectionPlugin=undefined}else if(this._sTableType==="ResponsiveTable"){e.detachEvent("itemPress",this._handleItemPress,this);e.detachEvent("selectionChange",this._handleSelectionChange,this);e.detachEvent("updateFinished",this._handleUpdateFinished,this)}this._oObserver.unobserve(e)}else{if(this._sTableType==="Table"){this._oObserver.observe(e,{bindings:["rows"],aggregations:["plugins"]});e.attachEvent("cellClick",this._handleItemPress,this);e.attachEvent("rowSelectionChange",this._handleSelectionChange,this);e.attachEvent("rowsUpdated",this._handleUpdateFinished,this);e.attachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);e.attachEvent("busyStateChanged",this._handleBusyStateChanged,this);this._oUITableSelectionPlugin=e.getPlugins().find(function(e){return e.isA("sap.ui.table.plugins.SelectionPlugin")});if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this)}}else if(this._sTableType==="ResponsiveTable"){this._oObserver.observe(e,{bindings:["items"]});e.attachEvent("itemPress",this._handleItemPress,this);e.attachEvent("selectionChange",this._handleSelectionChange,this);e.attachEvent("updateFinished",this._handleUpdateFinished,this)}}};m.prototype._observeChanges=function(t){if(["_defaultFilterBar","filterBar"].indexOf(t.name)!==-1){x.call(this)}if(t.name==="table"){var i=t.child;if(t.mutation==="remove"){this._oObserver.unobserve(i);this._oTable=null;this._oTableHelper=null;this._addPromise("listBinding")}else{this._oTable=i;if(this._oTable.getAutoBindOnInit()){d.warning("Usage of autobound tables may lead to unnecessary requests.")}else if(this.getForceBind()){this._bRebindTable=true}this._oObserver.observe(i,{aggregations:["_content"]});this._sTableType=v(i);i.addDelegate({onmouseover:function(e){var t=l(e.target).control(0);if(t&&t.isA("sap.m.ColumnListItem")){t.setType("Active")}}});B.call(this,this._oTable._oTable,"insert");C.call(this);I.call(this);x.call(this)}return}if(t.name==="_content"){B.call(this,t.child,t.mutation);return}if(["rows","items"].indexOf(t.name)!==-1&&t.mutation==="ready"){C.call(this);return}if(t.name==="config"){P.call(this)}if(t.name==="plugins"){this._oUITableSelectionPlugin=t.mutation==="remove"||!t.child.isA("sap.ui.table.plugins.SelectionPlugin")?undefined:t.child;if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this)}}e.prototype._observeChanges.apply(this,arguments)};m.prototype._getTable=function(){return this._oTable};function x(){var e=this._getPriorityFilterBar();if(this._oTable&&e&&this._oTable.getFilter()!==e.getId()){this._oTable.setFilter(e)}}function P(){if(this._oTableHelper){this._oTableHelper.adjustTable.call(this)}}m.prototype.getContent=function(){return this._retrievePromise("wrappedContent",function(){return t(["sap/ui/layout/FixFlex","sap/m/VBox","sap/m/ScrollContainer"]).then(function(e){var t=e[0];var i=e[1];var n=e[2];if(!this._oContentLayout){this._oFilterBarVBox=new i(this.getId()+"-FilterBarBox",{visible:"{$this>/_filterBarVisible}"});this._oFilterBarVBox.addStyleClass("sapMdcValueHelpPanelFilterbar");this._oFilterBarVBox._oWrapper=this;this._oFilterBarVBox.getItems=function(){var e=this._oWrapper._getPriorityFilterBar.call(this._oWrapper);var t=e?[e]:[];return t};this._oTableBox=new i(this.getId()+"-TB",{height:"100%"});this._oTableBox.addStyleClass("sapMdcValueHelpPanelTableBox");this._oTableBox._oWrapper=this;this._oTableBox.getItems=function(){var e=this._oWrapper._sTableType==="ResponsiveTable"?this._oWrapper._oScrollContainer:this._oWrapper._oTable;var t=e?[e]:[];return t};this._oContentLayout=new t(this.getId()+"-FF",{minFlexSize:200,fixContent:this._oFilterBarVBox,flexContent:this._oTableBox});this._oScrollContainer=new n(this.getId()+"-SC",{height:"calc(100% - 0.5rem)",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var e=[];var t=this._oWrapper&&this._oWrapper._oTable;if(t){e.push(t)}return e}}this.setAggregation("displayContent",this._oContentLayout);if(!this._getPriorityFilterBar()){return this._createDefaultFilterBar().then(function(){this._oFilterBarVBox.invalidate();return this._oContentLayout}.bind(this))}return this._oContentLayout}.bind(this))}.bind(this))};m.prototype.getListBinding=function(){var e=this.getTable();return e&&e.getRowBinding()};m.prototype._getListBindingInfo=function(){return this._oTableHelper&&this._oTableHelper.getListBindingInfo()};m.prototype.onBeforeShow=function(){return Promise.resolve(e.prototype.onBeforeShow.apply(this,arguments)).then(function(){var e=this.getTable();var t=e&&e.isTableBound()&&e._oTable.getShowOverlay();var i=e&&this._bRebindTable;if(i||t){e.rebind();this._bRebindTable=false}}.bind(this))};m.prototype.onShow=function(){if(this._oTable){P.call(this);var t=e.prototype._isSingleSelect.apply(this)?p.SingleMaster:p.Multi;if(this._oTable.getSelectionMode()===p.None){this._oTable.setSelectionMode(t)}if(this._oTable.getSelectionMode()!==t){throw new Error("Table selectionMode needs to be "+t)}}e.prototype.onShow.apply(this,arguments)};m.prototype._handleScrolling=function(e){return this._oTableHelper&&this._oTableHelper.handleScrolling.call(this,e)};m.prototype.getScrollDelegate=function(){if(!this.isTypeahead()&&this._oScrollContainer){return this._oScrollContainer.getScrollDelegate()}return e.prototype.getScrollDelegate.apply(this,arguments)};m.prototype._handleItemPress=function(e){this._oTableHelper.handleItemPress.call(this,e)};m.prototype._handleSelectionChange=function(e){if(!this._bSelectionIsUpdating){this._oTableHelper.handleSelectionChange.call(this,e)}};m.prototype.isQuickSelectSupported=function(){return true};m.prototype.setParent=function(t){e.prototype.setParent.apply(this,arguments);P.call(this)};m.prototype._isSingleSelect=function(){if(this._oTable){if(this._oTable.getSelectionMode()===p.Multi){return false}else{return true}}else{return e.prototype._isSingleSelect.apply(this,arguments)}};m.prototype.exit=function t(i){c.cleanup(this,["_oContentLayout","_oFilterBarVBox","_oTableBox","_oResourceBundle","_oScrollContainer","_oTableHelper","_bSelectionIsUpdating","_bScrolling","_bBusy","_sTableType","_oUITableSelectionPlugin","_oTable","_bRebindTable"]);e.prototype.exit.apply(this,arguments)};return m});