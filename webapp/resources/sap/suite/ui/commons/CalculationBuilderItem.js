sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/m/MessageBox","sap/base/security/encodeXML","./Utils","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable"],function(t,e,i,r,n,a){"use strict";var s=e.CalculationBuilderItemType,o=e.CalculationBuilderOperatorType,u=e.CalculationBuilderLogicalOperatorType;var l=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var p=i.extend("sap.suite.ui.commons.CalculationBuilderItem",{constructor:function(t,e){if(typeof t!=="string"&&t!==undefined){e=t}if(e&&e.key){e.key=this._sanitizeKey(e.key)}i.apply(this,arguments)},metadata:{library:"sap/suite/ui/commons",properties:{key:{type:"string",group:"Misc",defaultValue:null}}},renderer:{apiVersion:2,render:function(t,e){e._render(t)}}});p.prototype._innerRender=function(t,e){var i=this._bReadOnly?"sapMBtnDisabled":"",r=this._getLabel(),a={"!=":"NOT_EQUAL","-":"MINUS",",":"COMMA"};var s=function(t){t.openStart("div");t.class("sapCalculationBuilderItemFocusWrapper");t.openEnd();t.openStart("div");t.class("sapCalculationBuilderItemFocus");t.openEnd();t.close("div");t.close("div")};var o=function(t){t.openStart("div");t.class("sapCalculationBuilderItemExpandButtonWrapper");t.attr("title",l.getText("CALCULATION_BUILDER_EXPAND_BUTTON_TITLE"));t.openEnd();t.openStart("div");t.attr("id",this.getId()+"-expandbutton");t.class("sapCalculationBuilderItemExpandButton").class(i);t.attr("tabindex","-1");t.openEnd();if(!this._bReadOnly){t.openStart("div");t.class("sapCalculationBuilderItemExpandButtonFocus");t.openEnd();t.close("div")}u(t,"");t.close("div");t.close("div")}.bind(this);var u=function(t,e){t.openStart("span");t.attr("aria-hidden","true");t.attr("data-sap-ui-icon-content",e);t.class("sapCalculationBuilderEmptyItemIcon").class("sapUiIcon").class("sapUiIconMirrorInRTL").class("sapCalculationBuilderExpressionSAPFont");t.openEnd();t.close("span")};var p=function(t,e){t.attr("aria-label",l.getText(e))};t.openStart("div");t.class("sapCalculationBuilderItemContentWrapper");t.openEnd();t.openStart("div");t.attr("id",this.getId()+"-content");t.class("sapCalculationBuilderItemContent");if(this._bIsNew||this._isEmpty()){t.attr("title",l.getText("CALCULATION_BUILDER_NEW_ITEM_TITLE"))}else if(a[r]){p(t,"CALCULATION_BUILDER_"+a[r]+"_ARIA_LABEL")}t.attr("aria-haspopup","dialog");t.openEnd();s(t);if(this._isEmpty()){u(t,"");t.close("div")}else if(this._bIsNew){u(t,"");t.close("div")}else if(this._isFunction()){var c=this._getFunction();t.openStart("span");t.class("sapCalculationBuilderItemLabel").class("sapCalculationBuilderItemFunctionLabel");t.openEnd();t.unsafeHtml(n(c.title||this.getKey()));t.close("span");t.openStart("span");t.class("sapCalculationBuilderItemLabel").class("sapCalculationBuilderItemFunctionBracket");t.openEnd();t.unsafeHtml("(");t.close("span");t.close("div")}else{t.openStart("span");t.class("sapCalculationBuilderItemLabel");t.openEnd();t.unsafeHtml(n(r));t.close("span");t.close("div")}t.close("div");if(this._isVariable()&&this.isExpandable()){o(t)}if(e){t.flush(e)}};p.prototype._getClass=function(t,e,i){var r="",n=this._isEmpty();r+=this._bIsNew?"sapCalculationBuilderNewItem  sapCalculationBuilderCancelSelectable":"sapCalculationBuilderItem";if(n){r+=" sapCalculationBuilderNewItem "}if(this._isBracket()){r+=" sapCalculationBuilderItemBracket "}else if(this._isOperator()){r+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemOperatorLength-"+this._getLabel().length+" ";if(this._isLogicalOperator()){r+=" sapCalculationBuilderItemLogicalOperator "}}else if(this._isCustomOperator()){r+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemCustomOperator "}else if(this._isFunction()){r+=" sapCalculationBuilderItemFunction "}else if(this._isLiteral()){r+=" sapCalculationBuilderItemLiteral "}else if(this._isVariable()){r+=" sapCalculationBuilderItemVariable ";if(this.isExpandable()){r+=" sapCalculationBuilderItemVariableSeparator "}}else{r+=" sapCalculationBuilderUnknownItem "}if(t){r+=" sapCalculationBuilderItemErrorSyntax "}if(i){return r}var a=r.split(" "),s;for(s=0;s<a.length;s++){e.class(a[s])}};p.prototype._render=function(t){if(!this.getParent()){return}var e=this._hasCorrectParent(),i=this._getItemError(),r=this._getTooltip(),n=r?'"'+r+'"':"",a=this._bIsNew?"button":"",s=e?"-1":"0";t.openStart("div");this._getClass(!!i,t);t.attr("id",this.getId());t.attr("tabindex",s);t.attr("title",n);t.attr("role",a);t.openEnd();this._innerRender(t);t.close("div")};p.prototype.init=function(){this._bIsNew=false};p.prototype.onBeforeRendering=function(){this._oVariable=this.getVariable()};p.prototype.onAfterRendering=function(){this._afterRendering()};p.prototype._afterRendering=function(){var t=this.getParent();if(!t){return}this._setEvents();if(!this._bIsNew&&!this._bReadOnly){this._setupDraggable()}if(this._hasCorrectParent(t)){if(!t._bIsCalculationBuilderRendering){t._setupKeyboard();t.getParent()._enableOrDisableExpandAllButton()}}};p.prototype._setEvents=function(){if(this.isExpandable()){this.$("expandbutton").on("click",this._expandButtonPress.bind(this));this.$("expandbutton").on("mousedown",function(t){t.stopPropagation()})}if(!this._bReadOnly){this.$("content").on("click",this._buttonPress.bind(this))}if(this._isBracket()||this._isFunction()){this._setBracketHover()}};p.prototype._buttonPress=function(t){var e=this.getParent();if(this._hasCorrectParent(e)&&!e._bDragging){if(t.ctrlKey){e._selectItem(this.$())}else if(t.shiftKey){e._selectItemsTo(this.$())}else{e._deselect();e._openDialog({opener:this,currentItem:this})}}};p.prototype._expandButtonPress=function(t){if(!this._bReadOnly){this._openExpandConfirmMessageBox()}};p.prototype.isExpandable=function(){var t=this._oVariable?this._oVariable:this.getVariable();return t&&t.getItems().length>0};p.prototype.getVariable=function(){var t=this.getParent();return this._hasCorrectParent(t)&&t._getVariableByKey(this.getKey())};p.prototype.getType=function(){return this._getType()};p.prototype._setupDraggable=function(){var e=this.getParent(),i=e.$(),r=this.$();r.draggable({revert:"invalid",axis:"x",delay:100,cursor:"move",helper:function(t){var e=r.clone();e.addClass("sapCalculationBuilderDragging");e.css("pointer-events","none");return e},scope:e.getId()+"-scope",start:function(){i.find(".sapCalculationBuilderBracket").removeClass("sapCalculationBuilderBracket");i.find(".sapCalculationBuilderItemContent").css("cursor","move");t(this).addClass("sapCalculationBuilderDragging");e._bDragging=true;if(!t(this).hasClass("ui-selected")){e._deselect()}},stop:function(){t(this).removeClass("sapCalculationBuilderDragging");i.find(".sapCalculationBuilderItemContent").css("cursor","pointer");e._bDragging=false}});a._setupMobileDraggable(r)};p.prototype._setBracketHover=function(){var t=this.$("content"),e=this._isFunction()?o["("]:this.getKey(),i=e===o[")"],r=i?o["("]:o[")"],n;t.mouseenter(function(t){var a,s,o=0,u=this._hasCorrectParent()&&this.getParent().getItems()||[],l=i?u.length:0;for(;i?l>=0:l<u.length;i?l--:l++){a=u[l];if(a===this){s=true}if(s){if(a.getKey()===r||a._isFunction()&&i){o--;if(o===0){n=a;break}}else if(a.getKey()===e||a._isFunction()&&!i){o++}}}if(n){this.$().addClass("sapCalculationBuilderBracket");n.$().addClass("sapCalculationBuilderBracket")}}.bind(this));t.on("mouseleave",function(t){this.$().removeClass("sapCalculationBuilderBracket");if(n){n.$().removeClass("sapCalculationBuilderBracket")}}.bind(this))};p.prototype._expandVariable=function(t){var e=this.getParent(),i,r;if(e){i=e.getItems().indexOf(this);r=e._getVariableByKey(this.getKey());e.insertItem(new p({key:"("}),i++);r.getItems().forEach(function(t){e.insertItem(t._cloneItem(),i++)});e.insertItem(new p({key:")"}),i++);e.removeItem(this);if(t){e._aErrors=e._validateSyntax();e._fireChange()}}};p.prototype._cloneItem=function(){return new p({key:this.getKey()})};p.prototype._openExpandConfirmMessageBox=function(){r.show(l.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TEXT",this._getLabel()),{icon:r.Icon.WARNING,title:l.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TITLE"),actions:[r.Action.OK,r.Action.CANCEL],onClose:function(t){var e;if(t===r.Action.OK){this._expandVariable(true)}else{e=this.getParent();if(e){e._setCorrectFocus()}}}.bind(this)})};p.prototype._getItemError=function(){var e=this.getParent(),i;if(this._hasCorrectParent(e)){i=t.grep(e._aErrors,function(t){return t.index===this._iIndex}.bind(this))[0]}return i};p.prototype._getLabel=function(){var t=function(){var t=this._getItem();if(!t){return this.getKey()}if(t.title){return t.title}if(t._getLabel){return t._getLabel()}return t.getText()||t.getKey()}.bind(this);if(!this._sLabel){this._sLabel=t();if(this._isFunction()){this._sLabel+=" ("}}return this._sLabel};p.prototype._sanitizeKey=function(t){if(!t||typeof t!=="string"){return t}t=t.replace(/{/g,"&#125;");t=t.replace(/}/g,"&#123;");return t};p.prototype._reset=function(){this._sType="";this._sLabel="";this._oVariable=""};p.prototype.setKey=function(t,e){this._reset();this.setProperty("key",this._sanitizeKey(t),e);var i=this.getParent();if(i&&i._bRendered){i.getParent()&&i.getParent()._expressionChanged()}return this};p.prototype.getKey=function(){var t=this.getProperty("key");t=t.replace(/&#125;/g,"{");t=t.replace(/&#123;/g,"}");return t};p.prototype._getType=function(){var t=this.getParent();if(!this._sType&&t){this._sType=t._getType(this.getKey())}return this._sType};p.prototype._isEmpty=function(){return!this._bIsNew&&!this.getKey()};p.prototype._isOperator=function(){return this._getType()===s.Operator};p.prototype._isSecondaryOperator=function(){var t=this._getType();if(this._getType()===s.Operator){return["+","-","/","*","(",")",","].indexOf(this.getKey())===-1}return t===s.CustomOperator};p.prototype._isCustomOperator=function(){return this._getType()===s.CustomOperator};p.prototype._isVariable=function(){return this._getType()===s.Variable};p.prototype._isLiteral=function(){return this._getType()===s.Literal};p.prototype._isFunction=function(){var t=this._getType();return t===s.Function||t===s.CustomFunction};p.prototype._getFunction=function(){var t=this._getType();if(t===s.Function||t===s.CustomFunction){var e=this.getParent().getParent();return e._createFunctionObject(e._getFunctionDefinition(this.getKey()))}return null};p.prototype._getItemInstance=function(e,i){if(this._getType()===e){var r=this.getKey(),n=this.getParent()[i]();return t.grep(n,function(t){return t.getKey().toLowerCase()===r.toLowerCase()})[0]}return null};p.prototype._getItem=function(){var t=this._getType();switch(t){case s.Variable:return this._getVariable();case s.CustomFunction:return this._getCustomFunction();case s.CustomOperator:return this._getCustomOperator()}return null};p.prototype._getTooltip=function(){var t=this._getItem();return t&&t.getTooltip_AsString?t.getTooltip_AsString():""};p.prototype._getVariable=function(){return this._getItemInstance(s.Variable,"getVariables")};p.prototype._getCustomFunction=function(){return this._getItemInstance(s.CustomFunction,"getFunctions")};p.prototype._getCustomOperator=function(){return this._getItemInstance(s.CustomOperator,"getOperators")};p.prototype._isBracket=function(){return this._isOperator()&&(this.getKey()==="("||this.getKey()===")")};p.prototype._isAddition=function(){return this._isOperator()&&this.getKey()==="+"};p.prototype._isSubtraction=function(){return this._isOperator()&&this.getKey()==="-"};p.prototype._isDivision=function(){return this._isOperator()&&this.getKey()==="/"};p.prototype._isMultiplication=function(){return this._isOperator()&&this.getKey()==="*"};p.prototype._isComma=function(){return this._isOperator()&&this.getKey()===","};p.prototype._isLogicalOperator=function(){return this._isOperator()&&!!u[this.getKey()]};p.prototype._hasCorrectParent=function(t){t=t||this.getParent();return t instanceof sap.suite.ui.commons.CalculationBuilderExpression};return p});