/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/security/encodeURL","sap/ui/base/Object","sap/collaboration/components/utils/OdataUtil","sap/ui/thirdparty/jquery"],function(e,r,t,o,s){"use strict";var n=t.extend("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler",{constructor:function(r){this._oLogger=e.getLogger("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler");this._oOdataUtil=new o;this._oCollabModel=r;this._oExternalBObuffer={}},_requestsData:{getGroups:{url:function(e){return"/ExternalObjects('"+r(e)+"')/Groups"},urlParameters:function(){return{}},successLog:function(e,r){return"Groups were successfully retrieved."},errorLog:function(e){this._oLogger.error("Failed to retrieve groups: "+e.response.statusText)}},getExternalObjectByExidAndObjectType:{url:function(e,r,t){return t?t:"/ExternalObjects_FindByExidAndObjectType"},urlParameters:function(e,r){return{Exid:"'"+e.replace(/'/g,"''")+"'",ObjectType:"'"+r.replace(/'/g,"''")+"'",$expand:"FeedEntries/Creator"}},successLog:function(e,r){return"External object found: "+e.results.Name},errorLog:function(e){this._oLogger.error(e.response.statusText)}},getFeedEntries:{url:function(e,t){return t?t:"/ExternalObjects"+"('"+r(e)+"')/FeedEntries"},urlParameters:function(){return{$expand:"Creator/MemberProfile"}},successLog:function(e,r){return"Feed entries were successfully retrieved."},errorLog:function(e){this._oLogger.error("Failed to retrieve feed entries: "+e.response.statusText)}},getSuggestions:{url:function(){return"/Members_Autocomplete"},urlParameters:function(e,r){var t={Query:"'"+e+"'",$top:"4"};if(r){t.GroupId="'"+r+"'"}return t},successLog:function(e,r){return""},errorLog:function(e){this._oLogger.error("")}},getAtMentions:{url:function(e){return"/FeedEntries('"+r(e)+"')/AtMentions"},urlParameters:function(){return{}},successLog:function(e,r){return"@mentions were successfully retrieved."},errorLog:function(e){this._oLogger.error("Failed to retrieve the @mentions: "+e.response.statusText,e.stack)}},getReplies:{url:function(e,t){return t?t:"/FeedEntries('"+r(e)+"')/Replies"},urlParameters:function(){return{$orderby:"CreatedAt desc",$expand:"Creator"}},successLog:function(e,r){return"Replies were successfully retrieved."},errorLog:function(e){if(e.response){this._oLogger.error("Failed to retrieve replies: "+e.response.statusText,e.stack)}}}},_doAllTheThings:function(e,r){var t=this;var o=this._requestsData[e];var n=Array.prototype.slice.apply(arguments);n.shift();n.shift();var a=new s.Deferred;var i=function(e,r){t._oLogger.info(o.successLog.apply(t,[e,r]));a.resolve(e,r)};var u=function(e){o.errorLog.apply(t,[e]);a.reject(e)};var l=o.urlParameters.apply(t,n);if(Object.prototype.toString.apply(r)==="[object Object]"){for(var c in r){l[c]=r[c]}}var d={context:null,urlParameters:l,async:true,filters:[],sorters:[],success:i,error:u};return{request:this._oCollabModel.read(o.url.apply(t,n),d),promise:a.promise()}},getGroups:function(e,r,t){return this._doAllTheThings("getGroups",t,e,r)},getExternalObjectByExidAndObjectType:function(e,r){var t=e.ObjectType+e.Exid;this._oExternalBObuffer[t]=e;return this._doAllTheThings("getExternalObjectByExidAndObjectType",null,e.Exid,e.ObjectType,r)},getFeedEntries:function(e,r){return this._doAllTheThings("getFeedEntries",null,e,r)},getSuggestions:function(e,r){return this._doAllTheThings("getSuggestions",null,e,r)},getAtMentions:function(e){return this._doAllTheThings("getAtMentions",null,e)},getReplies:function(e,r){return this._doAllTheThings("getReplies",null,e,r)},getExternalObject:function(e){var r=this;var t=e.ObjectType+e.Exid;var o=s.Deferred();if(!this._oExternalBObuffer[t]){var n=this.postExternalObject(e);n.promise.done(function(e,s){var n=e.results;r._oExternalBObuffer[t]=n;o.resolve(n)});n.promise.fail(function(e){o.reject(e)})}else{o.resolve(this._oExternalBObuffer[t])}return o.promise()},getFeedEntryFromActivity:function(e){var t=this;var o="/Activities('"+r(e)+"')/FeedEntry";var n=s.Deferred();var a=function(e,r){n.resolve(e,r)};var i=function(e){t._oLogger.error("Failed to get the feed entry: "+e.response.statusText);n.reject(e)};var u={urlParameters:{$expand:"Creator"},async:true,success:a,error:i};this._oCollabModel.read(o,u);return n.promise()},getUserInfoBatch:function(e){var t=this;var o=[];e.forEach(function(e){var s="/Members_Autocomplete?Query='"+r(e)+"'&$expand=MemberProfile";var n="GET";var a=null;var i=null;o.push(t._oCollabModel.createBatchOperation(s,n,a,i))});this._oCollabModel.addBatchReadOperations(o);var n=true;var a=true;var i=s.Deferred();var u=function(e,r){var o=t._oOdataUtil.parseBatchResponse(e.__batchResponses);i.resolve(o,r)};var l=function(e){if(e.response.statusCode===403&&a){t._oCollabModel.refreshSecurityToken(function(){a=false;t._oCollabModel.addBatchReadOperations(o);t._oCollabModel.submitBatch(u,l,n)},function(e){t._oLogger.error("Failed to get member information: "+e.response.statusText);i.reject(e)},true)}else{t._oLogger.error("Failed to get member information: "+e.response.statusText);i.reject(e)}};return{request:this._oCollabModel.submitBatch(u,l,n),promise:i.promise()}},getAtMentionsBatch:function(e){var t=this;var o=10;var n=[];e.forEach(function(e,s){if(s<o){var a="/FeedEntries('"+r(e)+"')/AtMentions";var i="GET";var u=null;var l=null;n.push(t._oCollabModel.createBatchOperation(a,i,u,l))}});this._oCollabModel.addBatchReadOperations(n);var a=true;var i=true;var u=new s.Deferred;var l=function(e,r){var o=t._oOdataUtil.parseBatchResponse(e.__batchResponses);u.resolve(o,r)};var c=function(e){if(e.response.statusCode===403&&i){t._oCollabModel.refreshSecurityToken(function(){i=false;t._oCollabModel.addBatchReadOperations(n);t._oCollabModel.submitBatch(l,c,a)},function(e){t._oLogger.error("Failed to get the feeds @mentions: "+e.response.statusText);u.reject(e)},true)}else{t._oLogger.error("Failed to get the feeds @mentions: "+e.response.statusText);u.reject(e)}};return{request:this._oCollabModel.submitBatch(l,c,a),promise:u}},getSender:function(){var e=this;var r="/Self";var t=s.Deferred();var o=function(r,o){e._oLogger.info("The reply was successfully posted.");t.resolve(r.results)};var n=function(r){e._oLogger.error("Failed to retrieve the sender: "+r.response.statusText,r.stack);t.reject(r)};var a={urlParameters:null,async:true,success:o,error:n};return{request:this._oCollabModel.read(r,a),promise:t.promise()}},getGroupFeedEntries:function(e,t){var o=this;var n="";if(t){n=t}else{n="/Groups('"+r(e)+"')/FeedEntries"}var a=s.Deferred();var i=function(r,t){o._oLogger.info("The feed entries for the group '"+e+"' were retrieved.");a.resolve(r,t)};var u=function(r){o._oLogger.error("Failed to get feed entries for the group '"+e+"'.");a.reject(r)};var l={context:null,urlParameters:{$expand:"Group,Creator,TargetObjectReference"},async:true,success:i,error:u};return{request:this._oCollabModel.read(n,l),promise:a.promise()}},getGroupExternalObjectFeedEntries:function(e,t,o){var n=this;var a="";var i=s.Deferred();if(o){a=o}else{a="/GroupExternalObjects(GroupId='"+r(e)+"',ExternalObjectId='"+r(t)+"')/FeedEntries"}var u=function(r,o){n._oLogger.info("The feed entries for the group object wall was retrieved. Group Id is:'"+e+"', External Object Id is:"+t+".");i.resolve(r,o)};var l=function(r){n._oLogger.error("Failed to get feed entries for the group object wall. Group Id is:'"+e+"', External Object Id is:"+t+".");i.reject(r)};var c={context:null,urlParameters:{$expand:"Group,Creator,TargetObjectReference"},async:true,success:u,error:l};return{request:this._oCollabModel.read(a,c),promise:i.promise()}},addPostToExternalObject:function(e,r){var t=this;var o=this.postFeedEntryToObject(r,e).promise.then(function(e,r){var o=e.results;return t.getFeedEntryFromActivity(o.Id)}).then(function(e,r){var t=e.results;return t}).fail(function(e){return e});return o.promise()},postExternalObject:function(e){var r=this;var t="/ExternalObjects";var o=e;var n=s.Deferred();var a=function(e,t){r._oLogger.info("External object created. "+e.results.Name);n.resolve(e,t)};var i=function(e){r._oLogger.error("Failed to create external object: "+e.response.statusText);n.reject(e)};var u={context:null,urlParameters:null,async:true,success:a,error:i};return{request:this._oCollabModel.create(t,o,u),promise:n.promise()}},postFeedEntryToObject:function(e,r){var t=this;var o="/Activities";var n={};n.__metadata=e.__metadata;var a={Content:r,Object:n,Verb:"comment"};var i=true;var u=s.Deferred();var l=function(e,r){u.resolve(e,r)};var c=function(e){if(e.response.statusCode===403&&i){t._oCollabModel.refreshSecurityToken(function(){i=false;t._oCollabModel.create(o,a,d)},function(e){t._oLogger.error("Failed to get the activity: "+e.response.statusText);u.reject(e)},true)}else{t._oLogger.error("Failed to get the activity: "+e.response.statusText);u.reject(e)}};var d={context:null,urlParameters:null,async:true,success:l,error:c};return{request:this._oCollabModel.create(o,a,d),promise:u.promise()}},postReply:function(e,t){var o=this;var n="/FeedEntries('"+r(e)+"')/Replies";var a={Text:t};var i=true;var u=s.Deferred();var l=function(e,r){o._oLogger.info("The reply was successfully posted.");u.resolve(e)};var c=function(e){if(e.response.statusCode===403&&i){o._oCollabModel.refreshSecurityToken(function(){i=false;o._oCollabModel.create(n,a,d)},function(e){o._oLogger.error("Failed to post reply: "+e.response.statusText,e.stack);u.reject(e)},true)}else{o._oLogger.error("Failed to post reply: "+e.response.statusText,e.stack);u.reject(e)}};var d={context:null,urlParameters:null,async:true,success:l,error:c};return{request:this._oCollabModel.create(n,a,d),promise:u.promise()}},postGroupFeedEntry:function(e,t){var o=this;var n="/Groups('"+r(e)+"')/FeedEntries";var a={Text:t};var i=s.Deferred();var u=function(r,t){o._oLogger.info("Feed entry was successfully posted to Group '"+e+"'.");i.resolve(r,t)};var l=function(r){o._oLogger.error("Failed to post feed entry to group '"+e+"'.");i.reject(r)};var c={context:null,urlParameters:null,async:true,success:u,error:l};return{request:this._oCollabModel.create(n,a,c),promise:i.promise()}},postGroupExternalObjectFeedEntry:function(e,t,o){var n=this;var a="/GroupExternalObjects(GroupId='"+r(e)+"',ExternalObjectId='"+r(t)+"')/FeedEntries";var i={Text:o};var u=s.Deferred();var l=function(r,o){n._oLogger.info("Feed entry was successfully posted to group object wall. Group Id is:'"+e+"', External Object Id is:"+t+".");u.resolve(r,o)};var c=function(r){n._oLogger.error("Failed to post feed entry to group object wall. Group Id is:'"+e+"', External Object Id is:"+t+".");u.reject(r)};var d={context:null,urlParameters:null,async:true,success:l,error:c};return{request:this._oCollabModel.create(a,i,d),promise:u.promise()}},getFeedUpdatesLatestCount:function(e,r){var t=s.Deferred();var o="/ExternalObject_FeedLatestCount";var n={urlParameters:{LatestTopLevelId:"'"+e+"'",Id:"'"+r+"'"},success:function(e,r){t.resolve(e,r)},error:function(e){t.reject(e)}};return t.promise(this._oCollabModel.read(o,n))}});return n});