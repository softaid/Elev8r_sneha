/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
*/
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject","../utils/LanguageBundle","sap/ui/Device","sap/ui/core/Control","sap/ui/core/library","sap/ui/core/mvc/View","sap/ui/dom/includeStylesheet","sap/ui/model/json/JSONModel","sap/m/App","sap/m/Bar","sap/m/Button","sap/m/FeedListItem","sap/m/Label","sap/m/library","sap/m/Link","sap/m/List","sap/m/Page","sap/m/ResponsivePopover"],function(e,t,o,s,i,a,r,l,n,p,h,_,u,y,c,d,R,f,T){"use strict";var g=a.mvc.ViewType;var S=c.ListSeparators;var m=c.PlacementType;l(sap.ui.require.toUrl("sap/collaboration/components/resources/css/SocialProfile.css"));l(sap.ui.require.toUrl("sap/collaboration/components/resources/css/ReplyPopover.css"));var P=i.extend("sap.collaboration.components.controls.ReplyPopover",{metadata:{library:"sap.collaboration",events:{postReplyPress:{parameters:{value:{type:"string"}}},moreRepliesPress:{},afterClose:{}},aggregations:{socialTextArea:{type:"sap.collaboration.components.controls.SocialTextArea",multiple:false}}},renderer:null});P.prototype.init=function(){this._oLangBundle=new o;this._oJSONModelData=[];this._oJSONModel=new n(this._oJSONModelData);this._oControlToReceiveFocus;this._oSocialProfileView;this._oReplyApp;this._oReplyPage;this._oReplyTextArea;this._oReplyList;this._oReplyButton;this._oReplyHeaderBar;this._oReplyPopover=this._oReplyPopover||this._createReplyPopover()};P.prototype.exit=function(){if(this._oReplyPopover){this._oReplyPopover.destroy()}};P.prototype.addReply=function(e){if(!t(e)){if(e.Text){e.Text=this._replaceCarriageReturnWithBRTag(e.Text)}this._oJSONModelData.push(e);this._oJSONModel.setData(this._oJSONModelData,true)}else{this._oReplyTextArea.focus()}};P.prototype.addReplies=function(e){var t=e&&e.data;if(t&&t.length!==0){var o=this._oReplyList.getItems().length;var s=t.length;for(var i=0;i<t.length;i++){if(t[i].Text){t[i].Text=this._replaceCarriageReturnWithBRTag(t[i].Text);t[i].Text="‎"+t[i].Text+"‎"}}this._oJSONModelData=t.concat(this._oJSONModelData);this._oJSONModel.setData(this._oJSONModelData,true);if(o!==0){this._oControlToReceiveFocus=this._oReplyList.getItems()[s]}if(e.more){this._oShowMoreBar.setVisible(true)}else{this._oShowMoreBar.setVisible(false)}}};P.prototype.openBy=function(e){if(!this._oReplyTextArea){this._oReplyTextArea=this.getSocialTextArea();this._oReplyTextArea.addStyleClass("replyTextAreaToBottom").addStyleClass("replyTextArea");this._oControlToReceiveFocus=this._oReplyTextArea;this._oReplyPage.addContent(this._oShowMoreBar).addContent(this._addList()).addContent(this._oReplyTextArea);this._oReplyPopover.setInitialFocus(this._oReplyTextArea)}this._oReplyPopover.openBy(e);return this};P.prototype.setBusyIndicatorDelay=function(e){this._oReplyPage.setBusyIndicatorDelay(e);return this};P.prototype.setBusy=function(e){this._oReplyPage.setBusy(e);return this};P.prototype.getTextArea=function(){return this._oReplyTextArea};P.prototype._createReplyPopover=function(){var e=new T({showHeader:false,placement:m.Vertical,contentWidth:"25rem",contentHeight:"455px",content:this._addApp(),afterClose:[function(){this._oReplyApp.backToTop();this._oReplyList.destroyItems();this._oJSONModelData=[];this._oJSONModel.setData(this._oJSONModelData);this._oShowMoreBar.setVisible(false);this._oControlToReceiveFocus=this._oReplyTextArea;this.fireAfterClose()},this]});return e};P.prototype._addList=function(){var t=this;var o=new u({text:"{Text}",icon:"{Creator/ThumbnailImage}",sender:"{Creator/FullName}",timestamp:"{CreatedAt}",iconActive:false,senderPress:function(e){var o=e.getSource().getBindingContext().getObject();var s=o.Creator.Email;t._oSocialProfileView.getViewData().memberId=s;t._oSocialProfileView.rerender();t._oReplyApp.to(t._oSocialProfilePage)}}).addStyleClass("replyFeedListItem");if(!this._oReplyList){this._oReplyList=new R({width:"100%",items:[],noDataText:this._oLangBundle.getText("ST_REPLY_LIST_AREA"),showNoData:true,showSeparators:S.None,updateFinished:function(o){var s=t._oReplyList.getItems().length;if(s!==0&&t._oControlToReceiveFocus===t._oReplyTextArea){t._oReplyList.getItems()[s-1].focus()}if(t._oReplyList.getItems().length===0){t._oReplyTextArea.addStyleClass("replyTextAreaToBottom");t._oReplyTextArea._oPop.setOffsetX(0)}else{var i=e(t._oReplyList.getDomRef()).height();var a=e(t._oReplyPopover.getDomRef("cont")).height();var r=e(t._oReplyPage.getCustomHeader().getDomRef()).height();var l=parseInt(t._oReplyTextArea.getHeight());var n=e(t._oReplyPage.getFooter().getDomRef()).height();if(i>a-r-l-n){t._oReplyTextArea.removeStyleClass("replyTextAreaToBottom");t._oReplyTextArea._oPop.setOffsetX(9)}else{t._oReplyTextArea.addStyleClass("replyTextAreaToBottom");t._oReplyTextArea._oPop.setOffsetX(0)}}t._oControlToReceiveFocus.focus()}})}this._oReplyList.setModel(this._oJSONModel);this._oReplyList.bindItems({path:"/",template:o});return this._oReplyList};P.prototype._addSocialProfile=function(){var e=this;this._oSocialProfileView=new sap.ui.view({viewData:{langBundle:this._oLangBundle,popoverPrefix:this.getId(),afterUserInfoRetrieved:function(t){if(t){e._sUserProfileURL=t.WebURL}}},type:g.JS,viewName:"sap.collaboration.components.socialprofile.SocialProfile"});return this._oSocialProfileView};P.prototype.enableButton=function(e){this._oReplyButton.setEnabled(e)};P.prototype._addApp=function(){var e=this;if(this._oReplyApp){return this._oReplyApp}this._oReplyButton=new _({text:this._oLangBundle.getText("ST_REPLY_POST"),enabled:false,press:this._postReply.bind(e)});this._oShowMoreLink=new d({text:this._oLangBundle.getText("ST_SHOW_MORE_REPLIES"),press:this._showMoreReplies.bind(e)});this._oShowMoreBar=new h({contentMiddle:[this._oShowMoreLink],visible:false}).addStyleClass("showMoreReplies");this._oReplyPage=new f({showHeader:true,showSubHeader:false,showFooter:true,customHeader:new h({contentMiddle:[new y({text:this._oLangBundle.getText("ST_REPLY_TITLE")})]}),footer:new h({contentRight:[this._createMentionButton(),this._oReplyButton]})});this._oSocialProfileButton=new _({text:this._oLangBundle.getText("SP_OPEN_JAM_BUTTON"),press:function(){window.open(e._sUserProfileURL,"_blank")}});this._oSocialProfilePage=new f({title:this._oLangBundle.getText("SP_TITLE"),showNavButton:true,showHeader:true,showSubHeader:false,showFooter:true,navButtonPress:function(t){e._oReplyApp.back()},footer:new h({contentRight:[this._oSocialProfileButton]}),content:[this._addSocialProfile()]});this._oReplyApp=new p({backgroundColor:"#ffffff",pages:[this._oReplyPage,this._oSocialProfilePage]});return this._oReplyApp};P.prototype._createMentionButton=function(){if(s.system.phone){return}var e=new _({text:"@",tooltip:this._oLangBundle.getText("ST_MENTION_TOOLTIP"),press:[function(){this._oReplyTextArea.atMentionsButtonPressed()},this]});return e};P.prototype._replaceCarriageReturnWithBRTag=function(e){var t;if(typeof e==="string"){t=e.replace(/[\n\r]/g,"<br>")}return t};P.prototype._postReply=function(){var e=this._oReplyTextArea.convertTextWithFullNamesToEmailAliases();this.firePostReplyPress({value:e});this._oControlToReceiveFocus=this._oReplyTextArea};P.prototype._showMoreReplies=function(){this.fireMoreRepliesPress()};return P});