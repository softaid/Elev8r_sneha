// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/base/util/ObjectPath","sap/ui/core/Configuration","sap/ui/core/routing/History","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ushell/_ApplicationType/guiResolution","sap/ushell/_ApplicationType/systemAlias","sap/ushell/_ApplicationType/utils","sap/ushell/_ApplicationType/wdaResolution","sap/ushell/Config","sap/ushell/URLTemplateProcessor","sap/ushell/User","sap/ushell/utils"],function(e,t,a,n,r,s,i,o,p,l,u,c,f,d,m){"use strict";var h=new i(document.URL).search(true)["iframe-url"];function y(e,t,a){var n=e.inbound;var r=n&&n.resolutionResult;var s;if(n&&r){if(r["sap.wda"]){s=u.constructFullWDAResolutionResult(e,t,a)}else{s=u.constructWDAResolutionResult(e,t,a)}}if(s){s.then(function(t){M(e,t);return t})}return s}function v(e,t,a){return o.generateTRResolutionResult(e,t,a).then(function(t){M(e,t);return t})}function g(e,a,n){var r=new i(a);var s=e.inbound;var o=s&&s.resolutionResult;var u=t({},e.mappedIntentParamsPlusSimpleDefaults);var c;var f;if(u["sap-system"]){c=u["sap-system"][0];delete u["sap-system"]}if(u["sap-system-src"]){f=u["sap-system-src"][0];delete u["sap-system-src"]}return new Promise(function(t,a){p.spliceSapSystemIntoURI(r,o.systemAlias,c,f,"WCF",o.systemAliasSemantics||p.SYSTEM_ALIAS_SEMANTICS.applied,n).done(function(a){var n=l.getURLParsing().paramsToString(u),r=l.appendParametersToUrl(n,a.toString());var s={url:r,text:o.text||"",additionalInformation:o.additionalInformation||"",applicationType:"WCF",fullWidth:true};M(e,s);C(s,"WCF");t(s)}).fail(function(e){a(e)})})}function P(a,n,r){var s=a.inbound;var i={};["applicationType","additionalInformation","applicationDependencies"].forEach(function(e){if(s.resolutionResult.hasOwnProperty(e)){i[e]=s.resolutionResult[e]}});i.url=n;if(i.applicationDependencies&&typeof i.url==="undefined"){i.url=""}if(typeof i.url==="undefined"){i.url="";e.warning("The component url is undefined. We set it to empty string avoid rejection of the promise")}var o=t({},a.mappedIntentParamsPlusSimpleDefaults);i.reservedParameters={};var p={"sap-ui-fl-max-layer":true,"sap-ui-fl-control-variant-id":true,"sap-ui-fl-version":true};Object.keys(p).forEach(function(e){var t=o[e];if(t){delete o[e];i.reservedParameters[e]=t}});a.mappedDefaultedParamNames=a.mappedDefaultedParamNames.filter(function(e){return!p[e]});if(a.mappedDefaultedParamNames.length>0){o["sap-ushell-defaultedParameterNames"]=[JSON.stringify(a.mappedDefaultedParamNames)]}var u=o["sap-system"]&&o["sap-system"][0];var c=o["sap-system-src"]&&o["sap-system-src"][0];i["sap-system"]=u;if(typeof c==="string"){i["sap-system-src"]=c}a.effectiveParameters=o;var f=l.getURLParsing().paramsToString(o);if(f){i.url=i.url+(i.url.indexOf("?")<0?"?":"&")+f}if(typeof s.resolutionResult.ui5ComponentName!=="undefined"){i.ui5ComponentName=s.resolutionResult.ui5ComponentName}i.text=s.title;return Promise.resolve(i)}function S(t){var a=undefined;var n=window.hasher.getHash();var r=n.lastIndexOf("&/");var s=1;if(r>0){if(t&&t.capabilities&&t.capabilities.appFrameworkId==="UI5"){s=2}a=n.substring(r+s);try{if(a&&a.length>0){a=decodeURIComponent(a)}}catch(t){e.warning("inner route should be double encoded",t,"sap.ushell.ApplicationType.getInnerAppRoute")}}return a}function A(e){var t=e.targetNavigationMode;if(t===undefined||t===""){t="inplace"}return t}function R(){var e=window.hasher&&window.hasher.getHash();var t="";if(e&&e.length>0&&e.indexOf("sap-iapp-state=")>0){var a=/(?:sap-iapp-state=)([^&/\\]+)/.exec(e);if(a&&a.length===2){t=a[1]}}return t}function I(){return new Promise(function(e){Promise.all([sap.ushell.Container.getServiceAsync("UserInfo"),sap.ushell.Container.getServiceAsync("PluginManager"),m.getUi5VersionAsync()]).then(function(t){var a=t[0];var i=t[1];var o=t[2];var p=a.getUser();var l=p.getContentDensity()||(s("body").hasClass("sapUiSizeCompact")?"compact":"cozy");var u=p.getTheme();if(u.indexOf("sap_")!==0){var f=d.prototype.constants.themeFormat.THEME_NAME_PLUS_URL;u=p.getTheme(f)}var m=n.getLanguage&&n.getLanguage();var h=n.getSAPLogonLanguage&&n.getSAPLogonLanguage();var y=window.location.protocol+"//"+window.location.host+"/comsapuitheming.runtime/themeroot/v1";var v=0;if(c.last("/core/shell/sessionTimeoutIntervalInMinutes")>0){v=c.last("/core/shell/sessionTimeoutIntervalInMinutes")}e({language:m,logonLanguage:h,theme:u,themeServiceRoot:y,isDebugMode:!!window["sap-ui-debug"],ui5Version:o,contentDensity:l,sapPlugins:i._getNamesOfPluginsWithAgents(),innerAppState:R(),sessionTimeout:v,historyDirection:r.getInstance().getDirection()||""})})})}function w(e){var t;switch(e){case"inplace":t="embedded";break;case"explace":t="newWindow";break;default:t=e||"newWindow"}return t}function b(t,a){var n=w(t);var r=m.getMember(a,"sap|integration.navMode");switch(r){case"inplace":return"embedded";case"explace":if(n==="embedded"){return"newWindowThenEmbedded"}if(["newWindowThenEmbedded","newWindow"].indexOf(n)>=0){return n}e.error("App-defined navigation mode was ignored","Application requests to be opened in a new window but no expected navigation mode was defined on the template","sap.ushell.ApplicationType");default:return n}}function U(e,t,a){var n=m.clone(e);n.navigationMode=b(e.navigationMode,t);n.appId=a(e.appId||"");n.technicalAppComponentId=a(e.technicalAppComponentId||"");n.appSupportInfo=t["sap.app"]&&t["sap.app"].ach;n.appFrameworkId=e.appFrameworkId;delete n.urlTransformation;return n}function T(e,t,a){var n={appParams:{},system:undefined};if(a.mappedIntentParamsPlusSimpleDefaults){n.appParams=JSON.parse(JSON.stringify(a.mappedIntentParamsPlusSimpleDefaults))}var r=m.getMember(t,"sap|app.destination");if(typeof r==="string"&&r.length>0){n.system=e.systemAliases[r]&&JSON.parse(JSON.stringify(e.systemAliases[r]));if(typeof n.system==="object"){n.system.alias=r}}return n}function L(e,t,a){return new Promise(function(n,r){var s=new i(e);var o=s.query(true);var p=true;var l=["sap-language","sap-theme","sap-shell","sap-ui-app-id","transaction","sap-iframe-hint","sap-keep-alive","sap-ui-versionedLibCss","sap-wd-configId"];if(a&&a.mandatoryUrlParams){l=l.concat(a.mandatoryUrlParams.split(","));l=l.filter(function(e,t){return l.indexOf(e)===t})}if(t==="explace"){p=false}sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(t){t.compactParams(o,l,undefined,p).done(function(t){if(!t.hasOwnProperty("sap-intent-param")){n(e);return}var a;if(t["sap-theme"]){var r="sap-theme="+t["sap-theme"];t["sap-theme"]="sap-theme-temp-placeholder";s.query(t);a=s.toString();a=a.replace("sap-theme=sap-theme-temp-placeholder",r)}else{s.query(t);a=s.toString()}n(a)}).fail(function(e){r(e)})})})}function C(e,t){if(t){E(e,"sap-iframe-hint",t)}}function M(e,t){var a=e.intentParamsPlusAllDefaults;if(a&&a["sap-post"]&&a["sap-post"][0]==="false"){t.openWithPostByAppParam=false}}function x(e){var t=e.extendedInfo.appParams["sap-keep-alive"];if(t!==undefined){E(e,"sap-keep-alive",t[0])}}function D(e){var t=c.last("/core/spaces/enabled");if(t===true){E(e,"sap-spaces",t)}}function O(e,t,a){var n=m.getMember(t,"sap|integration.urlTemplateId");if(n==="urltemplate.url-dynamic"&&e.url.indexOf("sap-language=")===-1){E(e,"sap-language",a.env.language)}}function E(e,t,a){if(e.url){var n=e.url.indexOf("#");var r=e.url;var s="";if(n>0){r=e.url.slice(0,n);s=e.url.slice(n)}e.url=r+(r.indexOf("?")>=0?"&":"?")+t+"="+a+s}}function W(t,n,r){return new Promise(function(n){var r=t.inbound;var s=r.templateContext;var i=s.payload.capabilities||{};if(t.mappedIntentParamsPlusSimpleDefaults&&t.mappedIntentParamsPlusSimpleDefaults.hasOwnProperty("sap-ushell-innerAppRoute")){var o=window.hasher.getHash();if(t.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"].length>0&&o.indexOf("&/")===-1){o+="&/"+t.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"];window.hasher.replaceHash(o)}}var p={innerAppRoute:S(s.payload)||t.parsedIntent.appSpecificRoute,targetNavMode:A(t),defaultParameterNames:t.mappedDefaultedParamNames,startupParameter:t.mappedIntentParamsPlusSimpleDefaults};I().then(function(o){p.env=o;var l=a.get(["sap.integration","urlTemplateParams","query"],s.siteAppSection)||{};if(l.hasOwnProperty("sap-cssurl")){p.env.themeServiceRoot=undefined;p.env.theme=undefined}if(i.appFrameworkId==="UI5"&&p.startupParameter){for(var u in p.startupParameter){if(u!=="sap-ushell-innerAppRoute"){p.startupParameter[u][0]=encodeURIComponent(p.startupParameter[u][0])}}if(t.mappedDefaultedParamNames&&t.mappedDefaultedParamNames.length>0){p.startupParameter["sap-ushell-defaultedParameterNames"]=[JSON.stringify(t.mappedDefaultedParamNames)]}}var c="/universal_search/search?query=",d=p.innerAppRoute&&p.innerAppRoute.indexOf(c),y;if(d===0){y=p.innerAppRoute.substring(c.length);p.innerAppRoute="/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE"}var v=f.expand(s.payload,s.site,p,s.siteAppSection,"startupParameter");if(d===0){v=v.replace("/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE",c+encodeURIComponent(y))}if(p.env.theme===undefined){v=v.replace("&sap-theme=","")}if(i.appFrameworkId==="UI5"&&document.URL.indexOf("#")>0){var g=v.split("#"),P=g[1].split("&/"),S=sap.ushell.Container.getFLPUrl(true).split("#"),A=S[1].split("&/");v=g[0]+"#"+A[0]+(P.length>1?"&/"+P[1]:"");e.debug("- created URL with fixed hash: "+v,"sap.ushell.ApplicationType")}var R=function(e){var t=m.clone(s.payload);t.urlTemplate=e;return f.expand(t,s.site,p,s.siteAppSection,"startupParameter")};var I={applicationType:"URL",text:r.title,appCapabilities:U(i,s.siteAppSection,R),url:v,extendedInfo:T(s.site,s.siteAppSection,t),contentProviderId:r.contentProviderId||"",systemAlias:s.siteAppSection["sap.app"]&&s.siteAppSection["sap.app"].destination||s.siteAppSection.destination||""};C(I,I.appCapabilities.appFrameworkId);x(I);D(I);O(I,s.siteAppSection,p);var w=new Promise(function(e){sap.ushell.Container.getServiceAsync("URLTemplate").then(function(t){sap.ui.require(["sap/ushell/components/applicationIntegration/application/BlueBoxesCache"],function(a){var n=a.get(I.url)===undefined;t.handlePostTemplateProcessing(I.url,s.siteAppSection,n).then(e)})})});w.then(function(e){if(h&&e.indexOf("ui5appruntime.html")>0){var t=e.split("?");t[0]=h;e=t.join("?")}I.url=e;N(I.url,i,s).then(function(e){I.url=e;if(I.url&&typeof I.url==="string"&&I.url.indexOf("sap-iframe-hint=GUI")>0){n(I)}else{L(I.url,p.targetNavMode,i).then(function(e){I.url=e;n(I)},function(){n(I)})}})})})})}function N(t,n,r){return new Promise(function(s){var o=n.urlTransformation||{enabled:false};if(F(o,r)){var p=new i(t);var l=o.transformations[0];var u=l.service.uri;var c=f.prepareExpandData({urlTemplate:"",parameters:{names:u.queryOptions}},{},{urlComponent:{query:p.query(),fragment:p.fragment()}},r.siteAppSection,"");var d=i.expand("{+rootPath}/{+resourcePath}{?queryParams*}",{rootPath:u.rootPath,resourcePath:u.resourcePath,queryParams:c.oResolvedParameters}).toString();sap.ui.require(["sap/ui/thirdparty/datajs"],function(n){n.read({requestUri:d,headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}},function(n){var r=a.get("transformAppLaunchQueryString.value",n);if(r===undefined){r=a.get("transformAppLaunchIntent.value",n)}if(r===undefined){r=a.get("transformAppLaunchQueryString.queryString",n)}e.info("URL Transformation Succeeded",JSON.stringify({URLBeforeTransformation:t,URLAfterTransformation:r}),"sap.ushell.ApplicationType");var i=l.sourceURLComponent;if(i===undefined){i="query"}if(i==="query"||i==="fragment"){t=p[i].apply(p,[r]).toString()}else{e.error("The "+i+" component of the URL in URI.js is not transformed","","sap.ushell.ApplicationType")}s(t)},function(a){e.error("URL Transformation Failed",JSON.stringify(a),"sap.ushell.ApplicationType");s(t)})})}else{s(t)}})}function F(e,t){if(typeof e.enabled==="boolean"){return e.enabled}var a=f.prepareExpandData({urlTemplate:"",parameters:{names:{enabled:e.enabled}}},{},{},t.siteAppSection,"");return typeof a.oResolvedParameters.enabled==="boolean"?a.oResolvedParameters.enabled:false}function q(e,a,n){var r=e.inbound;var s=r&&r.resolutionResult;var o={};var u=new i(a);var f=t({},e.mappedIntentParamsPlusSimpleDefaults);if(e.inbound&&e.inbound.action==="launchURL"&&e.inbound.semanticObject==="Shell"){delete f["sap-external-url"]}var d=f["sap-system"]&&f["sap-system"][0];var m=f["sap-system-src"]&&f["sap-system-src"][0];o["sap-system"]=d;delete f["sap-system"];if(typeof m==="string"){o["sap-system-src"]=m;delete f["sap-system-src"]}return new Promise(function(e,t){if(l.absoluteUrlDefinedByUser(u,s.systemAlias,s.systemAliasSemantics)){e(a)}else{p.spliceSapSystemIntoURI(u,s.systemAlias,d,m,"URL",s.systemAliasSemantics||p.SYSTEM_ALIAS_SEMANTICS.applied,n).fail(t).done(function(t){var a=t.toString();e(a)})}}).then(function(e){var t=false,a,n=c.last("/core/navigation/flpURLDetectionPattern"),r=new RegExp(n);if(f&&f.hasOwnProperty("sap-params-append")){delete f["sap-params-append"];t=true}a=l.getURLParsing().paramsToString(f);return r.test(e)||t===true?l.appendParametersToIntentURL(f,e):l.appendParametersToUrl(a,e)},Promise.reject.bind(Promise)).then(function(e){["additionalInformation","applicationDependencies","systemAlias"].forEach(function(e){if(r.resolutionResult.hasOwnProperty(e)){o[e]=r.resolutionResult[e]}});o.url=e;o.text=r.title;o.applicationType="URL";return Promise.resolve(o)},Promise.reject.bind(Promise))}var j={URL:{type:"URL",defaultFullWidthSetting:true,generateResolutionResult:function(e){var t=e.inbound.hasOwnProperty("templateContext");return t?W.apply(null,arguments):q.apply(null,arguments)},easyAccessMenu:{intent:"Shell-startURL",resolver:null,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:false,systemSelectionPriority:1}},WDA:{type:"WDA",defaultFullWidthSetting:true,enableWdaCompatibilityMode:c.last("/core/navigation/enableWdaCompatibilityMode"),generateResolutionResult:y,easyAccessMenu:{intent:"Shell-startWDA",resolver:u.resolveEasyAccessMenuIntentWDA,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:2}},TR:{type:"TR",defaultFullWidthSetting:true,generateResolutionResult:v,easyAccessMenu:{intent:"Shell-startGUI",resolver:o.resolveEasyAccessMenuIntentWebgui,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:3}},NWBC:{type:"NWBC",defaultFullWidthSetting:true},WCF:{type:"WCF",generateResolutionResult:g,defaultFullWidthSetting:true},SAPUI5:{type:"SAPUI5",generateResolutionResult:P,defaultFullWidthSetting:false}};function k(){return Object.keys(j).map(function(e){return j[e]}).filter(function(e){return typeof e.easyAccessMenu==="object"})}function H(){var e={};k().forEach(function(t){e[t.easyAccessMenu.intent]=t.easyAccessMenu.resolver});return function(t,a){if(e[t]&&(!a||a!=="SAPUI5")){return e[t]}return null}}function _(e){return!!j[e]&&j[e].defaultFullWidthSetting}Object.defineProperty(j,"enum",{value:Object.keys(j).reduce(function(e,t){if(j[t].type){e[t]=j[t].type}return e},{})});var J={getEasyAccessMenuResolver:H(),getEasyAccessMenuDefinitions:k,getDefaultFullWidthSetting:_,handleURLTransformation:N};Object.keys(J).forEach(function(e){Object.defineProperty(j,e,{value:J[e]})});return j},false);