//Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils/HttpClient","sap/ui/thirdparty/URI","sap/base/util/isEmptyObject","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/Configuration"],function(e,t,r,n,s,i){"use strict";function o(r,n,o,a){this.fnSuccess=n;this.fnError=o;this.sUrl=r;this.oPromise=this._resolveDefaults(r,a).then(function(r){if(r){var n=i.getSAPLogonLanguage();var s=new t(r).escapeQuerySpace(false);if(n&&!s.hasQuery("sap-language")){s.addQuery("sap-language",n)}if(s.is("relative")){s=s.absoluteTo(location.href)}this.sBasePath=s.origin()+s.directory()+"/";this.sRequestPath=s.relativeTo(this.sBasePath).href();var o=this._getHeaders(r);this.oConfig={headers:o};this.oClient=new e(this.sBasePath,this.oConfig);this.refresh()}}.bind(this)).catch(function(e){s.error("Was not able to create a DynamicTileRequest:",e)})}o.prototype._getRequestUrl=function(){return this.sBasePath+this.sRequestPath};o.prototype.refresh=function(){if(!this.oRequest&&this.oClient){this.oRequest=this.oClient.get(this.sRequestPath).then(this._onSuccess.bind(this)).catch(this._onError.bind(this))}};o.prototype.abort=function(){if(this.oRequest&&this.oClient){this.oClient.abortAll();this.oRequest=null;return true}return false};o.prototype._onSuccess=function(e){var t;try{t=JSON.parse(e.responseText)}catch(e){throw new Error("Was not able to parse response of dynamic tile request")}this.oRequest=null;var r;if(typeof t==="object"){t=t.d?t.d:t;var s=n.fromURL(this.sRequestPath);if(s.get("$inlinecount")==="allpages"){r={number:t.__count}}else if(s.get("$count")==="true"){r={number:t["@odata.count"]}}else{r=this._extractData(t)}}else if(typeof t==="string"||typeof t==="number"){r={number:t}}this.fnSuccess(r)};o.prototype._onError=function(e){this.oRequest=null;this.fnError(e)};o.prototype._extractData=function(e){var t=["results","icon","title","number","numberUnit","info","infoState","infoStatus","targetParams","subtitle","stateArrow","numberState","numberDigits","numberFactor"];var n=Object.keys(e).reduce(function(r,n){if(t.indexOf(n)>-1){r[n]=e[n]}return r},{});if(!r(n)){return n}var s=Object.keys(e)[0];if(s!==undefined&&Object.keys(e).length===1){return Object.keys(e[s]).reduce(function(r,n){if(t.indexOf(n)>-1){r[n]=e[s][n]}return r},{})}return{}};o.prototype._getHeaders=function(e){var r={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":i.getLanguage()||"",Accept:"application/json, text/plain"};var n=i.getSAPLogonLanguage();if(n){r["sap-language"]=n}var s=sap.ushell.Container.getLogonSystem();var o=s&&s.getClient();var a=new t(e);if(o&&!a.protocol()){r["sap-client"]=o}return r};o.prototype._resolveDefaults=function(e,t){return sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return Promise.all([e.getSystemContext(t),sap.ushell.Container.getServiceAsync("ReferenceResolver")])}).then(function(t){var r=t[0];var n=t[1];return new Promise(function(t,s){n.resolveUserDefaultParameters(e,r).done(t).fail(s)})}).then(function(e){if(e.defaultsWithoutValue&&e.defaultsWithoutValue.length>0){s.error("The service URL contains User Default(s) with no set value: "+e.defaultsWithoutValue.join(", "));return}if(e.ignoredReferences&&e.ignoredReferences.length>0){s.error("The service URL contains invalid Reference(s): "+e.ignoredReferences.join(", "));return}return e.url})};o.prototype.destroy=function(){this.abort();this.fnError=null;this.fnSuccess=null};return o});