// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/container/ApplicationContainer","sap/ushell/components/applicationIntegration/application/PostMessageAPI","sap/ushell/utils","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ushell/UI5ComponentType","sap/base/Log","sap/base/util/ObjectPath"],function(e,t,r,i,n,a,s,o){"use strict";var p,l,u=e.getMetadata().getJSONKeys();function c(){var n=this;this.handleMessageEvent=function(t,i,a){var o=i.data;if(typeof o==="string"){try{o=JSON.parse(i.data)}catch(e){s.debug("Message received from origin '"+i.origin+"' cannot be parsed: "+e,o,"sap.ushell.components.container.ApplicationContainer");return}}if(o.action==="pro54_setGlobalDirty"&&localStorage.getItem(t.globalDirtyStorageKey)===sap.ushell.Container.DirtyState.PENDING){if(!e.prototype._isTrustedPostMessageSource(t,i)){s.warning("Received message from untrusted origin: "+i.origin,o,"sap.ushell.components.container.ApplicationContainer");return}s.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+t.globalDirtyStorageKey+" value: "+o.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");r.localStorageSetItem(t.globalDirtyStorageKey,o.parameters.globalDirty,true)}else{n.handleServiceMessageEvent(t,i,o,a)}};this.handleServiceMessageEvent=function(n,a,p,l){var u=o.get("sap-ushell-config.services.PostMessage.config")||o.create("sap-ushell-config.services.PostMessage.config"),c=p&&p.service,g,f,d,v,h=false,y=t.getAPIs(),m;s.debug("Received post message request from origin '"+a.origin+"': "+JSON.stringify(p),null,"sap.ushell.components.container.ApplicationContainer");if(p.type!=="request"||!c){return}for(var b in y){if(y.hasOwnProperty(b)){if(c.indexOf(b)!==-1){f=y[b];d=b;h=true;break}}}if(h===false){if(l.bPluginsStatusChecked===false||l.bKeepMessagesForPlugins===true){l.bApiRegistered=false}else{A("error",{code:-1,message:"Unknown service name: '"+p.service+"'"})}return}m=c.indexOf("user.postapi.")===0;g=c.split(".")[3];if(u&&u.enabled===false){s.warning("Received message for "+g+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return}if(!e.prototype._isTrustedPostMessageSource(n,a)){s.warning("Received message from untrusted origin '"+a.origin+"': "+JSON.stringify(a.data),null,"sap.ushell.components.container.ApplicationContainer");return}function S(e,t){var r;if(t===true){r={oMessage:a,oMessageData:p}}else{r={matchesLocalSid:M,getLocalSystemInSidForma:I,storeSapSystemData:R,executeSetBackNavigationService:C,sendResponseMessage:A,oMessage:a,oMessageData:p,oContainer:n}}try{e(r).done(function(e){A("success",{result:e})}).fail(function(e){A("error",{message:e})})}catch(e){A("error",{message:e.message})}}function A(e,t){var r=JSON.stringify({type:"response",service:p.service,request_id:p.request_id,status:e,body:t});s.debug("Sending post message response to origin ' "+a.origin+"': "+r,null,"sap.ushell.components.container.ApplicationContainer");if(typeof a.source!=="object"||a.source===null){s.debug("Cannot send response message to origin ' "+a.origin,"`source` member of request message is not an object","sap.ushell.components.container.ApplicationContainer");return}a.source.postMessage(r,a.origin)}function C(t,r){var a=new i.Deferred,s;if(r.body&&r.body.callbackMessage&&r.body.callbackMessage.service){s=e.prototype._backButtonPressedCallback.bind(null,t.source,r.body.callbackMessage.service,t.origin)}a.resolve(n.getShellUIService().setBackNavigation(s));return a.promise()}function R(e,t){var i,n,a,o=[e.id];if(arguments.length>1){o.unshift(t)}try{a=JSON.stringify(e)}catch(e){s.error("Cannot stringify and store expanded system data: "+e)}if(a){n=r.getLocalStorage();i=r.generateLocalStorageKey("sap-system-data",o);n.setItem(i,a)}}function I(){var e=sap.ushell.Container.getLogonSystem();var t=e.getName();var r=e.getClient();return"sid("+t+"."+r+")"}function M(e){return I().toLowerCase()===e.toLowerCase()}v=f.oServiceCalls[p.service.replace(d+".","")];if(v&&v.executeServiceCallFn){S(v.executeServiceCallFn,m)}else{A("error",{code:-1,message:"Unknown service name: '"+p.service+"'"})}};this.init=function(e){l=e};this.restoreArray=function(e){var t=[],r=0;while(e[r]){t.push(e[r]);r++}return t};this._createWaitForRendererCreatedPromise=function(){var e,t;t=sap.ushell.Container.getRenderer();if(t){s.debug("Shell controller._createWaitForRendererCreatedPromise: shell renderer already created, return empty array.");return[]}e=new Promise(function(e,r){var i;i=function(){s.info("Shell controller: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(i)};t=sap.ushell.Container.getRenderer();if(t){s.debug("Shell controller: resolving component waitFor promise immediately (shell renderer already created");e()}else{sap.ushell.Container.attachRendererCreatedEvent(i)}});return[e]};this.createComponent=function(e,t){var r=this,n=new i.Deferred;sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(i){i.createComponent(e,t,r._createWaitForRendererCreatedPromise(),a.Application).then(n.resolve,n.reject)});return n.promise()};this.stripURL=function(e){var t=e.indexOf("?"),r=e.indexOf("#"),i;if(t>=0){i=e.substr(0,t)}else if(r>=0){i=e.substr(0,r)}else{i=e}return i};this.createApplicationContainer=function(t,r){var i={};this._cleanTargetResolution(r,i);p=new e("application"+t,r);this._restoreTargetResolution(r,i);if(r.appCapabilities){p.setProperty("frameworkId",r.appCapabilities.appFrameworkId,true)}p.setHandleMessageEvent(this.handleMessageEvent);l.setAppCapabilities(p,r);return p};this.active=function(e){if(e){if(e.active){e.active()}}};this.restore=function(e){var t;if(e.container&&e.container._getIFrame&&e.container._getIFrame()!=undefined){this.postMessageToIframeApp(e.container,"sap.ushell.appRuntime","keepAliveAppShow",{},false)}if(e.app){sap.ui.getCore().getEventBus().publish("sap.ushell","appKeepAliveActivate",e.appTarget);if(e.app.getUrl){t=e.app.getUrl();p=l.get(this.stripURL(t));if(p){l.restoreApp(p.sApplication)}}if(e.app.isKeepAliveSupported&&e.app.isKeepAliveSupported()===true){e.app.activate()}else{if(e.app.restore){e.app.restore()}if(e.app.getRouter&&e.app.getRouter()&&e.app.getRouter().initialize){if(e.enableRouterRetrigger===false){e.app.getRouter().initialize()}else{e.app.getRouter().initialize(true)}}if(e.app.setInitialConfiguration){e.app.setInitialConfiguration()}}p=e.app}};this.store=function(e){var t;if(e.container&&e.container._getIFrame&&e.container._getIFrame()!=undefined){this.postMessageToIframeApp(e.container,"sap.ushell.appRuntime","keepAliveAppHide",{},false)}if(e.app){sap.ui.getCore().getEventBus().publish("sap.ushell","appKeepAliveDeactivate",e.appTarget);if(e.app.getUrl){t=e.app.getUrl();p=l.get(this.stripURL(t));if(p){l.storeApp(p.sApplication)}}if(e.app.isKeepAliveSupported&&e.app.isKeepAliveSupported()===true){e.app.deactivate()}else{if(e.app.suspend){e.app.suspend()}if(e.app.getRouter&&e.app.getRouter()){e.app.getRouter().stop()}}}};this.destroy=function(e){var t,r,i=false;if(e){if(e.getUrl){t=e.getUrl();r=l.get(this.stripURL(t));if(l.isStatefulContainerSupported(r)){i=true;l.destroyApp(r.sApplication)}}if(e.destroy&&i===false){try{e.destroy()}catch(t){s.error("exception when trying to close sapui5 application with id '"+(e.sId||"<unknown>")+"'. This error must be fixed in order for FLP to operate properly.\n",t.stack,"sap.ushell.components.applicationIntegration.application.Application::destroy")}}}};this.setActiveAppContainer=function(e){p=e};this.getActiveAppContainer=function(){return p}}c.prototype._cleanTargetResolution=function(e,t){var r;if(e){for(r in e){if(u[r]===undefined){t[r]=e[r];delete e[r]}}}};c.prototype._restoreTargetResolution=function(e,t){var r;if(e){for(r in t){e[r]=t[r]}}};c.prototype.getResponseHandler=function(e,r){return t.getResponseHandler(e,r)};c.prototype.isActiveOnly=function(e,r){return t.isActiveOnly(e,r)};c.prototype.isAppTypeSupported=function(e,r,i){var n=t._getPostMesageInterface(r,i);return this.isAppTypeSupportedByPolicy(e,n)};c.prototype.isAppTypeSupportedByPolicy=function(e,t){if(e&&e.getAdditionalInformation&&e.getAdditionalInformation().startsWith("SAPUI5.Component=")){return false}var r=t;if(!r||!r.distributionType){return false}if(r.distributionType.indexOf("all")>=0){return true}if(r.distributionType.indexOf("URL")>=0){return false}if(e.getApplicationType&&r.distributionType.indexOf(e.getApplicationType())>=0){return true}return false};c.prototype.postMessageToIframeApp=function(e,t,r,i,n){var a=t+"."+r,s=this.createPostMessageRequest(a,i);return this.postMessageToIframe(s,e,n)};c.prototype.createPostMessageRequest=function(e,t){var r=Date.now().toString();return{type:"request",request_id:r,service:e,body:t}};c.prototype.postMessageToIframe=function(e,t,r){var i=e.request_id,a=t._getIFrame();return new Promise(function(o,p){function l(t){var r;try{if(typeof t.data==="string"&&t.data.indexOf("{")===0){try{r=JSON.parse(t.data)}catch(e){r={}}}else{return}if(!r.request_id||i!==r.request_id){return}if(r.status==="success"){o(r)}else{p(r)}window.removeEventListener("message",l)}catch(r){o();s.warning("Obtained bad response from framework in response to message "+e.request_id);s.debug("Underlying framework returned invalid response data: '"+t.data+"'")}}var u=JSON.stringify(e);s.debug("Sending postMessage "+u+" to application container '"+t.getId()+"'");var c,g;if(!a){o()}else if(r){window.addEventListener("message",l,false);c=new n(t._getIFrameUrl(a));g=c.protocol()+"://"+c.host();a.contentWindow.postMessage(u,g)}else{c=new n(t._getIFrameUrl(a));g=c.protocol()+"://"+c.host();a.contentWindow.postMessage(u,g);o()}})};c.prototype.registerShellCommunicationHandler=function(e){t.registerShellCommunicationHandler(e)};c.prototype._getPostMesageInterface=function(e,r){return t._getPostMesageInterface(e,r)};return new c},true);