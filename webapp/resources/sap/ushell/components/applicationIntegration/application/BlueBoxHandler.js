// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/applicationIntegration/application/BlueBoxesCache","sap/ushell/components/applicationIntegration/application/Application","sap/ushell/components/container/ApplicationContainer","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/base/Log","sap/base/util/UriParameters","sap/base/security/encodeXML"],function(e,t,i,s,a,p,r,n){"use strict";function u(){var s=this,p,r={isStateful:{handler:function(e,t){if(e&&(e.enabled===true||e===true)){return true}return false}},isGUI:{handler:function(e,t){if(e&&e.protocol==="GUI"){return true}return false}},isGUIStateful:{handler:function(e,t){return s.isCapUT(t,"isGUI")&&s.isCapUT(t,"isStateful")}},isFLP:{handler:function(e,t){return!s.isCapUT(t,"isGUI")&&s.isCapUT(t,"isStateful")}}},n={},u={},o={setup:function(e,t){},create:function(e,s,p,r){var u=new a.Deferred,o,l;function f(){if(o){o["sap-flp-url"]=sap.ushell.Container.getFLPUrl(true);o["system-alias"]=e.getSystemAlias();l["sap-flp-params"]=o}sap.ui.getCore().getEventBus().publish("launchpad","appOpening",r);t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","create",l,true).then(function(){n[e].currentAppTarget=r;sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",r);u.resolve()})}s=i.prototype._checkNwbcUrlAdjustment(e,r.applicationType,s);l={sCacheId:p,sUrl:s,sHash:window.hasher.getHash()};if(s.indexOf("sap-iframe-hint=GUI")>0||s.indexOf("sap-iframe-hint=WDA")>0){var c=[];var h=i.prototype._getParamKeys(s,c);if(h.length>0){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){e.getAppStateData(h).then(function(e){o={};c.forEach(function(t,i){if(e[i][0]){o[t]=e[i][0]}});f()},function(){f()})})}else{o={};f()}}else{f()}return u.promise()},destroy:function(e,i){var s;sap.ushell.Container.setAsyncDirtyStateProvider(undefined);s=t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","destroy",{sCacheId:i},true);s.then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",n[e].currentAppTarget);n[e].currentAppTarget=undefined});return s},store:function(e,i){var s;sap.ushell.Container.setAsyncDirtyStateProvider(undefined);s=t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","store",{sCacheId:i},true);s.then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",n[e].currentAppTarget);n[e].currentAppTarget=undefined});return s},restore:function(e,i,s){var a;sap.ui.getCore().getEventBus().publish("launchpad","appOpening",s);a=t.postMessageToIframeApp(e,"sap.ushell.services.appLifeCycle","restore",{sCacheId:i,sUrl:s.url,sHash:window.hasher.getHash()},true);a.then(function(){n[e].currentAppTarget=s;sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",s)});return a}},l=[{service:"sap.ushell.services.appLifeCycle",action:"create"},{service:"sap.ushell.services.appLifeCycle",action:"destroy"}];this.init=function(i,s,r){e.init();t.init(this);p=r;if(s){u=a.extend(true,u,s.supportedTypes)}};this.isStatefulContainerSupported=function(e){var t=this.isCapabilitySupported(e,"sap.ushell.services.appLifeCycle","create")&&this.isCapabilitySupported(e,"sap.ushell.services.appLifeCycle","destroy");return t};this.isKeepAliveSupported=function(e){var t=this.isCapabilitySupported(e,"sap.ushell.services.appLifeCycle","store")&&this.isCapabilitySupported(e,"sap.ushell.services.appLifeCycle","restore");return t};this.isIframeIsValidSupported=function(e){return this.isCapabilitySupported(e,"sap.ushell.appRuntime","iframeIsValid")};this.isIframeBusySupported=function(e){return this.isCapabilitySupported(e,"sap.ushell.appRuntime","iframeIsBusy")};this.mapCapabilities=function(e,t){this.setCapabilities(e,t)};this.getCapabilities=function(e){return n[e].oCapMap};this.isCapabilitySupported=function(e,t,i){if(n[e]&&n[e].oCapMap&&n[e].oCapMap[t]){return!!n[e].oCapMap[t][i]}return false};this.setCapabilities=function(e,t){var i;if(!n[e]){this.initBlueBoxBD(e)}if(!n[e].oCapMap){n[e].oCapMap={}}i=n[e].oCapMap;Object.keys(t).forEach(function(e){var s=t[e],a;if(!i[s.service]){i[s.service]={}}a=i[s.service];a[s.action]=true});if(!e.getIsStateful()&&this.isStatefulContainerSupported(e)){e.setIsStateful(true)}};this.removeCapabilities=function(e){if(n[e]){n[e].oCapMap={};e.setIsStateful(false)}};this.hasIFrame=function(e){if(e&&e._getIFrame){return true}return false};this.initBlueBoxBD=function(e){n[e]={BlueBox:e}};this.setAppCapabilities=function(e,t){if(!n[e]){this.initBlueBoxBD(e)}n[e].currentAppTarget=t;n[e].appCapabilities=t.appCapabilities;if(t.appCapabilities&&t.appCapabilities.statefulContainer===true){this.setCapabilities(e,l)}};this.forEach=function(e){var t;for(t in n){if(n.hasOwnProperty(t)){e(n[t].BlueBox)}}};this.isCapByTarget=function(e,t){if(e.appCapabilities===undefined){return false}if(r[t]&&e&&e.appCapabilities){return r[t].handler(e.appCapabilities)}return e.appCapabilities[t]||false};this.isCapUT=function(e,t){var i=n[e];if(i===undefined||i.appCapabilities===undefined){return false}if(r[t]&&i){return r[t].handler(i.appCapabilities,e)}return i.appCapabilities[t]||false};this.setStorageKey=function(e,t){if(!n[e]){this.initBlueBoxBD(e)}n[e].sStorageKey=t};this.getStorageKey=function(e){if(!n[e]){return undefined}return n[e].sStorageKey};this.getHandler=function(){return o};this._getBlueBoxCacheKey=function(t){return e.getBlueBoxCacheKey(t)};this.deleteStateFul=function(e){return this.delete(e)};this.getStateFul=function(t){return e.get(t)};this.destroyApp=function(e){p.postMessageToIframeApp("sap.ushell.services.appLifeCycle","destroy",{appId:e})};this.openApp=function(e){p.postMessageToIframeApp("sap.ushell.services.appLifeCycle","create",{appId:e,sHash:window.hasher.getHash()})};this.storeApp=function(e){p.postMessageToIframeApp("sap.ushell.services.appLifeCycle","store",{appId:e,sHash:window.hasher.getHash()})};this.restoreApp=function(e){p.postMessageToIframeApp("sap.ushell.services.appLifeCycle","restore",{appId:e,sHash:window.hasher.getHash()})};this.delete=function(t){e.remove(t)};this.get=function(t){return e.get(t)};this.getById=function(t){return e.getById(t)};this.set=function(t,i){e.add(t,i)}}return new u},true);