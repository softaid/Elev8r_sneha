// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/generic","sap/m/library","sap/suite/ui/microchart/AreaMicroChartItem","sap/suite/ui/microchart/AreaMicroChartPoint","sap/ui/thirdparty/jquery"],function(e,i,a,t,l){"use strict";var r=i.FrameType;var s=i.LoadState;var o=e.extend("sap.ushell.components.tiles.indicatorArea.AreaChartTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false},doProcess:function(e,i){this.onAfterFinalEvaluation(e,i)},doDummyProcess:function(){var e=this;this.setTextInTile();e._updateTileModel({footer:"",description:"",width:"100%",height:"100%",chart:{color:"Good",data:[{day:0,balance:0},{day:30,balance:20},{day:60,balance:20},{day:100,balance:80}]},target:{color:"Error",data:[{day:0,balance:0},{day:30,balance:30},{day:60,balance:40},{day:100,balance:90}]},maxThreshold:{color:"Good",data:[{day:0,balance:0},{day:30,balance:40},{day:60,balance:50},{day:100,balance:100}]},innerMaxThreshold:{color:"Error",data:[]},innerMinThreshold:{color:"Neutral",data:[]},minThreshold:{color:"Error",data:[{day:0,balance:0},{day:30,balance:20},{day:60,balance:30},{day:100,balance:70}]},minXValue:0,maxXValue:100,minYValue:0,maxYValue:100,firstXLabel:{label:"June 123",color:"Error"},lastXLabel:{label:"June 30",color:"Error"},firstYLabel:{label:"0M",color:"Good"},lastYLabel:{label:"80M",color:"Critical"},minLabel:{},maxLabel:{}});this.oKpiTileView.oGenericTile.setState(s.Loaded)},scheduleJob:function(e){if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible())}},onAfterFinalEvaluation:function(e,i){var o=this;var n=this.DEFINITION_DATA.EVALUATION.ODATA_ENTITYSET;var c=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;var u=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.DEFINITION_DATA.EVALUATION_FILTERS,this.DEFINITION_DATA.ADDITIONAL_FILTERS);var h=this.DEFINITION_DATA.TILE_PROPERTIES.dimension;if(h==undefined){this.logError();return}var E=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;var T=this.DEFINITION_DATA.EVALUATION_VALUES;var d=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(o.oConfig.TILE_PROPERTIES.id);if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(o.oConfig)){if(d){var f=d.Data&&JSON.parse(d.Data)}}var g=o.oTileApi.configuration.getParameterValueAsString("timeStamp");var m=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(o.oConfig.TILE_PROPERTIES.id,g,o.chipCacheTime,o.chipCacheTimeUnit,o.tilePressed);var p=c;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(E){case"MI":o.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"WH","MEASURE");o.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"CH","MEASURE");o.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"TA","MEASURE");o.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"TC","MEASURE");if(o.sWarningHigh&&o.sCriticalHigh&&o.sTarget){p+=","+o.sWarningHigh+","+o.sCriticalHigh+","+o.sTarget}break;case"MA":o.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"WL","MEASURE");o.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"CL","MEASURE");o.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"TA","MEASURE");o.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"TC","MEASURE");if(o.sWarningLow&&o.sCriticalLow&&o.sTarget){p+=","+o.sWarningLow+","+o.sCriticalLow+","+o.sTarget}break;case"RA":o.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"WH","MEASURE");o.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"CH","MEASURE");o.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"TA","MEASURE");o.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"TC","MEASURE");o.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"WL","MEASURE");o.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(o.oConfig,"CL","MEASURE");if(o.sWarningLow&&o.sCriticalLow&&o.sTarget&&o.sWarningHigh&&o.sCriticalHigh){p+=","+o.sWarningLow+","+o.sCriticalLow+","+o.sTarget+","+o.sWarningHigh+","+o.sCriticalHigh}break}}var C=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(e);if(f&&!f.rightData||!d||!m&&o.oTileApi.visible.isVisible()||C||i&&o.oTileApi.visible.isVisible()||o.getView().getViewData().refresh){if(o.kpiValueFetchDeferred){o.kpiValueFetchDeferred=false;var A=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(o.oRunTimeODataModel,n,p,h,u);if(A){this.queryUriForTrendChart=A.uri;var L={};try{this.trendChartODataReadRef=A.model.read(A.uri,null,null,true,function(e){o.kpiValueFetchDeferred=true;if(e&&e.results&&e.results.length){if(A.unit[0]){o.unit=e.results[0][A.unit[0].name];o.CURRENCY_CODE=o.unit;L.unit=A.unit[0];L.unit.name=A.unit[0].name}o.queryUriResponseForTrendChart=e;h=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(o.oRunTimeODataModel,n,h);e.results.splice(10);e.firstXlabel=e.results[0][h];e.lastXlabel=e.results[e.results.length-1][h];L.data=e;if(L&&L.data&&L.data.results&&L.data.results.length){for(var i=0;i<L.data.results.length;i++){delete L.data.results[i].__metadata}}L.isCurM=o.isCurrencyMeasure(o.oConfig.EVALUATION.COLUMN_NAME);L.dimensionName=h;U(e,o.DEFINITION_DATA.EVALUATION.VALUES_SOURCE);var a={};o.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();a.ChipId=o.oConfig.TILE_PROPERTIES.id;a.Data=JSON.stringify(L);a.CacheMaxAge=Number(o.chipCacheTime);a.CacheMaxAgeUnit=o.chipCacheTimeUnit;a.CacheType=1;var t=o.getLocalCache(a);if(o.DEFINITION_DATA.TILE_PROPERTIES.frameType==r.TwoByOne){var c=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(o.oConfig.TILE_PROPERTIES.id),u;if(c){if(!c.CachedTime){c.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()}u=c.Data;if(u){u=JSON.parse(u);u.rightData=L}c.Data=JSON.stringify(u);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(o.oConfig.TILE_PROPERTIES.id,c)}else{u={};u.rightData=L;t.Data=JSON.stringify(u);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(o.oConfig.TILE_PROPERTIES.id,t)}o.cacheWriteData=L;o.getView().getViewData().deferredObj.resolve()}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(o.oConfig.TILE_PROPERTIES.id,t);var E=false;if(d){E=true}if(o.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(o.oTileApi,o.oConfig.TILE_PROPERTIES.id,a,E,function(e){if(e){o.cacheTime=e&&e.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(o.oConfig.TILE_PROPERTIES.id,e);o.setTimeStamp()}if(o.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(o.oConfig)){l.proxy(o.setTimeStamp(o.cacheTime),o)}})}o.oKpiTileView.oGenericTile.setState(s.Loaded);o.updateDatajobScheduled=false;var T=o.oConfig.TILE_PROPERTIES.id+"data";var f=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(T);if(f){clearTimeout(f);f=undefined}l.proxy(o.scheduleJob(o.cacheTime),o)}}else{o.setNoData()}},function(e){o.kpiValueFetchDeferred=true;if(e&&e.response){o.logError("Data call failed")}})}catch(e){o.kpiValueFetchDeferred=true;o.logError(e)}}else{o.kpiValueFetchDeferred=true;o.logError()}}}else if(d&&d.Data){try{var N;var I=o.oConfig&&o.oConfig.TILE_PROPERTIES&&o.oConfig.TILE_PROPERTIES.tileType;if(I.indexOf("DT-")==-1){N=d.Data&&JSON.parse(d.Data)}else{N=d.Data&&JSON.parse(d.Data);N=N.rightData}if(N.unit){o.unit=N.data.results[0][N.unit.name];o.CURRENCY_CODE=o.unit}o.cacheTime=d.CachedTime;if(o.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(o.oConfig)){l.proxy(o.setTimeStamp(o.cacheTime),o)}o.queryUriResponseForTrendChart=N.data;h=N.dimensionName;U(N.data,o.DEFINITION_DATA.EVALUATION.VALUES_SOURCE);if(o.oConfig.TILE_PROPERTIES.frameType==r.OneByOne){o.oKpiTileView.oGenericTile.setState(s.Loaded)}else{o.getView().getViewData().deferredObj.resolve()}l.proxy(o.scheduleJob(o.cacheTime),o)}catch(e){o.logError(e)}}else{o.setNoData()}function U(e,i){var l=[];var r=[];var s=[];var n=[];var u=[];var d=[];var f=e.firstXlabel;var g,m,p,C,A;var L=e.lastXlabel;var N=Number(e.results[0][c]);var I=Number(e.results[e.results.length-1][c]);var U;for(U in e.results){e.results[U][h]=Number(U);e.results[U][c]=Number(e.results[U][c]);if(o.sWarningHigh){e.results[U][o.sWarningHigh]=Number(e.results[U][o.sWarningHigh])}if(o.sCriticalHigh){e.results[U][o.sCriticalHigh]=Number(e.results[U][o.sCriticalHigh])}if(o.sCriticalLow){e.results[U][o.sCriticalLow]=Number(e.results[U][o.sCriticalLow])}if(o.sWarningLow){e.results[U][o.sWarningLow]=Number(e.results[U][o.sWarningLow])}if(o.sTarget){e.results[U][o.sTarget]=Number(e.results[U][o.sTarget])}if(o.sWarningHigh){s.push(e.results[U][o.sWarningHigh])}if(o.sCriticalHigh){n.push(e.results[U][o.sCriticalHigh])}if(o.sCriticalLow){u.push(e.results[U][o.sCriticalLow])}if(o.sWarningLow){d.push(e.results[U][o.sWarningLow])}l.push(e.results[U][h]);r.push(e.results[U][c])}try{f=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(f);L=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(L)}catch(e){o.logError(e)}var b=Number(N);if(o.oConfig.EVALUATION.SCALING==-2){b*=100}var M=Math.min.apply(Math,r);var S=o.isCurrencyMeasure(o.oConfig.EVALUATION.COLUMN_NAME);var D=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(b,o.oConfig.EVALUATION.SCALING,o.oConfig.EVALUATION.DECIMAL_PRECISION,S,o.CURRENCY_CODE);if(o.oConfig.EVALUATION.SCALING==-2){D+=" %"}var w=D.toString();var R=Number(I);if(o.oConfig.EVALUATION.SCALING==-2){R*=100}var O=Math.max.apply(Math,r);S=o.isCurrencyMeasure(o.oConfig.EVALUATION.COLUMN_NAME);var v=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(R,o.oConfig.EVALUATION.SCALING,o.oConfig.EVALUATION.DECIMAL_PRECISION,S,o.CURRENCY_CODE);if(o.oConfig.EVALUATION.SCALING==-2){v+=" %"}var V=v.toString();try{var H=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(Math.min.apply(Math,l));var y=sap.ushell.components.tiles.indicatorTileUtils.util.formatOdataObjectToString(Math.max.apply(Math,l))}catch(e){o.logError(e)}if(i=="MEASURE"){if(s.length!=0){o.firstwH=s[H];o.lastwH=s[y]}if(n.length!=0){o.firstcH=n[H];o.lastcH=n[y]}if(u.length!=0){o.firstcL=u[H];o.lastcL=u[y]}if(d.length!=0){o.firstwL=d[H];o.lastwL=d[y]}}var F={width:"100%",height:"100%",unit:o.unit||"",chart:{color:"Neutral",data:e.results},size:"Auto",minXValue:H,maxXValue:y,minYValue:M,maxYValue:O,firstXLabel:{label:f+"",color:"Neutral"},lastXLabel:{label:L+"",color:"Neutral"},firstYLabel:{label:w+"",color:"Neutral"},lastYLabel:{label:V+"",color:"Neutral"},minLabel:{},maxLabel:{}};var P;switch(E){case"MA":for(U in T){if(T[U].TYPE=="CL"){F.minThreshold={color:"Error"};P={};P[h]="";P[c]=Number(T[U].FIXED);o.cl=Number(T[U].FIXED);F.minThreshold.data=i=="MEASURE"?e.results:[P];g=i=="MEASURE"?o.sCriticalLow:c}else if(T[U].TYPE=="WL"){F.maxThreshold={color:"Good"};P={};P[h]="";P[c]=Number(T[U].FIXED);F.maxThreshold.data=i=="MEASURE"?e.results:[P];m=i=="MEASURE"?o.sWarningLow:c;o.wl=Number(T[U].FIXED)}else if(T[U].TYPE=="TA"){P={};P[h]="";P[c]=Number(T[U].FIXED);F.target={color:"Neutral"};F.target.data=i=="MEASURE"?e.results:[P];A=i=="MEASURE"?o.sTarget:c}}F.innerMinThreshold={data:[]};F.innerMaxThreshold={data:[]};if(i=="FIXED"){F.firstYLabel.color=N<o.cl?"Error":o.cl<=N&&N<=o.wl?"Critical":N>o.wl?"Good":"Neutral";F.lastYLabel.color=I<o.cl?"Error":o.cl<=I&&I<=o.wl?"Critical":I>o.wl?"Good":"Neutral"}else if(i=="MEASURE"&&o.firstwL&&o.lastwL&&o.firstcL&&o.lastcL){F.firstYLabel.color=N<o.firstcL?"Error":o.firstcL<=N&&N<=o.firstwL?"Critical":N>o.firstwL?"Good":"Neutral";F.lastYLabel.color=I<o.lastcL?"Error":o.lastcL<=I&&I<=o.lastwL?"Critical":I>o.lastwL?"Good":"Neutral"}break;case"MI":for(U in T){if(T[U].TYPE=="CH"){P={};P[h]="";P[c]=Number(T[U].FIXED);o.ch=Number(T[U].FIXED);F.maxThreshold={color:"Error"};F.maxThreshold.data=i=="MEASURE"?e.results:[P];m=i=="MEASURE"?o.sCriticalHigh:c}else if(T[U].TYPE=="WH"){P={};P[h]="";P[c]=Number(T[U].FIXED);o.wh=Number(T[U].FIXED);F.minThreshold={color:"Good"};F.minThreshold.data=i=="MEASURE"?e.results:[P];g=i=="MEASURE"?o.sWarningHigh:c}else if(T[U].TYPE=="TA"){P={};P[h]="";P[c]=Number(T[U].FIXED);F.target={color:"Neutral"};F.target.data=i=="MEASURE"?e.results:[P];A=i=="MEASURE"?o.sTarget:c}}if(i=="FIXED"){F.firstYLabel.color=N>o.ch?"Error":o.wh<=N&&N<=o.ch?"Critical":N<o.wh?"Good":"Neutral";F.lastYLabel.color=I>o.ch?"Error":o.wh<=I&&I<=o.ch?"Critical":I<o.wh?"Good":"Neutral"}else if(i=="MEASURE"&&o.firstwH&&o.lastwH&&o.firstcH&&o.lastcH){F.firstYLabel.color=N>o.firstcH?"Error":o.firstwH<=N&&N<=o.firstcH?"Critical":N<o.firstwH?"Good":"Neutral";F.lastYLabel.color=I>o.lastcH?"Error":o.lastwH<=I&&I<=o.lastcH?"Critical":I<o.lastwH?"Good":"Neutral"}F.innerMaxThreshold={data:[]};F.innerMinThreshold={data:[]};break;case"RA":for(U in T){if(T[U].TYPE=="CH"){P={};P[h]="";P[c]=Number(T[U].FIXED);o.ch=Number(T[U].FIXED);F.maxThreshold={color:"Error"};F.maxThreshold.data=i=="MEASURE"?e.results:[P];m=i=="MEASURE"?o.sCriticalHigh:c}else if(T[U].TYPE=="WH"){P={};P[h]="";P[c]=Number(T[U].FIXED);o.wh=Number(T[U].FIXED);F.innerMaxThreshold={color:"Good"};F.innerMaxThreshold.data=i=="MEASURE"?e.results:[P];C=i=="MEASURE"?o.sWarningHigh:c}else if(T[U].TYPE=="WL"){P={};P[h]="";P[c]=Number(T[U].FIXED);o.wl=Number(T[U].FIXED);F.innerMinThreshold={color:"Good"};F.innerMinThreshold.data=i=="MEASURE"?e.results:[P];p=i=="MEASURE"?o.sWarningLow:c}else if(T[U].TYPE=="CL"){P={};P[h]="";P[c]=Number(T[U].FIXED);o.cl=Number(T[U].FIXED);F.minThreshold={color:"Error"};F.minThreshold.data=i=="MEASURE"?e.results:[P];g=i=="MEASURE"?o.sCriticalLow:c}else if(T[U].TYPE=="TA"){P={};P[h]="";P[c]=Number(T[U].FIXED);F.target={color:"Neutral"};F.target.data=i=="MEASURE"?e.results:[P];A=i=="MEASURE"?o.sTarget:c}}if(i=="FIXED"){F.firstYLabel.color=N>o.ch||N<o.cl?"Error":o.wh<=N&&N<=o.ch||o.cl<=N&&N<=o.wl?"Critical":N>=o.wl&&N<=o.wh?"Good":"Neutral";F.lastYLabel.color=I>o.ch||I<o.cl?"Error":o.wh<=I&&I<=o.ch||o.cl<=I&&I<=o.wl?"Critical":I>=o.wl&&I<=o.wh?"Good":"Neutral"}else if(i=="MEASURE"&&o.firstwL&&o.lastwL&&o.firstcL&&o.lastcL&&o.firstwH&&o.lastwH&&o.firstcH&&o.lastcH){F.firstYLabel.color=N>o.firstcH||N<o.firstcL?"Error":o.firstwH<=N&&N<=o.firstcH||o.firstcL<=N&&N<=o.firstwL?"Critical":N>=o.firstwL&&N<=o.firstwH?"Good":"Neutral";F.lastYLabel.color=I>o.lastcH||I<o.lastcL?"Error":o.lastwH<=I&&I<=o.lastcH||o.lastcL<=I&&I<=o.lastwL?"Critical":I>=o.lastwL&&I<=o.lastwH?"Good":"Neutral"}break}var _=function(e,i,l,r){return new a({color:"{/"+e+"/color}",points:{path:"/"+e+"/data",template:new t({x:"{"+i+"}",y:"{"+l+"}"})}})};var Y=o.getView().oNVConfContS;Y.setTarget(_("target",h,A));Y.setInnerMinThreshold(_("innerMinThreshold",h,p));Y.setInnerMaxThreshold(_("innerMaxThreshold",h,C));Y.setMinThreshold(_("minThreshold",h,g));Y.setMaxThreshold(_("maxThreshold",h,m));Y.setChart(_("chart",h,c));o.setTextInTile();if(o.getView().getViewData().parentController){o.getView().getViewData().parentController._updateTileModel(F)}else{o._updateTileModel(F)}}}});return o});