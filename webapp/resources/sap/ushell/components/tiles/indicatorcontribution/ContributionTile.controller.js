// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/generic","sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],function(e,i,t,a){"use strict";var l=i.DeviationIndicator;var o=i.ValueColor;var s=i.Size;var n=i.LoadState;var r=i.FrameType;var T=e.extend("sap.ushell.components.tiles.indicatorcontribution.ContributionTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false},_processDataForComparisonChart:function(e,i,t,a){var l=this.oConfig.TILE_PROPERTIES.semanticColorContribution;var o=[];var s;var n;for(var r=0;r<e.results.length;r++){var T=e.results[r];var c={};try{c.title=T[t].toString()}catch(e){c.title=""}c.value=Number(T[i]);var u=Number(T[i]);if(this.oConfig.EVALUATION.SCALING==-2){u*=100}var p=this.isCurrencyMeasure(i);n=T[a];s=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(u,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION,p,n);c.displayValue=s.toString();if(typeof l==="undefined"){c.color="Neutral"}else{c.color=l}if(c&&a){c[a]=n}o.push(c)}return o},fetchChartData:function(e,i,l,o){var s=this;try{var n=this.oConfig.EVALUATION.ODATA_ENTITYSET,r;s.setThresholdValues();if(this.oConfig.TILE_PROPERTIES.semanticMeasure){r=this.oConfig.EVALUATION.COLUMN_NAME+","+this.oConfig.TILE_PROPERTIES.semanticMeasure}else{r=this.oConfig.EVALUATION.COLUMN_NAME}var T=null;var c=this.oConfig.TILE_PROPERTIES.dimension;var u=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(e);var p=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(s.oConfig.TILE_PROPERTIES.id);if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(s.oConfig)){if(p){var E=p.Data&&JSON.parse(p.Data)}}var h=s.oTileApi.configuration.getParameterValueAsString("timeStamp");var d=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(s.oConfig.TILE_PROPERTIES.id,h,s.chipCacheTime,s.chipCacheTimeUnit,s.tilePressed);if(E&&!E.rightData||!p||!d&&s.oTileApi.visible.isVisible()||u||i&&s.oTileApi.visible.isVisible()||s.getView().getViewData().refresh){if(s.kpiValueFetchDeferred){s.kpiValueFetchDeferred=false;var f=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var I={};I["0"]=r+",asc";I["1"]=r+",desc";I["2"]=c+",asc";I["3"]=c+",desc";var C=I[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");var g=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(s.oRunTimeODataModel,n,r,c,f,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure){g.uri+="&$top=3&$orderby="+C[0]+" "+C[2]}else{g.uri+="&$top=3&$orderby="+C[0]+" "+C[1]}this.comparisionChartODataRef=g.model.read(g.uri,null,null,true,function(e){s.kpiValueFetchDeferred=true;var i={};if(e&&e.results&&e.results.length){if(g.unit[0]){s._updateTileModel({unit:e.results[0][g.unit[0].name]});T=g.unit[0].name;i.unit=g.unit[0];i.unit.name=g.unit[0].name}c=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(s.oRunTimeODataModel,n,c);i.dimension=c;s.oConfig.TILE_PROPERTIES.FINALVALUE=e;s.oConfig.TILE_PROPERTIES.FINALVALUE=s._processDataForComparisonChart(s.oConfig.TILE_PROPERTIES.FINALVALUE,r.split(",")[0],c,T);i.data=s.oConfig.TILE_PROPERTIES.FINALVALUE;i.isCurM=s.isACurrencyMeasure(s.oConfig.EVALUATION.COLUMN_NAME);var a={};s.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();a.ChipId=s.oConfig.TILE_PROPERTIES.id;a.Data=JSON.stringify(i);a.CacheMaxAge=Number(s.chipCacheTime);a.CacheMaxAgeUnit=s.chipCacheTimeUnit;a.CacheType=1;var o=s.getLocalCache(a);s.updateDatajobScheduled=false;var u=s.oConfig.TILE_PROPERTIES.id+"data";var E=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(u);if(E){clearTimeout(E);E=undefined}if(!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(s.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,o);var h=false;if(p){h=true}if(s.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(s.oTileApi,s.oConfig.TILE_PROPERTIES.id,a,h,function(e){if(e){s.cacheTime=e&&e.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,e)}if(s.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(s.oConfig)){t.proxy(s.setTimeStamp(s.cacheTime),s)}})}}else{var d=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(s.oConfig.TILE_PROPERTIES.id),f;if(d){if(!d.CachedTime){d.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()}f=d.Data;if(f){f=JSON.parse(f);if(s.oKpiTileView.getViewName()=="tiles.indicatornumeric.NumericTile"){f.leftData=i}else{f.rightData=i}}d.Data=JSON.stringify(f);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,d)}else{f={};f.rightData=i;o.Data=JSON.stringify(f);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,o)}s.cacheWriteData=i}l.call(s,s.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(e.results.length==0){s.oConfig.TILE_PROPERTIES.FINALVALUE=e;if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(s.oConfig.TILE_PROPERTIES.id)){i=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(s.oConfig.TILE_PROPERTIES.id);i.data=e}else{i.data=e}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,i);l.call(s,s.oConfig.TILE_PROPERTIES.FINALVALUE);s.setNoData()}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(s.oConfig.TILE_PROPERTIES.id,{empty:"empty"});s.setNoData()}},function(e){s.kpiValueFetchDeferred=true;if(e&&e.response){a.error(e.message+" : "+e.request.requestUri);o.call(s,e)}})}}else if(p&&p.Data){var m;var L=s.oConfig&&s.oConfig.TILE_PROPERTIES&&s.oConfig.TILE_PROPERTIES.tileType;if(L.indexOf("DT-")==-1){m=p.Data&&JSON.parse(p.Data)}else{m=p.Data&&JSON.parse(p.Data);m=m.rightData}s.cacheTime=p.CachedTime;if(s.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(s.oConfig)){t.proxy(s.setTimeStamp(s.cacheTime),s)}if(m.data&&m.data.length){if(m.unit){s._updateTileModel({unit:m.data[0][m.unit.name]})}c=m.dimension;s.oConfig.TILE_PROPERTIES.FINALVALUE=m.data;l.call(s,s.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(m&&m.data&&m.data instanceof Array&&m.data.length==0){s.oConfig.TILE_PROPERTIES.FINALVALUE=m.data;l.call(s,s.oConfig.TILE_PROPERTIES.FINALVALUE);s.setNoData()}else{s.setNoData()}}else{s.setNoData()}}catch(e){s.kpiValueFetchDeferred=true;o.call(s,e)}},doProcess:function(e,i){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);this.setTextInTile();this.fetchChartData(e,i,function(e){this.CALCULATED_KPI_VALUE=e;this._updateTileModel({data:this.CALCULATED_KPI_VALUE});if(t.oConfig.TILE_PROPERTIES.frameType==r.TwoByOne){t.oKpiTileView.oGenericTile.setFrameType(r.TwoByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.getView().getViewData().parentController._updateTileModel(this.getTile().getModel().getData());t.getView().getViewData().deferredObj.resolve()}else{t.oKpiTileView.oGenericTile.setFrameType(r.OneByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.oKpiTileView.oGenericTile.addTileContent(t.oKpiTileView.oNVConfS);this.oKpiTileView.oGenericTile.setState(n.Loaded)}this.setToolTip(null,this.CALCULATED_KPI_VALUE,"CONT");if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible())}},this.logError)},doDummyProcess:function(){var e=this;e.setTextInTile();e._updateTileModel({value:8888,size:s.Auto,frameType:r.OneByOne,state:n.Loading,valueColor:o.Error,indicator:l.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral"},{title:"EMEA",value:50,color:"Neutral"},{title:"APAC",value:-20,color:"Neutral"}]});this.oKpiTileView.oGenericTile.setState(n.Loaded)}});return T});