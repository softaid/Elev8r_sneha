// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ushell/components/tiles/utils","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/Config","sap/ushell/utils/WindowUtils","sap/m/library","sap/ushell/library","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/thirdparty/jquery","sap/ushell/utils/UrlParsing"],function(e,t,i,a,n,o,r,s,l,g,p){"use strict";var c=o.GenericTileScope;var _=o.GenericTileMode;var u=r.AppType;return e.extend("sap.ushell.components.tiles.applauncher.StaticTile",{_aDoableObject:{},onInit:function(){var e=this.getView(),n=e.getViewData(),o=n.chip,r=t.getAppLauncherConfig(o,o.configurationUi.isEnabled(),false),l,g,c,u=this,f=r.navigation_target_url,d,y;this.oShellModel=i.getElementsModel();d=o.url.getApplicationSystem();if(d){if(p.isIntentUrl(f)){y=p.parseShellHash(f);if(!y.params){y.params={}}y.params["sap-system"]=d;f="#"+p.constructShellHash(y)}else{f+=(f.indexOf("?")<0?"?":"&")+"sap-system="+d}}this.navigationTargetUrl=f;l=new s({sizeBehavior:a.last("/core/home/sizeBehavior"),wrappingType:a.last("/core/home/wrappingType"),mode:r.display_mode,config:r,nav:{navigation_target_url:o.configurationUi&&o.configurationUi.isEnabled()?"":f},search:{display_highlight_terms:[]}});e.setModel(l);this._aDoableObject=a.on("/core/home/sizeBehavior").do(function(e){l.setProperty("/sizeBehavior",e)});if(o.types){o.types.attachSetType(function(e){if(u.tileType!==e){if(e==="link"){l.setProperty("/mode",_.LineMode)}else{l.setProperty("/mode",l.getProperty("/config/display_mode"))}u.tileType=e}})}if(!this.tileType){this.tileType="tile"}if(o.search){g=e.getModel().getProperty("/config/display_search_keywords");c=g.split(/[, ]+/).filter(function(e){return e&&e!==""});if(r.display_title_text&&r.display_title_text!==""&&c.indexOf(r.display_title_text)===-1){c.push(r.display_title_text)}if(r.display_subtitle_text&&r.display_subtitle_text!==""&&c.indexOf(r.display_subtitle_text)===-1){c.push(r.display_subtitle_text)}if(r.display_info_text&&r.display_info_text!==""&&c.indexOf(r.display_info_text)===-1){c.push(r.display_info_text)}o.search.setKeywords(c);o.search.attachHighlight(function(t){e.getModel().setProperty("/search/display_highlight_terms",t)})}if(o.bag&&o.bag.attachBagsUpdated){o.bag.attachBagsUpdated(function(i){if(i.indexOf("tileProperties")>-1){t._updateTilePropertiesTexts(e,o.bag.getBag("tileProperties"))}})}if(o.configuration&&o.configuration.attachConfigurationUpdated){o.configuration.attachConfigurationUpdated(function(i){if(i.indexOf("tileConfiguration")>-1){t._updateTileConfiguration(e,o.configuration.getParameterValueAsString("tileConfiguration"))}})}if(o.preview){o.preview.setTargetUrl(f);o.preview.setPreviewIcon(r.display_icon_url);o.preview.setPreviewTitle(r.display_title_text);if(o.preview.setPreviewSubtitle&&typeof o.preview.setPreviewSubtitle==="function"){o.preview.setPreviewSubtitle(r.display_subtitle_text)}}if(o.configurationUi.isEnabled()){o.configurationUi.setAsyncUiProvider(function(){return t.getConfigurationUi(e,"sap.ushell.components.tiles.applauncher.Configuration").then(function(e){o.configurationUi.attachCancel(u.onCancelConfiguration.bind(null,e));o.configurationUi.attachSave(u.onSaveConfiguration.bind(null,e));return e})});this.getView().getContent()[0].setTooltip(t.getResourceBundleModel().getResourceBundle().getText("edit_configuration.tooltip"))}if(o.actions){var h=r.actions,v;if(h){v=h.slice()}else{v=[]}if(a.last("/core/shell/enablePersonalization")){var b=l.getProperty("/mode")===_.LineMode?"link":"tile",w=t.getTileSettingsAction(l,this.onSaveRuntimeSettings.bind(this),b);v.push(w)}o.actions.setActionsProvider(function(){return v})}},onExit:function(){this._aDoableObject.off()},onPress:function(e){var t=this.getView(),i=t.getViewData(),o=i.chip,r=t.getModel().getProperty("/config");if(e.getSource().getScope&&e.getSource().getScope()===c.Display){if(o.configurationUi.isEnabled()){o.configurationUi.display()}else if(this.navigationTargetUrl){if(this.navigationTargetUrl[0]==="#"){hasher.setHash(this.navigationTargetUrl)}else{var s=a.last("/core/shell/enableRecentActivity")&&a.last("/core/shell/enableRecentActivityLogging");if(s){var l={title:r.display_title_text,appType:u.URL,url:r.navigation_target_url,appId:r.navigation_target_url};sap.ushell.Container.getRenderer("fiori2").logRecentActivity(l)}n.openURL(this.navigationTargetUrl,"_blank")}}}},onSaveRuntimeSettings:function(e){var t=e.getModel(),i=this.getView().getViewData().chip,a=this.getView().getModel().getProperty("/config");a.display_title_text=t.getProperty("/title")||"";a.display_subtitle_text=t.getProperty("/subtitle")||"";a.display_info_text=t.getProperty("/info")||"";a.display_search_keywords=t.getProperty("/keywords")||"";var n=i.bag.getBag("tileProperties");n.setText("display_title_text",a.display_title_text);n.setText("display_subtitle_text",a.display_subtitle_text);n.setText("display_info_text",a.display_info_text);n.setText("display_search_keywords",a.display_search_keywords);function o(e){l.error(e,null,"sap.ushell.components.tiles.applauncher.StaticTile.controller")}n.save(function(){l.debug("property bag 'tileProperties' saved successfully");this.getView().getModel().setProperty("/config/display_title_text",a.display_title_text);this.getView().getModel().setProperty("/config/display_subtitle_text",a.display_subtitle_text);this.getView().getModel().setProperty("/config/display_info_text",a.display_info_text);this.getView().getModel().setProperty("/config/display_search_keywords",a.display_search_keywords);this.getView().getModel().refresh()}.bind(this),o)},onSaveConfiguration:function(e){var i=new g.Deferred;var a=e.getModel();var n=a.getProperty("/tileModel");var o=e.getViewData().chip;var r=t.tileActionsRows2TileActionsArray(a.getProperty("/config/tile_actions_rows"));var p={display_icon_url:a.getProperty("/config/display_icon_url"),navigation_use_semantic_object:a.getProperty("/config/navigation_use_semantic_object"),navigation_target_url:a.getProperty("/config/navigation_target_url"),navigation_semantic_object:g.trim(a.getProperty("/config/navigation_semantic_object"))||"",navigation_semantic_action:g.trim(a.getProperty("/config/navigation_semantic_action"))||"",navigation_semantic_parameters:g.trim(a.getProperty("/config/navigation_semantic_parameters")),display_search_keywords:a.getProperty("/config/display_search_keywords")};var c=t.checkInputOnSaveConfig(e);if(!c){c=t.checkTileActions(e)}if(c){i.reject("mandatory_fields_missing");return i.promise()}if(p.navigation_use_semantic_object){p.navigation_target_url=t.getSemanticNavigationUrl(p);a.setProperty("/config/navigation_target_url",p.navigation_target_url)}var _=o.bag.getBag("tileProperties");_.setText("display_title_text",a.getProperty("/config/display_title_text"));_.setText("display_subtitle_text",a.getProperty("/config/display_subtitle_text"));_.setText("display_info_text",a.getProperty("/config/display_info_text"));_.setText("display_search_keywords",p.display_search_keywords);var u=o.bag.getBag("tileNavigationActions");t.populateTileNavigationActionsBag(u,r);function f(e,t){l.error(e,null,"sap.ushell.components.tiles.applauncher.StaticTile.controller");i.reject(e,t)}o.writeConfiguration.setParameterValues({tileConfiguration:JSON.stringify(p)},function(){var a=t.getAppLauncherConfig(o,false,false),r=t.getAppLauncherConfig(o,true,false),g=new s({config:a,nav:{navigation_target_url:""},tileModel:n});e.setModel(g);n.setData({config:r,nav:{navigation_target_url:""}},false);if(o.preview){o.preview.setTargetUrl(a.navigation_target_url);o.preview.setPreviewIcon(a.display_icon_url);o.preview.setPreviewTitle(a.display_title_text);if(o.preview.setPreviewSubtitle&&typeof o.preview.setPreviewSubtitle==="function"){o.preview.setPreviewSubtitle(a.display_subtitle_text)}}_.save(function(){l.debug("property bag 'tileProperties' saved successfully");if(o.title){o.title.setTitle(a.display_title_text,function(){i.resolve()},f)}else{i.resolve()}},f);u.save(function(){l.debug("property bag 'navigationProperties' saved successfully")},f)},f);e.destroy();return i.promise()},onCancelConfiguration:function(e){var i=e.getViewData(),a=e.getModel(),n=a.getProperty("/tileModel"),o=i.chip,r=t.getAppLauncherConfig(o,o.configurationUi.isEnabled(),false);e.getModel().setData({config:r,nav:{navigation_target_url:""},tileModel:n},false);e.destroy()},formatters:{leanURL:n.getLeanURL.bind(n)}})},false);