// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/tiles/generic","sap/m/library","sap/ui/thirdparty/jquery","sap/base/Log"],function(e,i,t,a){"use strict";var o=i.DeviationIndicator;var l=i.ValueColor;var s=i.Size;var n=i.LoadState;var r=i.FrameType;var T=e.extend("sap.ushell.components.tiles.indicatorcomparison.ComparisonTile",{onInit:function(){this.KPI_VALUE_REQUIRED=false},_processDataForComparisonChart:function(e,i,t){var a=[],o={},l,s,n;var r;var T=[];var E=this;var c=null;for(l=0;l<e.results.length;l++){var u=e.results[l]}T=sap.ushell.components.tiles.indicatorTileUtils.util.getAllMeasuresWithLabelText(this.oTileApi.url.addSystemToServiceUrl(this.oConfig.EVALUATION.ODATA_URL),this.oConfig.EVALUATION.ODATA_ENTITYSET);for(l=0,n=T.length;l<n;l++){s=T[l];o[s.key]=s.value}var h=E.oConfig.TILE_PROPERTIES.COLUMN_NAMES||E.oConfig.EVALUATION.COLUMN_NAMES;for(l=0;l<h.length;l++){var p={};var C=h[l];p.value=Number(u[C.COLUMN_NAME]);var f=Number(u[C.COLUMN_NAME]);var I=false;var L=0;var d=E._getEvaluationThresholdMeasures();var A=d?Array.prototype.indexOf.call(d,C.COLUMN_NAME):-1;if(A>-1){I=true;L=E.oConfig.EVALUATION.SCALING}if(E.oConfig.EVALUATION.SCALING==-2&&I){f*=100}var g=E.isCurrencyMeasure(C.COLUMN_NAME);if(t&&t[l]&&u[t[l].name]){c=u[t[l].name]}r=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(f,L,E.oConfig.EVALUATION.SCALING,E.oConfig.EVALUATION.DECIMAL_PRECISION,g,c);if(E.oConfig.EVALUATION.SCALING==-2&&I){r+=" %"}p.displayValue=r.toString();if(t){if(t[l]&&u[t[l].name]){p.displayValue+=" "+u[t[l].name]}}p.color=C.semanticColor;p.title=o[C.COLUMN_NAME]||C.COLUMN_NAME;p.measure=C.COLUMN_NAME;p.isCurM=g;a.push(p)}return a},fetchChartData:function(e,i,o,l){function s(e,i){var t=false;if(e&&e.results&&e.results.length){for(var a=0,o=i.length;a<o&&!t;a++){t=e.results[0][i[a].COLUMN_NAME]!==null}}return t}var n=this;try{var r=this.oConfig.EVALUATION.ODATA_ENTITYSET;var T=this.oConfig.EVALUATION.COLUMN_NAME;var E=T,c;if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES){for(c=0;c<this.oConfig.TILE_PROPERTIES.COLUMN_NAMES.length;c++){if(this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[c].COLUMN_NAME!=this.oConfig.EVALUATION.COLUMN_NAME){E=E+","+this.oConfig.TILE_PROPERTIES.COLUMN_NAMES[c].COLUMN_NAME}}}else{for(c=0;c<this.oConfig.EVALUATION.COLUMN_NAMES.length;c++){if(this.oConfig.EVALUATION.COLUMN_NAMES[c].COLUMN_NAME!=this.oConfig.EVALUATION.COLUMN_NAME){E=E+","+this.oConfig.EVALUATION.COLUMN_NAMES[c].COLUMN_NAME}}}var u=sap.ushell.components.tiles.indicatorTileUtils.util.getBoolValue(e);var h=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(n.oConfig.TILE_PROPERTIES.id);if(sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(n.oConfig)){if(h){var p=h.Data&&JSON.parse(h.Data)}}var C=n.oTileApi.configuration.getParameterValueAsString("timeStamp");var f=sap.ushell.components.tiles.indicatorTileUtils.util.isCacheValid(n.oConfig.TILE_PROPERTIES.id,C,n.chipCacheTime,n.chipCacheTimeUnit,n.tilePressed);if(p&&!p.rightData||!h||!f&&n.oTileApi.visible.isVisible()||u||i&&n.oTileApi.visible.isVisible()||n.getView().getViewData().refresh){if(n.kpiValueFetchDeferred){n.kpiValueFetchDeferred=false;var I=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var L=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(n.oRunTimeODataModel,r,E,null,I,3);this.comparisionChartODataRef=L.model.read(L.uri,null,null,true,function(e){n.kpiValueFetchDeferred=true;var i={};if(L.unit){i.unit=L.unit}if(s(e,n.oConfig.TILE_PROPERTIES.COLUMN_NAMES||n.oConfig.EVALUATION.COLUMN_NAMES)){n.oConfig.TILE_PROPERTIES.FINALVALUE=e;n.oConfig.TILE_PROPERTIES.FINALVALUE=n._processDataForComparisonChart(n.oConfig.TILE_PROPERTIES.FINALVALUE,E.split(",")[0],L.unit);i.data=n.oConfig.TILE_PROPERTIES.FINALVALUE;var a={};n.cacheTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate();a.ChipId=n.oConfig.TILE_PROPERTIES.id;a.Data=JSON.stringify(i);a.CacheMaxAge=Number(n.chipCacheTime);a.CacheMaxAgeUnit=n.chipCacheTimeUnit;a.CacheType=1;var l=n.getLocalCache(a);n.updateDatajobScheduled=false;var r=n.oConfig.TILE_PROPERTIES.id+"data";var T=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(r);if(T){clearTimeout(T);T=undefined}if(!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(n.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(n.oConfig.TILE_PROPERTIES.id,l);var c=false;if(h){c=true}if(n.chipCacheTime){sap.ushell.components.tiles.indicatorTileUtils.util.writeFrontendCacheByChipAndUserId(n.oTileApi,n.oConfig.TILE_PROPERTIES.id,a,c,function(e){if(e){n.cacheTime=e&&e.CachedTime;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(n.oConfig.TILE_PROPERTIES.id,e);n.setTimeStamp()}if(n.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(n.oConfig)){t.proxy(n.setTimeStamp(n.cacheTime),n)}})}}else{var u=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(n.oConfig.TILE_PROPERTIES.id),p;if(u){if(!u.CachedTime){u.CachedTime=sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()}p=u.Data;if(p){p=JSON.parse(p);p.rightData=i}u.Data=JSON.stringify(p);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(n.oConfig.TILE_PROPERTIES.id,u)}else{p={};p.rightData=i;l.Data=JSON.stringify(p);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(n.oConfig.TILE_PROPERTIES.id,l)}n.cacheWriteData=i}o.call(n,n.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(e.results.length==0){n.oConfig.TILE_PROPERTIES.FINALVALUE=e;if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(n.oConfig.TILE_PROPERTIES.id)){i=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(n.oConfig.TILE_PROPERTIES.id);i.data=e}else{i.data=e}sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(n.oConfig.TILE_PROPERTIES.id,i);o.call(n,n.oConfig.TILE_PROPERTIES.FINALVALUE);n.setNoData()}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(n.oConfig.TILE_PROPERTIES.id,{empty:"empty"});n.setNoData()}},function(e){n.kpiValueFetchDeferred=true;if(e&&e.response){a.error(e.message+" : "+e.request.requestUri);l.call(n,e)}})}}else if(h&&h.Data){var d;var A=n.oConfig&&n.oConfig.TILE_PROPERTIES&&n.oConfig.TILE_PROPERTIES.tileType;if(A.indexOf("DT-")==-1){d=h.Data&&JSON.parse(h.Data)}else{d=h.Data&&JSON.parse(h.Data);d=d.rightData}n.cacheTime=h.CachedTime;if(n.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(n.oConfig)){t.proxy(n.setTimeStamp(n.cacheTime),n)}if(d.data&&d.data.length){n.oConfig.TILE_PROPERTIES.FINALVALUE=d.data;o.call(n,n.oConfig.TILE_PROPERTIES.FINALVALUE)}else{n.oConfig.TILE_PROPERTIES.FINALVALUE=d.data;o.call(n,n.oConfig.TILE_PROPERTIES.FINALVALUE);n.setNoData()}}else{n.setNoData()}}catch(e){n.kpiValueFetchDeferred=true;l.call(n,e)}},doProcess:function(e,i){var t=this;this.setTextInTile();this.fetchChartData(e,i,function(e){this.CALCULATED_KPI_VALUE=e;this._updateTileModel({data:this.CALCULATED_KPI_VALUE});if(t.oConfig.TILE_PROPERTIES.frameType==r.TwoByOne){t.oKpiTileView.oGenericTile.setFrameType(r.TwoByOne);t.getView().getViewData().parentController._updateTileModel(this.getTile().getModel().getData());var i={};i.data=this.CALCULATED_KPI_VALUE;t.getView().getViewData().deferredObj.resolve()}else{t.oKpiTileView.oGenericTile.setFrameType(r.OneByOne);t.oKpiTileView.oGenericTile.removeAllTileContent();t.oKpiTileView.oGenericTile.addTileContent(t.oKpiTileView.oNVConfS);this.oKpiTileView.oGenericTile.setState(n.Loaded)}this.setToolTip(null,this.CALCULATED_KPI_VALUE,"COMP");if(this.chipCacheTime&&!sap.ushell.components.tiles.indicatorTileUtils.util.isDualTile(this.oConfig)){sap.ushell.components.tiles.indicatorTileUtils.util.scheduleFetchDataJob.call(this,this.oTileApi.visible.isVisible())}},this.logError)},doDummyProcess:function(){var e=this;this.setTextInTile();e._updateTileModel({value:8888,size:s.Auto,frameType:r.OneByOne,state:n.Loading,valueColor:l.Error,indicator:o.None,title:"Liquidity Structure",footer:"Current Quarter",description:"Apr 1st 2013 (B$)",data:[{title:"Measure 1",value:1.2,color:"Good"},{title:"Measure 2",value:.78,color:"Good"},{title:"Measure 3",value:1.4,color:"Error"}]});this.oKpiTileView.oGenericTile.setState(n.Loaded)}});return T});