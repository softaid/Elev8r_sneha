// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/model/json/JSONModel","sap/m/library","sap/ui/thirdparty/jquery"],function(e,i,t){"use strict";var l=i.DeviationIndicator;var a=i.ValueColor;var o=i.LoadState;sap.ui.controller("tiles.indicatorDualDeviation.DualDeviation",{logError:function(e){this.oDualDeviationView.oGenericTile.setState(o.Failed);this.oDualDeviationView.oGenericTile.setState(o.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e)},getThresholdsObjAndColor:function(e){try{var i={};i.arrObj=[];i.returnColor=a.Neutral;var t=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;var l,o,r,s;if(t==="MI"){r=Number(e.criticalHighValue)||0;s=Number(e.warningHighValue)||0;if(r&&s){r=window.parseFloat(r);s=window.parseFloat(s);i.arrObj.push({value:r,color:a.Error});i.arrObj.push({value:s,color:a.Critical});if(this.CALCULATED_KPI_VALUE<s){i.returnColor=a.Good}else if(this.CALCULATED_KPI_VALUE<=r){i.returnColor=a.Critical}else{i.returnColor=a.Error}}}else if(t==="MA"){o=Number(e.criticalLowValue)||0;l=Number(e.warningLowValue)||0;if(o&&l){o=window.parseFloat(o);l=window.parseFloat(l);i.arrObj.push({value:o,color:a.Error});i.arrObj.push({value:l,color:a.Critical});if(this.CALCULATED_KPI_VALUE<o){i.returnColor=a.Error}else if(this.CALCULATED_KPI_VALUE<=l){i.returnColor=a.Critical}else{i.returnColor=a.Good}}}else{r=Number(e.criticalHighValue)||0;s=Number(e.warningHighValue)||0;o=Number(e.criticalLowValue)||0;l=Number(e.warningLowValue)||0;if(l&&s&&o&&o){r=window.parseFloat(r);s=window.parseFloat(s);l=window.parseFloat(l);o=window.parseFloat(o);i.arrObj.push({value:r,color:a.Error});i.arrObj.push({value:s,color:a.Critical});i.arrObj.push({value:l,color:a.Critical});i.arrObj.push({value:o,color:a.Error});if(this.CALCULATED_KPI_VALUE<o||this.CALCULATED_KPI_VALUE>r){i.returnColor=a.Error}else if(this.CALCULATED_KPI_VALUE>=o&&this.CALCULATED_KPI_VALUE<=l||this.CALCULATED_KPI_VALUE>=s&&this.CALCULATED_KPI_VALUE<=r){i.returnColor=a.Critical}else{i.returnColor=a.Good}}}return i}catch(e){this.logError(e)}},getTrendIndicator:function(e,i){var t=this;e=Number(e);try{var a=l.None;if(e>i){a=l.Down}else if(e<i){a=l.Up}return a}catch(e){t.logError(e)}},getTile:function(){return this.oDualDeviationView.oGenericTile},_updateTileModel:function(e){var i=this.getTile().getModel().getData();t.extend(i,e);this.getTile().getModel().setData(i)},formSelectStatement:function(e){var i=Object.keys(e);var t="";for(var l=0;l<i.length;l++){if(e[i[l]]!==undefined&&e.fullyFormedMeasure){t+=","+e[i[l]]}}return t},setThresholdValues:function(){var e=this;var i={};i.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":i.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","MEASURE");i.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break;case"MA":i.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","MEASURE");i.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break;case"RA":i.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","MEASURE");i.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","MEASURE");i.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","MEASURE");i.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","MEASURE");i.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","MEASURE");i.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","MEASURE");i.fullyFormedMeasure+=e.formSelectStatement(i);break}}else{i.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CH","FIXED");i.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"CL","FIXED");i.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WH","FIXED");i.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"WL","FIXED");i.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TA","FIXED");i.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(e.oConfig,"TC","FIXED")}return i},fetchKpiValue:function(e,i){var t=this;var l=0;try{var a=this.DEFINITION_DATA.EVALUATION.ODATA_URL;var o=this.DEFINITION_DATA.EVALUATION.ODATA_ENTITYSET;var r=this.setThresholdValues();var s=r.fullyFormedMeasure;var n=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!n){var u=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.DEFINITION_DATA.EVALUATION_FILTERS,this.DEFINITION_DATA.ADDITIONAL_FILTERS);var c=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oTileApi.url.addSystemToServiceUrl(a),o,s,null,u);if(c){this.QUERY_SERVICE_MODEL=c.model;this.queryUriForKpiValue=c.uri;try{this.queryServiceUriODataReadRef=this.QUERY_SERVICE_MODEL.read(c.uri,null,null,true,function(a){t.writeData={};if(a&&a.results&&a.results.length){l=a.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(c.unit[0]){t._updateTileModel({unit:a.results[0][c.unit[0].name]});t.writeData.unit=c.unit[0];t.writeData.unit.name=c.unit[0].name}t.writeData.numericData=a;var o="",s;var n=l;if(t.oConfig.EVALUATION.SCALING==-2){n*=100;t.getView().oNumericContent.setFormatterValue(false)}o=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(n),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);s=t.getTrendIndicator(r.trendValue,n);if(t.oConfig.EVALUATION.SCALING==-2){t._updateTileModel({scale:"%"})}t._updateTileModel({value:o.toString(),indicator:s,valueColor:t.getThresholdsObjAndColor(r).returnColor});t.writeData.data=a;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,t.writeData);if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){r.criticalHighValue=a.results[0][r.sCriticalHigh];r.criticalLowValue=a.results[0][r.sCriticalLow];r.warningHighValue=a.results[0][r.sWarningHigh];r.warningLowValue=a.results[0][r.sWarningLow];r.targetValue=a.results[0][r.sTarget];r.trendValue=a.results[0][r.sTrend]}e.call(t,l,r)}else{i.call(t,"no Response from QueryServiceUri")}},function(e){if(e&&e.response){i.call(t,e.message)}})}catch(e){t.logError("Error in Query Service URI")}}}else if(n.data&&n.data.results&&n.data.results.length){var T,g,h;r=t.setThresholdValues();T=n.data.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(t.oConfig.EVALUATION.SCALING==-2){T*=100;t.getView().oNumericContent.setFormatterValue(true)}if(t.oConfig.EVALUATION.SCALING==-2){t._updateTileModel({scale:"%"})}g=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(T),t.oConfig.EVALUATION.SCALING,t.oConfig.EVALUATION.DECIMAL_PRECISION);h=t.getTrendIndicator(r.trendValue,T);if(n.unit){t._updateTileModel({unit:n.data.results[0][n.unit.name]})}t._updateTileModel({indicator:h,value:g.toString()});if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){r.criticalHighValue=n.data.results[0][r.sCriticalHigh];r.criticalLowValue=n.data.results[0][r.sCriticalLow];r.warningHighValue=n.data.results[0][r.sWarningHigh];r.warningLowValue=n.data.results[0][r.sWarningLow];r.targetValue=n.data.results[0][r.sTarget];r.trendValue=n.data.results[0][r.sTrend]}e.call(t,n.data.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME],r)}else{i.call(t,"no Response from QueryServiceUri")}}catch(e){i.call(t,e)}},flowWithoutDesignTimeCall:function(){var e=this;var i,t;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oTileApi.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(l,a){var r=Number(l);if(this.oConfig.EVALUATION.SCALING==-2){r*=100}i=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(r),this.oConfig.EVALUATION.SCALING,e.oConfig.EVALUATION.DECIMAL_PRECISION);this.CALCULATED_KPI_VALUE=Number(l);var s={};var n=this.getThresholdsObjAndColor(a);var u={value:Number(l),color:n.returnColor};s.valueColor=u.color;s.actualValueLabel=i.toString();s.actual=u;var c=this.DEFINITION_DATA.EVALUATION_VALUES,T;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){T=Number(a.targetValue);if(this.oConfig.EVALUATION.SCALING==-2){T*=100}t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(T,this.oConfig.EVALUATION.SCALING,this.oConfig.EVALUATION.DECIMAL_PRECISION);s.targetValue=Number(a.targetValue);s.targetValueLabel=t.toString()}else{for(var g=0;g<c.length;g++){if(c[g].TYPE==="TA"){T=Number(c[g].FIXED);if(this.oConfig.EVALUATION.SCALING==-2){T*=100}t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(T);s.targetValue=Number(c[g].FIXED);s.targetValueLabel=t.toString()}}}this._updateTileModel(s);var h=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system);e.oDualDeviationView.oGenericTile.$().wrap("<a href ='"+h+"'></a>");this.oDualDeviationView.oGenericTile.setState(o.Loaded);var E="";if(s.valueColor=="Error"){E="sb.error"}if(s.valueColor=="Neutral"){E="sb.neutral"}if(s.valueColor=="Critical"){E="sb.critical"}if(s.valueColor=="Good"){E="sb.good"}var A={status:E,actual:r,target:a.targetValue,cH:a.criticalHighValue,wH:a.warningHighValue,wL:a.warningLowValue,cL:a.criticalLowValue};var d=A;var C=e.oDualDeviationView.oGenericTile.getTileContent()[0].getContent();var f=e.oDualDeviationView.oGenericTile.getTileContent()[1].getContent();sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(C,"NT",A);sap.ushell.components.tiles.indicatorTileUtils.util.setTooltipInTile(f,"DT",d)},this.logError)}},flowWithDesignTimeCall:function(){var e=this;try{var i=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(i){e.oConfig.EVALUATION_FILTERS=i.EVALUATION_FILTERS;e.flowWithoutDesignTimeCall()}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,function(i){e.oConfig.EVALUATION_FILTERS=i;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(e.oConfig.TILE_PROPERTIES.id,e.oConfig);e.flowWithoutDesignTimeCall()})}}catch(e){this.logError(e)}},refreshHandler:function(e){if(!e.firstTimeVisible){if(Number(this.oTileApi.configuration.getParameterValueAsString("isSufficient"))){e.flowWithoutDesignTimeCall()}else{e.flowWithDesignTimeCall()}}},visibleHandler:function(e){if(!e){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef)}if(e){this.refreshHandler(this)}},setTextInTile:function(){var e=this;var i=sap.ushell.components.tiles.indicatorTileUtils.util.getTileTitleSubtitle(this.oTileApi);this._updateTileModel({header:i.title||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(e.oConfig),subheader:i.subTitle||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(e.oConfig)})},onInit:function(){var e=this;this.firstTimeVisible=false;this.oDualDeviationView=this.getView();this.oViewData=this.oDualDeviationView.getViewData();this.oTileApi=this.oViewData.chip;if(this.oTileApi.visible){this.oTileApi.visible.attachVisible(this.visibleHandler.bind(this))}this.system=this.oTileApi.url.getApplicationSystem();this.oDualDeviationView.oGenericTile.setState(o.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(e.oTileApi.configuration.getParameterValueAsString("tileConfiguration"),e.oTileApi.preview.isEnabled(),function(i){e.oConfig=i;e.setTextInTile();if(e.oTileApi.preview){e.oTileApi.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system))}if(e.oTileApi.preview.isEnabled()){e._updateTileModel({valueColor:"Good",value:100,frameType:"TwoByOne",unit:"USD",actual:{value:120,color:a.Good},targetValue:100,thresholds:[{value:0,color:a.Error},{value:50,color:a.Critical},{value:150,color:a.Critical},{value:200,color:a.Error}],showActualValue:true,showTargetValue:true});e.oDualDeviationView.oGenericTile.setState(o.Loaded)}else{e.oDualDeviationView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(e.queryServiceUriODataReadRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(e.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(e.oConfig,e.system)});if(Number(e.oTileApi.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(e.oConfig.TILE_PROPERTIES.id,e.oConfig);e.flowWithoutDesignTimeCall()}else{e.flowWithDesignTimeCall()}}})}catch(e){this.logError(e)}},_setLocalModelToTile:function(){if(!this.getTile().getModel()){this.getTile().setModel(new e({}))}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef)}})},true);