// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/m/Button","sap/m/library","sap/m/Popover","sap/m/Text","sap/ui/thirdparty/jquery","sap/ushell/components/HomepageManager","sap/ushell/resources","sap/ushell/utils/WindowUtils"],function(e,t,i,o,n,s,a,r,l){"use strict";var c=i.PlacementType;var p=function(){this.oEventBus=sap.ui.getCore().getEventBus();this.init=function(e){this.oModel=e}};p.prototype._activate=function(){this.oModel.setProperty("/tileActionModeActive",true);this.aOrigHiddenGroupsIds=this.getHomepageManager().getCurrentHiddenGroupIds(this.oModel);var e=sap.ui.getCore().byId("dashboardGroups");e.addLinksToUnselectedGroups();var t=sap.ui.getCore().byId("ActionModeBtn");if(t){t.setText(r.i18n.getText("exitEditMode"));if(t.setSelected){t.setSelected(true)}}this.oEventBus.publish("launchpad","actionModeActive")};p.prototype._deactivate=function(){this.oModel.setProperty("/tileActionModeActive",false);this.oEventBus.publish("launchpad","actionModeInactive",this.aOrigHiddenGroupsIds);var e=sap.ui.getCore().byId("TileActions");if(e!==undefined){e.destroy()}var t=sap.ui.getCore().byId("ActionModeBtn");if(t){t.setText(r.i18n.getText("activateEditMode"));if(t.setSelected){t.setSelected(false)}}};p.prototype.toggleActionMode=function(e,t,i){i=i||[];var o=i.filter(function(e){return e.getVisible()});var n={group:o[e.getProperty("/topGroupInViewPortIndex")],restoreLastFocusedTile:true};if(e.getProperty("/tileActionModeActive")){this._deactivate();var a=s(".sapUshellTileContainerHeader[tabindex=0]");if(a.length){var r=s(a[0]).closest(".sapUshellTileContainer");if(r.length){n.restoreLastFocusedTileContainerById=r[0].id}}}else{this._activate()}this.oEventBus.publish("launchpad","scrollToGroup",n)};p.prototype.activateGroupEditMode=function(e){var t=s(e.getDomRef()).find(".sapUshellTileContainerContent");t.addClass("sapUshellTileContainerEditMode")};p.prototype.getHomepageManager=function(){if(!this.oHomepageManager){this.oHomepageManager=a.prototype.getInstance()}return this.oHomepageManager};p.prototype._filterActions=function(e,t){var i=t.getModel();var o=t.getParent().getBindingContext().getPath();if(i.getProperty(o+"/isGroupLocked")){["tileSettingsBtn","linkSettingsBtn","ConvertToTile","ConvertToLink","moveTile_action"].forEach(function(t){e=e.filter(function(e){return e.id!==t})})}if(this.getHomepageManager().getPersonalizableGroups().length<2){e=e.filter(function(e){return e.id!=="moveTile_action"})}return e};p.prototype._openActionsMenu=function(i){var o=i.getSource();var n=o.getBindingContext().getObject().object;var a=this.getHomepageManager().getTileActions(n);a=this._filterActions(a,o);s(".sapUshellTileActionLayerDivSelected").removeClass("sapUshellTileActionLayerDivSelected");var r=s(o.getDomRef()).find(".sapUshellTileActionLayerDiv");r.addClass("sapUshellTileActionLayerDivSelected");var l=[];a.forEach(function(i){if(!i.press&&!i.targetURL){e.warning("Invalid Tile action discarded: "+JSON.stringify(i));return}l.push(new t({text:i.text,icon:i.icon,press:this._handleActionPress.bind(this,i,o)}))}.bind(this));if(l.length===0){this._openNoActionsPopover(i);return}var p=o.getActionSheetIcon?o.getActionSheetIcon():undefined;if(!p){var d=sap.ui.getCore().byId(o.getId()+"-action-more");p=d||o}var u=sap.ui.getCore().byId("TileActions");if(!u){sap.ui.require(["sap/m/ActionSheet"],function(e){u=new e("TileActions",{placement:c.Bottom,afterClose:function(){s(".sapUshellTileActionLayerDivSelected").removeClass("sapUshellTileActionLayerDivSelected");var e=sap.ui.getCore().getEventBus();e.publish("dashboard","actionSheetClose",o)}});this._openActionSheet(u,l,p)}.bind(this))}else{this._openActionSheet(u,l,p)}};p.prototype._openActionSheet=function(e,t,i){t=t||[];e.destroyButtons();t.forEach(function(t){e.addButton(t)});e.openBy(i)};p.prototype._openNoActionsPopover=function(e){var t=e.getSource();new o({placement:c.Bottom,showHeader:false,content:new n({text:r.i18n.getText("tileHasNoActions")})}).addStyleClass("sapUiContentPadding").openBy(t)};p.prototype._handleActionPress=function(e,t){if(e.press){e.press(t)}else if(e.targetURL){if(e.targetURL.indexOf("#")===0){hasher.setHash(e.targetURL)}else{l.openURL(e.targetURL,"_blank")}}};return new p},true);