// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/ui/base/Object","sap/ui/Device","sap/ui/model/Filter","sap/ushell/ui/launchpad/TileState","sap/ushell/components/_HomepageManager/PagingManager","sap/ushell/components/_HomepageManager/DashboardLoadingManager","sap/ushell/EventHub","sap/ushell/Config","sap/ushell/utils","sap/ushell/resources","sap/ushell/components/DestroyHelper","sap/ushell/components/GroupsHelper","sap/ushell/components/MessagingHelper","sap/m/GenericTile","sap/m/SelectDialog","sap/m/StandardListItem","sap/ushell/components/_HomepageManager/PersistentPageOperationAdapter","sap/ushell/components/_HomepageManager/TransientPageOperationAdapter","sap/ui/model/FilterOperator","sap/m/library","sap/ui/model/Context","sap/m/MessageToast","sap/base/Log","sap/ui/performance/Measurement"],function(e,t,i,o,r,s,n,a,l,u,d,p,h,g,c,f,b,M,v,m,P,T,G,_,y,I){"use strict";var k=T.GenericTileScope;var w={PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"};var L=[];var S;var A=i.extend("sap.ushell.components.HomepageManager",{metadata:{publicMethods:["getModel","getDashboardView","loadPersonalizedGroups","resetGroupsOnFailure","addGroupToModel","addTileToGroup","deleteTilesFromGroup"]},analyticsConstants:w,constructor:function(i,o){if(S){if(!S.view){S.setDashboardView(o.view)}return S}this.oServiceLoadingPromise=sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){this.oPageBuilderService=e;this.oPageBuilderService.registerTileActionsProvider(this._addFLPActionsToTile.bind(this));this.oPageOperationAdapter=v.getInstance(e);this.bLinkPersonalizationSupported=this.oPageOperationAdapter.isLinkPersonalizationSupported()}.bind(this));t.attachThemeChanged(d.handleTilesVisibility);S=this;this.oModel=o.model;this.oRouter=o.router;this.oDashboardView=o.view;this.oSortableDeferred=new e.Deferred;this.oSortableDeferred.resolve();this.registerEvents();this.tileViewUpdateQueue=[];this.tileViewUpdateTimeoutID=0;this.tileUuid=null;this.bIsGroupsModelLoading=false;this.bIsGroupsRequestPending=false;this.segmentsStore=[];this.bIsFirstSegment=true;this.bIsFirstSegmentViewLoaded=false;this.aGroupsFrame=null;this.iMinNumOfTilesForBlindLoading=this.oModel.getProperty("/optimizeTileLoadingThreshold")||100;this.bIsScrollModeAccordingKPI=false;this.oGroupNotLockedFilter=new r("isGroupLocked",P.EQ,false);this.oDashboardLoadingManager=new a("loadingManager",{oDashboardManager:this});if(this.oRouter){var s=this.oRouter.getTarget("home");s.attachDisplay(function(e){this.oDashboardView=e.getParameter("view")}.bind(this))}var n=u.last("/core/home/enableTransientMode");L.push(u.on("/core/home/enableTransientMode").do(function(e){if(n===e){return}n=e;this._changeMode(e)}.bind(this)));this.oModel.bindProperty("/tileActionModeActive").attachChange(this._changeLinksScope.bind(this));this._aRequestQueue=[];this._bRequestRunning=false;return undefined},_addRequest:function(e){this._aRequestQueue.push(e);if(!this._bRequestRunning){this._bRequestRunning=true;this._aRequestQueue.shift()()}},_checkRequestQueue:function(){if(this._aRequestQueue.length===0){this._bRequestRunning=false}else{this._aRequestQueue.shift()()}},_requestFailed:function(){this._aRequestQueue=[];this._bRequestRunning=false},isBlindLoading:function(){var e=u.last("/core/home/homePageGroupDisplay");if((e===undefined||e==="scroll")&&this.bIsScrollModeAccordingKPI){y.info("isBlindLoading reason IsScrollModeAccordingKPI and IsScrollMode: true");return true}if(this.oModel.getProperty("/tileActionModeActive")){y.info("isBlindLoading reason TileActionModeActive : true");return true}return false},createMoveActionDialog:function(t){var i=new b(t,{title:p.i18n.getText("moveTileDialog_title"),rememberSelections:false,contentWidth:"400px",contentHeight:"auto",confirm:function(e){var i=e.getParameter("selectedContexts");this.publishMoveActionEvents(i,t)}.bind(this),cancel:function(){var t=e('.sapUshellTile[tabindex="0"]')[0];if(t){t.focus()}},items:{path:"/groups",template:new M({title:"{title}"})}});return i},publishMoveActionEvents:function(e,i){var r=t.getEventBus();if(e.length){var s=this.tileType==="link"?"links":"tiles",n=e[0].getObject().groupId,a={sTileId:this.tileUuid,sToItems:s,sFromItems:s,sTileType:s,toGroupId:e[0].getObject().groupId,toIndex:e[0].getObject()[this.tileType==="link"?"links":"tiles"].length,source:i};if(o.system.desktop){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(e){e.getInstance().then(function(e){a.callBack=e.callbackSetFocus.bind(e);r.publish("launchpad","scrollToGroup",{groupId:n});r.publish("launchpad","movetile",a)})})}else{r.publish("launchpad","scrollToGroup",{groupId:n});r.publish("launchpad","movetile",a)}}},_changeLinksScope:function(e){var t=this;if(this.bLinkPersonalizationSupported){var i=e.getSource().getValue();this.oModel.getProperty("/groups").forEach(function(e,o){if(!e.isGroupLocked){t._changeGroupLinksScope(e,i?"Actions":"Display")}})}},_changeGroupLinksScope:function(e,t){var i=this;e.links.forEach(function(e,o){i._changeLinkScope(e.content[0],t)})},_changeLinkScope:function(e,t){var i;if(e.getScope){i=e}else if(e.getContent){i=e.getContent()[0]}if(this.bLinkPersonalizationSupported&&i&&i.setScope){i.setScope(t)}},registerEvents:function(){var e=t.getEventBus();e.subscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.subscribe("launchpad","tabSelected",this.getSegmentTabContentViews,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileAdded",this._addBookmarkToModel,this);e.subscribe("sap.ushell.services.Bookmark","catalogTileAdded",this._refreshGroupInModel,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileDeleted",this.loadPersonalizedGroups,this);e.subscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.subscribe("launchpad","createGroupAt",this._createGroupAt,this);e.subscribe("launchpad","deleteGroup",this._deleteGroup,this);e.subscribe("launchpad","resetGroup",this._resetGroup,this);e.subscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.subscribe("launchpad","moveGroup",this._moveGroup,this);e.subscribe("launchpad","deleteTile",this._deleteTile,this);e.subscribe("launchpad","movetile",this._moveTile,this);e.subscribe("launchpad","sortableStart",this._sortableStart,this);e.subscribe("launchpad","sortableStop",this._sortableStop,this);e.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.subscribe("launchpad","convertTile",this._convertTile,this)},_changeMode:function(e){var t=this.getModel().getProperty("/groups");if(e){this.oPageOperationAdapter=m.getInstance();var i=this.oPageOperationAdapter.transformGroupModel(t);this.getModel().setProperty("/groups",i)}else{this.oPageOperationAdapter=v.getInstance();h.destroyFLPAggregationModels(t);this.getModel().setProperty("/groups",[]);this.loadPersonalizedGroups()}},_addFLPActionsToTile:function(e){var t=[];if(u.last("/core/shell/enablePersonalization")){var i=this.bLinkPersonalizationSupported&&this.oPageOperationAdapter.isLinkPersonalizationSupported(e);t.push(this._getMoveTileAction(e));if(i){t.push(this._getConvertTileAction(e))}}return t},getPersonalizableGroups:function(){var e=this.getModel().getProperty("/groups");return e.filter(function(e){return!e.isGroupLocked})},_getConvertTileAction:function(e){var i=t.getEventBus();var r=this.oPageOperationAdapter.getTileType(e);var s=r==="tile"?"ConvertToLink":"ConvertToTile";return{id:s,text:p.i18n.getText(s),press:function(e){var t={tile:e};if(o.system.desktop){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(e){e.getInstance().then(function(e){t.callBack=e.callbackSetFocus.bind(e);i.publish("launchpad","convertTile",t)})})}else{i.publish("launchpad","convertTile",t)}}}},_getMoveTileAction:function(e){var t="moveTile_action";return{id:t,text:p.i18n.getText(t),press:function(t){this.tileType=this.oPageOperationAdapter.getTileType(e);var i=this.tileType==="tile";this.tileUuid=this.getModelTileById(this.oPageOperationAdapter.getTileId(e),i?"tiles":"links").uuid;var o=t.getParent().getProperty("groupId");var s=new r("groupId",P.NE,o);var n=function(e){var t=e.getParameter("value");var i=new r("title",P.Contains,t);var o=e.getSource().getBinding("items");o.filter([i,this.oGroupNotLockedFilter,s])}.bind(this);var a=i?this.moveTileDialog:this.moveLinkDialog;if(!a){a=this.createMoveActionDialog("move"+this.tileType+"Dialog");a.setModel(this.oModel);if(i){this.moveTileDialog=a}else{this.moveLinkDialog=a}}else{a.detachSearch(a._searchHandler)}a.getBinding("items").filter([this.oGroupNotLockedFilter,s]);a.attachSearch(n);a._searchHandler=n;a.open()}.bind(this)}},_handleTileAppearanceAnimation:function(e){if(!e){return}var t=["webkit",""];function i(i,o){for(var r=0;r<t.length;r++){o=o.toLowerCase();e.attachBrowserEvent(t[r]+o,function(t){if(t.originalEvent&&t.originalEvent.animationName==="sapUshellTileEntranceAnimation"){e.removeStyleClass("sapUshellTileEntrance")}},false)}}i(e,"AnimationEnd");e.addStyleClass("sapUshellTileEntrance")},destroy:function(){var e=t.getEventBus();e.unsubscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.unsubscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.unsubscribe("launchpad","createGroupAt",this._createGroupAt,this);e.unsubscribe("launchpad","deleteGroup",this._deleteGroup,this);e.unsubscribe("launchpad","resetGroup",this._resetGroup,this);e.unsubscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.unsubscribe("launchpad","moveGroup",this._moveGroup,this);e.unsubscribe("launchpad","deleteTile",this._deleteTile,this);e.unsubscribe("launchpad","movetile",this._moveTile,this);e.unsubscribe("launchpad","sortableStart",this._sortableStart,this);e.unsubscribe("launchpad","sortableStop",this._sortableStop,this);e.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);t.detachThemeChanged(d.handleTilesVisibility);L.forEach(function(e){e.off()});v.destroy();m.destroy();S=undefined;i.prototype.destroy.apply(this,arguments)},_sortableStart:function(){this.oSortableDeferred=new e.Deferred},_createBookmark:function(e,t,i){var o=i.group?i.group.object:"";delete i.group;function r(){sap.ushell.Container.getServiceAsync("Bookmark").then(function(e){e.addBookmark(i,o).always(this._checkRequestQueue.bind(this)).done(function(){c.showLocalizedMessage("tile_created_msg")}).fail(function(e){y.error("Failed to add bookmark",e,"sap.ushell.ui.footerbar.AddBookmarkButton");c.showLocalizedError("fail_to_add_tile_msg")})}.bind(this))}this._addRequest(r.bind(this))},_addBookmarkToModel:function(e,t,i){var o=i.tile,r,s=i.group,n,a,l,u,p;if(!i||!o){this.bIsGroupsModelDirty=true;if(!this.bGroupsModelLoadingInProcess){this._handleBookmarkModelUpdate()}return}if(!s){r=this.getModel().getProperty("/groups");for(p=0;p<r.length;p++){if(r[p].isDefaultGroup===true){s=r[p].object;break}}}a=this._getIndexOfGroupByObject(s);l=this.oModel.getProperty("/groups/"+a);n=this.oPageOperationAdapter.getPreparedTileModel(o,l.isGroupLocked);this.getTileView(n);l.tiles.push(n);l.visibilityModes=d.calcVisibilityModes(l,true);u=l.tiles.length;this._updateModelWithTileView(a,u);this.oModel.setProperty("/groups/"+a,l)},_refreshGroupInModel:function(e,t,i){var o=this;this.oPageOperationAdapter.refreshGroup(i).then(function(e){if(!e){return}var t=o._getIndexOfGroupByObject(e.object);e.visibilityModes=d.calcVisibilityModes(e.object,true);o.oModel.setProperty("/groups/"+t,e);if(e.tiles){e.tiles.forEach(function(e){o.getTileView(e)})}})},_sortableStop:function(){this.oSortableDeferred.resolve()},_handleAfterSortable:function(e){return function(){var t=Array.prototype.slice.call(arguments);this.oSortableDeferred.done(function(){e.apply(null,t)})}.bind(this)},_createGroupAt:function(e,t,i){var o=parseInt(i.location,10),r=this.oModel.getProperty("/groups"),s=this.oPageOperationAdapter.getPreparedGroupModel(null,false,o===r.length,i),n=this.oModel,a;s.index=o;r.splice(o,0,s);for(a=0;a<r.length-1;a++){r[a].isLastGroup=false}for(a=o+1;a<r.length;a++){r[a].index++}n.setProperty("/groups",r)},_getIndexOfGroupByObject:function(e){var t=this.oModel.getProperty("/groups");return this.oPageOperationAdapter.getIndexOfGroup(t,e)},getTileActions:function(e){return this.oPageOperationAdapter.getTileActions(e)},addTileToGroup:function(e,t){var i=e+"/tiles",o=this.oModel.getProperty(e),r=this.oModel.getProperty(i).length;var s=this.oModel.getProperty(e+"/isGroupLocked"),n=this.oModel.getProperty("/personalization");o.tiles[r]=this.oPageOperationAdapter.getPreparedTileModel(t,s);this.getTileView(o.tiles[r]);o.visibilityModes=d.calcVisibilityModes(o,n);this._updateModelWithTileView(o.index,r);this.oModel.setProperty(e,o)},addTilesToGroupByCatalogTileId:function(e,t){var i=e.getBindingContext();for(var o=0;o<t.length;o++){this.addTileToGroupByCatalogTileId(i.sPath,t[o])}},addTileToGroupByCatalogTileId:function(e,t){var i,o,r;if(!u.last("/core/home/enableTransientMode")){return}r=this.oPageOperationAdapter.getTileModelByCatalogTileId(t);if(!r){return}this.oDashboardLoadingManager.setTileResolved(r);i=this.oModel.getProperty(e+"/tiles").length;o=this.oModel.getProperty(e);o.tiles[i]=r;this.oModel.setProperty(e,o)},_getPathOfTile:function(e){var t=this.oModel.getProperty("/groups"),i,o,r,s,n;for(var a=0;a<t.length;++a){i=t[a];o=i.tiles;r=i.links;for(s=0;s<o.length;++s){if(o[s].uuid===e){return"/groups/"+a+"/tiles/"+s}}for(n=0;n<r.length;++n){if(r[n].uuid===e){return"/groups/"+a+"/links/"+n}}}return null},_moveInArray:function(e,t,i){if(i>=e.length){var o=i-e.length;while(o--+1){e.push(undefined)}}e.splice(i,0,e.splice(t,1)[0])},_updateGroupIndices:function(e){var t;for(t=0;t<e.length;t++){e[t].index=t}},_deleteGroup:function(i,o,r){var s=this,n=this.oModel,a=r.groupId,l=n.getProperty("/groups"),u=g.getIndexOfGroup(l,a),d=l.length-1===u,p=null,f,b;f=d?u-1:u;h.destroyFLPAggregationModel(n.getProperty("/groups/"+u));p=l.splice(u,1)[0];if(d){n.setProperty("/groups/"+f+"/isLastGroup",d)}n.setProperty("/groups",l);this._updateGroupIndices(l);if(f>=0){b=t.getEventBus();window.setTimeout(e.proxy(b.publish,b,"launchpad","scrollToGroup",{groupId:n.getProperty("/groups")[f].groupId}),200)}function M(){s.oPageOperationAdapter.deleteGroup(p).then(function(){c.showLocalizedMessage("group_deleted_msg",[p.title]);s._checkRequestQueue()},function(){s._resetGroupsOnFailure("fail_to_delete_group_msg")})}this._addRequest(M)},_resetGroup:function(e,i,o){var r=this,s=o.groupId,n=this.oModel,a=n.getProperty("/groups"),u=g.getIndexOfGroup(a,s),p=r.oModel.getProperty("/groups/indexOfDefaultGroup")===u,h=n.getProperty("/groups/"+u),f,b;n.setProperty("/groups/"+u+"/sortable",false);function M(){r.oPageOperationAdapter.resetGroup(h,p).then(function(e){r._handleAfterSortable(function(e,i,o){var s=r.oModel.getProperty("/groups"),n=g.getIndexOfGroup(s,e);r._loadGroup(n,o||i);c.showLocalizedMessage("group_reset_msg",[i.title]);r.oModel.setProperty("/groups/"+n+"/sortable",true);f=t.byId("dashboardGroups").getGroupControlByGroupId(e);b=f.getBindingContext().getObject().links;if(b&&b.length&&!f.getIsGroupLocked()){r._changeGroupLinksScope(f.getBindingContext().getObject(),r.oModel.getProperty("/tileActionModeActive")?k.Actions:k.Display)}if(f){f.rerender();l.emit("updateGroups",Date.now());d.handleTilesVisibility()}})(s,h,e);r._checkRequestQueue()},function(){r._resetGroupsOnFailure("fail_to_reset_group_msg")})}this._addRequest(M)},_moveGroup:function(e,t,i){if(isNaN(i.fromIndex)){return}var o=i.fromIndex,r=i.toIndex,s=this.oModel,n=s.getProperty("/groups"),a=s.getProperty("/tileActionModeActive"),l,u,d=this,p,h;if(!a){o=this._adjustFromGroupIndex(o,n)}l=n[o];u=l.groupId;if(!a){r=this._adjustToGroupIndex(r,n,u)}h=n[r];this._moveInArray(n,o,r);this._updateGroupIndices(n);for(p=0;p<n.length-1;p++){n[p].isLastGroup=false}n[n.length-1].isLastGroup=true;s.setProperty("/groups",n);function c(){n=s.getProperty("/groups");var e=s.getProperty(g.getModelPathOfGroup(n,u));if(!e.object){return}d.oPageOperationAdapter.getOriginalGroupIndex(h,n).then(function(t){var i={iFromIndex:o,iToIndex:r};return d.oPageOperationAdapter.moveGroup(e,t,i)}).then(d._checkRequestQueue.bind(d),function(){d._resetGroupsOnFailure("fail_to_move_group_msg")})}this._addRequest(c)},_adjustToGroupIndex:function(e,t,i){var o=0,r=false,s=0;for(s=0;s<t.length&&o<e;s++){if(t[s].isGroupVisible){if(t[s].groupId===i){r=true}else{o++}}}if(r){return s-1}return s},_adjustFromGroupIndex:function(e,t){var i=0,o;for(o=0;o<t.length;o++){if(t[o].isGroupVisible){i++}if(i===e+1){return o}}return e},_changeGroupTitle:function(e,t,i){var o=this,r=i.newTitle,s=this.oModel.getProperty("/groups"),n=i.groupId,a=g.getIndexOfGroup(s,n),l=o.oModel.getProperty("/groups/indexOfDefaultGroup")===a,u=this.oModel.getProperty("/groups/"+a),d=u.title;this.oModel.setProperty("/groups/"+a+"/title",r);function p(){var e;if(u.isLastGroup){e=o.oPageOperationAdapter.addGroupAt(u,undefined,l)}else{var t=o.oModel.getProperty("/groups")[a+1];e=o.oPageOperationAdapter.getOriginalGroupIndex(t,s).then(function(e){return o.oPageOperationAdapter.addGroupAt(u,e,l)})}e.then(function(e){o._handleAfterSortable(function(e,t){var i=o.oModel.getProperty("/groups");var r=g.getIndexOfGroup(i,e);var s=i[r];Object.keys(t).forEach(function(e){if(e==="tiles"||e==="links"){return}s[e]=t[e]});o.oModel.refresh();o._checkRequestQueue()})(n,e)},function(){o._resetGroupsOnFailure("fail_to_create_group_msg")})}function h(){this.oPageOperationAdapter.renameGroup(u,r,d).then(function(){o._checkRequestQueue()},function(){o._resetGroupsOnFailure("fail_to_rename_group_msg")})}if(!u.object){this._checkRequestQueue();this._addRequest(p.bind(this))}else{this._addRequest(h.bind(this))}},addGroupToModel:function(e){var t=this.oPageOperationAdapter.getPreparedGroupModel(e,false,true,{isRendered:true}),i=this.oModel.getProperty("/groups"),o=i.length,r;if(o>0){i[o-1].isLastGroup=false}t.index=o;i.push(t);this.oModel.setProperty("/groups/",i);r=new G(this.oModel,"/groups/"+o);return r},_deleteTile:function(e,i,r){var s=r.tileId,n=this.oModel.getProperty("/groups"),a=r.items||"tiles",l,u,p,g;function c(e,t){this.oPageOperationAdapter.removeTile(e,t).then(this._checkRequestQueue.bind(this),this._resetGroupsOnFailure.bind(this,"fail_to_remove_tile_msg"))}function f(e,i,o){var r=t.byId("dashboardGroups"),s=r.getGroupControlByGroupId(i.groupId),n;if(o==="tiles"){if(e+1===i[o].length){n=s.oPlusTile}}else{var a=s.getLinks();if(e+1===a.length){if(a.length===1){n=s.oPlusTile}else{n=a[e-1]}}else{n=a[e+1]}}if(n){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(e){e.getInstance().then(function(e){e.moveScrollDashboard(n.$())})})}}for(p=0;p<n.length;++p){l=n[p];for(g=0;g<l[a].length;++g){u=l[a][g];if(u.uuid===s){if(o.system.desktop){f(g,l,a)}h.destroyTileModel(this.oModel.getProperty("/groups/"+p+"/"+a+"/"+g));var b=l[a].splice(g,1)[0],M=this.oModel.getProperty("/personalization");l.visibilityModes=d.calcVisibilityModes(l,M);this.oModel.setProperty("/groups/"+p,l);this._addRequest(c.bind(this,l,b));d.handleTilesVisibility();return}}}},deleteTilesFromGroup:function(e,t){var i=this.oModel.getProperty("/groups"),o=g.getIndexOfGroup(i,e),r=this.oModel.getProperty("/groups/"+o),s=[];["tiles","links"].forEach(function(e){s=r[e].filter(function(e){if(t.indexOf(e.uuid)<0){return true}return false});r[e]=s});r.visibilityModes=d.calcVisibilityModes(r,true);this.oModel.setProperty("/groups/"+o,r)},_getGroupIndex:function(e){var t=this.oModel.getProperty("/groups"),i=this._getNewGroupInfo(t,e);if(i){return i.newGroupIndex}return undefined},_convertTile:function(e,t,i){var o=i.tile?i.tile:i,r=i.srcGroupId?this._getGroupIndex(i.srcGroupId):undefined,s=i.srcGroupId?this.oModel.getProperty("/groups/"+r):o.getParent().getBindingContext().getObject(),n=o.getBindingContext().sPath.split("/"),a=o.getBindingContext().getObject(),u=n[n.length-2],h=a.uuid,g=parseInt(n[n.length-1],10),c=i.toIndex!==undefined?i.toIndex:undefined,f=this.oModel.getProperty("/tileActionModeActive"),b=i.toGroupId?this._getGroupIndex(i.toGroupId):s.index,M=i.toGroupId?this.oModel.getProperty("/groups/"+b):s,v=this;var m=this._getIndexForConvert(u,g,c,s,M),P={tileIndex:g,groupIndex:r,group:s};function T(){a.tileIsBeingMoved=true;var e=this.oPageOperationAdapter.moveTile(a,m,s,M,u==="links"?"tile":"link");e.then(function(e){v._handleAfterSortable(function(e,t){var o=v._getPathOfTile(e);var r=t.content;if(o){if(u==="tiles"){v._attachLinkPressHandlers(r);v._changeLinkScope(r,f?"Actions":"Display")}if(s===M){_.show(p.i18n.getText("PageRuntime.Message.VisualizationConverted"))}else{_.show(p.i18n.getText("PageRuntime.Message.VisualizationMovedAndConverted"))}var n={tileIndex:c,groupIndex:b,group:M};var h={tile:a,view:r,type:u,tileObj:t.object};a.tileIsBeingMoved=true;v.replaceTileViewAfterConvert(P,n,h);l.emit("updateGroups",Date.now());d.handleTilesVisibility();if(i.callBack){i.callBack(r)}}})(h,e);v._checkRequestQueue()},function(){v._handleAfterSortable(v._resetGroupsOnFailure.bind(v))("fail_to_move_tile_msg")})}this._addRequest(T.bind(this))},replaceTileViewAfterConvert:function(e,t,i){var o=i.tile,r=o.content;o.tileIsBeingMoved=false;o.content=[i.view];o.object=i.tileObj;o.originalTileId=this.oPageOperationAdapter.getTileId(i.tileObj);e.group[i.type].splice(e.tileIndex,1);if(t.tileIndex!==undefined){t.group[i.type==="tiles"?"links":"tiles"].splice(t.tileIndex,0,o)}else{t.group[i.type==="tiles"?"links":"tiles"].push(o)}this.oModel.setProperty("/groups/"+t.groupIndex,t.group);this.oModel.setProperty("/groups/"+e.groupIndex,e.group);if(i.type==="links"){this._handleTileAppearanceAnimation(o.content[0].getParent())}else{this._handleTileAppearanceAnimation(o.content[0])}if(r&&r[0]){r[0].destroy()}},_getIndexForConvert:function(e,t,i,o,r){var s;if(e==="tiles"){if(i!==undefined){s=r[e].length+i}else{s=r[e].length+r.links.length}if(o.groupId===r.groupId){s--}}else{s=i||o.tiles.length;t+=o.tiles.length}return{tileIndex:t,newTileIndex:s}},_getIndexForMove:function(e,t,i,o,r){var s;if(e==="tiles"){s=i!==undefined?i:o[e].length}else{if(i!==undefined){s=o.tiles.length+i}else{s=o.tiles.length+o.links.length}t+=r.tiles.length}return{tileIndex:t,newTileIndex:s}},_getTileInfo:function(e,t,i){var o,r,s,n;for(o=0;o<e.length;++o){s=e[o];for(r=0;r<s[i].length;++r){n=s[i][r];if(n.uuid===t){return{oTile:n,tileIndex:r,oGroup:s,groupIndex:o}}}}return},_getNewGroupInfo:function(e,t){var i;for(var o=0;o<e.length;++o){i=e[o];if(i.groupId===t){return{oNewGroup:i,newGroupIndex:o}}}return},_moveTile:function(t,i,o){var r=o.toIndex,s=o.toGroupId,n=o.sTileId,a=o.source,u=o.sTileType==="tiles"||o.sTileType==="tile"?"tile":"link",h=o.sToItems,g=o.sFromItems,c=this.oModel.getProperty("/tileActionModeActive"),f=this.oModel.getProperty("/groups"),b,M,v,m,P,T={},G=this;m=this._getTileInfo(f,n,g);P=this._getNewGroupInfo(f,s);var y=m.tileIndex===P.oNewGroup.tiles.length-1&&r>=P.oNewGroup.tiles.length;if((m.tileIndex===r||y)&&m.oGroup.groupId===P.oNewGroup.groupId){return}if(m.oGroup.groupId===P.oNewGroup.groupId&&(a==="movetileDialog"||r===null||a==="movelinkDialog")){if(o.callBack&&m.oTile&&m.oTile.content&&m.oTile.content.length){o.callBack(m.oTile.content[0])}return}if(u==="link"){m.oTile.content[0].addStyleClass("sapUshellZeroOpacity")}if(u==="tile"&&h==="tiles"){if(r&&r>P.oNewGroup[h].length){r=P.oNewGroup[h].length}}if(m.oGroup.groupId===s&&h===g){if(r===null||r===undefined){m.oGroup[h].splice(m.tileIndex,1);r=m.oGroup[h].length;m.oGroup[h].push(m.oTile)}else{r=this._adjustTileIndex(r,m.oTile,m.oGroup,h);this._moveInArray(m.oGroup[h],m.tileIndex,r)}this.oModel.setProperty("/groups/"+m.groupIndex+"/"+h,m.oGroup[h])}else{v=this.oModel.getProperty("/personalization");m.oGroup[g].splice(m.tileIndex,1);m.oGroup.visibilityModes=d.calcVisibilityModes(m.oGroup,v);this.oModel.setProperty("/groups/"+m.groupIndex+"/"+g,m.oGroup[g]);if(r===null||r===undefined){r=P.oNewGroup[h].length;P.oNewGroup[h].push(m.oTile)}else{r=this._adjustTileIndex(r,m.oTile,P.oNewGroup,h);P.oNewGroup[h].splice(r,0,m.oTile)}P.oNewGroup.visibilityModes=d.calcVisibilityModes(P.oNewGroup,v);this.oModel.setProperty("/groups/"+P.newGroupIndex+"/"+h,P.oNewGroup[h])}l.emit("updateGroups",Date.now());d.handleTilesVisibility();function I(){b=this.oModel.getProperty("/groups/"+m.groupIndex);M=this.oModel.getProperty("/groups/"+P.newGroupIndex);T=this._getIndexForMove(g,m.tileIndex,r,P.oNewGroup,b);m.oTile.tileIsBeingMoved=true;this.oPageOperationAdapter.moveTile(m.oTile,T,b,M,u).then(function(t){var i=G._getPathOfTile(n);if(i){G.oModel.setProperty(i+"/object",t.object);G.oModel.setProperty(i+"/originalTileId",t.originalTileId);var r=G.oModel.getProperty(i+"/content");var s=t.content;if(h==="links"){G._changeLinkScope(s,c?"Actions":"Display");G._attachLinkPressHandlers(s);G._handleTileAppearanceAnimation(s);m.oTile.content=[s];G.oModel.setProperty(i,e.extend({},m.oTile));G.oModel.setProperty("/groups/"+P.newGroupIndex+"/"+h,G.oModel.getProperty("/groups/"+P.newGroupIndex+"/"+h))}else{G.oModel.setProperty(i+"/content",[s])}if(r&&r[0]){var a=s.onAfterRendering;s.onAfterRendering=function(){a.apply(this);r[0].destroy();s.onAfterRendering=a}}G.oModel.setProperty(i+"/tileIsBeingMoved",false);if(o.callBack){o.callBack(s)}_.show(p.i18n.getText("PageRuntime.Message.VisualizationMoved"))}G._checkRequestQueue()},function(){G._resetGroupsOnFailure("fail_to_move_tile_msg")})}this._addRequest(I.bind(this))},_adjustTileIndex:function(e,t,i,o){var r=0,s=false,n=0;for(n=0;n<i[o].length&&r<e;n++){if(i[o][n].isTileIntentSupported){if(i[o][n]===t){s=true}else{r++}}}if(s){return n-1}return n},getModel:function(){return this.oModel},getDashboardView:function(){return this.oDashboardView},setDashboardView:function(e){this.oDashboardView=e;return this},setTileVisible:function(e,t){this.oPageOperationAdapter.setTileVisible(e.object,t)},refreshTile:function(e){this.oPageOperationAdapter.refreshTile(e.object)},updateSettings:function(e){this.oModel=e.model||this.oModel;this.oConfig=e.config||this.oConfig;this.oRouter=e.router||this.oRouter;this.oDashboardView=e.view||this.oDashboardView},_resetGroupsOnFailure:function(e,t){this._requestFailed();c.showLocalizedError(e,t);this.bStartLoadRemainSegment=false;this.loadPersonalizedGroups();this.oModel.updateBindings(true)},resetGroupsOnFailure:function(){this._resetGroupsOnFailure.apply(this,arguments)},_bindSegment:function(e,t){var i,o,r,s;for(i=0;i<t.length;i++){r=t[i];s=r.index;o=e[s];if(o){o.isRendered=true;o.tiles=o.tiles.concat(r.tiles);o.links=o.links.concat(r.links)}}return e},createGroupsModelFrame:function(t,i){var o,r=[],s,n;n=function(t){var i=e.extend({},t);i.tiles=[];i.pendingLinks=[];i.links=[];return i};for(o=0;o<t.length;o++){s=t[o];r[o]=n(s);r[o].isRendered=false;r[o].visibilityModes=d.calcVisibilityModes(s,i)}return r},_splitGroups:function(e,t){var i,o=[],r=0,s=this.oModel.getProperty("/homePageGroupDisplay")==="tabs",n=this.oModel.getProperty("/personalization"),a=0,l;var u=500;for(i=0;i<e.length;i++){l=e[i];o.push(l);if(!this.segmentsStore.length){r+=this.PagingManager.getGroupHeight(l,t===i,n)}else{a+=l.tiles.length+l.links.length}if(s&&!this.segmentsStore.length&&r>0){o.loadTilesView=true;this.segmentsStore.push(o);o=[];r=0}if(r>=1||a>=u){this.segmentsStore.push(o);o=[];r=0;a=0}}if(o.length){this.segmentsStore.push(o)}},_processSegment:function(e){var t=this.segmentsStore.shift();if(!t){return e}if(this.isBlindLoading()===false){if(this.oModel.getProperty("/homePageGroupDisplay")!=="tabs"||t.loadTilesView){this.getSegmentContentViews(t)}}e=this._bindSegment(e,t);return e},getSegmentContentViews:function(e){var t,i,o,r;for(t=0;t<e.length;t++){o=e[t];for(i=0;i<o.tiles.length;i++){r=o.tiles[i];if(r.isTileIntentSupported){this.getTileView(r)}}for(i=0;i<o.links.length;i++){r=o.links[i];if(r.isTileIntentSupported){this.getTileView(r,o.index)}}}this.bIsFirstSegmentViewLoaded=true},getSegmentTabContentViews:function(e,t,i){var o,r,s=i.iSelectedGroup,n;n=this.oModel.getProperty("/groups/"+s);for(o=0;o<n.tiles.length;o++){r=n.tiles[o];if(r.isTileIntentSupported){this.getTileView(r)}}for(o=0;o<n.links.length;o++){r=n.links[o];if(r.isTileIntentSupported){this.getTileView(r,s)}}},_handleBookmarkModelUpdate:function(){this.bIsGroupsModelDirty=false;this.bGroupsModelLoadingInProcess=true;this.loadPersonalizedGroups()},_modelLoaded:function(){this.bGroupsModelLoadingInProcess=false;if(this.bIsGroupsModelDirty){this._handleBookmarkModelUpdate()}},handleFirstSegmentLoaded:function(){var e=this.oModel.getProperty("/groups");if(this.aGroupsFrame){Array.prototype.push.apply(e,this.aGroupsFrame);this.aGroupsFrame=null}this._initializeAnchorNavigationBar();if(!this.bStartLoadRemainSegment){this._processRemainingSegments()}},_initializeAnchorNavigationBar:function(){var e,t=S.getDashboardView();e=t.getAnchorItemTemplate();this.oDashboardView.oAnchorNavigationBar.bindAggregation("groups",{path:"/groups",template:e})},_processRemainingSegments:function(){var e;if(this.segmentsStore.length>0){window.setTimeout(function(){e=this._processSegment(this.oModel.getProperty("/groups"));this.oModel.setProperty("/groups",e);this.bIsFirstSegment=false;this._processRemainingSegments()}.bind(this),0)}else{this.bIsGroupsModelLoading=false;this._updateModelWithTileView(0,0);d.handleTilesVisibility();t.getEventBus().publish("launchpad","dashboardModelContentLoaded");l.emit("updateGroups",Date.now())}},tabsModeVisibilityChanged:function(){if(this.bIsFirstSegmentViewLoaded===false&&this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){this.oDashboardLoadingManager.manageTilesView();this.bIsFirstSegmentViewLoaded=true;l.emit("firstSegmentCompleteLoaded",true)}},_setGroupModel:function(t){if(this.bIsGroupsModelLoading){y.info("Skip set the group model, because the group model is still loading");return}var i=0,o,r=0,s=0,a=0,u,p,g=null,c,f,b=[];this.bIsGroupsModelLoading=true;try{r=this.oModel.getProperty("/groups").length}catch(e){}for(i=t.length;i<r;++i){h.destroyFLPAggregationModel(this.oModel.getProperty("/groups/"+i))}if(!this.PagingManager){var M=e("#dashboardGroups").width();if(!M){M=window.innerWidth}var v=e("#sapUshellDashboardPage-cont").height();if(v<100){v=window.innerHeight}this.PagingManager=new n("dashboardPaging",{supportedElements:{tile:{className:"sapUshellTile"},link:{className:"sapUshellLinkTile"}},containerHeight:v,containerWidth:M})}t.forEach(function(e){if(e.isGroupVisible){s+=e.tiles.length}});this.bIsScrollModeAccordingKPI=s>this.iMinNumOfTilesForBlindLoading;this.aGroupsFrame=this.createGroupsModelFrame(t,this.oModel.getProperty("/personalization"));for(i=0;i<this.aGroupsFrame.length;i++){if(this.aGroupsFrame[i].isGroupVisible&&this.aGroupsFrame[i].visibilityModes[0]){if(g===null){g=i;this.aGroupsFrame[i].isGroupSelected=true;this.oModel.setProperty("/iSelectedGroup",i)}a++;if(a>1){this.aGroupsFrame[g].showGroupHeader=false;break}}}this._splitGroups(t,g);p=this.segmentsStore[0]?this.segmentsStore[0].length:0;u=this.aGroupsFrame.splice(0,p);I.start("FLP:DashboardManager._processSegment","_processSegment","FLP");b=this._processSegment(u);t.every(function(e,t){if(e.isDefaultGroup){o=t;return false}return true});b.indexOfDefaultGroup=o;if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){c=this.getDashboardView();if(c){f=c.oDashboardGroupsBox;var m=f.getBinding("groups");if(m){m.filter([c.oFilterSelectedGroup])}}}I.end("FLP:DashboardManager._processSegment");this.oModel.setProperty("/groups",b);this.aGroupModel=b;if(this.oDashboardView){l.once("firstSegmentCompleteLoaded").do(function(){d.setPerformanceMark("FLP-TTI-Homepage",{bUseUniqueMark:true})}).do(this.handleFirstSegmentLoaded.bind(this))}else{setTimeout(function(){Array.prototype.push.apply(this.aGroupModel,this.aGroupsFrame);this.aGroupsFrame=null;this.bStartLoadRemainSegment=true;this._processRemainingSegments()}.bind(this),0)}if(this.bIsFirstSegmentViewLoaded){l.emit("firstSegmentCompleteLoaded",true)}I.end("FLP:DashboardManager.loadGroupsFromArray")},getPreparedGroupModel:function(){return this.aGroupModel},_loadGroup:function(e,t){var i=this,o="/groups/"+e,r=i.oModel.getProperty(o),s=r.isLastGroup,n=r.groupId;h.destroyFLPAggregationModel(r);if(n){t.groupId=n}t.isLastGroup=s;t.index=e;t.isRendered=true;this.oModel.setProperty(o,t)},_hasPendingLinks:function(e){for(var t=0;t<e.length;t++){if(e[t].content[0]===undefined){return true}}return false},_addModelToTileViewUpdateQueue:function(e,t){this.tileViewUpdateQueue.push({uuid:e,view:t})},_updateModelWithTileView:function(e,t){var i=this;if(this.tileViewUpdateTimeoutID){clearTimeout(this.tileViewUpdateTimeoutID)}this.tileViewUpdateTimeoutID=window.setTimeout(function(){i.tileViewUpdateTimeoutID=undefined;i.oSortableDeferred.done(function(){i._updateModelWithTilesViews(e,t)})},50)},_updateGroupModelWithTilesViews:function(e,t,i,o){var r,s,n,a,l=t||0;for(var u=l;u<e.length;u=u+1){r=e[u];for(var d=0;d<this.tileViewUpdateQueue.length;d++){s=this.tileViewUpdateQueue[d];if(r.uuid===s.uuid){i.push(d);if(s.view){if(o){r.content=[s.view]}else{r.content[0].destroy();r.content=[s.view]}this.oDashboardLoadingManager.setTileResolved(r);n=this.oPageOperationAdapter.getTileSize(r.object);a=n!==null&&n==="1x2"||false;if(r.long!==a){r.long=a}}else{r.content[0].setState("Failed")}break}}}},_updateModelWithTilesViews:function(e,t){var i=this.oModel.getProperty("/groups"),o=e||0,r=[];if(!i||this.tileViewUpdateQueue.length===0){return}for(var s=o;s<i.length;s=s+1){this._updateGroupModelWithTilesViews(i[s].tiles,t,r);if(i[s].links){this._updateGroupModelWithTilesViews(i[s].links,t,r,true);if(i[s].pendingLinks.length>0){if(!i[s].links){i[s].links=[]}i[s].links=i[s].links.concat(i[s].pendingLinks);i[s].pendingLinks=[]}}}var n=[],a;for(a=0;a<this.tileViewUpdateQueue.length;a++){if(r.indexOf(a)===-1){n.push(this.tileViewUpdateQueue[a])}}this.tileViewUpdateQueue=n;this.oModel.setProperty("/groups",i)},getModelTileById:function(e,t){var i=this.oModel.getProperty("/groups"),o,r=false;i.every(function(i){i[t].every(function(t){if(t.uuid===e||t.originalTileId===e){o=t;r=true}return!r});return!r});return o},_attachLinkPressHandlers:function(e){var i=t.getEventBus(),o=e.attachPress?e:e.getContent()[0];o.attachPress(function(t){var o=e.getBindingContext().getObject().tileIsBeingMoved;if(!o&&this.getScope&&this.getScope()==="Actions"){switch(t.getParameters().action){case"Press":var r=e.getState?e.getState():"";if(r!=="Failed"){sap.ui.require("sap/ushell/components/homepage/ActionMode")._openActionsMenu(t)}break;case"Remove":var s=e.getBindingContext().getObject().uuid;i.publish("launchpad","deleteTile",{tileId:s,items:"links"});break;default:break}}else{i.publish("launchpad","dashboardTileLinkClick")}})},handleDisplayModeChange:function(e){this.oModel.setProperty("/homePageGroupDisplay",e);switch(e){case"scroll":this._handleDisplayModeChangeToScroll();break;case"tabs":this._handleDisplayModeChangeToTabs();break}},_handleDisplayModeChangeToTabs:function(){var e=this.oModel.getProperty("/iSelectedGroup"),t=this.oModel.getProperty("/groups");this.oDashboardLoadingManager.manageTilesView();if(t.length>0){for(var i=0;i<t.length;i++){this.oModel.setProperty("/groups/"+i+"/isGroupSelected",false)}this.oModel.setProperty("/groups/"+e+"/isGroupSelected",true)}},_handleDisplayModeChangeToScroll:function(){if(this.isBlindLoading()){return}var e=this.oModel.getProperty("/groups"),i,o,r,s=[],n,a;for(n=0;n<e.length;n++){i=e[n];o=i.tiles||[];for(a=0;a<o.length;a++){r=o[a];if(r.content.length===0){this.getTileView(r,n)}}s=i.links||[];for(a=0;a<s.length;a++){this.getTileView(s[a],n)}}this.oModel.refresh(false);var l=this.oModel.getProperty("/iSelectedGroup");if(l){setTimeout(function(){t.getEventBus().publish("launchpad","scrollToGroup",{groupId:e[l].groupId})},100)}},getTileViewsFromArray:function(e){var t=this;if(e.length===0){return}e.forEach(function(e){t.getTileView(e.oTile,e.iGroup)});this.oModel.refresh(false);if(this.bIsFirstSegmentViewLoaded===false){this.bIsFirstSegmentViewLoaded=true;l.emit("firstSegmentCompleteLoaded",true)}},getTileView:function(e,t){var i=this.oPageOperationAdapter.getTileType(e.object);if(this.oDashboardLoadingManager.isTileViewRequestIssued(e)){return}this.oDashboardLoadingManager.setTileInProgress(e);this.oPageOperationAdapter.setTileVisible(e.object,false);if(i==="card"){this._loadCardData(e)}else{this._loadTileData(e,t,i)}},_loadCardData:function(e){var i=t.byId(e.controlId);if(i&&i.setManifest&&this.isBlindLoading()){i.setManifest(e.manifest)}e.content=[e.manifest];this.oDashboardLoadingManager.setTileResolved(e)},getCurrentHiddenGroupIds:function(e){return this.oPageOperationAdapter.getCurrentHiddenGroupIds(e)},_loadTileData:function(e,t,i){var o=this,r=this.oPageOperationAdapter.getTileView(e),n,a,l,u=this._addModelToTileViewUpdateQueue,d,p=false,h=e.uuid,g=false;if(r.state()==="resolved"){g=true}r.done(function(i){if(i.oController&&i.oController.navigationTargetUrl&&!e.isCustomTile){e.target=i.oController.navigationTargetUrl}d=i;if(d.getComponentInstance){I.average("FLP:getComponentInstance","get info for navMode","FLP1");var r=d.getComponentInstance().getComponentData();if(r&&r.properties){e.navigationMode=r.properties.navigationMode}I.end("FLP:getComponentInstance")}o.oDashboardLoadingManager.setTileResolved(e);n=i.getMode?i.getMode():"ContentMode";if(o.bLinkPersonalizationSupported&&n==="LineMode"){o._attachLinkPressHandlers(d);if(t>=0){a=o.oModel.getProperty("/groups");if(a[t]){e.content=[d];l=o.oModel.getProperty("/groups/"+t+"/links");o.oModel.setProperty("/groups/"+t+"/links",[]);o.oModel.setProperty("/groups/"+t+"/links",l)}}}else if(o.isBlindLoading()){if(e.content&&e.content.length>0){e.content[0].destroy()}e.content=[d];if(t>=0&&!g){o.oModel.refresh(false)}}if(o.isBlindLoading()){var s=o.oPageOperationAdapter.getTileSize(e.object);var c=s==="1x2";if(e.long!==c){e.long=c}}else if(n==="LineMode"){e.content=[d];if(p){l=o.oModel.getProperty("/groups/"+t+"/links");o.oModel.setProperty("/groups/"+t+"/links",[]);o.oModel.setProperty("/groups/"+t+"/links",l)}}else if(e.content.length===0){e.content=[d]}else{u.apply(o,[h,d]);o._updateModelWithTileView(0,0)}});r.fail(function(){if(o.oPageOperationAdapter.getTileType(e.object)==="link"&&o.bLinkPersonalizationSupported){d=o.oPageOperationAdapter.getFailedLinkView(e);o._attachLinkPressHandlers(d)}else{d=new s({state:"Failed"})}e.content=[d]});if(!d){if(o.oPageOperationAdapter.getTileType(e.object)==="link"){p=true;d=new f({mode:"LineMode"})}else{d=new s}e.content=[d]}},loadPersonalizedGroups:function(){var t=this;var i=new e.Deferred;if(this.bIsGroupsRequestPending){y.info("loadPersonalizedGroups was skipped because there is already a pending request.");i.reject();return i.promise()}this.bIsGroupsRequestPending=true;this.oServiceLoadingPromise.then(function(){return t.oPageOperationAdapter.getPage()}).then(function(e){t._setGroupModel(e);t.bIsGroupsRequestPending=false;i.resolve()}).catch(function(){c.showLocalizedError("fail_to_load_groups_msg");t.bIsGroupsRequestPending=false});I.start("FLP:DashboardManager.loadPersonalizedGroups","loadPersonalizedGroups","FLP");return i.promise()}});A.prototype.getInstance=function(){return S};return A});