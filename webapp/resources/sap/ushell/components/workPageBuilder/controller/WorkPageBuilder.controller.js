//Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/mvc/Controller","sap/base/util/uid","sap/ushell/EventHub","sap/ushell/components/workPageBuilder/controls/WorkPageWidgetContainer","sap/ushell/components/workPageBuilder/controls/WorkPageCell","sap/ushell/components/workPageBuilder/controls/WorkPageSection","sap/ui/integration/widgets/Card","sap/ui/core/Fragment","sap/ui/integration/Host","sap/base/util/ObjectPath","sap/ui/model/json/JSONModel"],function(t,e,o,i,n,r,a,s,l,d,g,h){"use strict";var u=4;var c=24;var p=2;var C=6;function f(){i.emit("WorkPageHasChanges",true)}return e.extend("sap.ushell.components.workPageBuilder.controller.WorkPageBuilder",{onInit:function(){this._fnDeleteRowHandler=this.deleteRow.bind(this);this._sModelRootPath=this.getOwnerComponent().getModelRootPath();this._sWorkPageRootPath=this._sModelRootPath+"/WorkPage";this._sVizRootPath=this._sModelRootPath+"/Visualizations";this._sCatalogRootPath=this._sModelRootPath+"/Catalog";this.oModel=new h({editMode:false,data:null});this._saveHost();this.byId("sapCepWorkPage").bindElement({path:this._sWorkPageRootPath})},onAddColumn:function(t){var e=this.getView().getModel();var o=t.getSource();var i=o.getParent();var n=i.indexOfAggregation("columns",o);var r=i.getBindingContext().getPath();var a=r+"/Columns/";var s=o.getBindingContext().getPath()+"/Descriptor/columnWidth";var l=e.getProperty(a);var d=l.length;var g=t.getParameter("left");if(d>=C){return}var h=o.getProperty("columnWidth");var p=Math.floor(h/2)>=u?Math.floor(h/2):u;var v=p%2;e.setProperty(s,p+v);var P=i.indexOfAggregation("columns",o)+(g===true?0:1);l.splice(P,0,this._createEmptyColumn(p-v));var m=l.reduce(function(t,e){return t+this._getColumnWidth(e)}.bind(this),0);if(m>c){this._calculateColWidths(l,n,m)}e.setProperty(a,l);f()},setEditMode:function(t){this.oModel.setProperty("/editMode",t)},getEditMode:function(){return this.oModel.getProperty("/editMode")},setPageData:function(t){this.oModel.setProperty(this._sModelRootPath,t)},getPageData:function(){return this.oModel.getData()},setCatalogData:function(t){this.oModel.setProperty(this._sCatalogRootPath,t)},onDeleteColumn:function(t){var e=this.getView().getModel();var o=t.getSource();var i=o.getColumnWidth();var n=o.getParent();var r=n.indexOfAggregation("columns",o);var a=n.getBindingContext().getPath();var s=a+"/Columns/";var l=e.getProperty(s);l.splice(r,1);var d=i/2;var g=r-1<0?r:r-1;while(d>0){var h=l[g];this._setColumnWidth(h,this._getColumnWidth(h)+p);g=++g>=l.length?0:g++;d--}e.setProperty(s,l);f()},onAddFirstRow:function(){var t=this._sWorkPageRootPath+"/Rows/";this.getView().getModel().setProperty(t,[this._createEmptyRow()]);f()},onAddRow:function(t){var e=this.getView().getModel();var o=t.getSource();var i=this.byId("sapCepWorkPage");var n=this._sWorkPageRootPath+"/Rows/";var r=e.getProperty(n);var a=this._createEmptyRow();var s=i.indexOfAggregation("rows",o)+(t.getParameter("bottom")===true?1:0);r.splice(s,0,a);e.setProperty(n,r);f()},onResize:function(t){var e=t.getParameter("posXDiff");var o=t.getSource();var i=o.getParent();var n=i.getSingleColumnWidth();var r,a,s,l,d,g,h,u;if(n===0){return}r=e/n;if(r>-1&&r<1){return}a=r<0?Math.floor(e/n):Math.ceil(e/n);s=a>=0?"right":"left";l=i.indexOfAggregation("columns",o);d=l-1;g=this._getCurrentColumnWidth(i,d);h=this._getCurrentColumnWidth(i,l);u=this._doColumnResizeStep(i,d,l,g,h,s);if(u){this._updateModelWithColumnWidths(i,d,l,u.newLeftColumnWidth,u.newRightColumnWidth)}f()},onDeleteWidget:function(t,e){var o=this.getView().getModel();var i=e.getParent();var n=i.indexOfAggregation("cells",e);var r=i.getBindingContext().getPath()+"/Cells";var a=o.getProperty(r);a.splice(n,1);o.setProperty(r,a);f()},onDeleteVisualization:function(t){var e=t.getBindingContext();var o=e.getPath();var i=this.getView().getModel();var n=o.substring(0,o.lastIndexOf("/"));var r=i.getProperty(o);var a=i.getProperty(n).filter(function(t){return t.Visualization.Id!==r.Visualization.Id});i.setProperty(n,a);f()},onEditTitle:function(){f()},onWidgetAdded:function(){f()},onAddWidget:function(t){this._oColumn=t.getSource();if(!this._oPromise){this._oPromise=this._loadContentFinderDialog()}return this._oPromise.then(function(t){this.oContentFinderDialog=t;var e={oWorkPageBuilderView:this.getView(),sCatalogRootPath:this._sCatalogRootPath,sVizRootPath:this._sVizRootPath,oColumn:this._oColumn,fnOnWidgetAdded:this.onWidgetAdded};this.oContentFinderDialogController.connect(this.sFragmentId,t,e,{iCurrentPageIndex:0});this.oContentFinderDialog.open()}.bind(this))},onAddApplications:function(t){var e=t.getSource();if(!this._oPromise){this._oPromise=this._loadContentFinderDialog()}return this._oPromise.then(function(t){this.oContentFinderDialog=t;var o={oWorkPageBuilderView:this.getView(),sCatalogRootPath:this._sCatalogRootPath,sVizRootPath:this._sVizRootPath,oCell:e,fnOnWidgetAdded:this.onWidgetAdded};this.oContentFinderDialogController.connect(this.sFragmentId,t,o,{iCurrentPageIndex:1,bRestrictedMode:true,sWidgetType:"widgets-tiles"});this.oContentFinderDialog.open()}.bind(this))},_loadContentFinderDialog:function(){return new Promise(function(t,e){sap.ui.require(["sap/ushell/components/workPageBuilder/controller/ContentFinderDialog.controller"],function(o){this.oContentFinderDialogController=new o;this.sFragmentId=this.createId("ContentFinderDialog");this.oContentFinderDialogController.init();l.load({id:this.sFragmentId,fragmentName:"sap.ushell.components.workPageBuilder.view.ContentFinderDialog",controller:this.oContentFinderDialogController}).then(function(e){this.getView().addDependent(e);t(e)}.bind(this)).catch(e)}.bind(this),e)}.bind(this))},onDeleteRow:function(t){var e=this.getOwnerComponent().getRootControl();var o=t.getSource().getBindingContext();if(!this.oLoadDeleteDialog){this.oLoadDeleteDialog=l.load({id:e.createId("rowDeleteDialog"),name:"sap.ushell.components.workPageBuilder.view.WorkPageRowDeleteDialog",controller:this}).then(function(t){t.setModel(this.getView().getModel("i18n"),"i18n");return t}.bind(this))}this.oLoadDeleteDialog.then(function(t){t.getBeginButton().detachEvent("press",this._fnDeleteRowHandler);t.getBeginButton().attachEvent("press",{rowContext:o},this._fnDeleteRowHandler);t.open()}.bind(this))},deleteRow:function(t,e){var o=this.getView().getModel();var i=e.rowContext;var n=o.getProperty(this._sWorkPageRootPath+"/Rows");var r=n.indexOf(i.getObject());if(r<=-1){return}n.splice(r,1);o.setProperty(this._sWorkPageRootPath+"/Rows",n);f();this.oLoadDeleteDialog.then(function(t){t.close()})},onRowDeleteCancel:function(){this.oLoadDeleteDialog.then(function(t){t.close()})},_isSectionCell:function(t){var e=t.getProperty("Widgets");if(e.length===0){return false}if(t.getProperty("Descriptor/tileMode")){return true}if(e.length>1){return true}var o=e[0].Visualization.Id;var i=t.getModel().getProperty("/data/Visualizations/"+o);return i?["sap.ushell.StaticAppLauncher","sap.ushell.DynamicAppLauncher"].indexOf(i.Type)>-1:false},cellFactory:function(t,e){var o=new r(t,{});if(this._isSectionCell(e)){var i=this.createId("sapCepWorkPageSection")+t;var n=this.createId("sapCepWorkPageWidgetContainer")+i;var a=this._createSection(i,{});var s=this._createWidgetContainer(n,o);a.bindAggregation("visualizations",{path:"Widgets"});a.bindProperty("editMode",{path:"/editMode"});o.addAggregation("widgetContainers",s.setWidget(a))}else{o.bindAggregation("widgetContainers",{path:"Widgets",factory:this.widgetFactory.bind(this,o)})}return o},widgetFactory:function(e,o,i){var n=i.getProperty("Visualization/Id");var r=this.createId("sapCepWorkPageWidgetContainer")+o;var a=this._createWidgetContainer(r,e);if(!n){t.error("No vizId found");return a}var s=this.getView().getModel().getProperty(this._sVizRootPath+"/"+n);if(!s||!s.Type){t.error("No viz or vizType found for vizId "+n);return a}switch(s.Type){case"sap.card":return a.setWidget(this._createCard(o,s));default:return a}},_createWidgetContainer:function(t,e){var o=new n(t,{editMode:"{/editMode}",openWidgetSettingsTooltip:"{i18n>WorkPage.WidgetContainer.OpenWidgetSettingsButtonTooltip}",deleteWidgetTooltip:"{i18n>WorkPage.WidgetContainer.DeleteWidgetButtonTooltip}"}).attachEvent("deleteWidget",this._deleteWidget.bind(this,e));e.addDependent(o);return o},_createSection:function(t){var e=new a(t);e.attachEvent("deleteVisualization",this._deleteVisualization.bind(this));e.attachEvent("addApplications",this.onAddApplications.bind(this));return e},_deleteVisualization:function(t){var e=t.getParameters().getSource();this.onDeleteVisualization(e)},_deleteWidget:function(t,e){this.onDeleteWidget(e.getSource(),t)},_createCard:function(e,o){var i={};var n=o.Descriptor&&o.Descriptor["sap.card"];var r=o.DescriptorResources&&(o.DescriptorResources.BaseUrl||o.DescriptorResources.DescriptorPath);if(!n&&!r){t.error("No Descriptor or DescriptorResources for Card");return new s(e)}if(n){i.manifest=o.Descriptor;if(r){i.baseUrl=o.DescriptorResources.BaseUrl+o.DescriptorResources.DescriptorPath}}else if(r){i.manifest=o.DescriptorResources.BaseUrl+o.DescriptorResources.DescriptorPath+"/manifest.json"}if(i.baseUrl&&i.baseUrl.substr(-1)!=="/"){i.baseUrl+="/"}var a=new s(e,i).addStyleClass("sapCepWidget");a.attachAction(this.executeNavigation);a.setHost(this.oHost);return a},executeNavigation:function(t){var e=t.getParameter("parameters");if(t.getParameter("type")!=="Navigation"){return Promise.resolve()}return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(t){return t.toExternal({target:{semanticObject:e.ibnTarget.semanticObject,action:e.ibnTarget.action},params:e.ibnParams})})},saveEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:true})},cancelEditChanges:function(){this.getOwnerComponent().fireEvent("closeEditMode",{saveChanges:false})},_updateModelWithColumnWidths:function(t,e,o,i,n){var r=this.getView().getModel();var a=t.getBindingContext();var s=a.getPath();var l=s+"/Columns/"+e+"/Descriptor/columnWidth";var d=s+"/Columns/"+o+"/Descriptor/columnWidth";r.setProperty(l,i);r.setProperty(d,n)},_updateColumnWidthClass:function(t,e,o){t.$().find(".sapCepWorkPageColumn").eq(e).removeClass(function(t,e){return(e.match(/sapCepColumnWidth.*/g)||[]).join(" ")}).addClass("sapCepColumnWidth"+o)},_doColumnResizeStep:function(e,o,i,n,r,a){var s=sap.ui.getCore().getConfiguration().getRTL();var l=0;if(!s){l=a==="right"?p:-p}else{l=a==="right"?-p:p}var d=n+l;var g=r-l;if(d<u||g<u){t.debug("new column value too small",d,g);return null}this._updateColumnWidthClass(e,o,d);this._updateColumnWidthClass(e,i,g);return{newLeftColumnWidth:d,newRightColumnWidth:g}},_getCurrentColumnWidth:function(t,e){var o=t.getBindingContext().getPath();var i=o+"/Columns/"+e+"/Descriptor/columnWidth";return this.getView().getModel().getProperty(i)},_getColumnWidth:function(t){return g.get("Descriptor.columnWidth",t)||c},_setColumnWidth:function(t,e){return g.set("Descriptor.columnWidth",e,t)},_calculateColWidths:function(t,e,o){var i=t[e];if(this._getColumnWidth(i)-p>=u){this._setColumnWidth(i,this._getColumnWidth(i)-p);o=o-p}if(o>c){var n=e-1>=0?e-1:t.length-1;this._calculateColWidths(t,n,o)}return t},_createEmptyColumn:function(t){return{Id:o(),Descriptor:{columnWidth:t},Configurations:[],Cells:[]}},_createEmptyRow:function(){return{Id:o(),Descriptor:{title:this.getView().getModel("i18n").getResourceBundle().getText("WorkPage.Row.OverflowToolbar.RowTitleLabel"),description:"this is not yet rendered",fillRowHeight:false,fullWidth:false},Columns:[this._createEmptyColumn(c)]}},_createEmptyCell:function(){return{Id:o(),Descriptor:{},Widgets:[]}},_saveHost:function(){this.oHost=sap.ui.getCore().byId("sap.shell.host.environment");if(!this.oHost){this.oHost=new d("sap.shell.host.environment",{resolveDestination:function(t){if(!t){return Promise.reject()}return Promise.resolve("/dynamic_dest/"+t)}})}}})});