// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/View","sap/ui/core/mvc/Controller","sap/ushell/components/CatalogsManager","sap/ui/thirdparty/jquery","sap/ui/core/library","sap/m/MessageToast","sap/ushell/resources"],function(e,t,r,o,s,a,n){"use strict";return t.extend("sap.ushell.components.appfinder.HierarchyApps",{onInit:function(){var e=this.getView().getViewData().easyAccessSystemsModel;if(e){this.getView().setModel(e,"easyAccessSystems")}},getCrumbsData:function(e,t){var r=e.split("/");r.splice(r.length-2,2);var o=[];while(r.length){var s=r.join("/");var a=t.getProperty(s+"/text");o.unshift({text:a,path:s});r.splice(r.length-2,2)}return o},_updateAppBoxedWithPinStatuses:function(e){var t=this.getView();if(!e){e=t.layout.getBinding("items").getPath()}var r=t.getModel("easyAccess");var o=r.getProperty(e)?r.getProperty(e):[];this.getView().oVisualizationOrganizerHelper.updateBookmarkCount.call(this,o).then(function(t){r.setProperty(e,t)})},updateBookmarkCount:function(e){return sap.ushell.Container.getServiceAsync("Bookmark").then(function(t){var r=e.map(function(e){return t.countBookmarks(e.url).then(function(t){e.bookmarkCount=t;return e})});return new Promise(function(e){o.when.apply(o,r).then(function(){var t=Array.prototype.slice.call(arguments);e(t)})})})},updatePageBindings:function(e){this.getView().layout.bindAggregation("items","easyAccess>"+e+"/apps",this.getView().oItemTemplate);this._updateAppBoxedWithPinStatuses(e+"/apps");this.getView().breadcrumbs.bindProperty("currentLocationText","easyAccess>"+e+"/text");var t=this.getCrumbsData(e,this.getView().getModel("easyAccess"));this.getView().crumbsModel.setProperty("/crumbs",t);var r=this.getView().getModel("easyAccess").getProperty(e+"/apps");this.getView().updateResultSetMessage(r.length,false)},onAppBoxPressed:function(e){if(e.mParameters.srcControl.$().closest(".sapUshellPinButton").length){return}var t=e.getSource().getProperty("url");if(t&&t.indexOf("#")===0){hasher.setHash(t)}},_handleSuccessMessage:function(e,t){var r;var o=t.addToGroups?t.addToGroups.length:0;var s=t.newGroups?t.newGroups.length:0;var i=o+s;if(i===1){var u;if(o===1){u=t.addToGroups[0].title}else{u=t.newGroups[0]}r=n.i18n.getText("appAddedToSingleGroup",[e.text,u])}else{r=n.i18n.getText("appAddedToSeveralGroups",[e.text,i])}if(i>0){a.show(r,{duration:3e3,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"})}return r},_prepareErrorMessage:function(e,t){var r,o,s,a=0,i=false,u;for(var p in e){r=e[p].group;o=e[p].action;if(o==="addBookmark_ToExistingGroup"){a++;if(a===1){s=r.title}}else if(o==="addBookmark_ToNewGroup"){a++;if(a===1){s=r}}else{i=true}}if(i){if(e.length===1){u=n.i18n.getText({messageId:"fail_tile_operation_create_new_group"})}else{u=n.i18n.getText({messageId:"fail_tile_operation_some_actions"})}}else if(e.length===1){u=n.i18n.getText({messageId:"fail_app_operation_add_to_group",parameters:[t,s]})}else{u=n.i18n.getText({messageId:"fail_app_operation_add_to_several_groups",parameters:[t]})}return u},_handleBookmarkAppPopoverResponse:function(e,t){var r=[];t.newGroups.forEach(function(t){r.push(this._createGroupAndAddBookmark(t,e))}.bind(this));t.addToGroups.forEach(function(t){r.push(this._addBookmark(t,e))}.bind(this));return o.when.apply(o,r).then(function(){var r=Array.prototype.slice.call(arguments);this._handlePopoverGroupsActionPromises(e,t,r)}.bind(this))},_handlePopoverGroupsActionPromises:function(e,t,o){var s=o.filter(function(e,t,r){return!e.status});if(s.length){var a=this._prepareErrorMessage(s,e.text);var n=r.prototype.getInstance();n.notifyOnActionFailure(a.messageId,a.parameters);return}this._updateAppBoxedWithPinStatuses();this._handleSuccessMessage(e,t)},_createGroupAndAddBookmark:function(e,t){var s=r.prototype.getInstance();var a=o.Deferred(),n={};var i=s.createGroup(e);i.done(function(r){var o=this._addBookmark(r.getObject(),t,true);o.done(function(e){a.resolve(e)}).fail(function(){n={group:e,status:0,action:"addBookmark_ToNewGroup"};a.resolve(n)})}.bind(this)).fail(function(){n={group:e,status:0,action:"addBookmark_NewGroupCreation"};a.resolve(n)});return a.promise()},_addBookmark:function(e,t,r){var s=o.Deferred(),a={};sap.ushell.Container.getServiceAsync("Bookmark").then(function(o){var n=o.addBookmark({url:t.url,title:t.text,subtitle:t.subtitle,icon:t.icon},e.object);var i=r?"addBookmark_ToNewGroup":"addBookmark_ToExistingGroup";n.done(function(){a={group:e,status:1,action:i};s.resolve(a)}).fail(function(){a={group:e,status:0,action:i};s.resolve(a)})});return s.promise()},showSaveAppPopover:function(e){this.getView().oVisualizationOrganizerHelper.onHierarchyAppsPinButtonClick.call(this,e).then(function(e){if(e){this._updateAppBoxedWithPinStatuses()}}.bind(this))},showGroupListPopover:function(t){var r=this.getView().getModel();var o=t.oSource.getParent().getBinding("title").getContext().getObject();var s=t.oSource;if(r.getProperty("/groupContext").path){var a=r.getProperty("/groupContext").path;var n=r.getProperty(a);var i={newGroups:[],addToGroups:[n]};this._handleBookmarkAppPopoverResponse(o,i);return}var u=r.getProperty("/groups").map(function(e){return{selected:false,initiallySelected:false,oGroup:e}});e.create({viewName:"module:sap/ushell/components/appfinder/GroupListPopoverView",viewData:{enableHideGroups:r.getProperty("/enableHideGroups"),enableHelp:r.getProperty("/enableHelp"),singleGroupSelection:true}}).then(function(e){e.getController().initializeData({groupData:u});var t=e.open(s);t.then(this._handleBookmarkAppPopoverResponse.bind(this,o));this.getView().addDependent(e);return e}.bind(this))},resultTextFormatter:function(e,t){var r=n.i18n;if(e){var o=e.systemName?e.systemName:e.systemId;var s="";if(t){s=r.getText("search_easy_access_results",[t,o])}return s}return""},showMoreResultsVisibilityFormatter:function(e,t){if(e&&e.length<t){return true}return false},showMoreResultsTextFormatter:function(e,t){if(!e||!t){return""}var r=e.length;return n.i18n.getText("EasyAccessSearchResults_ShowMoreResults",[r,t])}})},true);