// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/m/StandardListItem","sap/m/SelectDialog","sap/ui/core/Component"],function(e,t,s,i,r,n,o,a){"use strict";return e.extend("sap.ushell.components.appfinder.HierarchyFolders",{onInit:function(){this.oDialog=null;this.getView().setModel(this.getView().getViewData().easyAccessSystemsModel,"easyAccessSystems");this.getView().setModel(this.getView().getViewData().subHeaderModel,"subHeaderModel");this.getSelectedSystem().then(function(e){if(e){this.setSystemSelected(e)}else{this.setSystemSelected(undefined);this.onSystemSelectionPress()}}.bind(this),function(){this.setSystemSelected(undefined);this.onSystemSelectionPress()})},onExit:function(){if(this.oDialog){this.destroyDialog()}},onAfterRendering:function(){var e=s("#"+this.getView().getId());e.on("click",function(){this.exitSearchMode()}.bind(this))},getPersonalizer:function(){if(!this.oPersonalizerPromise){this.oPersonalizerPromise=sap.ushell.Container.getServiceAsync("Personalization").then(function(e){var t=a.getOwnerComponentFor(this),s={keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.LOW,clientStorageAllowed:true},i={container:"appfinder.HierarchyFolders",item:"lastSelectedSystem"};return e.getPersonalizer(i,s,t)}.bind(this))}return this.oPersonalizerPromise},getSelectedSystem:function(){var e=new s.Deferred,t=this.getView().getModel("easyAccessSystems").getProperty("/systemsList");if(t&&t.length&&t.length===1){var i=t[0];this.setSystemSelectedInPersonalization(i);e.resolve(i)}else{this.getSelectedSystemInPersonalization().then(function(s){if(s){var i=false;for(var r=0;r<t.length;r++){if(t[r].systemName&&t[r].systemName===s.systemName||t[r].systemId===s.systemId){i=true;e.resolve(s)}}if(!i){e.resolve();this.setSystemSelectedInPersonalization()}}else{e.resolve()}}.bind(this))}return e.promise()},setSystemSelected:function(e){this.getView().getModel("easyAccessSystems").setProperty("/systemSelected",e);this.setSystemSelectedInPersonalization(e)},getSelectedSystemInPersonalization:function(){var e=new s.Deferred;this.getPersonalizer().then(function(s){s.getPersData().then(function(t){if(t){e.resolve(t)}else{e.resolve()}},function(s){t.error("Failed to get selected system from the personalization",s,"sap.ushell.components.appfinder.HierarchyFolders");e.reject()})});return e.promise()},setSystemSelectedInPersonalization:function(e){this.getPersonalizer().then(function(s){s.setPersData(e).fail(function(e){t.error("Failed to save selected system in the personalization",e,"sap.ushell.components.appfinder.HierarchyFolders")})})},onSystemSelectionPress:function(){var e=this.getView().getModel("easyAccessSystems").getProperty("/systemsList");if(e&&e.length&&e.length<=1){return}var t=this.createDialog();t.open()},createDialog:function(){var e=this;if(!this.oDialog){this.oDialog=new o({id:"systemSelectionDialog",title:e.getView().translationBundle.getText("easyAccessSelectSystemDialogTitle"),multiSelect:false,contentHeight:"20rem",items:{path:"/systemsList",template:new n({adaptTitleSize:false,title:{parts:["systemName","systemId"],formatter:e.titleFormatter},description:{parts:["systemName","systemId"],formatter:e.descriptionFormatter},selected:{parts:["systemName","systemId"],formatter:e.selectedFormatter.bind(this)}})},confirm:e.systemConfirmHandler.bind(e),search:e.systemSearchHandler.bind(e),cancel:e.destroyDialog.bind(e)});this.oDialog.setModel(this.getView().getModel("easyAccessSystems"))}return this.oDialog},destroyDialog:function(){this.oDialog.destroyItems();this.oDialog.destroy();this.oDialog=null},systemConfirmHandler:function(e){var t=e.getParameters().selectedItem,s=t.getBindingContext().getObject();this.setSystemSelected(s);this.destroyDialog()},systemSearchHandler:function(e){var t=e.getParameter("value"),s=new r("systemName",i.Contains,t),n=new r("systemId",i.Contains,t),o=new r({filters:[n,s],and:false}),a=e.getSource().getBinding("items");a.filter(o)},titleFormatter:function(e,t){return e||t},descriptionFormatter:function(e,t){if(e){return t}return null},selectedFormatter:function(e,t){var s=this.getView().getModel("easyAccessSystems").getProperty("/systemSelected");if(!s){return false}if(e){return s.systemName===e&&s.systemId===t}return s.systemId===t},systemSelectorTextFormatter:function(e){if(e){if(e.systemName){return e.systemName}return e.systemId}return this.getView().translationBundle.getText("easyAccessSelectSystemTextWithoutSystem")},exitSearchMode:function(){var e=this.getView().getModel("subHeaderModel");e.setProperty("/search/searchMode",false);e.refresh(true)}})},true);