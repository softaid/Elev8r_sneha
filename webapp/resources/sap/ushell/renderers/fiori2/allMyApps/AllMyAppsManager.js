// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/resources"],function(t,e){"use strict";var i=function(){};i.prototype.loadAppsData=function(t,e,i){return sap.ushell.Container.getServiceAsync("AllMyApps").then(function(r){this.oPopover=e;if(!r.isEnabled()){return}this.iNumberOfProviders=0;this.oModel=t;if(r.isHomePageAppsEnabled()){this._handleGroupsData()}if(r.isExternalProviderAppsEnabled()){this._handleExternalProvidersData(t)}if(r.isCatalogAppsEnabled()){this._handleCatalogs(i)}if(!r.isCatalogAppsEnabled()||r.isCatalogAppsEnabled()&&i){var a=sap.ui.getCore().getEventBus();a.publish("launchpad","allMyAppsMasterLoaded")}}.bind(this))};i.prototype._handleGroupsData=function(){var t=this._getGroupsData();var i={title:e.i18n.getText("allMyApps_homeEntryTitle")};var r;return Promise.all([t,sap.ushell.Container.getServiceAsync("AllMyApps")]).then(function(t){var e=t[0];var a=t[1];i.groups=e;i.type=a.getProviderTypeEnum().HOME;if(e.length===0){return}r=this.oModel.getProperty("/AppsData");if(r){var s=this._getIndexByType(r,i.type);if(s!==undefined){r[s]=i}else{r.unshift(i)}}this.oModel.setProperty("/AppsData",r);this.iNumberOfProviders+=1}.bind(this))};i.prototype._getIndexByType=function(t,e){if(t.length<=0){return 0}for(var i=0;i<t.length;i++){if(t[i].type===e){return i}}};i.prototype._getGroupsData=function(){var e=new t.Deferred;sap.ushell.Container.getServiceAsync("LaunchPage").then(function(t){return Promise.all([t.getDefaultGroup(),t.getGroups()])}).then(function(t){this.oDefaultGroup=t[0];var e=t[1];var i=[];e.forEach(function(t){i.push(this._getFormattedGroup(t))}.bind(this));return Promise.all(i)}.bind(this)).then(function(t){var i=t.filter(function(t){return t&&(t.apps.length>0||t.numberCustomTiles>0)});e.resolve(i)});return e.promise()};i.prototype._getFormattedGroup=function(t){var i;var r;var a;return sap.ushell.Container.getServiceAsync("LaunchPage").then(function(s){if(s.isGroupVisible(t)===false){return}if(s.getGroupId(t)===s.getGroupId(this.oDefaultGroup)){r=e.i18n.getText("my_group")}else{r=s.getGroupTitle(t)}i={};i.title=r;i.apps=[];a=s.getGroupTiles(t);return this._getFormattedGroupApps(a)}.bind(this)).then(function(t){if(!t){return}i.apps=t.aFormattedApps;i.numberCustomTiles=t.iNumberOfCustomTiles;if(t.iNumberOfCustomTiles===1){i.sCustomLabel=e.i18n.getText("allMyApps_customStringSingle");i.sCustomLink=e.i18n.getText("allMyApps_customLinkHomePageSingle")}else{i.sCustomLabel=e.i18n.getText("allMyApps_customString",[t.iNumberOfCustomTiles]);i.sCustomLink=e.i18n.getText("allMyApps_customLinkHomePage")}i.handlePress=this._onHandleGroupPress;return i}.bind(this))};i.prototype._getFormattedGroupApps=function(t){var e=[];var i=0;return sap.ushell.Container.getServiceAsync("LaunchPage").then(function(r){var a=[];t.forEach(function(t){if(r.isTileIntentSupported(t)){var s=this._getAppEntityFromTile(t).then(function(t){if(t){e.push(t)}else{i++}});a.push(s)}}.bind(this));return Promise.all(a)}.bind(this)).then(function(){return{iNumberOfCustomTiles:i,aFormattedApps:e}})};i.prototype._onHandleGroupPress=function(t,e){window.hasher.setHash("#Shell-home");this.oPopover.close();var i=sap.ui.getCore().getEventBus();i.subscribe("launchpad","dashboardModelContentLoaded",function(){i.publish("launchpad","scrollToGroupByName",{groupName:e.title,isInEditTitle:false})},this);i.publish("launchpad","scrollToGroupByName",{groupName:e.title,isInEditTitle:false})};i.prototype._handleExternalProvidersData=function(){var t=this;return sap.ushell.Container.getServiceAsync("AllMyApps").then(function(e){var i=e.getDataProviders();var r=Object.keys(i);var a;var s;var o;var n;var l;var p;if(r.length>0){for(l=0;l<r.length;l++){a=r[l];s=i[a];o=s.getTitle();n={};n.title=o;p=s.getData();p.done(function(i){if(i&&i.length>0){this.groups=i;this.type=e.getProviderTypeEnum().EXTERNAL;t.oModel.setProperty("/AppsData/"+t.iNumberOfProviders,this);t.iNumberOfProviders+=1;var r=sap.ui.getCore().getEventBus();r.publish("launchpad","allMyAppsMasterLoaded")}}.bind(n))}}})};i.prototype._handleNotFirstCatalogsLoad=function(){var t=this.oModel.getProperty("/AppsData");return sap.ushell.Container.getServiceAsync("AllMyApps").then(function(e){var i=e.getProviderTypeEnum().CATALOG;if(t.length&&t[t.length-1].type===i){this.bFirstCatalogLoaded=true;sap.ui.getCore().getEventBus().publish("launchpad","allMyAppsFirstCatalogLoaded",{bFirstCatalogLoadedEvent:true})}})};i.prototype._handleCatalogs=function(i){if(!i){return this._handleNotFirstCatalogsLoad()}this.bFirstCatalogLoaded=false;this.aPromises=[];return sap.ushell.Container.getServiceAsync("LaunchPage").then(function(i){i.getCatalogs().done(function(){t.when.apply(t,this.aPromises).then(this._onDoneLoadingCatalogs.bind(this))}.bind(this)).fail(function(){this._onGetCatalogsFail(e.i18n.getText("fail_to_load_catalog_msg"))}.bind(this)).progress(this._addCatalogToModel.bind(this))}.bind(this))};i.prototype._addCatalogToModel=function(t){var i;var r;var a={apps:[],numberCustomTiles:0,type:null};var s;var o=[sap.ushell.Container.getServiceAsync("AllMyApps"),sap.ushell.Container.getServiceAsync("LaunchPage")];if(this._oAddCatalogToModelPromise){o.push(this._oAddCatalogToModelPromise)}this._oAddCatalogToModelPromise=Promise.all(o).then(function(e){i=e[0];r=e[1];a.type=i.getProviderTypeEnum().CATALOG;var s=r.getCatalogTiles(t);this.aPromises.push(s);return s}.bind(this)).then(function(e){var o;if(e.length===0){return}var n=r.getCatalogTitle(t);o=this.oModel.getProperty("/AppsData");for(s=0;s<o.length;s++){if(o[s].type===i.getProviderTypeEnum().CATALOG&&o[s].title===n){a=o[s];break}}a.title=r.getCatalogTitle(t);return this._getFormattedGroupApps(e)}.bind(this)).then(function(t){if(!t){return}Array.prototype.push.apply(a.apps,t.aFormattedApps);a.numberCustomTiles=t.iNumberOfCustomTiles;if(a.numberCustomTiles===1){a.sCustomLabel=e.i18n.getText("allMyApps_customStringSingle");a.sCustomLink=e.i18n.getText("allMyApps_customLinkAppFinderSingle")}else{a.sCustomLabel=e.i18n.getText("allMyApps_customString",[a.numberCustomTiles]);a.sCustomLink=e.i18n.getText("allMyApps_customLinkAppFinder")}a.handlePress=function(t,e){this.oPopover.close();window.hasher.setHash("#Shell-home&/appFinder/catalog/"+JSON.stringify({catalogSelector:e.title,tileFilter:"",tagFilter:"[]",targetGroup:""}))}.bind(this);if(a.apps.length>0||a.numberCustomTiles>0){this.oModel.setProperty("/AppsData/"+s,a);if(this.bFirstCatalogLoaded===false){sap.ui.getCore().getEventBus().publish("launchpad","allMyAppsFirstCatalogLoaded",{bFirstCatalogLoadedEvent:true});this.bFirstCatalogLoaded=true}this.iNumberOfProviders+=1}}.bind(this));return this._oAddCatalogToModelPromise};i.prototype._onGetCatalogsFail=function(t){return sap.ushell.Container.getServiceAsync("Message").then(function(e){e.info(t)})};i.prototype._onDoneLoadingCatalogs=function(){var t=this.oModel.getProperty("/AppsData");t.sort(function(t,e){var i=t.title.toUpperCase();var r=e.title.toUpperCase();if(i<r){return-1}if(i>r){return 1}return 0});this.oModel.setProperty("/AppsData",t);var e=sap.ui.getCore().getEventBus();if(!this.bFirstCatalogLoaded){e.publish("launchpad","allMyAppsNoCatalogsLoaded")}};i.prototype._getAppEntityFromTile=function(t){return sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){var i;var r=e.getCatalogTilePreviewTitle(t);var a=e.getCatalogTilePreviewSubtitle(t);var s=e.getCatalogTileTargetURL(t);if(s&&(r||a)){i={};i.url=s;if(r){i.title=r;i.subTitle=a}else{i.title=a}return i}})};return new i},true);