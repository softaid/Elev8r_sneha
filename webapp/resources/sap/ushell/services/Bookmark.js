// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/library","sap/base/util/deepClone","sap/base/util/deepExtend","sap/base/Log"],function(e,r,o,t,n,i){"use strict";var a="X-SAP-UI2-HANA:hana?remoteId=HANA_CATALOG";var s=o.ContentNodeType;function u(){this._oLaunchPageServicePromise=sap.ushell.Container.getServiceAsync("LaunchPage");if(r.last("/core/spaces/enabled")){this._oPagesServicePromise=sap.ushell.Container.getServiceAsync("Pages")}this._addBookmarkToContentNodes=function(e,r,o,t){var n=r.map(function(r){if(r&&r.hasOwnProperty("type")&&r.isContainer){switch(r.type){case s.Page:return this.addBookmarkToPage(e,r.id,t);case s.HomepageGroup:return new Promise(function(e,o){this._oLaunchPageServicePromise.then(function(t){t.getGroupById(r.id).done(e).fail(o)})}.bind(this)).then(function(r){return this.addBookmarkToHomepageGroup(e,r,o,t)}.bind(this));default:return Promise.reject("Bookmark Service: The API needs to be called with a valid content node type. '"+r.type+"' is not supported.")}}return Promise.reject("Bookmark Service: Not a valid content node.")}.bind(this));return Promise.all(n)};this.addBookmark=function(o,t,n){var i=new e.Deferred;var a=r.last("/core/shell/enablePersonalization");var s=r.last("/core/spaces/enabled");var u=r.last("/core/spaces/myHome/enabled");if(!a&&(!s||!u)){return i.resolve().promise()}if(typeof t==="undefined"&&s){sap.ushell.Container.getServiceAsync("Menu").then(function(e){return e.getDefaultSpace()}).then(function(e){var r=e&&e.children&&e.children[0];return r}).then(function(e){this._addBookmarkToContentNodes(o,[e],false,n).then(i.resolve).catch(i.reject)}.bind(this));return i.promise()}if((typeof t==="undefined"||!t.hasOwnProperty("type"))&&!Array.isArray(t)){this.addBookmarkToHomepageGroup(o,t,false,n).then(i.resolve).catch(i.reject);return i.promise()}var c=[].concat(t);this._addBookmarkToContentNodes(o,c,false,n).then(i.resolve).catch(i.reject);return i.promise()};this.addCustomBookmark=function(e,r,o,i){var a=t(r);var s=n(a,{vizType:e,vizConfig:{"sap.flp":{chipConfig:a.chipConfig},"sap.platform.runtime":{includeManifest:!a.loadManifest}}});delete s.chipConfig;delete s.loadManifest;var u=[].concat(o);return this._addBookmarkToContentNodes(s,u,true,i)};this.addBookmarkToHomepageGroup=function(e,o,t,n){if(r.last("/core/spaces/enabled")){var i="Bookmark Service: The API is not available in spaces mode.";return Promise.reject(i)}return new Promise(function(r,i){this._oLaunchPageServicePromise.then(function(a){var s;if(t){s=a.addCustomBookmark(e,o,n)}else{s=a.addBookmark(e,o,n)}s.done(function(e){var t={tile:e,group:o};sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileAdded",t);r()}).fail(i)})}.bind(this))};this.addBookmarkToPage=function(e,o,t){if(!r.last("/core/spaces/enabled")){return Promise.reject("Bookmark Service: 'addBookmarkToPage' is not valid in launchpad homepage mode, use 'addBookmark' instead.")}var n=r.last("/core/shell/enablePersonalization");var i=r.last("/core/spaces/myHome/enabled");var a=r.last("/core/spaces/myHome/myHomePageId");if(!n&&(!i||i&&o!==a)){return Promise.reject("Bookmark Service: Add bookmark is not allowed as the personalization functionality is not enabled.")}if(e&&(typeof e.title!=="string"||typeof e.url!=="string")){return Promise.reject("Bookmark Service - Invalid bookmark data.")}return this._oPagesServicePromise.then(function(r){return r.addBookmarkToPage(o,e,undefined,t)})};this.addBookmarkByGroupId=function(o,t,n){var i=new e.Deferred;if(r.last("/core/spaces/enabled")){var a="Bookmark Service: The API 'addBookmarkByGroupId' is not supported in launchpad spaces mode.";return i.reject(a).promise()}this._oLaunchPageServicePromise.then(function(r){r.getGroups().done(function(r){r=e.grep(r,function(e){return e.id===t});var a=null;if(r.length>0){a=r[0]}this.addBookmark(o,a,n).done(i.resolve).fail(i.reject)}.bind(this)).fail(i.reject)}.bind(this)).catch(i.reject);return i.promise()};this.getShellGroupIDs=function(o){var t=new e.Deferred;if(r.last("/core/spaces/enabled")){var n="Bookmark Service: The API 'getShellGroupIDs' is not supported in launchpad spaces mode.";return t.reject(n).promise()}this._oLaunchPageServicePromise.then(function(e){e.getGroupsForBookmarks(o).done(function(r){r=r.map(function(r){return{id:e.getGroupId(r.object),title:r.title}});t.resolve(r)}).fail(t.reject)});return t.promise()};this._doAddCatalogTileToGroup=function(e,r,o,t){this._oLaunchPageServicePromise.then(function(n){if(t){n.getGroups().fail(e.reject).done(function(a){var s=a.some(function(i){if(n.getGroupId(i)===t){this._addToGroup(o,e,r,i);return true}}.bind(this));if(!s){var u="Group '"+t+"' is unknown";i.error(u,null,"sap.ushell.services.Bookmark");e.reject(u)}}.bind(this))}else{n.getDefaultGroup().fail(e.reject).done(function(t){this._addToGroup(o,e,r,t)}.bind(this))}}.bind(this));return e.promise()};this._isSameCatalogTile=function(e,r,o){var t=o.getCatalogTileId(r);if(t===undefined){return false}return t.indexOf(e)===0};this._addToGroup=function(e,r,o,t){return this._oLaunchPageServicePromise.then(function(n){n.getCatalogTiles(e).fail(r.reject).done(function(a){var s=n.getGroupId(t);var u=a.some(function(e){if(this._isSameCatalogTile(o,e,n)){n.addTile(e,t).fail(r.reject).done(function(){r.resolve();sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","catalogTileAdded",s)});return true}}.bind(this));if(!u){var c="No tile '"+o+"' in catalog '"+n.getCatalogId(e)+"'";i.error(c,null,"sap.ushell.services.Bookmark");r.reject(c)}}.bind(this))}.bind(this))};this.addCatalogTileToGroup=function(o,t,n){var s=new e.Deferred;var u;if(r.last("/core/spaces/enabled")){u="Bookmark Service: The API 'addCatalogTileToGroup' is not supported in launchpad spaces mode.";return s.reject(u).promise()}this._oLaunchPageServicePromise.then(function(e){var r=n?this._isMatchingRemoteCatalog:this._isLegacyHANACatalog;n=n||{id:a};e.onCatalogTileAdded(o);e.getCatalogs().fail(s.reject).done(function(a){var c;a.forEach(function(o){if(r(o,n,e)){if(!c){c=o}else{i.warning("More than one matching catalog: "+JSON.stringify(n),null,"sap.ushell.services.Bookmark")}}});if(c){this._doAddCatalogTileToGroup(s,o,c,t)}else{u="No matching catalog found: "+JSON.stringify(n);i.error(u,null,"sap.ushell.services.Bookmark");s.reject(u)}}.bind(this))}.bind(this));return s.promise()};this._isMatchingRemoteCatalog=function(e,r,o){var t=o.getCatalogData(e);return t.remoteId===r.remoteId&&t.baseUrl.replace(/\/$/,"")===r.baseUrl.replace(/\/$/,"")};this._isLegacyHANACatalog=function(e,r,o){return o.getCatalogId(e)===a};this.countBookmarks=function(o,t){var n=new e.Deferred;if(r.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.countBookmarks({url:o,contentProviderId:t})}).then(n.resolve,n.reject)}else{this._oLaunchPageServicePromise.then(function(e){e.countBookmarks(o,t).done(n.resolve).fail(n.reject)})}return n.promise()};this.countCustomBookmarks=function(e){if(!e||!e.url||!e.vizType){return Promise.reject("countCustomBookmarks: Some required parameters are missing.")}if(r.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(r){return r.countBookmarks(e)})}return this._oLaunchPageServicePromise.then(function(r){return r.countCustomBookmarks(e)})};this.deleteBookmarks=function(o,t){var n=new e.Deferred;if(r.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.deleteBookmarks({url:o,contentProviderId:t})}).then(n.resolve,n.reject)}else{this._oLaunchPageServicePromise.then(function(e){e.deleteBookmarks(o,t).done(function(e){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",o);n.resolve(e)}).fail(n.reject)})}return n.promise()};this.deleteCustomBookmarks=function(e){if(!e||!e.url||!e.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.")}if(r.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(r){return r.deleteBookmarks(e)})}return this._oLaunchPageServicePromise.then(function(r){return r.deleteCustomBookmarks(e)}).then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",e.url)})};this.updateBookmarks=function(o,t,n){var i=new e.Deferred;if(r.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.updateBookmarks({url:o,contentProviderId:n},t)}).then(i.resolve,i.reject)}else{this._oLaunchPageServicePromise.then(function(e){e.updateBookmarks(o,t,n).done(i.resolve).fail(i.reject)})}return i.promise()};this.updateCustomBookmarks=function(e,o){if(!e||!e.url||!e.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.")}var t=n({},o,{vizConfig:{"sap.flp":{chipConfig:o.chipConfig},"sap.platform.runtime":{includeManifest:!o.loadManifest}}});delete t.chipConfig;delete t.loadManifest;if(r.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(r){return r.updateBookmarks(e,t)})}return this._oLaunchPageServicePromise.then(function(r){return r.updateCustomBookmarks(e,t)})};this.getContentNodes=function(){if(r.last("/core/spaces/enabled")){return sap.ushell.Container.getServiceAsync("Menu").then(function(e){return e.getContentNodes()})}return new Promise(function(e,r){this._oLaunchPageServicePromise.then(function(o){o.getGroupsForBookmarks().done(function(r){var t=r.map(function(e){return{id:o.getGroupId(e.object),label:e.title,type:s.HomepageGroup,isContainer:true}});e(t)}).fail(r)})}.bind(this))}}u.hasNoAdapter=true;return u},true);