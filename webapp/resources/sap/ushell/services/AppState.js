// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_AppState/WindowAdapter","sap/ushell/services/_AppState/SequentializingAdapter","sap/ushell/services/_AppState/AppState","sap/ushell/services/_AppState/Sequentializer","sap/ushell/services/_AppState/AppStatePersistencyMethod","sap/ushell/utils","sap/ui/thirdparty/jquery"],function(e,t,n,i,s,a,r){"use strict";function o(e){return a.isDefined(e)&&a.isDefined(e.transient)?!!e.transient:true}function p(n,i,s,a){this._oConfig=a&&a.config;this._sSessionKey="";this._oAdapter=new t(n);this._oAdapter=new e(this,this._oAdapter,a)}p.prototype._getSessionKey=function(){if(!this._sSessionKey){this._sSessionKey=this._getGeneratedKey()}return this._sSessionKey};p.prototype.getAppState=function(e){var t=new r.Deferred,i=this,s;this._loadAppState(e).done(function(e,a,r,o){s=new n(i,e,false,a,undefined,undefined,undefined,r,o);t.resolve(s)}).fail(function(){s=new n(i,e);t.resolve(s)});return t.promise()};p.prototype._getGeneratedKey=function(e){var t=a.generateRandomKey();if(e){t=("TAS"+t).substring(0,41)}else{t=("AS"+t).substring(0,40)}return t};p.prototype.createEmptyAppState=function(e,t,i,a){var r;var p="";var d="";var f=t||o(this._oConfig);var u=this._getGeneratedKey(f);if(i!==undefined&&!this.isPersistencyMethodSupported(i)){i=undefined;a=undefined}if(e){if(!(e instanceof sap.ui.core.UIComponent)){throw new Error("oComponent passed must be a UI5 Component")}if(e.getMetadata&&e.getMetadata()&&typeof e.getMetadata().getName==="function"){p=e.getMetadata().getName()||""}if(!p&&e.getMetadata&&e.getMetadata().getComponentName){p=e.getMetadata().getComponentName()}if(e.getMetadata&&e.getMetadata()&&typeof e.getMetadata().getManifest==="function"&&typeof e.getMetadata().getManifest()==="object"&&typeof e.getMetadata().getManifest()["sap.app"]==="object"){d=e.getMetadata().getManifest()["sap.app"].ach||""}}if(f===true){i=a=undefined}else if(i===undefined&&this.isPersistencyMethodSupported(s.PersonalState)){i=s.PersonalState;a=undefined}r=new n(this,u,true,undefined,p,d,f,i,a);return r};p.prototype.createEmptyUnmodifiableAppState=function(){var e=this._getGeneratedKey(),t;t=new n(this,e,false);return t};p.prototype._saveAppState=function(e,t,n,i,r,p,d){var f=this._getSessionKey(),u=a.isDefined(r)?r:o(this._oConfig);if(u){p=undefined;d=undefined}else if(p!==undefined){if(!this.isPersistencyMethodSupported(p)){if(this.isPersistencyMethodSupported(s.PersonalState)){p=s.PersonalState}else{p=undefined}d=undefined}}return this._oAdapter.saveAppState(e,f,t,n,i,u,p,d)};p.prototype._loadAppState=function(e){return this._oAdapter.loadAppState(e)};p.prototype.deleteAppState=function(e){return this._oAdapter.deleteAppState(e)};p._getSequentializer=function(){return new i};p.prototype.getSupportedPersistencyMethods=function(){if(this._oAdapter.getSupportedPersistencyMethods){return this._oAdapter.getSupportedPersistencyMethods()}return[]};p.prototype.isPersistencyMethodSupported=function(e){var t=this.getSupportedPersistencyMethods();if(t.length>0&&e!==undefined){return t.indexOf(e)>=0}return false};p.prototype.setAppStateToPublic=function(e){var t=d(e,"sap-xapp-state"),n=d(e,"sap-iapp-state"),i=(new r.Deferred).resolve(),a=(new r.Deferred).resolve(),o=new r.Deferred,p,f;if(t!==undefined){i=this.makeStatePersistent(t,s.PublicState).done(function(n){if(t!==n){e=e.replace(t,n);p=n}}).fail(o.reject)}if(n!==undefined){a=this.makeStatePersistent(n,s.PublicState).done(function(t){if(n!==t){e=e.replace(n,t);f=t}}).fail(o.reject)}r.when(i,a).done(function(){o.resolve(e,t,n,p,f)});return o.promise()};function d(e,t){var n=new RegExp("(?:"+t+"=)([^&/]+)"),i=n.exec(e),s;if(i&&i.length===2){s=i[1]}return s}p.prototype.makeStatePersistent=function(e,t,n){var i=new r.Deferred;if(this.getSupportedPersistencyMethods().length===0){return i.resolve(e)}if(this.isPersistencyMethodSupported(t)){this.getAppState(e).done(function(s){if(s._iPersistencyMethod!==t){s.bTransient=false;s._iPersistencyMethod=t;s._oPersistencySettings=n;if(e.startsWith("TAS")){e=e.substring(1,e.length)}this._saveAppState(e,s._sData,s._sAppName,s._sACHComponent,false,t,n).done(function(){i.resolve(e)}).fail(i.reject)}else{i.resolve(e)}}.bind(this)).fail(i.reject)}else{i.reject("AppState.makeStatePersistent - adapter does not support persistence method: "+t)}return i.promise()};p.WindowAdapter=e;p.hasNoAdapter=false;return p},true);