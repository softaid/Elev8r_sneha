// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/services/ContentExtensionAdapterFactory","sap/ui/thirdparty/jquery","sap/ushell/resources","sap/ushell/services/_AppState/AppStatePersistencyMethod","sap/ushell/Config","sap/m/library","sap/m/GenericTile"],function(e,t,r,i,o,n,a,s){"use strict";var u=a.LoadState;function l(o){var a=this,l=[],d=t.getAdapters();this.oAdapters={default:o};d.then(function(e){r.extend(this.oAdapters,e)}.bind(this));this.getGroups=function(){if(n.last("/core/spaces/enabled")){return(new r.Deferred).resolve([]).promise()}var t=new r.Deferred;d.then(function(){var i=Object.keys(a.oAdapters).map(function(e){return a._getAdapter(e).getGroups()});r.when.apply(r,i).done(function(){var e=[].concat.apply([],arguments);t.resolve(e)}).fail(function(){e.error("getGroups failed")})});return t.promise()};this.getGroupsForBookmarks=function(t){var o=new r.Deferred;this.getGroups().then(function(r){this.getDefaultGroup().then(function(e){if(r.length>0){r=r.filter(function(e){if(t===true){return this.isGroupVisible(e)}return!this.isGroupLocked(e)&&this.isGroupVisible(e)}.bind(this));r=r.map(function(t){return{title:t===e&&i.i18n.getText("my_group")||this.getGroupTitle(t),object:t}}.bind(this))}o.resolve(r)}.bind(this),function(t){e.error("getGroupsForBookmarks - getDefaultGroup - failed: "+t.message)})}.bind(this),function(t){e.error("getGroupsForBookmarks - getGroups - failed: "+t.message)});return o.promise()};this.getDefaultGroup=function(){var t=this._getAdapter().getDefaultGroup();t.fail(function(){e.error("getDefaultGroup failed")});return t};this.getGroupTitle=function(e){return this._getAdapter(e.contentProvider).getGroupTitle(e)};this.getGroupId=function(e){return this._getAdapter(e.contentProvider).getGroupId(e)};this.getGroupById=function(e){var t=new r.Deferred,i=this;this.getGroups().then(function(o){o=r.grep(o,function(t){return i.getGroupId(t)===e});t.resolve(o&&o.length>0?o[0]:undefined)});return t.promise()};this.getGroupTiles=function(e){return this._getAdapter(e.contentProvider).getGroupTiles(e)};this.getTilesByGroupId=function(e){var t=new r.Deferred,i=this;this.getGroupById(e).then(function(r){if(r){var o=i._getAdapter(r.contentProvider).getGroupTiles(r);if(o){o=o.map(function(t){return{id:i.getTileId(t),title:i.getTileTitle(t),subtitle:i.getCatalogTilePreviewSubtitle(t),url:i.getCatalogTileTargetURL(t),icon:i.getCatalogTilePreviewIcon(t),groupId:e}})}else{o=[]}t.resolve(o)}else{t.resolve([])}});return t.promise()};this.getLinkTiles=function(e){return this._getAdapter(e.contentProvider).getLinkTiles(e)};this.addGroupAt=function(t,i){var o,n=i,a=this._getAdapter();if(a.addGroupAt){o=a.addGroupAt(t,i);o.fail(function(){e.error("addGroup "+t+" failed")})}else{var s=new r.Deferred;o=a.addGroup(t);o.done(function(e){var t=this.moveGroup(e,n),r=e;t.done(function(){s.resolve(r)});t.fail(function(){s.reject()})}.bind(this));o.fail(function(){e.error("addGroup "+t+" failed");s.reject()});return s.promise()}return o};this.addGroup=function(t){var r=this._getAdapter().addGroup(t);r.fail(function(){e.error("addGroup "+t+" failed")});return r};this.removeGroup=function(t,r){var i=this._getAdapter(t.contentProvider).removeGroup(t,r);i.fail(function(){e.error("Fail to removeGroup "+a.getGroupTitle(t))});return i};this.resetGroup=function(t,r){var i=this._getAdapter(t.contentProvider).resetGroup(t,r);i.fail(function(){e.error("Fail to resetGroup "+a.getGroupTitle(t))});return i};this.isGroupRemovable=function(e){return this._getAdapter(e.contentProvider).isGroupRemovable(e)};this.isGroupLocked=function(e){var t=this._getAdapter(e.contentProvider);if(typeof t.isGroupLocked==="function"){return t.isGroupLocked(e)}return false};this.isGroupFeatured=function(e){var t=this._getAdapter(e.contentProvider);if(typeof t.isGroupFeatured==="function"){return t.isGroupFeatured(e)}return false};this.moveGroup=function(t,r){var i=this._getAdapter(t.contentProvider).moveGroup(t,r);i.fail(function(){e.error("Fail to moveGroup "+a.getGroupTitle(t))});return i};this.setGroupTitle=function(t,r){var i=this._getAdapter(t.contentProvider).setGroupTitle(t,r);i.fail(function(){e.error("Fail to set Group title: "+a.getGroupTitle(t))});return i};this.hideGroups=function(t){var i=new r.Deferred,o=this._getAdapter();if(typeof o.hideGroups!=="function"){i.reject("hideGroups() is not implemented in the Adapter.")}else{o.hideGroups(t).done(function(){i.resolve()}).fail(function(t){e.error("Fail to store groups visibility."+t);i.reject()})}return i.promise()};this.isGroupVisible=function(e){var t=this._getAdapter(e.contentProvider);if(typeof t.isGroupVisible==="function"){return t.isGroupVisible(e)}return true};this.addTile=function(t,r){return this._getAdapter(r.contentProvider).addTile(t,r).fail(function(){e.error("Fail to add Tile: "+a.getCatalogTileId(t))})};this.removeTile=function(t,i,o){var n=new r.Deferred;sap.ushell.Container.getServiceAsync("AppState").then(function(r){this._getAdapter(t.contentProvider).removeTile(t,i,o).done(function(){var e=this.getCatalogTileTargetURL(i);this.deleteURLStatesPersistentData(e,r);n.resolve()}.bind(this)).fail(function(t){e.error("Fail to remove Tile: "+this.getTileId(i));n.reject(t)}.bind(this))}.bind(this)).catch(n.reject);return n.promise()};this.moveTile=function(t,r,i,o,n,s){var u=this._getAdapter().moveTile(t,r,i,o,n,s);u.fail(function(){e.error("Fail to move Tile: "+a.getTileId(t))});return u};this.isLinkPersonalizationSupported=function(e){var t=e&&e.contentProvider,r=this._getAdapter(t);if(typeof r.isLinkPersonalizationSupported==="function"){return r.isLinkPersonalizationSupported(e)}return false};this.getTileId=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getTileId(e)};this.getTileTitle=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getTileTitle(e)};this.getTileType=function(e){var t=e&&e.contentProvider,r=this._getAdapter(t);if(r.getTileType){return r.getTileType(e)}return"tile"};this.getTileView=function(e){var t=e&&e.contentProvider,i=this._getAdapter(t).getTileView(e);if(!r.isFunction(i.promise)){i=(new r.Deferred).resolve(i).promise()}i.done(function(e){if(e&&e.addEventDelegate&&e.getDomRef){e.addEventDelegate({onBeforeRendering:function(){var t=e.getDomRef();if(t){var r=t.getAttribute("data-oldTabindex");if(r){t.setAttribute("tabindex",t.getAttribute("data-oldTabindex"));t.removeAttribute("data-oldTabindex")}else{t.removeAttribute("tabindex")}}},onAfterRendering:function(){var t=e.getDomRef();if(t){var r=t.getAttribute("tabindex");if(r){t.setAttribute("data-oldTabindex",r)}t.setAttribute("tabindex","-1")}}})}});return i};this.getCardManifest=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getCardManifest(e)};this.getAppBoxPressHandler=function(e){var t=e&&e.contentProvider,r=this._getAdapter(t);if(r.getAppBoxPressHandler){return r.getAppBoxPressHandler(e)}return undefined};this.getTileSize=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getTileSize(e)};this.getTileTarget=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getTileTarget(e)};this.getTileDebugInfo=function(e){var t=e&&e.contentProvider,r=this._getAdapter(t);if(typeof r.getTileDebugInfo==="function"){return r.getTileDebugInfo(e)}return undefined};this.isTileIntentSupported=function(e){var t=e&&e.contentProvider,r=this._getAdapter(t);if(typeof r.isTileIntentSupported==="function"){return r.isTileIntentSupported(e)}return true};this.refreshTile=function(e){var t=e&&e.contentProvider;this._getAdapter(t).refreshTile(e)};this.setTileVisible=function(e,t){var r=e&&e.contentProvider;this._getAdapter(r).setTileVisible(e,t)};this.registerTileActionsProvider=function(e){if(typeof e!=="function"){throw new Error("Tile actions Provider is not a function")}l.push(e)};this.getTileActions=function(e){var t=[],r,i=e&&e.contentProvider,o=this._getAdapter(i);if(typeof o.getTileActions==="function"){r=o.getTileActions(e);if(r&&r.length){t.push.apply(t,r)}}for(var n=0;n<l.length;n++){r=l[n](e);if(r&&r.length){t.push.apply(t,r)}}return t};this.getCatalogs=function(){return this._getAdapter().getCatalogs()};this.isCatalogsValid=function(){return this._getAdapter().isCatalogsValid()};this.getCatalogData=function(t){var r=this._getAdapter();if(typeof r.getCatalogData!=="function"){e.warning("getCatalogData not implemented in adapter",null,"sap.ushell.services.LaunchPage");return{id:this.getCatalogId(t)}}return r.getCatalogData(t)};this.getCatalogError=function(e){return this._getAdapter().getCatalogError(e)};this.getCatalogId=function(e){return this._getAdapter().getCatalogId(e)};this.getCatalogTitle=function(e){return this._getAdapter().getCatalogTitle(e)};this.getCatalogTiles=function(t){var r=this._getAdapter().getCatalogTiles(t);r.fail(function(){e.error("Fail to get Tiles of Catalog: "+a.getCatalogTitle(t))});return r};this.getCatalogTileId=function(e){return this._getAdapter(e.contentProvider).getCatalogTileId(e)};this.getStableCatalogTileId=function(e){var t=this._getAdapter(e.contentProvider);if(t&&!t.getStableCatalogTileId){return null}return t.getStableCatalogTileId(e)};this.getCatalogTileTitle=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getCatalogTileTitle(e)};this.getCatalogTileSize=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getCatalogTileSize(e)};this.getCatalogTileViewControl=function(e){var t=e&&e.contentProvider;var i=this._getAdapter(t);if(typeof i.getCatalogTileViewControl==="function"){return i.getCatalogTileViewControl(e)}var o=new r.Deferred;var n=this.getCatalogTileView(e);o.resolve(n);return o.promise()};this.getCatalogTileView=function(t){e.error("Deprecated API call of 'sap.ushell.LaunchPage.getCatalogTileView'. Please use 'getCatalogTileViewControl' instead",null,"sap.ushell.services.LaunchPage");var r=t&&t.contentProvider;var i=this._getAdapter(r);if(i.getCatalogTileView){return i.getCatalogTileView(t)}var o=this.getTileTitle(t)||this.getCatalogTileTitle(t);return this._createErrorTile(o,"The LaunchPageAdapter does not support getCatalogTileView")};this._createErrorTile=function(e,t){var r=new s({state:u.Failed,header:e,subheader:t||""}).addStyleClass("sapUshellTileError");return r};this.getCatalogTileTargetURL=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getCatalogTileTargetURL(e)};this.getCatalogTileTags=function(e){var t=e&&e.contentProvider;var r=this._getAdapter(t);if(typeof r.getCatalogTileTags==="function"){return r.getCatalogTileTags(e)}return[]};this.getCatalogTileKeywords=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getCatalogTileKeywords(e)};this.getCatalogTilePreviewTitle=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getCatalogTilePreviewTitle(e)};this.getCatalogTilePreviewInfo=function(e){var t=e&&e.contentProvider;if(this._getAdapter(t).getCatalogTilePreviewInfo){return this._getAdapter(t).getCatalogTilePreviewInfo(e)}return""};this.getCatalogTilePreviewSubtitle=function(e){var t=e&&e.contentProvider;var r=this._getAdapter(t);if(r.getCatalogTilePreviewSubtitle){return r.getCatalogTilePreviewSubtitle(e)}return undefined};this.getCatalogTilePreviewIcon=function(e){var t=e&&e.contentProvider;return this._getAdapter(t).getCatalogTilePreviewIcon(e)};this.addBookmark=function(t,i,o){var n=new r.Deferred;if(this._hasRequiredBookmarkParameters(t)){if(i&&this.isGroupLocked(i)){var a="Tile cannot be added, target group ("+this.getGroupTitle(i)+")is locked!";e.error(a);return n.reject(a)}this.changeURLStatesToPersistent(t.url).done(function(r){var a=i&&i.contentProvider;t.url=r;this._getAdapter(a).addBookmark(t,i,o).done(n.resolve).fail(function(){e.error("Fail to add bookmark for URL: "+t.url+" and Title: "+t.title);n.reject()})}.bind(this)).fail(function(r){e.error(r||"Fail to change url states to persistent: "+t.url);n.reject()})}return n.promise()};this.addCustomBookmark=function(t,i,o){var n=new r.Deferred;if(this._hasRequiredBookmarkParameters(t)){if(i&&this.isGroupLocked(i)){var a="Tile cannot be added, target group ("+this.getGroupTitle(i)+")is locked!";e.error(a);return n.reject(a)}this.changeURLStatesToPersistent(t.url).done(function(r){var a=i&&i.contentProvider;t.url=r;this._getAdapter(a).addCustomBookmark(t,i,o).done(n.resolve).fail(function(){e.error("Fail to add bookmark for URL: "+t.url+" and Title: "+t.title);n.reject()})}.bind(this)).fail(function(r){e.error(r||"Fail to change url states to persistent: "+t.url);n.reject()})}return n.promise()};this._hasRequiredBookmarkParameters=function(t){if(!t.title){e.error("Add Bookmark - Missing title");throw new Error("Title missing in bookmark configuration")}if(!t.url){e.error("Add Bookmark - Missing URL");throw new Error("URL missing in bookmark configuration")}return true};this.countBookmarks=function(t,r){if(!t||typeof t!=="string"){e.error("Fail to count bookmarks. No valid URL");throw new Error("Missing URL")}var i=this._getAdapter().countBookmarks(t,r);i.fail(function(){e.error("Fail to count bookmarks")});return i};this.countCustomBookmarks=function(e){if(!e.url||!e.vizType){return Promise.reject("countCustomBookmarks: Some required parameters are missing.")}return this._getAdapter().countCustomBookmarks(e)};this.deleteBookmarks=function(t,i){var o=new r.Deferred;if(!t||typeof t!=="string"){return o.reject(new Error("Missing URL")).promise()}sap.ushell.Container.getServiceAsync("AppState").then(function(r){this._getAdapter().deleteBookmarks(t,undefined,i).done(function(e){this.deleteURLStatesPersistentData(t,r);o.resolve(e)}.bind(this)).fail(function(r){e.error("Fail to delete bookmark for: "+t);o.reject(r)})}.bind(this)).catch(o.reject);return o.promise()};this.deleteCustomBookmarks=function(e){if(!e.url||!e.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.")}return this._getAdapter().deleteCustomBookmarks(e)};this.updateBookmarks=function(t,i,o){if(!t||typeof t!=="string"){e.error("Fail to update bookmark. No valid URL");throw new Error("Missing URL")}if(!i||typeof i!=="object"){e.error("Fail to update bookmark. No valid parameters, URL is: "+t);throw new Error("Missing parameters")}var n=new r.Deferred;this.changeURLStatesToPersistent(i.url).done(function(r){i.url=r;this._getAdapter().updateBookmarks(t,i,undefined,o).done(n.resolve).fail(function(){e.error("Fail to update bookmark for: "+t);n.reject()})}.bind(this)).fail(function(t){e.error(t||"Fail to change url states to persistent: "+i.url);n.reject()});return n.promise()};this.updateCustomBookmarks=function(e,t){if(!e.url||!e.vizType||!t){return Promise.reject("updateCustomBookmarks: Some required parameters are missing.")}return this._getAdapter().updateCustomBookmarks(e,t)};this.onCatalogTileAdded=function(e){this._getAdapter().onCatalogTileAdded(e)};this.changeURLStatesToPersistent=function(t){var i=new r.Deferred;sap.ushell.Container.getServiceAsync("AppState").then(function(r){if(r.getSupportedPersistencyMethods().length===0){i.resolve(t);return}if(t&&t.length>0){try{r.setAppStateToPublic(t).done(i.resolve).fail(i.reject)}catch(t){e.error("error in converting transient state to personal persistent when bookmark is added",t,"sap.ushell.services.LaunchPage");i.reject()}}else{i.resolve(t)}});return i.promise()};this.deleteURLStatesPersistentData=function(t,r){if(r.getSupportedPersistencyMethods().length===0){return}if(t&&t.length>0){try{var i=g(t,"sap-xapp-state"),o=g(t,"sap-iapp-state");if(i!==undefined||o!==undefined){this.countBookmarks(t).done(function(e){if(e===0){if(i!==undefined){r.deleteAppState(i)}if(o!==undefined){r.deleteAppState(o)}}})}}catch(t){e.error("error in deleting persistent state when bookmark is deleted",t,"sap.ushell.services.LaunchPage")}}};function g(e,t){var r=new RegExp("(?:"+t+"=)([^&/]+)"),i=r.exec(e),o;if(i&&i.length===2){o=i[1]}return o}}l.prototype._getAdapter=function(e){return this.oAdapters[e]||this.oAdapters.default};l.hasNoAdapter=false;return l},true);