// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_Personalization/utils","sap/ushell/services/_Personalization/constants.private","sap/ushell/services/_Personalization/PersonalizationContainerVariantSet","sap/ui/thirdparty/jquery"],function(t,e,n,r,i){"use strict";function a(e,n){this._sContainerKey=n;this._oAdapterContainer={};this._aLoadedVariantSetKeys=[];this._aLoadedItemKeys=[];var r={},a=this;this._init();r=new i.Deferred;if(!this._sContainerKey||typeof this._sContainerKey!=="string"){throw new t.Error("Invalid container key: sap.ushell.services.Personalization"," ")}this._oAdapterContainer=e.getAdapterContainer(this._sContainerKey);this.load().fail(function(){r.reject()}).done(function(){r.resolve(a)});return r.promise()}a.prototype._init=function(){this._oVariantSetMap={};this._oItemMap={};this._aLoadedVariantSetKeys=[];this._aLoadedItemKeys=[];this._oVariantSetMap=new t.Map;this._oItemMap=new t.Map};a.prototype.load=function(){var a={},o=[],s=[],p=[],u=[],_=this;function f(t){var r=[],i=[];r=t.filter(function(t){return t.indexOf(n.S_ITEM_PREFIX)!==0});if(r.length===0){return t}i=t.filter(function(t){return t.indexOf(n.S_ITEM_PREFIX)===0});r.forEach(function(t){var r={},a="";a=n.S_ITEM_PREFIX+t;r=e.clone(_._oAdapterContainer.getItemValue(t));_._oAdapterContainer.setItemValue(a,r);_._oAdapterContainer.delItem(t);if(i&&Array.prototype.indexOf.call(i,a)===-1){i.push(a)}});return i}a=new i.Deferred;if(!this._sContainerKey){throw new t.Error("Invalid container key: sap.ushell.services.Personalization"," ")}this._init();this._oAdapterContainer.load().fail(function(){a.reject()}).done(function(){o=_._oAdapterContainer.getItemKeys().splice(0);s=o.filter(function(t){return t.indexOf(n.S_VARIANT_PREFIX)===0});s.forEach(function(t){var e={};e=new r(t,_._oAdapterContainer);_._oVariantSetMap.put(t,e)});p=o.filter(function(t){return t.indexOf(n.S_VARIANT_PREFIX)!==0});u=f(p);u.forEach(function(t){_._oItemMap.put(t,e.clone(_._oAdapterContainer.getItemValue(t)))});_._aLoadedVariantSetKeys=_._oVariantSetMap.keys().splice(0);_._aLoadedItemKeys=_._oItemMap.keys().splice(0);a.resolve()});return a.promise()};a.prototype.save=function(){var t,e;this._serializeVariantSets();this._serializeItems();t=new i.Deferred;function n(){t.resolve()}function r(){t.reject()}try{e=this._oAdapterContainer.save();e.fail(r);e.done(n)}catch(e){t.reject()}return t.promise()};a.prototype.getItemKeys=function(){return this._oItemMap.keys().map(function(t){return t.replace(n.S_ITEM_PREFIX,"","")})};a.prototype.getItemValue=function(t){if(typeof t!=="string"){return undefined}return this._oItemMap.get(n.S_ITEM_PREFIX+t)};a.prototype.containsItem=function(t){if(typeof t!=="string"){return undefined}return this._oItemMap.containsKey(n.S_ITEM_PREFIX+t)};a.prototype.setItemValue=function(e,r){if(typeof e!=="string"){throw new t.Error("Parameter value of sItemKey is not a string: sap.ushell.services.Personalization"," ")}this._oItemMap.put(n.S_ITEM_PREFIX+e,r)};a.prototype.delItem=function(t){if(typeof t!=="string"){return undefined}if(this.containsItem(t)){this._oItemMap.remove(n.S_ITEM_PREFIX+t)}};a.prototype._serializeItems=function(){var t=[],n=[],r=this;t=this._oItemMap.keys();t.forEach(function(t){r._oAdapterContainer.setItemValue(t,e.clone(r._oItemMap.get(t)))});n=this._aLoadedItemKeys.filter(function(e){return!(t.indexOf(e)>-1)});n.forEach(function(t){r._oAdapterContainer.delItem(t)})};a.prototype.getVariantSetKeys=function(){var t=[],e=[];e=this._oVariantSetMap.keys();t=e.map(function(t){return t.replace(n.S_VARIANT_PREFIX,"","")});return t};a.prototype.containsVariantSet=function(t){return this._oVariantSetMap.containsKey(n.S_VARIANT_PREFIX+t)};a.prototype.getVariantSet=function(t){var e,r={};e=n.S_VARIANT_PREFIX+t;r=this._oVariantSetMap.get(e);return r};a.prototype.addVariantSet=function(e){var i={},a={},o="";if(this.containsVariantSet(e)){throw new t.Error("Container already contains a variant set with key '"+e+"': sap.ushell.services.Personalization"," ")}o=n.S_VARIANT_PREFIX+e;i={currentVariant:null,variants:{}};this._oAdapterContainer.setItemValue(o,i);a=new r(o,this._oAdapterContainer);this._oVariantSetMap.put(o,a);return a};a.prototype._serializeVariantSets=function(){var t=[],n=[],r=this;t=this._oVariantSetMap.keys();t.forEach(function(t){var n={},i={};n=r._oVariantSetMap.get(t);i=n._serialize();r._oAdapterContainer.setItemValue(t,e.clone(i))});n=this._aLoadedVariantSetKeys.filter(function(e){return!(t.indexOf(e)>-1)});n.forEach(function(t){r._oAdapterContainer.delItem(t)})};a.prototype.delVariantSet=function(t){var e="";e=n.S_VARIANT_PREFIX+t;this._oVariantSetMap.remove(e);return this._oAdapterContainer.delItem(e)};return a});