// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/navigationMode","sap/ushell/services/AppConfiguration","sap/ushell/Config","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/base/util/isPlainObject","sap/ui/generic/app/navigation/service/SelectionVariant","sap/base/Log"],function(e,t,a,n,r,i,s,o,u,l,p){"use strict";function f(e,a){var n=new i.Deferred,r,s=e.resolutionResult,o=e.inbound&&(e.inbound.signature||{}),u=d(s)||o.additionalParameters==="ignored"||A(e);if(!u){c(n,e);return n.promise()}var l=e.intentParamsPlusAllDefaults["sap-xapp-state"]&&e.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(l){N(a,l).then(v).then(function(i){if(d(s)){var u=t.constructParameterDominatorMap(o.parameters);Object.keys(s.oNewAppStateMembers).forEach(function(e){var t=u[e].dominatedBy;if(P(i,t)){delete s.oNewAppStateMembers[e]}})}var l=o.additionalParameters==="ignored";if(!d(s)&&!A(e)&&!l){c(n,e);return}r=a.createEmptyAppState(undefined,true);if(r){r.setData(i);m(r,e,n)}},function(){delete s.oNewAppStateMembers;c(n,e);return});return n.promise()}if(d(s)){var p=a.createEmptyAppState(undefined,true);m(p,e,n);return n.promise()}c(n,e);return n.promise()}function m(e,t,a){var n=e.getData()||{},r,i={},s=t.inbound.signature,o=t.resolutionResult;if(n.selectionVariant){r=new l(JSON.stringify(n.selectionVariant))}else{r=new l}if(d(o)){Object.keys(o.oNewAppStateMembers).forEach(function(e){r.massAddSelectOption(e,o.oNewAppStateMembers[e].Ranges)})}var u=s.additionalParameters==="ignored";r=S(r,i,s.parameters,u);if(r.getParameterNames().length!==0||r.getSelectOptionsPropertyNames().length!==0||i.deleted){n.selectionVariant=r.toJSONObject()}if(!i.changed&&!i.deleted&&!d(o)){c(a,t);return}e.setData(n);e.save().done(function(){t.intentParamsPlusAllDefaults["sap-xapp-state"]=[e.getKey()];t.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[e.getKey()];c(a,t)})}function c(t,i){var o;O(i);h(i);o=a.compute(s.get("inbound.resolutionResult.applicationType",i),(i.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(i.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(n.getCurrentApplication()||{}).applicationType,r.last("/core/navigation/enableInPlaceForClassicUIs"));e.shallowMergeObject(i.resolutionResult,o);delete i.resolutionResult.oNewAppStateMembers;t.resolve(i)}function d(e){return e.oNewAppStateMembers&&!o(e.oNewAppStateMembers)}function g(e,t){return Array.isArray(e)&&e.some(function(e){return t.indexOf(e)!==-1})}function P(e,t){if(e&&e.selectionVariant){var a=new l(JSON.stringify(e.selectionVariant)),n=a.getSelectOptionsPropertyNames()||[],r=a.getParameterNames()||[];if(g(n,t)||g(r,t)){return true}}return false}function S(e,t,a,n){var r=new l,i=e.getParameterNames()||[],s=e.getSelectOptionsPropertyNames()||[],o,u;i.forEach(function(i){o=e.getParameter(i);if(n&&!a[i]){t.deleted=true;return}if(a[i]&&a[i].renameTo){if(r.getParameter(a[i].renameTo)===undefined&&r.getSelectOption(a[i].renameTo)===undefined){r.addParameter(a[i].renameTo,o);t.changed=true}else{p.error("renaming of appstate creates duplicates "+i+"->"+a[i].renameTo)}}else if(r.getParameter(i)===undefined&&r.getSelectOption(i)===undefined){r.addParameter(i,o)}});s.forEach(function(i){u=e.getSelectOption(i);if(n&&!a[i]){t.deleted=true;return}if(a[i]&&a[i].renameTo){if(r.getSelectOption(a[i].renameTo)===undefined&&r.getParameter(a[i].renameTo)===undefined){r.massAddSelectOption(a[i].renameTo,u);t.changed=true}else{p.error("renaming of appstate creates duplicates "+i+"->"+a[i].renameTo)}}else if(r.getSelectOption(i)===undefined&&r.getParameter(i)===undefined){r.massAddSelectOption(i,u)}});i.forEach(function(t){e.removeParameter(t)});s.forEach(function(t){e.removeSelectOption(t)});r.getParameterNames().forEach(function(t){e.addParameter(t,r.getParameter(t))});r.getSelectOptionsPropertyNames().forEach(function(t){e.massAddSelectOption(t,r.getSelectOption(t))});return e}function b(e){if(e===undefined||u(e)){return false}return true}function A(e){return e.inbound&&e.inbound.signature&&e.inbound.signature.parameters&&Object.keys(e.inbound.signature.parameters).some(function(t){return!!e.inbound.signature.parameters[t].renameTo})}function O(e){e.defaultedParamNames=e.defaultedParamNames.filter(function(t){if(e.intentParamsPlusAllDefaults[t]&&!Array.isArray(e.intentParamsPlusAllDefaults[t])){if(!(e.resolutionResult.oNewAppStateMembers&&e.resolutionResult.oNewAppStateMembers[t])){return false}}return true})}function h(e){var t=s.get("inbound.signature.parameters",e)||{},a={};e.defaultedParamNames.forEach(function(e){var n=t[e]&&t[e].renameTo||e;if(a[n]){p.error("renaming of defaultedParamNames creates duplicates"+e+"->"+n)}else{a[n]=true}});e.mappedDefaultedParamNames=Object.keys(a).sort()}function v(e){if(b(e)){return Promise.reject()}return Promise.resolve(e)}function N(e,t){return new Promise(function(a,n){e.getAppState(t).done(function(e){a(e.getData())}).fail(function(e){n(e)})})}return{mixAppStateIntoResolutionResultAndRename:f,_hasRenameTo:A}});