// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/User","sap/ui/model/odata/ODataUtils","sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject","sap/base/Log"],function(e,t,r,n,a){"use strict";function s(){this.getValue=function(t){var n=new r.Deferred;var a;if(t==="User.env.sap-ui-legacy-date-format"){a=sap.ui.getCore().getConfiguration().getFormatSettings().getLegacyDateFormat()}if(t==="User.env.sap-ui-legacy-number-format"){a=sap.ui.getCore().getConfiguration().getFormatSettings().getLegacyNumberFormat()}if(t==="User.env.sap-ui-legacy-time-format"){a=sap.ui.getCore().getConfiguration().getFormatSettings().getLegacyTimeFormat()}if(t==="User.env.sap-language"){a=sap.ushell.Container.getUser().getLanguage()}if(t==="User.env.sap-languagebcp47"){a=sap.ushell.Container.getUser().getLanguageBcp47()}if(t==="User.env.sap-accessibility"){a=sap.ushell.Container.getUser().getAccessibilityMode()?"X":undefined}if(t==="User.env.sap-statistics"){a=sap.ui.getCore().getConfiguration().getStatistics()?"true":undefined}if(t==="User.env.sap-theme"){a=sap.ushell.Container.getUser().getTheme(e.prototype.constants.themeFormat.THEME_NAME_PLUS_URL)}if(t==="User.env.sap-theme-name"){a=sap.ushell.Container.getUser().getTheme()}if(t==="User.env.sap-theme-NWBC"){a=sap.ushell.Container.getUser().getTheme(e.prototype.constants.themeFormat.NWBC)}n.resolve({value:a});return n.promise()}}function i(e,i,u){this._getUserEnvReferenceResolver=function(){if(!this.oUserEnvReferenceResolver){this.oUserEnvReferenceResolver=new s}return this.oUserEnvReferenceResolver};this.resolveReferences=function(e,t){var s=this;var i=new r.Deferred;var u=[];var f=true;var l={};var o={};var c=sap.ushell.Container.getServiceAsync("UserDefaultParameters");var g,p;if(!t){p=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return e.getSystemContext()})}else{p=Promise.resolve(t)}var d=e.map(function(e){var t;if(e.indexOf("User.env.")===0){t=e;o[t]=1}if(e.indexOf("UserDefault.")===0){t=s._extractAnyUserDefaultReferenceName(e);l[t]=1}if(typeof t!=="string"){f=false;a.error("'"+e+"' is not a legal reference name",null,"sap.ushell.services.ReferenceResolver")}return{full:e,name:t}});if(!f){return i.reject("One or more references could not be resolved").promise()}Promise.all([p,c]).then(function(e){var t=e[0];var a=e[1];Object.keys(l).forEach(function(e){u.push(a.getValue(e,t))});Object.keys(o).forEach(function(e){g=g||s._getUserEnvReferenceResolver();u.push(g.getValue(e))});r.when.apply(r,u).done(function(){var e={};var t=0,r=arguments;Object.keys(l).forEach(function(e){l[e]=r[t];t=t+1});Object.keys(o).forEach(function(e){o[e]=r[t];t=t+1});d.forEach(function(t){var r;if(t.full.indexOf("UserDefault.extended.")===0){r=s.mergeSimpleAndExtended(l[t.name]);if(!n(r)){e[t.full]=r}else{e[t.full]=undefined}}else if(t.full.indexOf("UserDefault.")===0){e[t.full]=l[t.name].value}else if(t.full.indexOf("User.env.")===0){e[t.full]=o[t.name].value}});i.resolve(e)})});return i.promise()};this._extractAnyUserDefaultReferenceName=function(e){var t=this.extractExtendedUserDefaultReferenceName(e);if(typeof t==="string"){return t}return this.extractUserDefaultReferenceName(e)};this.extractExtendedUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.extended.")!==0){return undefined}return e.replace(/^UserDefault[.]extended[.]/,"")};this.extractUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.")!==0||e.indexOf("UserDefault.extended.")===0){return undefined}return e.replace(/^UserDefault[.]/,"")};this.mergeSimpleAndExtended=function(e){var t=r.extend(true,{},e.extendedValue);if(typeof e.value==="string"){if(!Array.isArray(t.Ranges)){t.Ranges=[]}t.Ranges.push({Sign:"I",Option:"EQ",Low:e.value,High:null})}return t};function f(e){var t=/{([^}%]*%%[^%]+%%)}?/g,r=/([^%]*)%%/,n=/%%([^%]+)%%/,a,s,i,u=[];a=t.exec(e);while(a){s=r.exec(a[1]);i=n.exec(a[1]);u.push({edmType:s[1],name:i[1]});a=t.exec(e)}return u}this.resolveUserDefaultParameters=function(e,n){var a=new r.Deferred,s,i,u=[],l;l=/[^(?]*/.exec(e);s=l===null?[]:f(l[0]);s.forEach(function(e){u.push(e.name)});l=/[(?][^]*/.exec(e);s=l===null?[]:f(l[0]);var o=[],c={};s.forEach(function(e){o.push(e.name);c[e.name]=e.edmType});i=o.filter(function(e){if(/^UserDefault\.(?!extended\.).+/.test(e)){return true}u.push(e);return false});if(i.length>0){this.resolveReferences(i,n).done(function(r){var n=e,s=[];Object.keys(r).forEach(function(e){var a,i=false;while(a!=n){a=n;if(r[e]!==undefined){var u=t.formatValue(r[e],c[e]);n=n.replace("{"+c[e]+"%%"+e+"%%}",window.encodeURIComponent(u))}else{i=true;n=n.replace("{"+c[e]+"%%"+e+"%%}","")}}if(i){s.push(e)}});a.resolve({url:n,defaultsWithoutValue:s,ignoredReferences:u})})}else{a.resolve({url:e,defaultsWithoutValue:[],ignoredReferences:u})}return a.promise()}}i.hasNoAdapter=true;return i},true);