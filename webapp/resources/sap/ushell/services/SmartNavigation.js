// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/utils","sap/ushell/services/AppConfiguration","sap/base/Log","sap/ushell/utils/UrlParsing"],function(e,t,n,r,i){"use strict";function a(e,t,n){this._oServiceConfig=n;this._oCrossAppNavigationServicePromise=sap.ushell.Container.getServiceAsync("CrossApplicationNavigation");this._oPersonalizationServicePromise=sap.ushell.Container.getServiceAsync("Personalization");this._oHashCodeCache={"":0}}a.STATISTIC_COLLECTION_WINDOW_DAYS=90;a.PERS_CONTAINER_KEY_PREFIX="ushell.smartnav.";a.ONE_DAY_IN_MILLISECOND=24*60*60*1e3;a.prototype.getLinks=function(t){var i=new e.Deferred;this._oCrossAppNavigationServicePromise.then(function(a){var o=a.getLinks(t);if(!this._isTrackingEnabled(this._oServiceConfig)){o.done(i.resolve).fail(i.reject);return}var s=n.getCurrentApplication();var c=s.sShellHash;var l=s.componentHandle;if(s.componentHandle){l=s.componentHandle.getInstance()}if(!c){r.warning("Call to SmartNavigation#getLinks() simply delegated to CrossApplicationNavigation#getLinks()"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");o.done(i.resolve).fail(i.reject);return}var u=this._getNavigationOccurrences(c,l);e.when(o,u).done(function(e,t){if(t.length===0){i.resolve(e);return}var n=this._prepareLinksForSorting(e,t);e=n.sort(function(e,t){return t.clickCount-e.clickCount});i.resolve(e)}.bind(this)).fail(i.reject)}.bind(this)).catch(i.reject);return i.promise()};a.prototype.toExternal=function(e){var t=arguments;this._oCrossAppNavigationServicePromise.then(function(i){if(!this._isTrackingEnabled(this._oServiceConfig)){i.toExternal.apply(i,t);return}var a=n.getCurrentApplication();var o=a.sShellHash;var s=a.componentHandle;if(a.componentHandle){s=a.componentHandle.getInstance()}if(!o){r.warning("Current shell hash could not be identified. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");i.toExternal.apply(i,t);return}var c=this._getHashFromOArgs(e.target);if(!c){r.warning("Destination hash does not conform with the ushell guidelines. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");i.toExternal.apply(i,t);return}this._recordNavigationOccurrences(o,c,s).then(function(){i.toExternal.apply(i,t)})}.bind(this))};a.prototype.hrefForExternal=function(){r.error("Deprecated API call of 'sap.ushell.services.SmartNavigation.hrefForExternal'. Please use 'hrefForExternalAsync' instead.",null,"sap.ushell.services.SmartNavigation");var e=sap.ushell.Container.getService("CrossApplicationNavigation");return e.hrefForExternal.apply(e,arguments)};a.prototype.hrefForExternalAsync=function(){var e=arguments;return this._oCrossAppNavigationServicePromise.then(function(t){return t.hrefForExternalAsync.apply(t,e)})};a.prototype.getPrimaryIntent=function(){var t=new e.Deferred;var n=arguments;this._oCrossAppNavigationServicePromise.then(function(e){e.getPrimaryIntent.apply(e,n).done(t.resolve).fail(t.reject)}).catch(t.reject);return t.promise()};a.prototype.trackNavigation=function(t){if(!this._isTrackingEnabled(this._oServiceConfig)){r.debug("Call to SmartNavigation#trackNavigation() ignored because Service is not enabled via Configuration",null,"sap.ushell.services.SmartNavigation");return e.when(null)}var i=t.target;var a=n.getCurrentApplication();var o=a.sShellHash;var s;if(!o){r.warning("Call to SmartNavigation#trackNavigation() simply ignored"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");return e.when(null)}s=this._getHashFromOArgs(i);if(!s){r.warning("Navigation not tracked - no valid destination provided",null,"sap.ushell.services.SmartNavigation");return e.when(null)}r.debug("Navigation to "+s+" was tracked out of "+o,null,"sap.ushell.services.SmartNavigation");return this._recordNavigationOccurrences(o,s,a.componentHandle.getInstance())};a.prototype._isTrackingEnabled=function(e){return t.isDefined(e)&&t.isDefined(e.config)&&t.isDefined(e.config.isTrackingEnabled)?e.config.isTrackingEnabled:false};a.prototype._getHashCode=function(e){var t=e+"";if(this._oHashCodeCache[t]){return this._oHashCodeCache[t]}var n=0;var r=t.length;while(r--){n=(n<<5)-n+(t.charCodeAt(r)|0);n|=0}this._oHashCodeCache[t]=n;return n};a.prototype._getBaseHashPart=function(e){var t=i.parseShellHash(e);if(t&&t.semanticObject&&t.action){return t.semanticObject+"-"+t.action}throw"Invalid intent `"+e+"`"};a.prototype._getHashFromOArgs=function(e){if(!e){return null}if(e.shellHash&&i.parseShellHash(e.shellHash)){return this._getBaseHashPart(e.shellHash)}if(e.semanticObject&&e.action){return e.semanticObject+"-"+e.action}return null};a.prototype._getPersContainerKey=function(e){return a.PERS_CONTAINER_KEY_PREFIX+this._getHashCode(e)};a.prototype._getNavigationOccurrences=function(t,n){var r=new e.Deferred;var i=this._getPersContainerKey(t);this._oPersonalizationServicePromise.then(function(e){var t=e.getContainer(i,{keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:true},n);t.done(function(e){var t=e.getItemKeys();var n=t.map(function(t){var n=e.getItemValue(t);var r=Object.keys(n.actions);return r.map(function(e){var r=n.actions[e];var i=r.dailyFrequency.reduce(function(e,t){return e+t},0);return{intent:t+"-"+e,clickCount:i}})});var i=n.reduce(function(e,t){Array.prototype.push.apply(e,t);return e},[]);r.resolve(i)})}).catch(r.reject);return r.promise()};a.prototype._prepareLinksForSorting=function(e,t){var n={};t.forEach(function(e){n[e.intent]=e});e.forEach(function(e){var t=this._getBaseHashPart(e.intent);var r=n[t];e.clickCount=r?r.clickCount:0}.bind(this));return e};a.prototype._recordNavigationOccurrences=function(t,n,r){var a=i.parseShellHash(n);var o=this._getPersContainerKey(t);var s=a.semanticObject;var c=new e.Deferred;this._oPersonalizationServicePromise.then(function(e){var t=e.getContainer(o,{keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:true},r);t.done(function(e){var t=e.getItemValue(s);var n=a.action;if(!t){t={actions:{},latestVisit:Date.now(),dailyFrequency:[0]}}var r=t.actions[n];if(!r){r={latestVisit:Date.now(),dailyFrequency:[0]};t.actions[n]=r}this._updateHistoryEntryWithCurrentUsage(t);this._updateHistoryEntryWithCurrentUsage(r);e.setItemValue(s,t);e.save().done(c.resolve).fail(c.reject)}.bind(this)).fail(c.reject)}.bind(this)).catch(c.reject);return c.promise()};a.prototype._updateHistoryEntryWithCurrentUsage=function(e){var t=Date.now();var n=t-e.latestVisit;var r=Math.floor(n/a.ONE_DAY_IN_MILLISECOND);while(r--){e.dailyFrequency.unshift(0);if(e.dailyFrequency.length>a.STATISTIC_COLLECTION_WINDOW_DAYS){e.dailyFrequency.pop()}}++e.dailyFrequency[0];e.latestVisit=t;return e};a.hasNoAdapter=true;return a});