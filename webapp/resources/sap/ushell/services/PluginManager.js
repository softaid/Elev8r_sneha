// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_PluginManager/Extensions","sap/base/Log","sap/ui/thirdparty/jquery","sap/base/util/UriParameters","sap/ushell/utils","sap/ushell/components/applicationIntegration/application/PostMessageAPIInterface","sap/ushell/UI5ComponentType"],function(e,n,i,t,o,r,a){"use strict";var s="sap.ushell.services.PluginManager";var l="sap-ushell-plugin-type";var u="RendererExtensions";var g="sap.ushell.components.shell.defaults";var f=[u,"EarlyLoading","UserDefaults","UserImage","ContentProvider","AppWarmup"];function c(c,p,d){var h=this;this._oPluginCollection={};this._oCategoryLoadingProgress={};this._mInitializedComponentPromise={};this._sPluginAgentsNames="";this._oConfig=d&&d.config||{};if(this._oConfig.isBlueBox===undefined){this._oConfig.isBlueBox=false}f.forEach(function(e){h._oPluginCollection[e]={};h._oCategoryLoadingProgress[e]=new i.Deferred});this._handlePluginCreation=function(e,i,t,r){var a=this,l=a._oPluginCollection[e][i];o.setPerformanceMark("FLP -- PluginManager.loadPlugin["+e+"]["+i+"]");try{if(l.hasOwnProperty("component")){if(a._mInitializedComponentPromise.hasOwnProperty(l.component)){a._mInitializedComponentPromise[l.component].then(function(){a._instantiateComponent(l,t,r)},function(){a._instantiateComponent(l,t,r)})}else{a._mInitializedComponentPromise[l.component]=a._instantiateComponent(l,t,r)}}else{n.error("Invalid plugin configuration. The plugin "+i+" must contain a <component> key",s)}}catch(e){n.error("Error while loading bootstrap plugin: "+l.component||"",s);if(t){t.reject(e)}}};this._getFileNameForXhrAuth=function(){return"Component-preload.js"};this._handleXhrAuthentication=function(e,t){var o;if(e&&["true",true,"X"].indexOf(e["sap-ushell-xhr-authentication"])>-1){if(!t){n.error(["Illegal state: configuration parameter 'sap-ushell-xhr-authentication-timeout' set, but no component URL specified.","XHR authentication request will not be sent. Please check the target mapping definitions for plug-ins","and the application index."].join(" "),undefined,s);return i.when()}if(e.hasOwnProperty("sap-ushell-xhr-authentication-timeout")){o=parseInt(e["sap-ushell-xhr-authentication-timeout"],10);if(isNaN(o)){n.error(["Invalid value for configuration parameter 'sap-ushell-xhr-authentication-timeout' for plug-in component with URL '",t,"': '",e["sap-ushell-xhr-authentication-timeout"],"' is not a number. Timeout will be ignored."].join(""),undefined,s)}else{sap.ushell.Container.setXhrLogonTimeout(t,o)}}return i.ajax(t+"/"+this._getFileNameForXhrAuth(),{dataType:"text"})}return i.when()};this._instantiateComponent=function(t,o,r){var l=new i.Deferred,u=JSON.parse(JSON.stringify(t)),g={ui5ComponentName:u.component,url:u.url,getExtensions:e.bind(null,t.component)};function f(e){return function(i){e=e||"Cannot create UI5 plugin component: (componentId/appdescrId :"+g.ui5ComponentName+")\n"+i+" properties "+JSON.stringify(g)+"\n This indicates a plugin misconfiguration, see e.g. Note 2316443.";i=i||"";n.error(e,i.stack,s);if(o){o.reject.apply(this,arguments)}l.reject.apply(this,arguments)}}u.name=u.component;delete u.component;g.applicationDependencies=u;if(u.config){g.applicationConfiguration=u.config;delete u.config}g.loadDefaultDependencies=false;if(r!==undefined){g.oPostMessageInterface=r}sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(e){this._handleXhrAuthentication(g.applicationConfiguration,u.url).done(function(){e.createComponent(g,{},[],a.Plugin).done(function(e){if(o){o.resolve(e)}l.resolve.apply(this,arguments)}).fail(f())}).fail(f("XHR logon for FLP plugin failed"))}.bind(this)).catch(f());return l.promise()};this.getSupportedPluginCategories=function(){return JSON.parse(JSON.stringify(f))};this.getRegisteredPlugins=function(){return JSON.parse(JSON.stringify(this._oPluginCollection))};this.registerPlugins=function(e){var i=this,o,r,a,g=[],c,p;if(!e){return}if(this._oConfig.isBlueBox===true){c=new t(window.location.href).get("sap-plugins");if(c&&c.length>0){c=","+c+","}else{c=undefined}}Object.keys(e).sort().forEach(function(t){o=e[t]||{};r=o.config||{};a=r[l]||"";if(o.enabled===false){return}if(!i._isFormFactorSupported(o)){n.info("Plugin '"+t+"' filtered from result: form factor not supported");return}if(i._oConfig.isBlueBox===true){if(o.config&&o.config["sap-plugin-agent"]===true){p=o.config["sap-plugin-agent-id"]||t;if(c){if(c.indexOf(","+p+",")<0){return}}else{return}}}if(o.enabled===undefined){o.enabled=true}if(o.hasOwnProperty("module")){var d=(o.module||"").replace(/\./g,"/");n.error("Plugin "+t+" cannot get registered, because the module mechanism for plugins is not valid anymore. Plugins need to be defined as SAPUI5 components.",s);try{sap.ui.requireSync(d)}catch(e){n.error("Plugin module "+d+" is not found.")}return}if(r&&r.hasOwnProperty(l)){if(f&&Array.prototype.indexOf.call(f,a)!==-1){if(g.indexOf(a)===-1){g.push(a)}i._oPluginCollection[a][t]=JSON.parse(JSON.stringify(o))}else{n.warning("Plugin "+t+" will not be inserted into the plugin collection of the PluginManager, because of unsupported category "+a,s)}}else{i._oPluginCollection[u][t]=JSON.parse(JSON.stringify(o));if(g.indexOf(u)===-1){g.push(u)}}});try{if(i._oConfig.isBlueBox!==true){i._buildNamesOfPluginsWithAgents()}}catch(e){n.error("failed to build plugin agents names list",e.message||e.toString(),"sap.ushell.services.PluginManager")}g.forEach(function(e){if(i._oCategoryLoadingProgress.hasOwnProperty(e)&&i._oCategoryLoadingProgress[e].state()==="resolved"){i.loadPlugins(e)}})};this._isFormFactorSupported=function(e){var n=e.deviceTypes,i=o.getFormFactor();if(n&&n[i]===false){return false}return true};this.getPluginLoadingPromise=function(e){if(this._oCategoryLoadingProgress.hasOwnProperty(e)){return this._oCategoryLoadingProgress[e].promise()}};this.loadPlugins=function(e){var a=this,l,c,p,d;o.setPerformanceMark("FLP -- PluginManager.startLoadPlugins["+e+"]");if(e===u){d=r.getInterface()}if(f&&Array.prototype.indexOf.call(f,e)!==-1){if(a._oCategoryLoadingProgress[e].pluginLoadingTriggered===undefined){a._oCategoryLoadingProgress[e].pluginLoadingTriggered=true}if(Object.keys(a._oPluginCollection[e]).length>0){l=[];p=Object.keys(a._oPluginCollection[e]);if(new t(window.location.href).get("sap-ushell-xx-pluginmode")==="discard"&&(e==="RendererExtensions"||e==="AppWarmup")){p=p.filter(function(n){return a._oPluginCollection[e][n].component===g})}p.forEach(function(n){var t=a._oPluginCollection[e][n];if(!t.loaded){t.loaded=true;c=new i.Deferred;l.push(c.promise());a._handlePluginCreation(e,n,c,d)}});if(l.length>0){i.when.apply(undefined,l).done(function(){o.setPerformanceMark("FLP -- PluginManager.endLoadPlugins["+e+"]");a._oCategoryLoadingProgress[e].resolve()}).fail(a._oCategoryLoadingProgress[e].reject.bind())}}else{a._oCategoryLoadingProgress[e].resolve()}}else{n.error("Plugins with category "+e+" cannot be loaded by the PluginManager",s);a._oCategoryLoadingProgress[e].reject("Plugins with category "+e+" cannot be loaded by the PluginManager")}return a._oCategoryLoadingProgress[e].promise()};this._buildNamesOfPluginsWithAgents=function(){var e=this,n="",i;Object.keys(e._oPluginCollection).forEach(function(t){Object.keys(e._oPluginCollection[t]).forEach(function(o){i=e._oPluginCollection[t][o];if(i&&i.enabled&&i.enabled===true){if(i.config&&i.config["sap-plugin-agent"]===true){n+=(i.config["sap-plugin-agent-id"]||o)+","}}})});if(n.endsWith(",")){n=n.slice(0,-1)}this._sPluginAgentsNames=n};this._getNamesOfPluginsWithAgents=function(){return this._sPluginAgentsNames}}c.hasNoAdapter=true;return c},true);