// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject","sap/base/Log","sap/base/util/ObjectPath","sap/base/util/deepClone"],function(e,r,i,o,t){"use strict";function a(){}a.prototype._getItemIndex=function(e,r){var i;for(i=0;i<e.length;i++){if(e[i].id===r){break}}i=i>=e.length?-1:i;return i};a.prototype._applyRenameGroup=function(e,r,i){var o,t=false;if(!r){return false}if(e&&i&&i.groups&&i.groups[e]){o=i.groups[e];if(o.identification&&o.identification.title){i.groups[e].identification.title=r;t=true}}return t};a.prototype._applyGroupVisibility=function(e,r,i){var o=false;if(r===undefined){return false}if(e&&i&&i.groups&&i.groups[e]){i.groups[e].identification.isVisible=r;o=true}return o};a.prototype.mixinPersonalization=function(i,o){var t=new e.Deferred,a=this;if(!o||r(o)){return t.resolve(i).promise()}if(o.groups){Object.keys(o.groups).forEach(function(e){var r=o.groups[e];if(i.groups[e]){if(r.identification){if(r.identification.title){a._applyRenameGroup(e,r.identification.title,i)}if(r.identification.hasOwnProperty("isVisible")&&r.identification.isVisible===false){a._applyGroupVisibility(e,false,i)}}}})}this._applyAddGroups(i,o);if(o.removedGroups&&Array.isArray(o.removedGroups)){o.removedGroups.forEach(function(e){a._applyRemoveGroup(i,e)})}this._applyMoveGroup(i,o);this._applyItemChanges(i,o);this._applyTileSettings(i,o);return t.resolve(i).promise()};a.prototype._applyAddGroups=function(e,r){var i=[];e.site=e.site||{};e.site.payload=e.site.payload||{};e.site.payload.groupsOrder=e.site.payload.groupsOrder||[];e.groups=e.groups||{};if(Array.isArray(r.groupOrder)){e.site.payload.groupsOrder.forEach(function(e){if(r.groupOrder.indexOf(e)===-1){if(r.removedGroups&&r.removedGroups.indexOf(e)===-1||!r.removedGroups){i.push(e)}}})}if(Array.isArray(r.groupOrder)&&r.addedGroups&&Object.keys(r.addedGroups).length>0){Object.keys(r.addedGroups).forEach(function(i){e.groups[i]=t(r.addedGroups[i],20);e.groups[i].payload.isPreset=false});e.site.payload.groupsOrder=r.groupOrder}i.forEach(function(r){e.site.payload.groupsOrder.push(r)})};a.prototype._checkRenameGroup=function(e,r,i,o){if(e&&r&&i){if(i[e]){if(r[e].identification.title!==i[e].identification.title){o=o||{};o.groups=o.groups||{};o.groups[e]=o.groups[e]||{};o.groups[e].identification=o.groups[e].identification||{};o.groups[e].identification.title=r[e].identification.title}}}return o};a.prototype._applyTileSettings=function(e,r){var i,o;if(!r.modifiedTiles){return}i=Object.keys(e.groups).map(function(e){return this[e]},e.groups);o=Object.keys(r.modifiedTiles).map(function(e){return this[e]},r.modifiedTiles);i.some(function(e){["tiles","links"].forEach(function(r){if(e.payload[r]){e.payload[r].some(function(e){var r;o.some(function(i,o){if(i.id===e.id){if(i.title!==undefined){e.title=i.title}if(i.subTitle!==undefined){e.subTitle=i.subTitle}if(i.info!==undefined){e.info=i.info}if(i.displayFormatHint!==undefined){e.displayFormatHint=i.displayFormatHint}r=o;return true}return false});if(r!==undefined){o.splice(r,1)}return o.length===0})}});return o.length===0})};a.prototype._checkGroupVisibility=function(e,r,i,o){if(e&&r&&i){if(i[e]){if(r[e].identification.isVisible!==i[e].identification.isVisible&&typeof r[e].identification.isVisible==="boolean"){o=o||{};o.groups=o.groups||{};o.groups[e]=o.groups[e]||{};o.groups[e].identification=o.groups[e].identification||{};o.groups[e].identification.isVisible=r[e].identification.isVisible}}}return o};a.prototype._addGroupToPersonalizationDelta=function(r,i,o){var t=false,a,s;if(r&&r.site&&r.site.payload&&r.site.payload.groupsOrder&&r.groups&&o&&r.groups[o]&&i){a=r.site.payload.groupsOrder;s=r.groups[o];i.addedGroups=i.addedGroups||{};i.addedGroups[o]={};i.addedGroups[o].identification=e.extend({},s.identification);i.addedGroups[o].payload=e.extend({},s.payload);i.addedGroups[o].payload.tiles=[];i.addedGroups[o].payload.links=[];i.groupOrder=a;t=true}return t};a.prototype.extractPersonalization=function(i,o){var t=new e.Deferred,a,s={},p,n,l=this;if(i&&i.groups&&o&&o.groups){a=i.groups;p=o.groups;n=this._getExtractHelperObject(o,i,s);Object.keys(p).forEach(function(e){l._checkRemoveGroup(i,s,e);l._extractFromOriginalSiteOneGroup(o,n,e,"tiles");l._extractFromOriginalSiteOneGroup(o,n,e,"links")});Object.keys(a).forEach(function(e){if(p[e]){l._checkRenameGroup(e,a,p,s);l._checkGroupVisibility(e,a,p,s)}else{l._addGroupToPersonalizationDelta(i,s,e)}l._extractFromPersonalizedSiteOneGroup(i,n,e,"tiles");l._extractFromPersonalizedSiteOneGroup(i,n,e,"links")});this._checkMoveGroup(i,o,s);this._cleanupRemovedGroups(o,s);if(n.oPersonalizationDelta.movedTiles&&r(n.oPersonalizationDelta.movedTiles)){delete n.oPersonalizationDelta.movedTiles}if(n.oPersonalizationDelta.movedLinks&&r(n.oPersonalizationDelta.movedLinks)){delete n.oPersonalizationDelta.movedLinks}}if(o._version){s._version=o._version}return t.resolve(s).promise()};a.prototype._checkRemoveGroup=function(e,r,i){var o=false;if(e&&e.groups&&r&&i){if(!e.groups[i]){r.removedGroups=r.removedGroups||[];r.groupOrder=r.groupOrder||[];if(r.removedGroups.indexOf(i)===-1){r.removedGroups.push(i)}if(e.site&&e.site.payload&&e.site.payload.groupsOrder&&Array.isArray(e.site.payload.groupsOrder)){r.groupOrder=e.site.payload.groupsOrder.slice(0)}}o=true}return o};a.prototype._applyRemoveGroup=function(e,r){var i,o,t;if(e&&e.groups&&e.site&&e.site.payload&&e.site.payload.groupsOrder&&r){i=e.groups;o=e.site.payload.groupsOrder;t=o.indexOf(r);if(!(t===-1)){o.splice(t,1);delete i[r];return true}}return false};a.prototype._checkMoveGroup=function(e,r,i){var o,t,a=false,s=false;if(e.site&&e.site.payload&&Array.isArray(e.site.payload.groupsOrder)&&r.site&&r.site.payload&&Array.isArray(r.site.payload.groupsOrder)){o=e.site.payload.groupsOrder;t=r.site.payload.groupsOrder;if(o.length===t.length){a=function(){var e=false,r;for(r=0;r<t.length;r++){if(t[r]!==o[r]){e=true;break}}return e}();if(a){i.groupOrder=o;s=true}}}return s};a.prototype._applyMoveGroup=function(e,r){var i=false;if(Array.isArray(r.groupOrder)){e.site=e.site||{};e.site.payload=e.site.payload||{};if(!Array.isArray(e.site.payload.groupsOrder)){e.site.payload.groupsOrder=[]}if(e.site.payload.groupsOrder.length===r.groupOrder.length){e.site.payload.groupsOrder=r.groupOrder;i=true}}return i};a.prototype._getHashedItemsFromSite=function(e){var r=null;if(e&&e.groups){if(Object.keys(e.groups).length>0){r={};Object.keys(e.groups).forEach(function(i){var o=e.groups[i],t;r[i]={};if(o.payload){["tiles","links"].forEach(function(e){r[i][e]={};if(Array.isArray(o.payload[e])){t=o.payload[e];t.forEach(function(o,t){var a;if(o&&o.id){a=o.id;r[i][e][a]={iIndex:t,sItemId:o}}})}})}})}}return r};a.prototype._getExtractHelperObject=function(e,r,i){var o=null;o={};o.oHashedItemsOriginal=this._getHashedItemsFromSite(e)||{};o.oHashedItemsPersonalized=this._getHashedItemsFromSite(r);o.oPersonalizationDelta=i;return o};a.prototype._extractFromOriginalSiteOneGroup=function(e,r,i,o){var t=false,a,s,p,n="movedTiles";o=o||"tiles";if(o!=="tiles"){n="movedLinks"}p=function(e,r){s[e]=s[e]?s[e]:{};s[e].fromGroup=r;s[e].toGroup=null};if(r&&r.oHashedItemsPersonalized&&r.oPersonalizationDelta&&e&&e.groups&&e.groups[i]&&e.groups[i].payload&&Array.isArray(e.groups[i].payload[o])){a=e.groups[i].payload[o];r.oPersonalizationDelta[n]=r.oPersonalizationDelta[n]?r.oPersonalizationDelta[n]:{};s=r.oPersonalizationDelta[n];if(r.oHashedItemsPersonalized[i]){a.forEach(function(e){if(!r.oHashedItemsPersonalized[i][o][e.id]){p(e.id,i)}});t=true}else{a.forEach(function(e){p(e.id,i)});t=true}}return t};a.prototype._extractPersonalizationDeltaForTile=function(e,i,t,a){var s=o.get(["oHashedItemsOriginal",t,a,e.id,"sItemId"],i);if(!s){return false}var p={};if(e.title!==s.title){p.title=e.title}if(e.subTitle!==s.subTitle){p.subTitle=e.subTitle}if(e.info!==s.info){p.info=e.info}if(e.displayFormatHint!==s.displayFormatHint&&!(e.displayFormatHint==="default"&&!s.displayFormatHint)){p.displayFormatHint=e.displayFormatHint}if(r(p)){return false}if(!i.oPersonalizationDelta.modifiedTiles){i.oPersonalizationDelta.modifiedTiles={}}var n=i.oPersonalizationDelta.modifiedTiles;p.id=e.id;n[e.id]=p;return true};a.prototype._extractFromPersonalizedSiteOneGroup=function(e,r,o,t){var a=false,s,p,n=false,l,u=this,d="movedTiles";t=t||"tiles";if(t!=="tiles"&&t!=="links"){return a}if(t!=="tiles"){d="movedLinks"}if(r&&r.oPersonalizationDelta&&e&&e.groups&&e.groups[o]&&e.groups[o].payload&&Array.isArray(e.groups[o].payload[t])){l=e.groups[o].payload[t];r.oPersonalizationDelta[d]=r.oPersonalizationDelta[d]?r.oPersonalizationDelta[d]:{};s=r.oPersonalizationDelta[d];p=[];l.forEach(function(e,a){if(!e){return}p.push(e.id);if(r.oHashedItemsOriginal[o]&&r.oHashedItemsOriginal[o][t][e.id]){if(s[e.id]){i.error("Extract personalization failed","The Tile ID "+e.id+" is not unique in the site","PersonalizationProcessor");delete s[e.id]}if(r.oHashedItemsOriginal[o][t][e.id].iIndex!==a){n=true}u._extractPersonalizationDeltaForTile(e,r,o,t)}else{n=true;if(s[e.id]){if(s[e.id].fromGroup&&s[e.id].fromGroup!==o){if(!s[e.id].toGroup){s[e.id].toGroup=o;u._extractPersonalizationDeltaForTile(e,r,s[e.id].fromGroup,t)}}}else{s[e.id]={};s[e.id].fromGroup=null;s[e.id].toGroup=o;s[e.id].item=e}}});if(n){r.oPersonalizationDelta.groups=r.oPersonalizationDelta.groups||{};r.oPersonalizationDelta.groups[o]=r.oPersonalizationDelta.groups[o]||{};r.oPersonalizationDelta.groups[o].payload=r.oPersonalizationDelta.groups[o].payload||{};if(t==="tiles"){r.oPersonalizationDelta.groups[o].payload.tileOrder=p}else{r.oPersonalizationDelta.groups[o].payload.linkOrder=p}}a=true}return a};a.prototype._cleanupRemovedGroups=function(e,r){var i,o;if(r.removedGroups&&r&&Array.isArray(r.removedGroups)&&r.removedGroups.length>0){r.removedGroups.forEach(function(t){if(e&&e.groups&&e.groups[t]&&e.groups[t].payload){[{sType:"tiles",sPersonalizationDeltaType:"movedTiles"},{sType:"links",sPersonalizationDeltaType:"movedLinks"}].forEach(function(a){if(Array.isArray(e.groups[t].payload[a.sType])){i=e.groups[t].payload[a.sType];i.forEach(function(e){if(r[a.sPersonalizationDeltaType]){o=r[a.sPersonalizationDeltaType][e.id];if(o&&o.fromGroup&&o.fromGroup===t&&!o.toGroup){delete r[a.sPersonalizationDeltaType][e.id]}}})}})}})}};a.prototype._setItemOrderOnSiteCollection=function(e,r){var i=true,o=e.length,t,a={},s,p,n,l;if(!Array.isArray(e)||!Array.isArray(e)||e.length!==r.length){return false}t=e.splice(0,e.length);for(s=0;s<r.length;s++){n=r[s];p=t.shift();if(p&&n===p.id){e.push(p)}else if(a[n]){e.push(a[n]);delete a[n];if(p){a[p.id]=p}}else if(p){a[p.id]=p;l=false;while(t.length>0){p=t.shift();if(n===p.id){e.push(p);l=true;break}else{a[p.id]=p}}if(!l){i=false}}}if(e.length!==o){i=false}return i};a.prototype._setItemOrderOnSiteGroupForItemType=function(e,r,i){var o=true,t,a;if(i==="tiles"||i==="links"){a=i==="tiles"?"tileOrder":"linkOrder"}else{return false}if(r.payload&&Array.isArray(r.payload[a])&&r.payload[a].length>0){if(e.payload&&Array.isArray(e.payload[i])&&e.payload[i].length>0){t=this._setItemOrderOnSiteCollection(e.payload[i],r.payload[a]);if(!t){o=false}}else{o=false}}return o};a.prototype._setItemOrderOnSite=function(e,r){var i=true,o,t=this;if(e.groups&&r.groups){Object.keys(r.groups).forEach(function(a){if(r.groups[a]&&e.groups[a]){o=t._setItemOrderOnSiteGroupForItemType(e.groups[a],r.groups[a],"tiles");if(!o){i=false}o=t._setItemOrderOnSiteGroupForItemType(e.groups[a],r.groups[a],"links");if(!o){i=false}}})}return i};a.prototype._applyMoveItemsWithoutOrder=function(e,i,o){var t=true,a,s,p="tileOrder",n,l,u,d=[],f=this;function y(r,t){var a=true;if(e.groups[t]&&e.groups[t].payload&&i.groups&&i.groups[t]&&i.groups[t].payload&&Array.isArray(i.groups[t].payload[p])&&i.groups[t].payload[p].length>0){if(!Array.isArray(e.groups[t].payload[o])){e.groups[t].payload[o]=[]}e.groups[t].payload[o].push(r)}else{a=false}return a}if(o==="tiles"||o==="links"){s=o==="tiles"?"movedTiles":"movedLinks";p=o==="tiles"?"tileOrder":"linkOrder"}else{return false}if(!e||!e.groups||!e.site||!e.site.payload||!Array.isArray(e.site.payload.groupsOrder)||!i){return false}if(i[s]){Object.keys(i[s]).forEach(function(p){n=i[s][p];if(n.fromGroup){if(n.toGroup){if(n.fromGroup!==n.toGroup){if(e.groups[n.fromGroup]&&e.groups[n.fromGroup].payload&&Array.isArray(e.groups[n.fromGroup].payload[o])){d=e.groups[n.fromGroup].payload[o];l=f._getItemIndex(d,p);if(l>=0){u=d.splice(l,1);a=y(u[0],n.toGroup);if(!a){t=false}}else{t=false}}else{t=false}}else{t=false}}else if(e.groups[n.fromGroup]&&e.groups[n.fromGroup].payload&&Array.isArray(e.groups[n.fromGroup].payload[o])){d=e.groups[n.fromGroup].payload[o];l=f._getItemIndex(d,p);if(l>=0){d.splice(l,1)}else{t=false}}else{t=false}}else if(n.toGroup){if(n.item&&!r(n.item)){a=y(n.item,n.toGroup);if(!a){t=false}}else{t=false}}else{t=false}})}return t};a.prototype._applyItemChanges=function(e,r){var i=true,o;o=this._applyMoveItemsWithoutOrder(e,r,"tiles");if(!o){i=false}o=this._applyMoveItemsWithoutOrder(e,r,"links");if(!o){i=false}if(r.groups){o=this._setItemOrderOnSite(e,r);if(!o){i=false}}return i};return a});