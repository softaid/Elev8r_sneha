// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/ui/core/ws/SapPcpWebSocket","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/model/json/JSONModel","sap/ushell/utils"],function(e,t,i,s,n,o){"use strict";var r="/sap/bc/apc/iwngw/notification_push_apc";var a=60;function c(c,u,f){var d=new n,l=new Date,g=f&&f.config,p={getNotifications:{},getNotificationsByType:{},getNotificationsInGroup:{},getBadgeNumber:{},resetBadgeNumber:{},getNotificationTypesSettings:{},getNotificationsGroupHeaders:{},getMobileSupportSettings:{},getEmailSupportSettings:{},getWebSocketValidity:{},getNotificationCount:{}},h,N,v,_,S=[],T=[],C=[],I=false,m=[],b=false,y=false,D=true,E,A,P=5e3,O=6e3,B=false,R={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3,GET_SETTINGS:4,GET_MOBILE_SUPPORT_SETTINGS:5,NOTIFICATIONS_GROUP_HEADERS:6,NOTIFICATIONS_IN_GROUP:7,GET_NOTIFICATIONS_COUNT:8,VALIDATE_WEBSOCKET_CHANNEL:9,GET_EMAIL_SUPPORT_SETTINGS:10,NOTIFICATIONS_BY_DATE_DESCENDING:"notificationsByDateDescending",NOTIFICATIONS_BY_DATE_ASCENDING:"notificationsByDateAscending",NOTIFICATIONS_BY_PRIORITY_DESCENDING:"notificationsByPriorityDescending",NOTIFICATIONS_BY_TYPE_DESCENDING:"notificationsByTypeDescending"},k={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3},U,F=false,G=true,q=false,w=new i.Deferred,L=new i.Deferred,M,H,j=w.promise(),W=false,X={},x=10,$=false,z=false,J=[];this.isEnabled=function(){if(!g.enabled||!g.serviceUrl){D=false;if(g.enabled&&!g.serviceUrl){s.warning("No serviceUrl was found in the service configuration")}}else{D=true}return D};this.init=function(){if(!b&&this.isEnabled()){sap.ui.getCore().getEventBus().subscribe("launchpad","sessionTimeout",this.destroy,this);this.lastNotificationDate=new Date;this._setWorkingMode();b=true;this.bUpdateDependencyInitiatorExists=false;this._userSettingInitialization()}sap.ui.getCore().getEventBus().subscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this._onSetConnectionToServer=function(e,t,i){if(i.active){this._resumeConnection()}else{this._closeConnection()}};this.getUnseenNotificationsCount=function(){var e=new i.Deferred;e.resolve(d.getProperty("/UnseenCount"));return e.promise()};this.getNotificationsCount=function(){return d.getProperty("/NotificationsCount")?d.getProperty("/NotificationsCount"):"0"};this.getNotificationsByTypeWithGroupHeaders=function(){var t={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},n,o=new i.Deferred,r=this._getRequestURI(R.NOTIFICATIONS_BY_TYPE);n={requestUri:r};if(!this._getHeaderXcsrfToken()){t["X-CSRF-Token"]="fetch"}n.headers=t;e.request(n,function(e){o.resolve(e)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){o.resolve(e.response.body)}else{o.reject(e);s.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}});return o.promise()};this.getNotificationsGroupHeaders=function(){var t={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},n,o=new i.Deferred,r=this._getRequestURI(R.NOTIFICATIONS_GROUP_HEADERS);n={requestUri:r};if(!this._getHeaderXcsrfToken()){t["X-CSRF-Token"]="fetch"}n.headers=t;e.request(n,function(e){o.resolve(e)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){o.resolve(e.response.body)}else{o.reject();s.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}});return o.promise()};this.getNotificationsBufferInGroup=function(t,n,o){var r=this,a={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},c,u=new i.Deferred,f={group:t,skip:n,top:o},d,l,g=this._getRequestURI(R.NOTIFICATIONS_IN_GROUP,f);if(W===true){d=X[R.NOTIFICATIONS_IN_GROUP].slice(n,n+o);l=JSON.stringify({"@odata.context":"$metadata#Notifications",value:d});setTimeout(function(){u.resolve(l)},1e3)}else{c={requestUri:g};if(!this._getHeaderXcsrfToken()){a["X-CSRF-Token"]="fetch"}c.headers=a;e.request(c,function(e){r._updateCSRF(e.response);u.resolve(e.value)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){r._updateCSRF(e.response);u.resolve(JSON.parse(e.response.body).value)}else{u.reject();s.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}})}return u.promise()};this.getNotificationsBufferBySortingType=function(t,n,o){var r=this,a={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},c,u=new i.Deferred,f={skip:n,top:o},d,l,g=this._getRequestURI(t,f);if(W===true){d=X[t].slice(n,n+o);l=JSON.stringify({"@odata.context":"$metadata#Notifications",value:d});setTimeout(function(){u.resolve(l)},1e3)}else{c={requestUri:g};if(!this._getHeaderXcsrfToken()){a["X-CSRF-Token"]="fetch"}c.headers=a;e.request(c,function(e){r._updateCSRF(e.response);u.resolve(e.value)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){r._updateCSRF(e.response);u.resolve(JSON.parse(e.response.body).value)}else{u.reject();s.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}})}return u.promise()};this.getNotifications=function(){var e,t=new i.Deferred;if(U===k.FIORI_CLIENT||U===k.PACKAGED_APP){e=this._readNotificationsData(false);e.done(function(){t.resolve(d.getProperty("/Notifications"))}).fail(function(){t.reject()})}else{t.resolve(d.getProperty("/Notifications"))}return t.promise()};this.executeBulkAction=function(e,t){var s=new i.Deferred,n=[],o=[],r={succededNotifications:n,failedNotifications:o},a=this;a.sendBulkAction(e,t).done(function(e){e.forEach(function(e,t){var i=e.NotificationId,s=e.Success;if(s){n.push(i)}else{o.push(i)}});if(o.length){s.reject(r)}else{s.resolve(r)}}).fail(function(){s.reject(r)});return s.promise()};this.dismissBulkNotifications=function(e){var t=new i.Deferred,s=this;s.sendBulkDismiss(e).done(function(){t.resolve()}).fail(function(){t.reject()});return t.promise()};this.executeAction=function(t,n){var o=this,r=g.serviceUrl+"/ExecuteAction",a={NotificationId:t,ActionId:n},c={requestUri:r,method:"POST",data:a,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:A,"X-CSRF-Token":E}},u=new i.Deferred;e.request(c,function(e){var t,i={isSucessfull:true,message:""};if(e&&e.response&&e.response.statusCode===200&&e.response.body){t=JSON.parse(e.response.body);i.isSucessfull=t.Success;i.message=t.MessageText}u.resolve(i)},function(e){var i,r={isSucessfull:false,message:""};if(e.response&&e.response.statusCode===200&&e.response.body){i=JSON.parse(e.response.body);r.isSucessfull=i.Success;r.message=i.MessageText;u.resolve(r)}else if(o._csrfTokenInvalid(e)&&$===false){o._invalidCsrfTokenRecovery(u,o.executeAction,[t,n])}else{u.reject(e);s.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}});return u.promise()};this.sendBulkAction=function(t,n){var o=this,r=g.serviceUrl+"/BulkActionByHeader",a={ParentId:t,ActionId:n},c={requestUri:r,method:"POST",data:a,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:A,"X-CSRF-Token":E}},u=new i.Deferred;e.request(c,function(e){var t,i;if(e&&e.response&&e.response.statusCode===200&&e.response.body){t=JSON.parse(e.response.body);i=t.value}u.resolve(i)},function(e){var i,r;if(e.response&&e.response.statusCode===200&&e.response.body){i=JSON.parse(e.response.body);r=i.value;u.resolve(r)}else if(o._csrfTokenInvalid(e)&&$===false){o._invalidCsrfTokenRecovery(u,o.sendBulkAction,[t,n])}else{u.reject();s.error("Notification service - oData executeBulkAction failed: ",e.message,"sap.ushell.services.Notifications")}});return u.promise()};this.sendBulkDismiss=function(t){var n=this,o=g.serviceUrl+"/DismissAll",r={ParentId:t},a={requestUri:o,method:"POST",data:r,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:A,"X-CSRF-Token":E}},c=new i.Deferred;e.request(a,function(){c.resolve()},function(e){if(e.response&&e.response.statusCode===200){c.resolve()}else if(n._csrfTokenInvalid(e)&&$===false){n._invalidCsrfTokenRecovery(c,n.sendBulkDismiss,[t])}else{c.reject();var i=e?e.message:"";s.error("Notification service - oData executeBulkAction failed: ",i,"sap.ushell.services.Notifications")}});return c.promise()};this.markRead=function(t){var n=this,o=g.serviceUrl+"/MarkRead",r={NotificationId:t},a={requestUri:o,method:"POST",data:r,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:A,"X-CSRF-Token":E}},c=new i.Deferred;e.request(a,function(){c.resolve()},function(e){if(n._csrfTokenInvalid(e)&&$===false){n._invalidCsrfTokenRecovery(c,n.markRead,[t])}else{s.error("Notification service - oData reset badge number failed: ",e,"sap.ushell.services.Notifications");c.reject(e)}});return c.promise()};this.dismissNotification=function(t){var n=g.serviceUrl+"/Dismiss",o=this,r={NotificationId:t},a={requestUri:n,method:"POST",data:r,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:A,"X-CSRF-Token":E}},c=new i.Deferred;e.request(a,function(){o._addDismissNotifications(t);c.resolve()},function(e){if(o._csrfTokenInvalid(e)&&$===false){o._invalidCsrfTokenRecovery(c,o.dismissNotification,[t])}else{c.reject(e);s.error("Notification service - oData dismiss notification failed: ",e,"sap.ushell.services.Notifications")}});return c.promise()};this.registerNotificationsUpdateCallback=function(e){S.push(e)};this.registerDependencyNotificationsUpdateCallback=function(e,t){if(t===false){this.bUpdateDependencyInitiatorExists=true}T.push({callback:e,dependent:t})};this.registerNotificationCountUpdateCallback=function(e){C.push(e)};this.notificationsSeen=function(){this._setNotificationsAsSeen()};this.isFirstDataLoaded=function(){return F};this.readSettings=function(){var e;e=this._readSettingsFromServer();return e};this.saveSettingsEntry=function(e){var t=this._writeSettingsEntryToServer(e);return t};this.getUserSettingsFlags=function(){var e=new i.Deferred;if(q===true){e.resolve({highPriorityBannerEnabled:G})}else{j.done(function(){e.resolve({highPriorityBannerEnabled:G})})}return e.promise()};this.setUserSettingsFlags=function(e){G=e.highPriorityBannerEnabled;this._writeUserSettingsFlagsToPersonalization(e)};this._getNotificationSettingsMobileSupport=function(){return M};this._getDismissNotifications=function(){return J};this.filterDismisssedItems=function(e,t){return e.filter(function(e){return!t.some(function(t){return t===e.originalItemId})})};this._addDismissNotifications=function(e){if(J.indexOf(e)===-1){J.push(e)}};this._initializeDismissNotifications=function(){J=[]};this._getNotificationSettingsEmailSupport=function(){return H};this.destroy=function(){y=true;if(N){clearTimeout(N)}else if(v){clearTimeout(v)}else if(_){clearTimeout(_)}if(U===k.WEB_SOCKET&&h){h.close()}sap.ui.getCore().getEventBus().unsubscribe("launchpad","sessionTimeout",this.destroy,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this._readUnseenNotificationsCount=function(t){var n=this,o=new i.Deferred,r=this._getRequestURI(R.GET_BADGE_NUMBER),a={requestUri:r,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}};e.read(a,function(e,t){d.setProperty("/UnseenCount",t.data.GetBadgeNumber.Number);n._setNativeIconBadge(t.data.GetBadgeNumber.Number);o.resolve(t.data.GetBadgeNumber.Number)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){var t=JSON.parse(e.response.body);d.setProperty("/UnseenCount",t.value);n._setNativeIconBadge(t.value);o.resolve(t.value)}else{s.error("Notification service - oData read unseen notifications count failed: ",e.message,"sap.ushell.services.Notifications");o.reject(e)}});return o.promise()};this.readNotificationsCount=function(){var t=new i.Deferred,n=this._getRequestURI(R.GET_NOTIFICATIONS_COUNT),o={requestUri:n,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}};e.read(o,function(e,i){t.resolve(i.data)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){var i=JSON.parse(e.response.body);t.resolve(i.value)}else{s.error("Notification service - oData read notifications count failed: ",e.message,"sap.ushell.services.Notifications");t.reject(e)}});return t.promise()};this._getNotificationSettingsAvalability=function(){return L.promise()};this._setNotificationsAsSeen=function(){var t=this,n=new i.Deferred,o=this._getRequestURI(R.RESET_BADGE_NUMBER),r={requestUri:o,method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:A,"X-CSRF-Token":E}};if(this._isFioriClientMode()===true||this._isPackagedMode()===true){this._setNativeIconBadge(0)}e.request(r,function(){n.resolve()},function(e){if(t._csrfTokenInvalid(e)&&$===false){t._invalidCsrfTokenRecovery(n,t._setNotificationsAsSeen)}else{s.error("Notification service - oData reset badge number failed: ",e,"sap.ushell.services.Notifications");n.reject(e)}});return n.promise()};this._readNotificationsData=function(e){var t=this,s,n,o,r=new i.Deferred,a=[];s=this._readUnseenNotificationsCount(e);a.push(s);o=this.readNotificationsCount();o.done(function(e){d.setProperty("/NotificationsCount",e)});n=this.getNotificationsBufferBySortingType(R.NOTIFICATIONS_BY_DATE_DESCENDING,0,x);a.push(n);i.when.apply(i,a).then(function(){a[0].done(function(){if(e===true){t._updateNotificationsCountConsumers()}});a[1].done(function(i){d.setProperty("/Notifications",i);t._notificationAlert(i);if(e===true){t._updateNotificationsConsumers();t._updateDependentNotificationsConsumers()}r.resolve()})});return r.promise()};this._getHeaderXcsrfToken=function(){return E};this._getDataServiceVersion=function(){return A};this._getRequestURI=function(e,t){var i,s=encodeURI(this._getConsumedIntents(e));switch(e){case R.NOTIFICATIONS:if(p.getNotifications.basic===undefined){p.getNotifications.basic=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false"}if(this._isIntentBasedConsumption()){if(p.getNotifications.byIntents===undefined){p.getNotifications.byIntents=p.getNotifications.basic.concat("&intents%20eq%20"+s)}return p.getNotifications.byIntents}return p.getNotifications.basic;case R.NOTIFICATIONS_BY_TYPE:if(p.getNotificationsByType.basic===undefined){p.getNotificationsByType.basic=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams"}if(this._isIntentBasedConsumption()){if(p.getNotificationsByType.byIntents===undefined){p.getNotificationsByType.byIntents=p.getNotificationsByType.basic.concat("&$filter=intents%20eq%20"+s)}return p.getNotificationsByType.byIntents}return p.getNotificationsByType.basic;case R.NOTIFICATIONS_GROUP_HEADERS:if(p.getNotificationsGroupHeaders.basic===undefined){p.getNotificationsGroupHeaders.basic=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20true"}if(this._isIntentBasedConsumption()){if(p.getNotificationsGroupHeaders.byIntents===undefined){p.getNotificationsGroupHeaders.byIntents=p.getNotificationsGroupHeaders.basic.concat("&intents%20eq%20"+s)}return p.getNotificationsGroupHeaders.byIntents}return p.getNotificationsGroupHeaders.basic;case R.NOTIFICATIONS_IN_GROUP:i=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt desc&$filter=IsGroupHeader eq false and ParentId eq "+t.group+"&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;case R.GET_BADGE_NUMBER:if(p.getBadgeNumber.basic===undefined){p.getBadgeNumber.basic=g.serviceUrl+"/GetBadgeNumber()"}if(this._isIntentBasedConsumption()){if(p.getBadgeNumber.byIntents===undefined){p.getBadgeNumber.byIntents=g.serviceUrl+"/GetBadgeCountByIntent("+s+")"}return p.getBadgeNumber.byIntents}return p.getBadgeNumber.basic;case R.GET_NOTIFICATIONS_COUNT:if(p.getNotificationCount.basic===undefined){p.getNotificationCount.basic=g.serviceUrl+"/Notifications/$count"}return p.getNotificationCount.basic;case R.RESET_BADGE_NUMBER:if(p.resetBadgeNumber.basic===undefined){p.resetBadgeNumber.basic=g.serviceUrl+"/ResetBadgeNumber"}return p.resetBadgeNumber.basic;case R.GET_SETTINGS:if(p.getNotificationTypesSettings.basic===undefined){p.getNotificationTypesSettings.basic=g.serviceUrl+"/NotificationTypePersonalizationSet"}return p.getNotificationTypesSettings.basic;case R.GET_MOBILE_SUPPORT_SETTINGS:if(p.getMobileSupportSettings.basic===undefined){p.getMobileSupportSettings.basic=g.serviceUrl+"/Channels(ChannelId='SAP_SMP')"}return p.getMobileSupportSettings.basic;case R.GET_EMAIL_SUPPORT_SETTINGS:if(p.getEmailSupportSettings.basic===undefined){p.getEmailSupportSettings.basic=g.serviceUrl+"/Channels(ChannelId='SAP_EMAIL')"}return p.getEmailSupportSettings.basic;case R.VALIDATE_WEBSOCKET_CHANNEL:if(p.getWebSocketValidity.basic===undefined){p.getWebSocketValidity.basic=g.serviceUrl+"/Channels('SAP_WEBSOCKET')"}return p.getWebSocketValidity.basic;case R.NOTIFICATIONS_BY_DATE_DESCENDING:i=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;case R.NOTIFICATIONS_BY_DATE_ASCENDING:i=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20asc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;case R.NOTIFICATIONS_BY_PRIORITY_DESCENDING:i=g.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=Priority%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;default:i=""}return i};this._readSettingsFromServer=function(){var t=this._getRequestURI(R.GET_SETTINGS),n={requestUri:t,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}},o=new i.Deferred;e.request(n,function(e){o.resolve(e.results)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){o.resolve(e.response.body)}else{o.reject(e);s.error("Notification service - oData get settings failed: ",e,"sap.ushell.services.Notifications")}});return o.promise()};this._readMobileSettingsFromServer=function(){return this._readChannelSettingsFromServer(R.GET_MOBILE_SUPPORT_SETTINGS)};this._readEmailSettingsFromServer=function(){return this._readChannelSettingsFromServer(R.GET_EMAIL_SUPPORT_SETTINGS)};this._readChannelSettingsFromServer=function(t){var n=this._getRequestURI(t),o={requestUri:n,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}},r=new i.Deferred,a,c;e.request(o,function(e){if(typeof e.results==="string"){a=JSON.parse(e.results);a.successStatus=true;c=JSON.stringify(a);r.resolve(c)}else{e.results.successStatus=true;r.resolve(e.results)}},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){a=JSON.parse(e.response.body);a.successStatus=true;c=JSON.stringify(a);r.resolve(c)}else{r.resolve(JSON.stringify({successStatus:false}));s.error("Notification service - oData get settings failed: ",e,"sap.ushell.services.Notifications")}});return r.promise()};this._checkWebSocketActivity=function(){var t=this._getRequestURI(R.VALIDATE_WEBSOCKET_CHANNEL),n={requestUri:t,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}},o=new i.Deferred,r;e.request(n,function(e){if(typeof e.results==="string"){r=JSON.parse(e.results);o.resolve(r.IsActive)}else{o.resolve(false)}},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){r=JSON.parse(e.response.body);o.resolve(r.IsActive)}else{o.resolve(false);s.error("Notification service - oData get settings failed: ",e,"sap.ushell.services.Notifications")}});return o.promise()};this._writeSettingsEntryToServer=function(t){var n=this,o,r=this._getRequestURI(R.GET_SETTINGS)+"(NotificationTypeId="+t.NotificationTypeId+")",a={requestUri:r,method:"PUT",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:A,"X-CSRF-Token":E}};a.data=JSON.parse(JSON.stringify(t));a.data["@odata.context"]="$metadata#NotificationTypePersonalizationSet/$entity";o=new i.Deferred;e.request(a,function(e){o.resolve(e)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){o.resolve(e.response.body)}else if(n._csrfTokenInvalid(e)&&$===false){n._invalidCsrfTokenRecovery(o,n._writeSettingsEntryToServer,[t])}else{o.reject(e);s.error("Notification service - oData set settings entry failed: ",e,"sap.ushell.services.Notifications")}});return o.promise()};this._updateNotificationsConsumers=function(){S.forEach(function(e){e()})};this._updateDependentNotificationsConsumers=function(){var e=this,t=new i.Deferred;T.forEach(function(i){if(e.bUpdateDependencyInitiatorExists===false){i.callback()}else if(i.dependent===true){i.callback(t.promise())}else{i.callback(t)}})};this._updateNotificationsCountConsumers=function(){C.forEach(function(e){e()})};this._updateAllConsumers=function(){this._updateNotificationsConsumers();this._updateNotificationsCountConsumers();this._updateDependentNotificationsConsumers()};this._getModel=function(){return d};this._getMode=function(){return U};this._setWorkingMode=function(){var e;if(g.intentBasedConsumption===true){m=this._getIntentsFromConfiguration(g.consumedIntents);if(m.length>0){I=true}}if(this._isPackagedMode()){U=k.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){m=e}if(m.length>0){I=true}this._registerForPush();this._readNotificationsData(true);this._setNativeIconBadgeWithDelay();return}this._performFirstRead()};this._performFirstRead=function(){var e=this,t,i=this._readNotificationsData(true);i.done(function(){t=e._getFioriClientRemainingDelay();if(t<=0){e._fioriClientStep()}else{N=setTimeout(function(){e._fioriClientStep()},t)}F=true}).fail(function(e){s.error("Notifications oData read failed. Error: "+e);return})};this._fioriClientStep=function(){var e=this,t;if(this._isFioriClientMode()){U=k.FIORI_CLIENT;this._addPushNotificationHandler();t=this.getUnseenNotificationsCount();t.done(function(t){e._setNativeIconBadge(t,function(){})}).fail(function(){})}else{this._webSocketStep()}};this._webSocketStep=function(){U=k.WEB_SOCKET;this._establishWebSocketConnection()};this._webSocketRecoveryStep=function(){if(B===false){B=true;v=setTimeout(function(){this._webSocketStep()}.bind(this),P)}else{this._activatePollingAfterInterval()}};this._activatePollingAfterInterval=function(){var e=g.pollingIntervalInSeconds||a;clearTimeout(_);_=setTimeout(this._activatePolling.bind(this),o.sanitizeTimeoutDelay(e*1e3))};this._activatePolling=function(){var e=g.pollingIntervalInSeconds||a;U=k.POLLING;this._readNotificationsData(true);clearTimeout(_);_=setTimeout(this._activatePolling.bind(this,e,false),o.sanitizeTimeoutDelay(e*1e3))};this._formatAsDate=function(e){return new Date(e)};this._notificationAlert=function(e){if(G===false){return}var t,i=[],s=0;for(t in e){if(this.lastNotificationDate&&this._formatAsDate(e[t].CreatedAt)>this.lastNotificationDate){if(e[t].Priority==="HIGH"){i.push(e[t])}}if(s<this._formatAsDate(e[t].CreatedAt)){s=this._formatAsDate(e[t].CreatedAt)}}if(this.lastNotificationDate&&i&&i.length>0){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Notifications","onNewNotifications",i)}this.lastNotificationDate=s};this._getFioriClientRemainingDelay=function(){return O-(new Date-l)};this._establishWebSocketConnection=function(){var e=this,i=false,n;try{h=this._getWebSocketObjectObject(g.webSocketUrl||r,[t.SUPPORTED_PROTOCOLS.v10]);h.attachMessage(this,function(t){n=t.getParameter("pcpFields");if(n&&n.Command&&n.Command==="Notification"){e._readNotificationsData(true)}});h.attachOpen(this,function(){e._checkWebSocketActivity().done(function(t){if(!t){i=true;h.close();e._activatePollingAfterInterval()}});s.info("Notifications UShell service WebSocket: webSocket connection opened")});h.attachClose(this,function(t){s.warning("Notifications UShell service WebSocket: attachClose called with code: "+t.mParameters.code+" and reason: "+t.mParameters.reason);if(!y&&!i){e._webSocketRecoveryStep()}});h.attachError(this,function(){s.warning("Notifications UShell service WebSocket: attachError called!")})}catch(e){s.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message: "+e.message)}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined)};this._isPackagedMode=function(){return window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true};this._setNativeIconBadge=function(e){if(sap.Push!==undefined&&sap.Push.setBadgeNumber!==undefined){sap.Push.setBadgeNumber(e,function(){})}};this._setNativeIconBadgeWithDelay=function(){var e=this,t;setTimeout(function(){t=e.getUnseenNotificationsCount();t.done(function(t){e._setNativeIconBadge(t)}).fail(function(){})},4e3)};this._getIntentsFromConfiguration=function(e){var t=[],i,s;if(e&&e.length>0){for(s=0;s<e.length;s++){i=e[s].intent;t.push(i)}}return t};this._handlePushedNotification=function(e){var t,i,s,n,r=[],a;if(e!==undefined){if(e.additionalData===undefined||e.additionalData.foreground===true){this._readNotificationsData(true)}else{if(e.additionalData&&e.additionalData.NavigationTargetObject){i=e.additionalData.NavigationTargetObject}else{i=e.NavigationTargetObject}if(e.additionalData&&e.additionalData.NavigationTargetAction){s=e.additionalData.NavigationTargetAction}else{s=e.NavigationTargetAction}if(e.additionalData&&e.additionalData.NavigationTargetParam){n=e.additionalData.NavigationTargetParam}else{n=e.NavigationTargetParam}if(n){if(typeof n==="string"||n instanceof String){r[0]=n}else if(Array.isArray(n)===true){r=n}}t=e.NotificationId;if(i&&s){if(typeof hasher!=="undefined"&&hasher.getHash()===i+"-"+s){a=sap.ui.getCore().byId("viewPortContainer");if(a){a.switchState("Center")}}o.toExternalWithParameters(i,s,r)}this.markRead(t);this._readNotificationsData(true)}}};this._registerForPush=function(){sap.Push.initPush(this._handlePushedNotification.bind(this))};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false)};this._isIntentBasedConsumption=function(){return I};this._getConsumedIntents=function(e){var t="",i;if(!this._isIntentBasedConsumption()){return t}if(m.length>0){if(e!==R.GET_BADGE_NUMBER){t="&"}for(i=0;i<m.length;i++){if(e===R.GET_BADGE_NUMBER){if(i===0){t=m[i]}else{t=t+","+m[i]}}else{t=t+"NavigationIntent%20eq%20%27"+m[i]+"%27"}}}return t};this._revalidateCsrfToken=function(){var e;E=undefined;z=false;e=this.getNotificationsBufferBySortingType(R.NOTIFICATIONS_BY_DATE_DESCENDING,0,1);return e.promise()};this._csrfTokenInvalid=function(e){var t=e.response;var i=t&&t.statusCode===403;var s=t?t.headers["x-csrf-token"]:"";var n=s.toLowerCase()==="required";return i&&n};this._invalidCsrfTokenRecovery=function(e,t,i){var n=this,o=this._revalidateCsrfToken(),r;$=true;o.done(function(){r=t.apply(n,i);r.done(function(t){$=false;e.resolve(t)});r.fail(function(t){$=false;if(t.response&&t.response.statusCode===200&&t.response.body){e.resolve(t.response.body)}else{e.reject(t)}})});o.fail(function(t){$=false;e.reject(t);s.error("Notification service - oData markRead failed: ",t.message,"sap.ushell.services.Notifications")})};this._notificationsAscendingSortBy=function(e,t){e.sort(function(e,i){var s=e[t],n=i[t];if(s===n){s=e.id;n=i.id}return n>s?-1:1});return e};this._getWebSocketObjectObject=function(e,i){return new t(e,i)};this.getOperationEnum=function(){return R};this._readUserSettingsFlagsFromPersonalization=function(){this._getUserSettingsPersonalizer().then(function(e){e.getPersData().done(function(e){if(e===undefined){this._writeUserSettingsFlagsToPersonalization({highPriorityBannerEnabled:G})}else{G=e.highPriorityBannerEnabled}q=true;w.resolve()}.bind(this)).fail(function(){s.error("Reading User Settings flags from Personalization service failed")})}.bind(this)).catch(function(e){s.error("Personalization service does not work:");s.error(e.name+": "+e.message);s.error("Reading User Settings flags from Personalization service failed")})};this._writeUserSettingsFlagsToPersonalization=function(e){var t=new i.Deferred;this._getUserSettingsPersonalizer().then(function(i){i.setPersData(e).done(t.resolve).fail(t.reject)}).catch(function(e){s.error("Personalization service does not work:");s.error(e.name+": "+e.message);t.reject(e)});return t.promise()};this._getUserSettingsPersonalizer=function(){if(!this.oUserSettingsPersonalizerPromise){this.oUserSettingsPersonalizerPromise=sap.ushell.Container.getServiceAsync("Personalization").then(function(e){var t={keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.LOW,clientStorageAllowed:true};var i={container:"sap.ushell.services.Notifications",item:"userSettingsData"};return e.getPersonalizer(i,t)})}return this.oUserSettingsPersonalizerPromise};this._updateCSRF=function(e){if(z===true||e.headers===undefined){return}if(!this._getHeaderXcsrfToken()){E=e.headers["x-csrf-token"]||e.headers["X-CSRF-Token"]||e.headers["X-Csrf-Token"]}if(!this._getDataServiceVersion()){A=e.headers.DataServiceVersion||e.headers["odata-version"]}z=true};this._userSettingInitialization=function(){var e,t,s,n={settingsAvailable:false,mobileAvailable:false,emailAvailable:false},o,r,a,c;this._readUserSettingsFlagsFromPersonalization();e=this._readSettingsFromServer();t=this._readMobileSettingsFromServer();s=this._readEmailSettingsFromServer();o=[e,t,s];e.done(function(){n.settingsAvailable=true});t.done(function(e){r=JSON.parse(e);a=r.successStatus;if(a){M=e?r.IsActive:false;n.mobileAvailable=M}else{M=false;n.mobileAvailable=false}});s.done(function(e){r=JSON.parse(e);c=r.successStatus;if(c){H=e?r.IsActive:false;n.emailAvailable=H}else{H=false;n.emailAvailable=false}});i.when.apply(i,o).then(function(){L.resolve(n)})};this._closeConnection=function(){if(!y){if(U===k.WEB_SOCKET&&h){h.close();y=true}if(U===k.POLLING&&_){clearTimeout(_);y=true}}};this._resumeConnection=function(){if(y){y=false;this._webSocketStep()}}}c.hasNoAdapter=true;return c},true);