// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/EventProvider","sap/base/Log","sap/ushell/utils","sap/ui/thirdparty/jquery","sap/base/util/deepEqual","sap/base/util/isEmptyObject"],function(e,t,a,n,r,i){"use strict";var s="valueStored";var o=["value","noEdit","noStore","extendedValue","alwaysAskPlugin"];function u(u,l,f,d){this._aPlugins=[];this._oUserDefaultParametersNames={};this._oWasParameterPersisted={};var c=this;var h=new e;function m(e){var t=typeof e.getComponentData==="function"&&e.getComponentData()&&e.getComponentData().config&&e.getComponentData().config["sap-priority"]||0;if(typeof t!=="number"||isNaN(t)){return 0}return t}this._insertPluginOrdered=function(e,t){var a=m(t),n,r;for(n=0;n<e.length&&t;++n){r=m(e[n]);if(t&&a>r){e.splice(n,0,t);t=undefined}}if(t){e.push(t)}return e};this.registerPlugin=function(e){this._aPlugins=this._insertPluginOrdered(this._aPlugins,e)};this._getUserDefaultValueFromPlugin=function(e,a,n,r){var i;if(typeof e.getUserDefault==="function"){i=new Promise(function(i,s){e.getUserDefault(a,r,n).done(function(s){var o=s||r;var u=this._getComponentNameOfPlugin(e);t.debug('[UserDefaults] Fetched "'+a+'" for SystemContext='+n.id+" from Plugin="+u,JSON.stringify(o,null,2));i(o)}.bind(this)).fail(function(){t.error('invocation of getUserDefault("'+a+'") for plugin '+c._getComponentNameOfPlugin(e)+" rejected.",null,"sap.ushell.services.UserDefaultParameters");i(r)})}.bind(this))}else{i=Promise.resolve(r)}return i};this._iterateOverPluginsToGetDefaultValue=function(e,a,n,r){return new Promise(function(i,s){r.loadPlugins("UserDefaults").done(function(){var t=this._aPlugins.reduce(function(t,a){var r=t.then(this._getUserDefaultValueFromPlugin.bind(this,a,e,n));return r}.bind(this),Promise.resolve(a));t.then(i)}.bind(this)).fail(function(){t.error("Cannot get value for "+e+". One or more plugins could not be loaded.");s("Initialization of plugins failed")})}.bind(this))};this._getStoreDate=function(){return(new Date).toString()};this._storeValue=function(e,t,a,n){if(a&&t.extendedValue){return sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(r){return new Promise(function(i){r.getUserDefaultParameterNames(n).done(function(r){var s=this._extractKeyArrays(r);var o=s.extended.indexOf(e)<0;this._saveParameterValue(e,t,a,o,n).then(i)}.bind(this)).fail(function(){this._saveParameterValue(e,t,a,false,n).then(i)}.bind(this))}.bind(this))}.bind(this))}return this._saveParameterValue(e,t,a,false,n)};this._saveParameterValue=function(e,t,r,i,o){if(i){t.extendedValue=undefined}if(r&&this._valueIsEmpty(t)){t=undefined;this._oWasParameterPersisted[e]=false}else{t._shellData=n.extend(true,{storeDate:this._getStoreDate()},t._shellData)}return sap.ushell.Container.getServiceAsync("UserDefaultParameterPersistence").then(function(n){return new Promise(function(r){n.saveParameterValue(e,t,o).always(function(){var n={parameterName:e,parameterValue:a.clone(t||{}),systemContext:o};h.fireEvent(s,n);r(e)})})})};this._getPersistedValue=function(e,t){return new Promise(function(a,n){sap.ushell.Container.getServiceAsync("UserDefaultParameterPersistence").then(function(r){r.loadParameterValue(e,t).done(a).fail(n)})})};this._valueIsEmpty=function(e){return!e||!e.value&&!e.extendedValue};this._haveSameMembersValue=function(e,t,a){return a.every(function(a){return e[a]===t[a]||r(e[a],t[a])})};this._getUserDefaultParameterNames=function(e){if(!this._oUserDefaultParametersNames[e.id]){this._oUserDefaultParametersNames[e.id]=new Promise(function(t){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(a){a.getUserDefaultParameterNames(e).done(function(e){var a=this._extractKeyArrays(e);var n=a.extended;var r=a.allParameters;var i=this._arrayToObject(r);t({aAllParameterNames:r,aExtendedParameterNames:n,oMetadataObject:i})}.bind(this))}.bind(this))}.bind(this))}return this._oUserDefaultParametersNames[e.id]};this._isRelevantParameter=function(e,t){return this._getUserDefaultParameterNames(t).then(function(t){if(!t.aAllParameterNames||t.aAllParameterNames.indexOf(e)===-1){throw new Error('The given parameter "'+e+'" is not part of the list of parameters for the given system context.')}})};this.hasRelevantMaintainableParameters=function(e){var t=false;var a=[];return new Promise(function(r){this._getUserDefaultParameterNames(e).then(function(s){if(!i(s)&&s.aAllParameterNames){s.aAllParameterNames.forEach(function(n){var r=this.getValue(n,e);a.push(r);r.done(function(e){if(e&&!e.hasOwnProperty("noEdit")){t=true}})}.bind(this));n.when.apply(undefined,a).done(function(){r(t)}).fail(function(){r()})}else{r()}}.bind(this))}.bind(this))};this.getValue=function(e,t){var r=new n.Deferred;this._isRelevantParameter(e,t).then(function(){return this._getPersistedValue(e,t).then(function(t){this._oWasParameterPersisted[e]=true;return t||{}}.bind(this)).catch(function(){return{value:undefined}})}.bind(this)).then(function(e){var t=a.clone(e);var n=!e._shellData&&this._valueIsEmpty(e)||e.noStore||e.alwaysAskPlugin;if(!n){r.resolve(e);return}return Promise.all([t,e,sap.ushell.Container.getServiceAsync("PluginManager")])}.bind(this)).then(function(a){var n=a[0];var i=a[1];var s=a[2];return this._iterateOverPluginsToGetDefaultValue(e,i,t,s).then(function(a){if(!this._oWasParameterPersisted[e]||!this._haveSameMembersValue(n,a,o)){this._oWasParameterPersisted[e]=true;this._storeValue(e,a,false,t).then(function(){r.resolve(a)})}else{r.resolve(a)}}.bind(this)).catch(r.reject)}.bind(this)).catch(function(){r.resolve({value:undefined})});return r.promise()};this._addParameterValuesToParameters=function(e,t,a){var r=new n.Deferred;var i=[];t.forEach(function(t){var n=this.getValue(t,a);i.push(n);n.done(function(a){e[t].valueObject=a})}.bind(this));n.when.apply(n,i).done(r.resolve.bind(r,e)).fail(r.reject.bind(r,e));return r.promise()};this._arrayToObject=function(e){var t={};e.forEach(function(e){t[e]={}});return t};this._getComponentNameOfPlugin=function(e){try{return e.getMetadata().getComponentName()||""}catch(e){return"'name of plugin could not be determined'"}};this._getEditorDataAndValue=function(e,a,r,i,s){var o=this;var u=[];var l=[];this._aPlugins.forEach(function(e){if(typeof e.getEditorMetadata==="function"){var a=new n.Deferred;u.push(a);try{var r=u.length-1;e.getEditorMetadata(i,s).done(function(e){l[r]=e}).always(a.resolve).fail(function(){t.error("EditorMetadata for plugin "+o._getComponentNameOfPlugin(e)+"cannot be invoked.",null,"sap.ushell.services.UserDefaultParameters");a.resolve()})}catch(e){t.error("Error invoking getEditorMetaData on plugin: "+e+e.stack,null,"sap.ushell.services.UserDefaultParameters");a.resolve()}}});n.when.apply(n,u).done(function(){var u=[];var f=l.reverse().reduce(function(e,t){a.forEach(function(a){if(t[a]&&t[a].editorMetadata){e[a].editorMetadata=t[a].editorMetadata}});return e},i);a.forEach(function(e){if(!(f[e]&&f[e].editorMetadata)){u.push(e)}});o._addParameterValuesToParameters(f,a,s).done(function(a){var i=n.extend(true,{},a),s;r.forEach(function(e){if(i[e]){i[e].editorMetadata=i[e].editorMetadata||{};i[e].editorMetadata.extendedUsage=true}});s=Object.keys(i).splice(0);s.forEach(function(e){var t;if(i[e].valueObject&&i[e].valueObject.noEdit===true){delete i[e];t=u.indexOf(e);if(t>=0){u.splice(t,1)}}});if(u.length>0){t.error('The following parameter names have no editor metadata and thus likely no configured plugin:\n"'+u.join('",\n"')+'".')}e.resolve(i)}).fail(e.reject.bind(e))})};this.editorGetParameters=function(e){var a=new n.Deferred;Promise.all([sap.ushell.Container.getServiceAsync("PluginManager"),this._getUserDefaultParameterNames(e)]).then(function(n){var r=n[0];var i=n[1];if(i.oMetadataObject.length===0){a.resolve({})}else{r.loadPlugins("UserDefaults").done(function(){this._getEditorDataAndValue(a,i.aAllParameterNames,i.aExtendedParameterNames,i.oMetadataObject,e)}.bind(this)).fail(function(){t.error("One or more plugins could not be loaded");a.reject("Initialization of plugins failed")})}}.bind(this));return a.promise()};this._extractKeyArrays=function(e){var t={simple:e&&e.simple&&Object.keys(e.simple).sort()||[],extended:e&&e.extended&&Object.keys(e.extended).sort()||[]};var a=t.extended.filter(function(e){return t.simple.indexOf(e)<0});t.allParameters=t.simple.concat(a).sort();return t};this.editorSetValue=function(e,t,a){var r=new n.Deferred;this._storeValue(e,t,true,a).then(r.resolve);return r.promise()};this.attachValueStored=function(e){h.attachEvent(s,e)};this.detachValueStored=function(e){h.detachEvent(s,e)}}u.hasNoAdapter=true;return u},true);