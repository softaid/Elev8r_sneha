// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/assert","sap/base/Log","sap/base/util/ObjectPath","sap/base/util/uid","sap/ui/base/EventProvider","sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ui/util/Mobile","sap/ushell/EventHub","sap/ushell/System","sap/ushell/Ui5NativeServiceFactory","sap/ushell/Ui5ServiceFactory","sap/ushell/utils","sap/ushell/utils/UrlParsing"],function(e,t,r,n,i,o,a,s,u,l,c,f,d,g,h,p,v,m){"use strict";var y="sap.ushell.services.Container",S="sap.ushell.Container.dirtyState.",w={},C,D,P,b=[];function E(){close()}function L(){document.location="about:blank"}function A(e){if(D&&D[e]){return D[e]}return"sap.ushell.adapters."+e}function I(e){return C.services&&C.services[e]||{}}function R(e,t,r,n,i){var o=I(e).adapter||{},a;function s(e){var n=sap.ui.requireSync(e);return new n(t,r,{config:o.config||{}})}function u(e){return new Promise(function(n,i){sap.ui.require([e],function(e){var i=new e(t,r,{config:o.config||{}});n(i)},i)})}if(i===true){a=o.module;if(a===undefined){return n?Promise.resolve():undefined}}else{a=o.module||A(t.getPlatform())+"."+e+"Adapter"}var l=a.replace(/\./g,"/");if(n){return u(l)}return s(l)}function F(r){var s=new i,f=false,h=[],p={},D="sap.ushell.Container."+r.getSystem().getPlatform()+".remoteSystem.",P={},A,F,U=v.getLocalStorage(),N=new v.Map,M=new v.Map,T="sap.ushell.Container."+r.getSystem().getPlatform()+".sessionTermination",_=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelLogon()}};this.createRenderer=function(e,r){if(typeof e==="boolean"){r=e;e=undefined}var n={async:!!r};var i;var a;u.start("FLP:Container.InitLoading","Initial Loading","FLP");v.setPerformanceMark("FLP - renderer created");e=e||C.defaultRenderer;if(!e){throw new Error("Missing renderer name")}a=C.renderers&&C.renderers[e]||{};i=a.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);if(a.componentData&&a.componentData.config){n.config=a.componentData.config}function l(t){var r=sap.ui.requireSync(t);var i=new r({componentData:n});var a;var u=sap.ui.require("sap/ui/core/UIComponent");if(i instanceof u){var l=sap.ui.requireSync("sap/ui/core/ComponentContainer");a=new l({component:i,height:"100%",width:"100%"})}else{a=i}if(!(a instanceof o)){throw new Error("Unsupported renderer type for name "+e)}f(a);p[e]=i;s.fireEvent("rendererCreated",{renderer:i});return a}function c(t){return new Promise(function(r,i){sap.ui.require([t,"sap/ui/core/ComponentContainer","sap/ui/core/UIComponent","sap/ui/core/routing/Router"],function(t,a,u){var l=new t({componentData:n});if(l instanceof u){var c=new a({component:l,height:"100%",width:"100%",async:true});f(c);p[e]=l;l.rootControlLoaded().then(function(){s.fireEvent("rendererCreated",{renderer:l});r(c)})}else if(l instanceof o){f(l);p[e]=l;s.fireEvent("rendererCreated",{renderer:l});r(l)}else{i(new Error("Unsupported renderer type!"))}})})}function f(e){e.placeAt=function(e,t){var r=e,n="canvas",i=document.body;if(e===i.id){r=document.createElement("div");r.setAttribute("id",n);r.classList.add("sapUShellFullHeight");switch(t){case"first":if(i.firstChild){i.insertBefore(r,i.firstChild);break}case"only":i.innerHTML="";default:i.appendChild(r)}e=n;t=""}o.prototype.placeAt.call(this,e,t)}}var d=i.replace(/\./g,"/");if(r){return c(d)}t.error("sap.ushell.Container.createRenderer() should always be called with bAsync:true.");return l(d)};this.getRenderer=function(e){var r,n;e=e||C.defaultRenderer;if(e){r=p[e]}else{n=Object.keys(p);if(n.length===1){r=p[n[0]]}else{t.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",null,y)}}if(r&&r.isA("sap.ui.core.ComponentContainer")){return r.getComponentInstance()}return r};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var e,r=new l.Deferred,i=n(),o,a=0,s=this.DirtyState.CLEAN;function u(){if(a===0||s===_.DirtyState.DIRTY){r.resolve(s);t.debug("getGlobalDirty() Resolving: "+s,null,"sap.ushell.Container")}}function c(e){if(e.key.indexOf(S)===0&&e.newValue!==_.DirtyState.INITIAL&&e.newValue!==_.DirtyState.PENDING){t.debug("getGlobalDirty() Receiving event key: "+e.key+" value: "+e.newValue,null,"sap.ushell.Container");if(e.newValue===_.DirtyState.DIRTY||e.newValue===_.DirtyState.MAYBE_DIRTY){s=e.newValue}a-=1;u()}}try{U.setItem(i,"CHECK");U.removeItem(i)}catch(e){t.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return r.resolve(this.DirtyState.MAYBE_DIRTY).promise()}if(A){throw new Error("getGlobalDirty already called!")}A=r;window.addEventListener("storage",c);r.always(function(){window.removeEventListener("storage",c);A=undefined});for(e=U.length-1;e>=0;e-=1){o=U.key(e);if(o.indexOf(S)===0){if(U.getItem(o)==="PENDING"){U.removeItem(o);t.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+o,null,"sap.ushell.Container")}else{a+=1;v.localStorageSetItem(o,this.DirtyState.PENDING,true);t.debug("getGlobalDirty() Requesting status for: "+o,null,"sap.ushell.Container")}}}u();setTimeout(function(){if(r.state()!=="resolved"){r.resolve("MAYBE_DIRTY");t.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container")}},a*2e3);return r.promise()};this.getLogonSystem=function(){return r.getSystem()};this.getUser=function(){return r.getUser()};this.getDirtyFlag=function(){var e=f;var t=this._oShellNavigationService.getNavigationContext();for(var r=0;r<h.length;r++){e=e||h[r](t)}return e};this.fnAsyncDirtyStateProvider=null;this.getDirtyFlagsAsync=function(){if(!this.fnAsyncDirtyStateProvider){return Promise.resolve(this.getDirtyFlag())}var e=this._oShellNavigationService.getNavigationContext();return this.fnAsyncDirtyStateProvider(e).then(function(e){return e||this.getDirtyFlag()}.bind(this))};this.isAsyncDirtyStateProviderSet=function(){return typeof this.fnAsyncDirtyStateProvider==="function"};this.setAsyncDirtyStateProvider=function(e){this.fnAsyncDirtyStateProvider=e};this.setDirtyFlag=function(e){f=e};this.sessionKeepAlive=function(){if(r.sessionKeepAlive){r.sessionKeepAlive()}};this.extendSession=function(){d.emit("nwbcUserIsActive",Date.now())};this.registerDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function")}h.push(e)};this.deregisterDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function")}var t=-1;for(var r=h.length-1;r>=0;r--){if(h[r]===e){t=r;break}}if(t===-1){return}h.splice(t,1)};this.getService=function(e,t,r){return _._getService.apply(_,arguments)};this.getServiceAsync=function(e,t){return _._getService(e,t,true)};this._getService=function(e,n,i){var o={},a,s,u,c,f,d;function g(t){var r=new l.Deferred;if(!t){throw new Error("Missing system")}r.resolve(R(e,t,n));sap.ushell.Container.addRemoteSystem(t);return r.promise()}if(!e){throw new Error("Missing service name")}if(e.indexOf(".")>=0){throw new Error("Unsupported service name")}f=I(e);a=f.module||"sap.ushell.services."+e;s=a+"/"+(n||"");d={config:f.config||{}};function h(e,t){o.createAdapter=g;return new e(t,o,n,d)}function p(t,i){var a;if(N.containsKey(s)){a=N.get(s)}else if(t.hasNoAdapter){a=new t(o,n,d)}else{c=R(e,r.getSystem(),n,i,t.useConfiguredAdapterOnly);if(i){return c.then(function(e){var r=h(t,e);N.put(s,r);return r})}a=h(t,c)}N.put(s,a);return i?Promise.resolve(a):a}if(!N.containsKey(s)){if(i){if(!M.containsKey(s)){var v=new Promise(function(e,t){sap.ui.require([a.replace(/[.]/g,"/")],function(t){e(p(t,true))},t)});M.put(s,v);return v}return M.get(s)}t.error("Deprecated API call of 'sap.ushell.Container.getService'. Please use 'getServiceAsync' instead",null,"sap.ushell.services.Container");u=sap.ui.requireSync(a.replace(/[.]/g,"/"));return p(u)}if(i){return Promise.resolve(N.get(s))}return N.get(s)};function k(){var e,t,r,n;for(r=U.length-1;r>=0;r-=1){n=U.key(r);if(n.indexOf(D)===0){try{e=n.substring(D.length);t=JSON.parse(U.getItem(n));P[e]=new g(t)}catch(e){U.removeItem(n)}}}return P}function O(){if(typeof OData==="undefined"){return}function e(e,r,n){t.warning(e,null,"sap.ushell.Container");if(n){setTimeout(n.bind(null,e),5e3)}return{abort:function(){return}}}OData.read=function(t,r,n){return e("OData.read('"+(t&&t.Uri?t.requestUri:t)+"') disabled during logout processing",r,n)};OData.request=function(t,r,n){return e("OData.request('"+(t?t.requestUri:"")+"') disabled during logout processing",r,n)}}this.addRemoteSystem=function(e){var r=e.getAlias(),n=P[r];if(this._isLocalSystem(e)){return}if(n){if(n.toString()===e.toString()){return}t.warning("Replacing "+n+" by "+e,null,"sap.ushell.Container")}else{t.debug("Added "+e,null,"sap.ushell.Container")}P[r]=e;v.localStorageSetItem(D+r,e)};this._isLocalSystem=function(e){var t=e.getAlias();if(t&&t.toUpperCase()==="LOCAL"){return true}var r=new c(v.getLocationHref()),n=this.getLogonSystem().getClient()||"";if(e.getBaseUrl()===r.origin()&&e.getClient()===n){return true}return false};this.addRemoteSystemForServiceUrl=function(e){var t,r={baseUrl:";o="};if(!e||e.charAt(0)!=="/"||e.indexOf("//")===0){return}t=/^[^?]*;o=([^/;?]*)/.exec(e);if(t&&t.length>=2){r.alias=t[1]}e=e.replace(/;[^/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){r.platform="hana";r.alias=r.alias||"hana"}else if(/^\/sap\/opu\//.test(e)){r.platform="abap"}if(r.alias&&r.platform){this.addRemoteSystem(new g(r))}};this.attachLogoutEvent=function(t,r){var n=false;if(r===true){e(typeof t==="function","Container.attachLogoutEvent: fnFunction must be a function");for(var i=0;i<b.length;i++){if(b[i]===t){n=true;break}}if(!n){b.push(t)}}else{s.attachEvent("Logout",t)}};this.detachLogoutEvent=function(e){s.detachEvent("Logout",e);for(var t=0;t<b.length;t++){if(b[t]===e){b.splice(t,1);break}}};this.attachRendererCreatedEvent=function(e){s.attachEvent("rendererCreated",e)};this.detachRendererCreatedEvent=function(e){s.detachEvent("rendererCreated",e)};this.defaultLogout=function(){var e=new l.Deferred;function n(){r.logout(true).always(function(){U.removeItem(T);e.resolve()})}function i(){var e=new l.Deferred,t=e.promise(),r=[];if(b.length>0){for(var i=0;i<b.length;i++){r.push(b[i]())}Promise.all(r).then(e.resolve);setTimeout(e.resolve,4e3)}else{e.resolve()}t.done(function(){if(s.fireEvent("Logout",true)){n()}else{setTimeout(n,1e3)}})}function o(){var e,r=[];if(F){window.removeEventListener("storage",F)}v.localStorageSetItem(T,"pending");_._suppressOData();e=_._getRemoteSystems();Object.keys(e).forEach(function(n){try{r.push(R("Container",e[n]).logout(false))}catch(e){t.warning("Could not create adapter for "+n,e.toString(),"sap.ushell.Container")}U.removeItem(D+n)});l.when.apply(l,r).done(i)}if(typeof r.addFurtherRemoteSystems==="function"){r.addFurtherRemoteSystems().always(o)}else{o()}return e.promise()};this.logout=this.defaultLogout;this.registerLogout=function(e){this.logout=e};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.logonFrameProvider=e}};this.setXhrLogonTimeout=function(e,t){if(this.oFrameLogonManager){this.oFrameLogonManager.setTimeout(e,t)}};this.getFLPConfig=function(){var e=new Promise(function(e,t){var r={URL:this.getFLPUrl()};if(w.CDMPromise){w.CDMPromise.then(function(t){t.getSiteWithoutPersonalization().then(function(t){r.scopeId=t.site.identification.id;e(r)})})}else{e(r)}}.bind(this));return e};this.getFLPUrl=function(e){var t=v.getLocationHref(),r=t.indexOf(m.getShellHash(t));if(r===-1||e===true){return t}return t.substr(0,r-1)};this.getFLPUrlAsync=function(e){return(new l.Deferred).resolve(_.getFLPUrl(e)).promise()};this.inAppRuntime=function(){return false};this.runningInIframe=this.inAppRuntime;this._getAdapter=function(){return r};this.getFLPPlatform=function(e){if(e===true){return C.flpPlatform}return Promise.resolve(C.flpPlatform)};this._closeWindow=E;this._redirectWindow=L;this._getRemoteSystems=k;this._suppressOData=O;a.getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,t,r){_.addRemoteSystemForServiceUrl(r)});if(typeof r.logoutRedirect==="function"){F=function(e){function t(){_._closeWindow();_._redirectWindow()}if(sap.ushell.Container!==_){return}if(e.key.indexOf(D)===0&&e.newValue&&e.newValue!==U.getItem(e.key)){v.localStorageSetItem(e.key,e.newValue)}if(e.key===T){if(e.newValue==="pending"){_._suppressOData();if(s.fireEvent("Logout",true)){t()}else{setTimeout(t,1e3)}}}};window.addEventListener("storage",F)}this._getFunctionsForUnitTest=function(){return{createAdapter:R}}}function U(e,t){e.forEach(function(e){var r=p.createServiceFactory(e,t);s.register("sap.ushell.ui5service."+e,r)})}function N(e){e.forEach(function(e){var t=h.createServiceFactory(e);s.register("sap.ushell.ui5service."+e,t)})}r.create("sap.ushell");sap.ushell.bootstrap=function(e,r){var n,i=new l.Deferred;f.init();if(sap.ushell.Container!==undefined){n=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+P);t.error(n,n.stack,y);throw n}P=(new Error).stack;C=l.extend({},true,window["sap-ushell-config"]||{});D=r;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"])}U(["Personalization","URLParsing","CrossApplicationNavigation"],true);U(["Configuration"],false);N(["CardNavigation","CardUserRecents","CardUserFrequents"]);var o=new g({alias:"",platform:C.platform||e});R("Container",o,null,true).then(function(e){e.load().then(function(){function o(){var e,t;var r=window["sap-ushell-config"];if(!r||!r.services){return false}e=r.services.PluginManager;t=e&&e.config;return t&&t.loadPluginsFromSite}sap.ushell.Container=new F(e);var a=[sap.ushell.Container.getServiceAsync("PluginManager")];if(o()){w.CDMPromise=sap.ushell.Container.getServiceAsync("CommonDataModel");a.push(w.CDMPromise)}Promise.all(a).then(function(e){r(e)}).then(n);var s=[];if(C.preloadServices!==undefined&&Array.isArray(C.preloadServices)){C.preloadServices.forEach(function(e){s.push(sap.ushell.Container.getServiceAsync(e))});t.error("Ushell Config's preloadServices should not be used!")}var u=sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(e){sap.ushell.Container._oShellNavigationService=e});s.push(u);Promise.all(s).then(function(){i.resolve()})});function r(e){var r=e[0];var n=e[1];var i=n?n.getPlugins():l.when({});i.then(function(e){var n=l.extend(true,{},C.bootstrapPlugins,e);r.registerPlugins(n);try{r.loadPlugins("EarlyLoading").catch(function(){t.error("Error loading S/4's my home plugin")})}catch(e){t.error("Error loading S/4's my home plugin")}})}function n(){o();sap.ui.require(["sap/ushell/Config"],function(e){a(e)})}function o(){if(v.hasFLPReady2NotificationCapability()){sap.ui.require(["sap/ushell/NWBCInterface"],function(e){v.getPrivateEpcm().doEventFlpReady2(e)})}else if(v.hasFLPReadyNotificationCapability()){v.getPrivateEpcm().doEventFlpReady()}}function a(e){if(e.last("/core/darkMode/enabled")){sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(e){if(e&&e.setup){e.setup()}})}}});return i.promise()}});