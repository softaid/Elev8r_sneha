// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/ushell/utils","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/base/Log"],function(e,t,n,r,i){"use strict";var o="";var a={apply:"apply",applied:"applied"};function s(e){return(e.protocol()||"").length>0}function f(e,r,i){var o=typeof r==="string";var a=[e];if(o){a.unshift(r)}var s=t.generateLocalStorageKey("sap-system-data",a);var f=t.getLocalStorage();var p=f.getItem(s);var l={};if(p){try{l=JSON.parse(p)}catch(e){return(new n.Deferred).reject("Cannot parse system data from local storage at key '"+s+"'. Data: "+p)}return(new n.Deferred).resolve(l).promise()}else if(o){return(new n.Deferred).reject("Cannot find data for system '"+e+"' in local storage using key '"+s+"'")}if(!i){return(new n.Deferred).reject("fallback: the adapter does not implement resolveSystemAlias").promise()}return i(e)}function p(t,r,a,s,p){var l=a,u=new n.Deferred;f(t,r,p).fail(function(e){u.reject(e)}).done(function(n){var r=m(n);if(!r.isValid){v(r);u.reject("Invalid system alias definition");return u}var f=g(n,new e(window.location.toString()).protocol()),d=n[f],h,y,R;if(t===o&&d.host===""&&(d.port===0||d.port==="")){f=""}l.protocol(f);l.hostname(d.host);l.port(d.port);w(l,s,d.pathPrefix,p).fail(function(e){u.reject(e)}).done(function(e){h=e.query();if(typeof n.client==="string"&&n.client!==""){h=h+(h.length>0?"&":"")+"sap-client="+n.client}if(typeof n.language==="string"&&n.language!==""){y=n.language}else{R=sap.ushell.Container.getUser();if(!R){i.error("Cannot retieve the User object via sap.ushell.Container while determining sap-language","will default to 'en' language","sap.ushell.services.ClientSideTargetResolution");y="en"}else{y=R.getLanguage()}}h=h+(h.length>0?"&":"")+"sap-language="+y;e.query(h);if(n.hasOwnProperty("rfc")&&s==="NATIVEWEBGUI"){var t=c(n.rfc,d.host,e);var r=e.path()+";"+t;e.path(r);a._parts.path=r}u.resolve(e)})});return u.promise()}function l(e,t,r,i,o,s,f){var l=new n.Deferred;if(s!==a.apply&&s!==a.applied){throw new Error("Invalid system alias semantic was provided: '"+s+"'")}if(s===a.applied&&(typeof r==="undefined"||t===r)){return l.resolve(e).promise()}if(s===a.apply&&typeof t==="undefined"&&typeof r==="undefined"){return l.resolve(e).promise()}if(o==="URL"&&s==a.applied){return u(e,t,r,i,f)}new Promise(function(n){if(s===a.apply){n({targetUri:e,alias:r||t,sapSystemSrc:r?i:undefined});return}d(e,t,undefined,o,f).fail(function(e){l.reject(e)}).done(function(e){n({targetUri:e,alias:r})})}).then(function(e){p(e.alias,e.sapSystemSrc,e.targetUri,o,f).fail(function(e){l.reject(e)}).done(function(e){l.resolve(e)})});return l.promise()}function u(t,r,i,a,l){var u=new n.Deferred;if(r===o||typeof r==="undefined"){if(s(t)){return u.resolve(t)}p(i,a,t,"URL",l).fail(function(e){u.reject(e)}).done(function(e){u.resolve(e)});return u.promise()}f(r,a,l).fail(function(e){u.reject(e)}).done(function(n){var r=g(n,new e(window.location.toString()).protocol()),o=n[r],s;if((t.protocol()||"").toLowerCase()===r&&(t.hostname()||"")===o.host&&t.path().indexOf(o.pathPrefix)===0){t.protocol("");t.hostname("");s=t.path().replace(o.pathPrefix,"");t.path(s);y(t,["sap-language","sap-client"]);p(i,a,t,"URL",l).fail(function(e){u.reject(e)}).done(function(e){u.resolve(e)})}else{u.resolve(t)}});return u.promise()}function c(e,t){var n,r,o,a,s;o=!!e.systemId;if(o){a=[e.systemId&&"~sysid="+e.systemId,e.loginGroup&&"~loginGroup="+e.loginGroup,e.sncNameR3&&"~messageServer="+encodeURIComponent(e.sncNameR3),e.sncNameR3&&"~sncNameR3="+encodeURIComponent(e.sncNameR3),e.sncQoPR3&&"~sncQoPR3="+e.sncQoPR3].filter(function(e){return typeof e==="string"&&e!==""})}else{s=e.host||"";r=s.toLowerCase()===t.toLowerCase();n=/^[/][HGMR][/].*/.test(s);if(s.length>0&&!r&&!n){i.error("Invalid connect string provided in 'host' field of system alias","Data for rfc destination provided are: "+JSON.stringify(e,null,3),"sap.ushell.services.ClientSideTargetResolution")}a=[s&&!n&&!r&&"~rfcHostName="+s,n&&"~connectString="+encodeURIComponent(s),e.service&&"~service="+e.service,e.sncNameR3&&"~sncNameR3="+encodeURIComponent(e.sncNameR3),e.sncQoPR3&&"~sncQoPR3="+e.sncQoPR3].filter(function(e){return typeof e==="string"&&e!==""})}return a.join(";").replace(/(%[A-F0-9]{2})/g,function(e){return e.toLowerCase()})}function d(e,t,r,i,o){var a=new n.Deferred;if(typeof t==="undefined"){h(e,t,i,undefined,o).fail(function(e){a.reject(e)}).done(function(e){a.resolve(e)});return a.promise()}f(t,r,o).fail(function(e){a.reject(e)}).done(function(n){h(e,t,i,n,o).fail(function(e){a.reject(e)}).done(function(e){a.resolve(e)})});return a.promise()}function h(t,i,o,a,s){var p,l,u,c,d=new n.Deferred,h=new n.Deferred;t.protocol("");t.hostname("");t.port("");y(t,["sap-client","sap-language"]);if(!r(a)||typeof i!=="string"){return d.resolve(t).promise()}l=g(a,new e(window.location.toString()).protocol());p=a[l];c=typeof p.pathPrefix==="string"&&p.pathPrefix;if(c!==""){h.resolve(c)}else{f("",undefined,s).fail(function(e){d.reject(e)}).done(function(e){var t=e[l];h.resolve(t.pathPrefix)})}h.fail(function(e){d.reject(e)}).done(function(e){if(e&&e.length>0){u=t.path();u=u.replace(e,"");if(u.indexOf("/")!==0){u="/"+u}t.path(u)}if(o==="NATIVEWEBGUI"&&a.hasOwnProperty("rfc")){u=t.path();u=u.split(";").filter(function(e){return e.indexOf("~sysid=")!==0&&e.indexOf("~service=")!==0&&e.indexOf("~loginGroup=")!==0&&e.indexOf("~messageServer=")!==0&&e.indexOf("~sncNameR3=")!==0&&e.indexOf("~sncQoPR3=")!==0}).join(";");t.path(u)}d.resolve(t)});return d.promise()}function g(e,t){if(e.hasOwnProperty("https")){return"https"}if(e.hasOwnProperty("http")){return"http"}i.error("Cannot select which system alias to pick between http/https","make sure they are provided in the given system alias collection","sap.ushell.services.ClientSideTargetResolution");return undefined}function v(e){i.error("Invalid system alias definition: "+e.debug,"ERRORS:"+e.errors.map(function(e){return"\n - "+e}).join(""),"sap.ushell.ApplicationType")}function m(e){function t(e){var t=[];if(typeof e.host!=="string"){t.push("host field must be a string")}if(typeof e.port!=="number"&&typeof e.port!=="string"){t.push("port field must be a number or a string")}if(typeof e.pathPrefix!=="string"){t.push("pathPrefix field must be a string")}return t}var n=[],r=e.hasOwnProperty("https"),i=e.hasOwnProperty("http");if(!i&&!r){n.push("at least one of 'http' or 'https' fields must be defined")}if(r){t(e.https).forEach(function(e){n.push("https>"+e)})}if(i){t(e.http).forEach(function(e){n.push("http>"+e)})}if(n.length>0){return{isValid:false,errors:n,debug:JSON.stringify(e,null,3)}}return{isValid:true}}function y(e,t){var n={},r;t.forEach(function(e){n[e]=true});r=e.query();r=r.split("&").filter(function(e){var t=(e.split("=")[0]||"").toLowerCase();return!n.hasOwnProperty(t)}).join("&");e.query(r)}function w(t,r,i,o){var a=new n.Deferred,s;if(r==="URL"&&i.length===0){return a.resolve(t).promise()}function p(e){var n=e+t.path();t.path(n.replace(/\/+/g,"/"));a.resolve(t)}f("",undefined,o).fail(function(e){a.reject(e)}).done(function(n){var o=g(n,new e(window.location.toString()).protocol());var a=n[o].pathPrefix;var f=i===a;if(i.length>0&&!f){if((r==="WDA"||r==="WEBGUI")&&t.path().indexOf("~canvas")>=0){s=t.path();s="/~canvas"+s.split("~canvas")[1];t.path(s)}}if(i.length===0){p(a)}else{p(i)}});return a.promise()}return{LOCAL_SYSTEM_ALIAS:o,SYSTEM_ALIAS_SEMANTICS:a,spliceSapSystemIntoURI:l,isAbsoluteURI:s,stripURI:d,selectSystemAliasDataName:g,constructNativeWebguiParameters:c}},false);