// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/base/util/UriParameters","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/core/BusyIndicator","sap/ushell/appRuntime/ui5/performance/FesrEnhancer","sap/ushell/EventHub","sap/base/Log","sap/ui/thirdparty/hasher"],function(e,t,s,i,r,a,n,u,p,o,l){"use strict";function c(){var c=this,d,f,h=true,g={},v,m={},y={},C={},S={},b,I,A;this.init=function(i,a,n,o,f,g){d=i;v=a;I=n;if(o!==undefined){h=o}this.addAppInfoToCache(f,g);e.registerCommHandlers({"sap.ushell.services.appLifeCycle":{oServiceCalls:{create:{executeServiceCallFn:function(e){u.startInteraction();t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:true});var i=JSON.parse(e.oMessage.data),a=s.fromURL(i.body.sUrl).get("sap-ui-app-id");l.disableCFLPUpdate=true;l.replaceHash(i.body.sHash);l.disableCFLPUpdate=false;c.create(a,i.body.sUrl);return(new r.Deferred).resolve().promise()}},destroy:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);c.destroy(t.body.sCacheId);return(new r.Deferred).resolve().promise()}},store:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);c.store(t.body.sCacheId);return(new r.Deferred).resolve().promise()}},restore:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);l.disableCFLPUpdate=true;l.replaceHash(t.body.sHash);l.disableCFLPUpdate=false;c.restore(t.body.sCacheId);return(new r.Deferred).resolve().promise()}}}}});p.on("disableKeepAliveRestoreRouterRetrigger").do(function(e){if(e.componentId&&y[e.componentId]){y[e.componentId]=e.disable}});this.initialSetup()};this.initialSetup=function(){t.sendMessageToOuterShell("sap.ushell.services.appLifeCycle.setup",{isStateful:true,isKeepAlive:true,isIframeValid:true,isIframeBusy:true})};this.create=function(e,s){if(a.browser.chrome){n.show(0)}if(A){A._resetBackNavigationCallback()}sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});var r=new Promise(function(t){c.getAppInfo(e,s).then(function(e){t(e)})}).then(function(r){c.getURLParameters(new i(s).query(true)).then(function(s){v(e,s,r).then(function(e){I(e);t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:false});sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{})})})});return r};this.destroy=function(e){function t(e){var t=e.sId||"<unkown>";try{e.destroy()}catch(e){o.error("exception when trying to close sapui5 application with id '"+t+"' when running inside the appruntim iframe '"+document.URL+"'. This error must be fixed in order for the iframe to operate properly.\n",e.stack,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy")}}if(e&&m[e]){if(m[e]===b){b=undefined}delete y[m[e].sId];t(m[e]);delete m[e]}else if(b){delete y[b.sId];t(b);b=undefined}sap.ushell.Container.cleanDirtyStateProviderArray();if(A){A._resetBackNavigationCallback()}u.setAppShortId();sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{})};this.store=function(e){var t=b,s;m[e]=t;if(A){S[e]=A._getBackNavigationCallback()}s=t.getComponentInstance();t.setVisible(false);if(sap.ushell.Container){C[e]=sap.ushell.Container.getAsyncDirtyStateProviders();sap.ushell.Container.cleanDirtyStateProviderArray()}if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.deactivate()}else{if(s.suspend){s.suspend()}if(s.getRouter&&s.getRouter()){s.getRouter().stop()}}}sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{})};this.restore=function(e){var t=m[e],s=t.getComponentInstance(),i=y[t.sId];sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});t.setVisible(true);if(C[e]&&sap.ushell.Container){sap.ushell.Container.setAsyncDirtyStateProviders(C[e])}if(A){A.setBackNavigation(S[e])}if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.activate()}else{if(s.restore){s.restore()}if(s.getRouter&&s.getRouter()&&s.getRouter().initialize){if(i===false){s.getRouter().initialize()}else{s.getRouter().initialize(true)}}}b=t}sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{})};this.getURLParameters=function(e){return new Promise(function(s,a){if(e.hasOwnProperty("sap-intent-param")){var n=e["sap-intent-param"];t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:n}).then(function(t){delete e["sap-intent-param"];var a=r.extend({},e,new i("?"+t).query(true),true);s(a)},function(t){s(e)})}else{s(e)}})};this.getAppInfo=function(e,t){return new Promise(function(s){function i(){f.getAppInfo(e,t).then(function(t){c.addAppInfoToCache(e,t);s(t)})}if(h===true&&g[e]){s(JSON.parse(JSON.stringify(g[e])))}else if(f){i()}else{sap.ui.require([d.replace(/\./g,"/")],function(e){f=e;i()})}})};this.addAppInfoToCache=function(e,t){if(e&&t&&h===true&&g[e]===undefined){g[e]=JSON.parse(JSON.stringify(t))}};this.setComponent=function(e){b=e;if(b){y[b.sId]=true}};this.setShellUIService=function(e){A=e}}return new c},true);