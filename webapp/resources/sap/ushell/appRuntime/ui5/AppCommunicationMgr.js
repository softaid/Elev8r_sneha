// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessage","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/Log"],function(e,s,t,n){"use strict";var i="sap.ushell.appRuntime.ui5.AppCommunicationMgr";var r,a=[],u=0;function o(){this.init=function(s){var t=this;r=e.getHandlers();t.handleMessageEvent=o.prototype._handleMessageEvent.bind(t,t);addEventListener("message",t.handleMessageEvent);if(s===true){t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid");setInterval(function(){t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid")},2500)}};this.destroy=function(){removeEventListener("message",this.handleMessageEvent)};this._handleMessageResponse=function(e){if(e.request_id&&a[e.request_id]){var s=a[e.request_id];if(e.status==="success"){s.resolve(e.body.result)}else{s.reject()}}};this._handleMessageRequest=function(e,s,a){var u=this,o=t.create("sap-ushell-config.services.PostMessage.config"),g=a&&a.service,d,p,c,l,f;n.debug("App Runtime received post message request from origin '"+s.origin+"': "+JSON.stringify(a),null,i);if(!g){return}if(o&&o.enabled===false){n.warning("App Runtime received message for "+p+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,i);return}if(!this._isTrustedPostMessageSource(e,s)){n.warning("App Runtime received message from untrusted origin '"+s.origin+"': "+JSON.stringify(s.data),null,i);return}if(g.indexOf(".")>0){d=g.split(".");c=d[d.length-1];p=g.substr(0,g.length-c.length-1)}else{n.warning("App Runtime received message with invalid service name ("+g+") :"+JSON.stringify(s.data),null,i);return}var h={oMessage:s,oMessageData:a,oContainer:e};try{l=r[p];f=l&&l.oServiceCalls[c];if(f&&f.executeServiceCallFn){f.executeServiceCallFn(h).done(function(e){u.sendResponseMessage(s,a,"success",{result:e})}).fail(function(e){u.sendResponseMessage(s,a,"error",{message:e})})}else{n.warning("App Runtime received message with unknown service name ("+a.service+") :"+JSON.stringify(s.data),null,i)}}catch(e){n.warning("Error in processing message: "+e.message+") :"+JSON.stringify(s.data),null,i)}};this._getCFLPWindow=function(){return window.parent};this._isTrustedPostMessageSource=function(e,s){var t=false,n=e._getCFLPWindow();if(n){t=s.source===n}return t};this.sendResponseMessage=function(e,s,t,r){var a=JSON.stringify({type:"response",service:s.service,request_id:s.request_id,status:t,body:r});n.debug("Sending post message response to origin ' "+e.origin+"': "+a,null,i);if(typeof e.source!=="object"||e.source===null){n.debug("Cannot send response message to origin ' "+e.origin,"`source` member of request message is not an object",i);return}e.source.postMessage(a,e.origin)};this._getTargetWindow=function(){return window.parent};this.postMessage=function(e){var s,t=this._getTargetWindow();if(e){try{if(e.type==="request"&&!e.request_id){e.request_id=this.getId()}s=JSON.stringify(e);t.postMessage(s,"*")}catch(s){n.error("Message '"+e+"' cannot be posted: "+s,"sap.ui5Isolation.AppCommunicationMgr")}}};this.sendMessageToOuterShell=function(e,t,n){var i=new s.Deferred,r={type:"request",service:e,body:t||{},request_id:n};this.postMessage(r);a[r.request_id]=i;return i.promise()};this.getId=function(){return"SAPUI5_APPRUNTIME_MSGID_"+ ++u}}o.prototype._handleMessageEvent=function(e,s){if(s===undefined){return}var t=s.data;if(typeof t==="string"){try{t=JSON.parse(s.data,this)}catch(e){n.debug("Message received from origin '"+s.origin+"' cannot be parsed: "+e,t,i);return}}if(t.type==="request"){return e._handleMessageRequest(e,s,t)}else if(t.type==="response"){return e._handleMessageResponse(t)}};return new o});