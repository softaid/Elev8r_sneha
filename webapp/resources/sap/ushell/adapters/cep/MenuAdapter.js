// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/Configuration","sap/ushell/Config","sap/ushell/library","sap/ushell/utils/HttpClient"],function(e,t,n,i,r){"use strict";var s=i.ContentNodeType;var a="sap.ushell.adapters.cep.MenuAdapter";var o=function(t,n,i){if(i&&i.config&&i.config.serviceUrl&&i.config.siteId){this.httpClient=new r;this.serviceUrl=i.config.serviceUrl;this.siteId=i.config.siteId;this.oSiteDataPromise=this._doRequest(this.serviceUrl,this.siteId)}else{e.error("Invalid configuration provided.","",a)}};o.prototype.isMenuEnabled=function(){if(!n.last("/core/menu/enabled")){return Promise.resolve(false)}return this.getMenuEntries().then(function(e){return e.length>0})};o.prototype.getMenuEntries=function(){return this.oSiteDataPromise.then(this._getSpaces.bind(this)).then(this._buildMenuEntries.bind(this))};o.prototype.getContentNodes=function(){return this.oSiteDataPromise.then(this._getSpaces.bind(this)).then(this._buildContentNodes.bind(this))};o.prototype._buildMenuEntries=function(e){return e.filter(this._isSpaceNotEmpty.bind(null,"FLP menu")).map(function(e){var t={title:e.Descriptor.title||e.Id,"help-id":"Space-"+e.Id,description:e.Descriptor.description||"",icon:undefined,type:"IBN",target:{semanticObject:"Launchpad",action:"openFLPPage",parameters:[{name:"spaceId",value:e.Id},{name:"pageId",value:e.WorkPages.nodes[0].Id}],innerAppRoute:undefined},menuEntries:[]};var n=e.WorkPages.nodes.map(function(t){return{title:t.Descriptor.title||t.Id,"help-id":"Page-"+t.Id,description:t.Descriptor.description||"",icon:undefined,type:"IBN",target:{semanticObject:"Launchpad",action:"openFLPPage",parameters:[{name:"spaceId",value:e.Id},{name:"pageId",value:t.Id}],innerAppRoute:undefined},menuEntries:[]}});if(n.length>1){t.menuEntries=n}return t})};o.prototype._buildContentNodes=function(e){return e.filter(this._isSpaceNotEmpty.bind(null,"content nodes")).map(function(e){return{id:e.Id,label:e.Descriptor.title||e.Id,type:s.Space,isContainer:false,children:e.WorkPages.nodes.map(function(e){return{id:e.Id,label:e.Descriptor.title||e.Id,type:s.Page,isContainer:this._isTraditionalPage(e.Descriptor),children:[]}}.bind(this))}}.bind(this))};o.prototype.isWorkPage=function(e){return this.oSiteDataPromise.then(this._getSpaces.bind(this)).then(function(t){var n=t.flatMap(function(e){return e.WorkPages&&e.WorkPages.nodes||[]}).find(function(t){return t.Id===e});if(n){return!this._isTraditionalPage(n.Descriptor)}return false}.bind(this))};o.prototype._isTraditionalPage=function(e){if(e.pageType&&e.pageType.toLowerCase()===s.Page.toLowerCase()){return true}return false};o.prototype._doRequest=function(n,i){var r="{"+"Spaces("+'SiteId:"'+i+'"'+"){"+"nodes{"+"Id,"+'Descriptor(select:["/title"]),'+"WorkPages{"+"nodes{"+"Id,"+'Descriptor(select:["/title","/pageType","/description"])'+"}"+"}"+"}"+"}"+"}";return this.httpClient.get(n+"?query="+r,{headers:{"Content-Type":"application/json",Accept:"application/json","Accept-Language":t.getLanguageTag()}}).then(function(t){if(t.status!==200){e.error(t.responseText,"",a);return Promise.reject("HTTP request to GraphQL service failed with status: "+t.status+" - "+t.statusText)}return JSON.parse(t.responseText||"{}")}).then(function(e){try{e.data.Spaces.nodes=e.data.Spaces.nodes.filter(function(e){return e.Id!=="default_space"})}catch(e){}return e})};o.prototype._getSpaces=function(t){if(t.data&&t.data.Spaces&&Array.isArray(t.data.Spaces.nodes)){return t.data.Spaces.nodes}e.warning("No spaces found for site-id: "+this.siteId,"",a);return[]};o.prototype._isSpaceNotEmpty=function(t,n){if(!n.WorkPages||!n.WorkPages.nodes||n.WorkPages.nodes.length===0){e.warning("FLP space "+n.Id+" without page omitted in "+t+".","",a);return false}return true};return o},false);