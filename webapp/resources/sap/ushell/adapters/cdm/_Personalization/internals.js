// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_Personalization/constants","sap/ushell/services/_Personalization/constants.private","sap/ui/thirdparty/jquery","sap/base/Log"],function(e,t,n,r){"use strict";return{PersonalizationAdapter:i,getStorageResourceRoot:a,getContainerPath:u,delAdapterContainer:c,createContainerData:f,getAdapterContainer:p,getContainerCategory:m,isCategoryPContainer:y,trimContainerKey:l,save:I,load:h,del:_,clearContainerData:v,getItemKeys:R,containsItem:P,setItemValue:b,getItemValue:A,delItem:C,addPrefixToItemKey:w,stripPrefixFromItemKey:E,getHttpHeaderValue:z};function i(e,t,n,r,i){var o,s;var u={cache:{},headers:{"sap-client":n.getClient()}};i=i&&i.config;if(!i){throw new Error("PersonalizationAdapter: missing configuration.")}if(!t){t={}}o=a(i);s=new e(o,u);return{getAdapterContainer:p.bind(null,i,t,s),delAdapterContainer:c.bind(null,i,t,s)}}function a(e){var t=!e||!e.storageResourceRoot;if(t){throw new Error("Configuration error: storage resource root is not defined.")}return e.storageResourceRoot}function o(e){var t=!e||!e.relativeUrlReadOptimized;if(t){throw new Error("Configuration error: relative URL for read optimization is not defined.")}return e.relativeUrlReadOptimized}function s(e){var t=!e||!e.relativeUrlWriteOptimized;if(t){throw new Error("Configuration error: relative URL for write optimization is not defined.")}return e.relativeUrlWriteOptimized}function u(e,t,n){return g(e,t)+"/"+encodeURIComponent(l(n))+".json"}function l(e){var i=t.S_CONTAINER_PREFIX,a,o;if(n.type(e)!=="string"||e.length===0){throw new Error("Personalization container key must be a non-empty string")}if(e.substring(0,i.length)===i){a=e.substring(i.length)}else{r.error("Unexpected personalization container key: "+e,"should always be prefixed with "+i,"sap.ushell.adapters.cdm.PersonalizationAdapter");a=e}if(a.length<=40){o=a}else{o=a.substring(0,40);r.error("Invalid personalization container key: '"+a+"'"+" exceeds maximum key length (40 characters) and is shortened to '"+o+"'",undefined,"sap.ushell.adapters.cdm.PersonalizationAdapter")}return o}function d(){return{validity:Infinity,keyCategory:e.keyCategory.GENERATED_KEY,writeFrequency:e.writeFrequency.HIGH,clientStorageAllowed:false}}function c(e,t,n,r,i){var a=u(e,i,r);var o=t&&t[a];if(o){delete t[a]}return _(n,a)}function f(e,t){var n;if(!t&&t!==""||t.constructor!==String){r.warning("Personalization container has an invalid app name; must be a non-empty string",null,"sap.ushell.adapters.cdm.PersonalizationAdapter")}if(!e){e=d()}n={items:{},__metadata:{appName:t,expiry:Date.now()+e.validity*60*1e3,validity:e.validity,category:m(e)}};return n}function p(e,t,n,r,i,a){var o,s,l=u(e,i,r);if(t&&t[l]){return t[l]}s=f(i,a);o=s.items;return{save:I.bind(null,n,s,l),load:h.bind(null,n,s,l),del:_.bind(null,n,s,l),setItemValue:b.bind(null,o),getItemValue:A.bind(null,o),getItemKeys:R.bind(null,o),containsItem:P.bind(null,o),delItem:C.bind(null,o)}}function m(e){return y(e)?"p":"u"}function g(e,t){return y(t)?o(e):s(e)}function y(t){return t&&t.keyCategory===e.keyCategory.FIXED_KEY&&t.writeFrequency===e.writeFrequency.LOW&&t.clientStorageAllowed}function I(e,t,i){return new n.Deferred(function(n){e.put(i,{data:t}).then(function(e){n.resolve()}).catch(function(e){r.error("Failed to save personalization container; response: "+(typeof e==="object"?JSON.stringify(e):e),e.stack?e.stack:null,"sap.ushell.adapters.cdm.PersonalizationAdapter");n.reject(e)})}).promise()}function h(e,t,r){function i(e){v(e.items)}return new n.Deferred(function(n){e.get(r).then(function(e){var r,a;if(e.status===200&&z(e.responseHeaders,"content-length")==="0"&&z(e.responseHeaders,"content-type").indexOf("text/plain")===0){i(t)}else{r=JSON.parse(e.responseText);if(r.data){r.items=r.data;delete r.data;r.__metadata=t.__metadata}a=r.items;v(t.items);Object.keys(a).forEach(function(e){t.items[e]=a[e]});t.__metadata=r.__metadata}n.resolve()}).catch(function(e){if(e.status===404){i(t);n.resolve()}else{v(t.items);n.reject(e)}})}).promise()}function _(e,t){return new n.Deferred(function(n){e.delete(t).then(function(){n.resolve()}).catch(function(e){n.reject(e)})}).promise()}function v(e){Object.keys(e).forEach(function(t){delete e[t]})}function w(e){if(e==="__metadata"){return undefined}else if(e.indexOf(t.S_VARIANT_PREFIX)===0||e.indexOf(t.S_ADMIN_PREFIX)===0){return e}return t.S_ITEM_PREFIX+e}function E(e){if(e.indexOf(t.S_ITEM_PREFIX)===0){return e.substring(t.S_ITEM_PREFIX.length)}else if(e.indexOf(t.S_VARIANT_PREFIX)===0||e.indexOf(t.S_ADMIN_PREFIX)===0){return e}throw new Error("Illegal item key for personalization container: '"+e+"'; must be prefixed with one of the following: ["+t.S_ITEM_PREFIX+", "+t.S_VARIANT_PREFIX+", "+t.S_ADMIN_PREFIX+"] ")}function R(e){return Object.keys(e).map(w).filter(function(e){return!!e})}function P(e,t){return e.hasOwnProperty(E(t))}function b(e,t,n){e[E(t)]=n}function A(e,t){return e[E(t)]}function C(e,t){delete e[E(t)]}function z(e,t){var n=e&&e.filter(function(e){return e.name.toLowerCase()===t});return n&&n[0]&&n[0].value}});