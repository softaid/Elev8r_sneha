// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/base/Log","sap/base/util/Version","sap/base/util/UriParameters","sap/ui/thirdparty/jquery"],function(e,t,i,n,o){"use strict";var r=function(e,t,i){this.oAdapterConfiguration=i;if(i&&i.config&&i.config.siteData){this.oCdmSiteDataRequestPromise=(new o.Deferred).resolve(i.config.siteData)}else if(i&&i.config&&i.config.siteDataPromise){this.oCdmSiteDataRequestPromise=i.config.siteDataPromise}else{var n=this._identifySiteUrlFromConfig(i);var r=this._normalizeUrl(n,location.href);this.oCdmSiteDataRequestPromise=this._requestSiteData(r)}};r.prototype._requestSiteData=function(e){var i=new o.Deferred;if(!e){return i.reject("Cannot load site: configuration property 'siteDataUrl' is missing for CommonDataModelAdapter.")}o.ajax({type:"GET",dataType:"json",url:e}).done(function(e){i.resolve(e)}).fail(function(e){t.error(e.responseText);i.reject("CDM Site was requested but could not be loaded.")});return i.promise()};r.prototype._normalizeUrl=function(t,i){if(typeof t!=="string"){return t}if(t.indexOf("http")===0){return t}var n=document.getElementsByTagName("base")[0];return new e(t,n).absoluteTo(i).toString()};r.prototype.getSite=function(){var e=new o.Deferred;this.oCdmSiteDataRequestPromise.done(function(t){var i=o.extend({},t);delete i.personalization;e.resolve(i)}).fail(function(t){e.reject(t)});return e.promise()};r.prototype.getPersonalization=function(){var e=new o.Deferred,i=this;this.oCdmSiteDataRequestPromise.done(function(n){var r=o.extend({},n),a=r._version,s;if(i.oAdapterConfiguration&&i.oAdapterConfiguration.config&&i.oAdapterConfiguration.config.ignoreSiteDataPersonalization){delete r.personalization}if(r.personalization){s=r.personalization._version;if(Object.keys(r.personalization).length>0&&!i._isPersonalizationVersionValid(a,s)){t.error("Personalization version is not compatible to the site version and will not be loaded."+" Please proceed to personalize the homepage again if needed. Personalization version: "+s+"; Site version: "+a);e.resolve();return}e.resolve(r.personalization)}else{i._readPersonalizationDataFromStorage(a).done(function(n){s=n._version;if(Object.keys(n).length>0&&!i._isPersonalizationVersionValid(a,s)){t.error("Personalization version is not compatible to the site version and will not be loaded."+" Please proceed to personalize the homepage again if needed. Personalization version: "+s+"; Site version: "+a);e.resolve();return}e.resolve(n)}).fail(function(t){e.reject(t)})}}).fail(function(t){e.reject(t)});return e.promise()};r.prototype._isPersonalizationVersionValid=function(e,t){if(!e){return false}var n=new i(e).getMajor(),o=new i(t);if(n>=3){return o.getMajor()===n}return o.getMajor()<3};r.prototype.setPersonalization=function(e){var n=new o.Deferred;sap.ushell.Container.getServiceAsync("Personalization").then(function(o){var r,a={keyCategory:o.constants.keyCategory.FIXED_KEY,writeFrequency:o.constants.writeFrequency.LOW,clientStorageAllowed:true},s={container:"sap.ushell.cdm.personalization",item:"data"},l=new i(e.version);if(l.inRange("3.1.0","4.0.0")){s={container:"sap.ushell.cdm3-1.personalization",item:"data"}}var f=o.getPersonalizer(s,a,r);f.setPersData(e).done(function(){t.info("Personalization data has been stored successfully.");n.resolve()}).fail(function(){n.reject("Writing personalization data failed.")})});return n.promise()};r.prototype._readPersonalizationDataFromStorage=function(e){var t=new o.Deferred;sap.ushell.Container.getServiceAsync("Personalization").then(function(n){var o={keyCategory:n.constants.keyCategory.FIXED_KEY,writeFrequency:n.constants.writeFrequency.LOW,clientStorageAllowed:true};var r={container:"sap.ushell.cdm.personalization",item:"data"};if(e){var a=new i(e);if(a&&a.inRange("3.1.0","4.0.0")){r={container:"sap.ushell.cdm3-1.personalization",item:"data"}}}n.getPersonalizer(r,o).getPersData().done(function(e){t.resolve(e||{})}).fail(function(){t.reject("Fetching personalization data failed.")})});return t.promise()};r.prototype._identifySiteUrlFromConfig=function(e){var t=n.fromQuery(window.location.search);var i=t.get("sap-ushell-cdm-site-url");var o=e&&e.config;if(o&&!o.allowSiteSourceFromURLParameter&&i){i=null}if(o&&!i){i=o.siteDataUrl||o.cdmSiteUrl}this.sCdmSiteUrl=i;return i};return r},false);