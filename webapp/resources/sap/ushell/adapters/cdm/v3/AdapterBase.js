// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/v3/_LaunchPage/readHome","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/m/GenericTile","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/util/deepExtend","sap/base/util/deepClone","sap/base/Log","sap/ushell/UI5ComponentType"],function(e,t,i,r,o,n,s,a,l,u,p,d,c,f,g,h,m,v,T,y,R){"use strict";var _=y.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter");var C=y.Level;var b="sap.ushell.components.tiles.cdm.applauncher";var I="sap.ushell.components.tiles.cdm.applauncherdynamic";function D(e,t,i){this.oAdapterConfiguration=i;this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.TileType={Tile:"tile",Link:"link",Card:"card"}}D.prototype.getGroups=function(){var e=new f.Deferred;this._ensureLoaded().done(function(t){p.setPerformanceMark("FLP - homepage groups processed");e.resolve(t)}).fail(function(){e.resolve([])});return e.promise()};D.prototype._ensureLoaded=function(){var t=this,i;if(this._ensureLoadedDeferred){return this._ensureLoadedDeferred.promise()}i=new f.Deferred;this._ensureLoadedDeferred=i;this._getSiteData().done(function(i){if(!t.isSiteSupported(i)){throw new Error("Invalid CDM site version: Check the configuration of the launchpage adapter and the version of the FLP site")}var r=[];var o=e.getGroupsArrayFromSite(i);o=t._addDefaultGroup(o,i);o.forEach(function(e){r=t._ensureGroupItemsResolved(e,i).concat(r)});t._allPromisesDone(r).done(function(){t._ensureLoadedDeferred.resolve(o);delete t._ensureLoadedDeferred;t._logTileResolutionFailures(t._mFailedResolvedTiles)})}).fail(function(e){_.error("Delivering hompage groups failed - "+e);t._ensureLoadedDeferred.resolve([]);delete t._ensureLoadedDeferred});return i.promise()};D.prototype._ensureGroupItemsResolved=function(e,t){var i=[],r,o;if(e.payload&&e.payload.tiles){r=this._ensureGroupTilesResolved(e.payload.tiles,t);Array.prototype.push.apply(i,r)}if(e.payload&&e.payload.links){o=this._ensureGroupLinksResolved(e.payload.links,t);Array.prototype.push.apply(i,o)}return i};D.prototype._ensureGroupTilesResolved=function(e,t){return(e||[]).map(function(e,i){return this._resolveGroupTile(e,t).then(function(e){e.isLink=false;return e})},this)};D.prototype._ensureGroupLinksResolved=function(e,t){return(e||[]).map(function(e){return this._resolveGroupTile(e,t).then(function(e){e.isLink=true;return e})},this)};D.prototype._resolveGroupTile=function(e,t){var i=this._mResolvedTiles;var r=this._mFailedResolvedTiles;var o;function n(t){i[e.id]=t;if(r[e.id]){delete r[e.id]}return t}function s(e){var t=e.target;return t&&t.semanticObject==="Shell"&&t.action==="launchURL"}if(i[e.id]){return(new f.Deferred).resolve(i[e.id]).promise()}if(e.target&&e.target.url){o=f.when(this._getTileForUrl(e))}else if(e.isBookmark&&e.vizType===undefined){o=this._resolveTileByIntent(e,t)}else if(s(e)){o=this._resolveTileByIntent(e,t)}else{o=this._resolveTileByVizId(e,t)}var a=new f.Deferred;o.done(function(e){a.resolve(n(e))}).fail(function(t){r[e.id]=t;a.reject(t)});return a.promise()};D.prototype._resolveTileByVizId=function(r,o){var n,a,u,c,h,m,y,R,_,b,I,D,S;function L(e,t){return(new f.Deferred).reject({logLevel:e,message:t}).promise()}var P=new f.Deferred;if(!g(o)){return L(C.ERROR,"Cannot resolve tile: oSite must be an object")}if(!g(r)){return L(C.ERROR,"Cannot resolve tile: oTile must be an object")}a=r.vizId;n=T(t.get(o,a||"")||{});c=r.vizType||t.getTypeId(n);u=t.getType(o,c);if(!u){return L(C.ERROR,"Cannot resolve tile '"+r.id+"': no visualization type found for vizTypeId '"+c+"'")}h=t.getAppId(n);if(h){m=t.getAppDescriptor(o,h);if(!m){return L(C.INFO,"Tile '"+r.id+"' filtered from result: no app descriptor found for appId '"+h+"' (dangling app reference)")}y=e.getInbound(m,t.getTarget(n).inboundId);if(!y){return L(C.ERROR,"Cannot resolve tile '"+r.id+"': app '"+h+"' has no navigation inbound")}R=d.mapOne(y.key,y.inbound,m,n,u,o);var G=R.resolutionResult.applicationType,F=R.resolutionResult.additionalInformation,w=s.last("/core/navigation/enableInPlaceForClassicUIs"),k=w?w[G]:false;_=l.computeNavigationModeForHomepageTiles(G,F,k);D=t.getOutbound(n,y.inbound);I=this._toHashFromOutbound(D)}else{n.vizConfig=v({},n.vizConfig,r.vizConfig);R=d.mapOne(undefined,undefined,undefined,n,u,o);if(t.startsExternalUrl(n)){S=p.getMember(n.vizConfig,"sap|flp.target.url")}}b=R.tileResolutionResult;b.navigationMode=_;b.isLink=false;if(!this._isFormFactorSupported(b)){return L(C.INFO,"Tile '"+r.id+"' filtered from result: form factor not supported")}if(S||I){P.resolve({tileResolutionResult:b,tileIntent:S||I})}else{if(!this._oUrlParsingPromise){this._oUrlParsingPromise=sap.ushell.Container.getServiceAsync("URLParsing")}this._oUrlParsingPromise.then(function(e){if(r.target){var t=T(r.target);I=d.toHashFromTarget(i.harmonizeTarget(t),e)}P.resolve({tileResolutionResult:b,tileIntent:I})})}return P.promise()};D.prototype._isFormFactorSupported=function(t){var i=p.getFormFactor();return e.supportsFormFactor(t,i)};D.prototype._getFirstInbound=function(e){var t=Object.keys(e["sap.app"].crossNavigation.inbounds).shift(),i=e["sap.app"].crossNavigation.inbounds[t];return{key:t,inbound:i}};D.prototype._resolveTileByIntent=function(e){var t=this._prepareTileHash(e);return this._getTileFromHash(t)};D.prototype._allPromisesDone=function(e){var t=new f.Deferred,i;if(e.length===0){t.resolve([])}else{var r=e.map(function(e){i=new f.Deferred;e.always(i.resolve.bind(i));return i.promise()});f.when.apply(this,r).done(function(){var e=Array.prototype.slice.call(arguments);t.resolve(e)})}return t.promise()};D.prototype._logTileResolutionFailures=function(e){var t={};if(!e){return}Object.keys(C).filter(function(e){var t=C[e];return t>=C.FATAL&&t<=C.ALL}).forEach(function(e){t[C[e]]=""});Object.keys(e).forEach(function(i){var r=e[i];if(r.logLevel){t[r.logLevel]=t[r.logLevel].concat(r.message).concat("\n")}});if(t[C.FATAL]){_.fatal(t[C.FATAL])}if(t[C.ERROR]){_.error(t[C.ERROR])}if(t[C.WARNING]){_.warning(t[C.WARNING])}if(t[C.INFO]){_.info(t[C.INFO])}if(t[C.DEBUG]){_.debug(t[C.DEBUG])}if(t[C.TRACE]){_.trace(t[C.TRACE])}};D.prototype._isValidTitle=function(e){return typeof e==="string"&&e};D.prototype._isGroupPreset=function(t){return e.isGroupPreset(t)};D.prototype._isGroupLocked=function(t){return e.isGroupLocked(t)};D.prototype.getGroupTitle=function(t){return e.getGroupTitle(t)};D.prototype.getGroupId=function(t){return e.getGroupId(t)};D.prototype.isGroupVisible=function(t){return e.isGroupVisible(t)};D.prototype.getTileTitle=function(t){return e.getTileTitle(this._mResolvedTiles,t)};D.prototype.getTileContentProviderId=function(t){return e.getContentProviderId(t)};D.prototype.getTileSubtitle=function(t){return e.getTileSubtitle(this._mResolvedTiles,t)};D.prototype.getTileIcon=function(t){return e.getTileIcon(this._mResolvedTiles,t)};D.prototype.getTileInfo=function(t){return e.getTileInfo(this._mResolvedTiles,t)};D.prototype.getTileIndicatorDataSource=function(e){var t=this._mResolvedTiles[e.id],i={},r;if(e.indicatorDataSource){i.indicatorDataSource=v({},e.indicatorDataSource);if(e.dataSource){i.dataSource=v({},e.dataSource)}return i}if(!t){return i}r=t.tileResolutionResult;if(r.indicatorDataSource){i.indicatorDataSource=v({},r.indicatorDataSource);if(r.indicatorDataSource.hasOwnProperty("dataSource")){var o=r.indicatorDataSource.dataSource,s=r.dataSources;if(s&&s.hasOwnProperty(o)){i.dataSource=v({},s[o])}else{y.warning("datasource referenced but not found for tile: "+t.tileIntent)}}if(p.getMember(r,"runtimeInformation.componentProperties.url")){var a=p.getMember(i,"indicatorDataSource.path");var l=p.getMember(i,"dataSource.uri");var u=p.getMember(r,"runtimeInformation.componentProperties.url");var d=n(a,l,u,this.getWindowLocationHref());if(!d.error){if(a){i.indicatorDataSource.path=d.uri}if(l){i.dataSource.uri=d.uriParent}}}}return i};D.prototype.getWindowLocationHref=function(){return window.location.href};D.prototype.isGroupRemovable=function(e){return!this._isGroupPreset(e)};D.prototype.isGroupLocked=function(e){return this._isGroupLocked(e)};D.prototype.getGroupTiles=function(t){return e.getGroupTiles(t).concat(e.getGroupLinks(t))};D.prototype.getTileType=function(t){if(e.isLink(this._mResolvedTiles,t)){return this.TileType.Link}if(e.isCard(this._mResolvedTiles,t)){return this.TileType.Card}return this.TileType.Tile};D.prototype.getTileId=function(t){return e.getTileId(t)};D.prototype.getTileSize=function(t){return e.getTileSize(this._mResolvedTiles,t)||"1x1"};D.prototype.getTileTarget=function(t){var i=e.getTileId(t),r=this._mResolvedTiles[i];if(t.target&&t.target.url){return t.target.url}if(r){return r.tileIntent}y.warning("Could not find a target for Tile with id '"+i+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return""};D.prototype.isTileIntentSupported=function(e){return this._mFailedResolvedTiles[e.id]===undefined};D.prototype.setTileVisible=function(e,t){var i=this._mResolvedTiles[e.id];if(i){if(i.tileComponent){this._notifyTileAboutVisibility(i.tileComponent,t,i.visibility)}i.visibility=t}};D.prototype.getCardManifest=function(e){var t,i=this._mResolvedTiles[e.id];t=i.tileResolutionResult;return t.tileComponentLoadInfo};D.prototype._getTileUiComponentContainer=function(e,t,i){var n=this,s,l,p,d,c,g,h=new f.Deferred;sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(r){l=r;var o=this._createTileComponentData(e,i,t);return o}.bind(this)).then(function(t){return this._enhanceTileComponentData(e,t)}.bind(this)).then(function(f){s=t.tileResolutionResult;if(t.isLink){p=s.navigationMode;h.resolve(n._createLinkInstance(e,i,p,r,u));return}var m=this._createTileComponentProperties(f,s.tileComponentLoadInfo);if(!m.name){return Promise.reject("Cannot find name of tile component for tile with id: '"+e.id+"'")}if(m.manifest){f.properties=f.properties||{};f.properties.manifest=m.manifest}g=this._isCustomTileComponent(m.name);var v=function(t){var r;d=t.componentHandle.getInstance();c=new o({component:d,height:"100%"});if(!i){r=n._mResolvedTiles[e.id];r.tileComponent=d;if(typeof r.visibility==="boolean"){n._notifyTileAboutVisibility(d,r.visibility)}}return c};var T=function(){return l.createComponent({loadCoreExt:g,loadDefaultDependencies:false,componentData:f,url:m.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:m,ui5ComponentName:m.name},{},[],R.Visualization).then(v)};if(g){a.once("CoreResourcesComplementLoaded").do(function(){T().then(function(e){h.resolve(e)}).fail(function(e){h.reject(e)})})}else{T().then(function(e){h.resolve(e)}).fail(function(e){h.reject(e)})}}.bind(this)).catch(function(e){h.reject(e)});return h.promise()};D.prototype._createTileComponentProperties=function(e,t){var i={};if(!t||h(t)){if(e.properties.indicatorDataSource&&e.properties.indicatorDataSource.path){i.name=I}else{i.name=b}}else{i=t.componentProperties||{};i.name=t.componentName}return i};D.prototype.getTileView=function(e){var t=this;return new f.Deferred(function(i){return t._getTileView(e,false).then(function(e){i.resolve(e)},function(t){var r="Tile with ID '"+e.id+"' could not be initialized"+(t?":\n"+t:".");y.error(r,null,e.tileType);i.reject(r)})}).promise()};D.prototype._getTileView=function(e){var t,i,r=new f.Deferred;if(typeof e!=="object"||!e.id){i="Invalid input parameter passed to _getTileView: "+e;y.error(i);return r.reject(i).promise()}t=this._mResolvedTiles[e.id];if(!t){i="No resolved tile found for tile ID: "+e.id;y.error(i);return r.reject(i).promise()}return this._getTileUiComponentContainer(e,t,false)};D.prototype._createTileComponentData=function(e,t,i){var r=t?this.getCatalogTileTitle(e):this.getTileTitle(e),o=t?this.getCatalogTilePreviewSubtitle(e):this.getTileSubtitle(e),n=t?this.getCatalogTilePreviewIcon(e):this.getTileIcon(e),s=t?this.getCatalogTilePreviewInfo(e):this.getTileInfo(e),a=t?this.getCatalogTileTargetURL(e):this.getTileTarget(e),l=this.getTileIndicatorDataSource(e),u=e.numberUnit||i.tileResolutionResult&&i.tileResolutionResult.numberUnit,p={properties:{},startupParameters:{}};if(i.tileResolutionResult&&i.tileResolutionResult.isCustomTile===true&&i.tileResolutionResult.startupParameters){p.startupParameters=i.tileResolutionResult.startupParameters}if(r){p.properties.title=r}if(s){p.properties.info=s}if(o){p.properties.subtitle=o}if(n){p.properties.icon=n}if(a){p.properties.targetURL=a}if(u){p.properties.numberUnit=u}if(l.indicatorDataSource){p.properties.indicatorDataSource=l.indicatorDataSource;if(l.dataSource){p.properties.dataSource=l.dataSource}}if(i.tileResolutionResult){p.properties.navigationMode=i.tileResolutionResult.navigationMode;p.properties.contentProviderId=i.tileResolutionResult.contentProviderId||""}return p};D.prototype._enhanceTileComponentData=function(e,t){var i=Promise.resolve();var r=this.getTileContentProviderId(e);if(r){i=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return e.getSystemContext(r)}).then(function(e){t.properties.indicatorDataSource.path=e.getFullyQualifiedXhrUrl(t.properties.indicatorDataSource.path)}).catch(function(){y.error("System Context not available")})}return i.then(function(){return t})};D.prototype._isGroupTile=function(t){return e.isGroupTile(t)};D.prototype._isCatalogTile=function(e){return!!(e&&e.isCatalogTile)};D.prototype._isFailedGroupTile=function(t){return!!(t&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[e.getTileId(t)])};D.prototype.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined}if(e.isBookmark&&m.get("target.url",e)){return e.target.url}return e.vizId||e.target&&e.target.url}if(this._isCatalogTile(e)){return e.id}return undefined};D.prototype.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e)}return e.tileResolutionResult&&e.tileResolutionResult.title||""};D.prototype.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy")}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return""}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound)}return e.tileIntent||""}return this.getTileTarget(e)};D.prototype.isGroupFeatured=function(e){return!!e.isFeatured};D.prototype._getMember=function(e,t){return p.getMember(e,t)};D.prototype.getCdmVersionsSupported=function(){return{min:c("3.0.0"),max:c("3.1.0")}};D.prototype.isSiteSupported=function(e){if(!e._version||c(e._version).compareTo(this.getCdmVersionsSupported().min)<0||c(e._version).compareTo(this.getCdmVersionsSupported().max)>0){y.fatal("Invalid CDM site version: Only version 3.0.0 is supported");return false}return true};D.prototype._isCustomTileComponent=function(e){return!(e===b||e===I)};return D},false);